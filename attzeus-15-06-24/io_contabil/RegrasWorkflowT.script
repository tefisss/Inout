


//////////////////////////////////////////////////////////////////////////////
// Grava arquivo DE/PARA de Fornecedores PENDENTES.
//////////////////////////////////////////////////////////////////////////////

public boolean gravaArquivoDeParaFornecedoresPendentes(DataBase dbIOCont,
 String codEmpresa,
 String lote,
 String filename,
 String filenameH,
 String geraTudoDePara,
 InoutLogger logger) throws Exception {

    boolean gerouArquivo = false;

	geraTudoDePara = "FALSE";

    JSONArray records   = findMovimentosPendentesPorEmpresaLote(dbIOCont, codEmpresa, lote);
    JSONArray recordsH  = findMovimentosPendentesHistorico(dbIOCont, codEmpresa, lote);
    JSONArray recordsOK = new JSONArray();


    logger.logDebug(">> Encontrou " + String.valueOf(records.length()) + " registros pendentes na tabela IO_MOVIMENTO");

    String nomeOrigemUnico   = "";
    String nomeOrigemAnterior = "";
    if (records.length() > 0) {

	  gerouArquivo = true;
      // Cria pasta de DePara se nao existir
      String deParaDirName = filename.substring(0, filename.lastIndexOf("/"));
      if (!FileUtil.fileExists(deParaDirName)) {
        FileUtil.mkDir(deParaDirName);
    }

        // Cria o arquivo de DE-PARA FORNECEDOR
    FileWriter writer = new FileWriter(filename);
    StringBuilder txt = new StringBuilder();
    txt.append("FORNECEDOR;");
    txt.append("CENTROCUSTO;");
    txt.append("CONTACLI;");
    txt.append("CONTAFOR;");
    txt.append("\r\n");

		// Percorre a lista de objetos
    for (int i=0; i<records.length(); i++) {
        JSONObject recFornecedortxt = records.optJSONObject(i);
        String txtNOMEORIGEM = recFornecedortxt.optString("NOMEORIGEM").trim();
        String txtCENTROCUSTO = recFornecedortxt.optString("CENTROCUSTO").trim();

        String txtCONTADEBITO  = "";
        String txtCONTACREDITO = "";

        if (lote.contains("_PAGAR"))  {
            txtCONTADEBITO = recFornecedortxt.optString("CONTADEBITO").trim();
        }
        if (lote.contains("_RECEBER")) {
            txtCONTACREDITO = recFornecedortxt.optString("CONTACREDITO").trim();
        }

        if (txtCONTADEBITO.equals("PENDENTE"))  txtCONTADEBITO = "";
        if (txtCONTACREDITO.equals("PENDENTE")) txtCONTACREDITO = "";

        if (txtCONTADEBITO.equals("LOTE_ENCERRADO"))  continue;
        if (txtCONTACREDITO.equals("LOTE_ENCERRADO")) continue;


        nomeOrigemUnico = txtNOMEORIGEM;
        if (nomeOrigemUnico.contains("##")) nomeOrigemUnico = nomeOrigemUnico.substring(0,nomeOrigemUnico.indexOf("##")).trim();

			// utilizar o IF abaixo e deseja que aparece o nome do fornecedor apenas uma vez no depara
			//if (nomeOrigemUnico.equals(nomeOrigemAnterior)) continue;
        nomeOrigemAnterior = nomeOrigemUnico;

        if (geraTudoDePara.equals("TRUE")) {
            txt.append(txtNOMEORIGEM);
            txt.append(";");
            txt.append(txtCENTROCUSTO);
            txt.append(";");
            txt.append(txtCONTACREDITO);
            txt.append(";");
            txt.append(txtCONTADEBITO);
            txt.append(";");
            txt.append("\r\n");
            logger.logDebug(">> Registro Pendente: " + recFornecedortxt.toString());
        }
        else {
            txt.append(txtNOMEORIGEM);
            txt.append(";");
            txt.append(txtCENTROCUSTO);
            txt.append(";");
            txt.append(";");
            txt.append(";");
            txt.append("\r\n");
            logger.logDebug(">> Registro Pendente: " + recFornecedortxt.toString());
        }
    }
        // Gravacao do Arquivo TXT
    writer.writeNewFile(txt.toString());
    logger.logDebug(">> Gravou arquivo de pendentes: " + filename);


        // Cria o arquivo de DE-PARA FORNECEDOR
    FileWriter writerH = new FileWriter(filenameH);
    StringBuilder txtH = new StringBuilder();
    txtH.append("EMPRESA;");
    txtH.append("CLIENTE/FORNECEDOR;");
    txtH.append("VALOR DOCUMENTO;");
    txtH.append("DOCUMENTO/NF;");
    txtH.append("COMPLEMENTO01;COMPLEMENTO02;COMPLEMENTO03");
    txtH.append("\r\n");


    for (int i=0; i<recordsH.length(); i++) {
        JSONObject recHitoricotxt = recordsH.optJSONObject(i);
        String txtCODEMPRESA        = recHitoricotxt.optString("CODEMPRESA").trim();
        String txtNOMEORIGEM        = recHitoricotxt.optString("NOMEORIGEM").trim();
        String txtVALORLIQUIDACAO   = recHitoricotxt.optString("VALORLIQUIDACAO").trim();
        String txtDOCUMENTO         = recHitoricotxt.optString("DOCUMENTO").trim();
        String txtHISTORICO         = recHitoricotxt.optString("HISTORICO").trim();
        txtHISTORICO = txtHISTORICO.substring(txtHISTORICO.indexOf(";")+1).trim();
        txtH.append(txtCODEMPRESA);
        txtH.append(";");
        txtH.append(txtNOMEORIGEM);
        txtH.append(";");
        txtH.append(txtVALORLIQUIDACAO);
        txtH.append(";");
        txtH.append(txtDOCUMENTO);
        txtH.append(";");
        txtH.append(txtHISTORICO);
        txtH.append("\r\n");
    }
        // Gravacao do Arquivo TXT
    writerH.writeNewFile(txtH.toString());
}




return gerouArquivo;
}

//////////////////////////////////////////////////////////////////////////////
// Grava arquivo DE/PARA de Fornecedores PENDENTES. --- VERSAO PORTAL
//////////////////////////////////////////////////////////////////////////////


public boolean gravaArquivoDeParaVersaoPortal(DataBase dbIOCont,
													   String nomeContabilidade,
                                                       String codEmpresa,
                                                       String lote,
                                                       String filename,
                                                       String filenameH,
                                                       String geraTudoDePara,
                                                       InoutLogger logger) throws Exception {

    boolean gerouArquivo = false;


     JSONArray records     = findMovimentosParaDeParaSemLote(dbIOCont, codEmpresa, lote);            // grava depara de todas as contas
     JSONArray recordsPort = findMovimentosParaDeParaPortadorSemLote(dbIOCont, codEmpresa, lote);
	
   
	
	
	boolean deparaFuncional = false;
	if (lote.contains("RECEBER") && (codEmpresa.equals("222") || codEmpresa.equals("223")) && nomeContabilidade.toUpperCase().contains("FUNCIONAL")) deparaFuncional = true;

    if (records.length() > 0 || recordsPort.length() > 0) {

        // Cria pasta de DePara se nao existir
        String deParaDirName = filename.substring(0, filename.lastIndexOf("/"));
        if (!FileUtil.fileExists(deParaDirName)) {
            FileUtil.mkDir(deParaDirName);
        }

        // Cria o arquivo de DE-PARA FORNECEDOR
        FileWriter writer = new FileWriter(filename);
        StringBuilder txt = new StringBuilder();
        txt.append("FORNECEDOR;");
        txt.append("CENTROCUSTO;");
        txt.append("CONTACLI;");
        txt.append("CONTAFOR;");
        txt.append("ORIGEM;");
        txt.append("MESREF;");
        txt.append("\r\n");
        String mesReferencia = "";

        if (lote.contains("_")) mesReferencia = lote.substring(0, lote.lastIndexOf("_")).trim();
        if (mesReferencia.contains("_")) mesReferencia = mesReferencia.substring(mesReferencia.lastIndexOf("_")+1).trim(); else mesReferencia = "";


        // Percorre a lista de objetos
        for (int i=0; i<records.length(); i++) {
            JSONObject recFornecedortxt = records.optJSONObject(i);
            String txtNOMEORIGEM = recFornecedortxt.optString("NOMEORIGEM").trim();
            String txtCENTROCUSTO = recFornecedortxt.optString("CENTROCUSTO").trim();

            String txtCONTADEBITO  = "";
            String txtCONTACREDITO = "";

            String origemConta = "0";
			boolean pendente = false;

			String chaveIOPessoa = codEmpresa + txtNOMEORIGEM;
            if (lote.contains("_PAGAR")   && recFornecedortxt.has("CONTADEBITO")  && recFornecedortxt.optString("CONTADEBITO").length() > 0 && !hasPessoaFor(dbIOCont, chaveIOPessoa, recFornecedortxt.optString("CONTADEBITO")))  origemConta = "1";
            if (lote.contains("_RECEBER") && recFornecedortxt.has("CONTACREDITO") && recFornecedortxt.optString("CONTACREDITO").length() > 0 && !hasPessoaCli(dbIOCont, chaveIOPessoa, recFornecedortxt.optString("CONTACREDITO"))) origemConta = "1";

            if (lote.contains("_PAGAR") && recFornecedortxt.has("CONTADEBITO"))  {
                txtCONTADEBITO = recFornecedortxt.optString("CONTADEBITO");
            }
            if (lote.contains("_RECEBER") && recFornecedortxt.has("CONTACREDITO")) {
                txtCONTACREDITO = recFornecedortxt.optString("CONTACREDITO");
            }

			logger.logDebug("LENDO ORIGEM = " + origemConta + "===" + txtCONTADEBITO + "---" + txtNOMEORIGEM);

            if (txtCONTADEBITO.equals("PENDENTE"))  {
                origemConta  = "0";
                gerouArquivo = true;
                txtCONTADEBITO = "";
				pendente = true;
            }
            if (txtCONTACREDITO.equals("PENDENTE")) {
                origemConta     = "0";
                gerouArquivo    = true;
                txtCONTACREDITO = "";
				pendente = true;
            }

            if (txtCONTADEBITO.equals("LOTE_ENCERRADO"))  continue;
            if (txtCONTACREDITO.equals("LOTE_ENCERRADO")) continue;

			if (!nomeContabilidade.toUpperCase().contains("CONTACGO")) {
				if ((records.length() > 200 || nomeContabilidade.toUpperCase().contains("ESCONTEC") || nomeContabilidade.toUpperCase().contains("CSI")) && !pendente) continue;
			}

            txt.append(txtNOMEORIGEM);
            txt.append(";");
            txt.append(txtCENTROCUSTO);
            txt.append(";");
            txt.append(txtCONTACREDITO);
            txt.append(";");
            txt.append(txtCONTADEBITO);
            txt.append(";");
            txt.append(origemConta);
            txt.append(";");
            txt.append(mesReferencia);
            txt.append(";");
            txt.append("\r\n");
        }


        // Percorre a lista de objetos
		if (!nomeContabilidade.toUpperCase().contains("DEPAULA") &&
			!nomeContabilidade.toUpperCase().contains("ESCONTEC") &&
			(!nomeContabilidade.toUpperCase().contains("FUNCIONAL") || deparaFuncional) &&
			!nomeContabilidade.toUpperCase().equals("META") &&
			!nomeContabilidade.toUpperCase().contains("ESCRITORIOGOMES")) {

			for (int i=0; i<recordsPort.length(); i++) {
				JSONObject recFornecedortxt = recordsPort.optJSONObject(i);
				String txtNOMEORIGEM = recFornecedortxt.optString("NOMEPORTADOR");
				String txtCENTROCUSTO = recFornecedortxt.optString("CENTROCUSTO");

				String txtCONTADEBITO  = "";
				String txtCONTACREDITO = "";

				String origemConta = "2";
				boolean pendente = false;


				if (lote.contains("_PAGAR") && recFornecedortxt.has("CONTACREDITO"))  {


					txtCONTADEBITO = recFornecedortxt.optString("CONTACREDITO");
					if (txtCONTADEBITO.equals("")) gerouArquivo = true;

				}
				if (lote.contains("_RECEBER") && recFornecedortxt.has("CONTADEBITO")) {
					txtCONTACREDITO = recFornecedortxt.optString("CONTADEBITO");
					if (txtCONTACREDITO.equals("")) gerouArquivo = true;
				}

				if (txtCONTADEBITO.equals("PENDENTE"))  {
					gerouArquivo   = true;
					txtCONTADEBITO = "";
					pendente = true;
				}
				if (txtCONTACREDITO.equals("PENDENTE")) {
					gerouArquivo   = true;
					txtCONTACREDITO = "";
					pendente = true;
				}

				if (txtCONTADEBITO.equals("LOTE_ENCERRADO"))  continue;
				if (txtCONTACREDITO.equals("LOTE_ENCERRADO")) continue;

				//if (recordsPort.length() > 200 && !pendente) continue;
				if (i > 200 && !pendente) continue; 
				
				//if (nomeContabilidade.toUpperCase().contains("FUNCIONAL") && !pendente) continue;


				txt.append(txtNOMEORIGEM);
				txt.append(";");
				txt.append(txtCENTROCUSTO);
				txt.append(";");
				txt.append(txtCONTACREDITO);
				txt.append(";");
				txt.append(txtCONTADEBITO);
				txt.append(";");
				txt.append(origemConta);
				txt.append(";");
				txt.append(mesReferencia);
				txt.append(";");
				txt.append("\r\n");
			}


		}
		// Gravacao do Arquivo TXT
		if (gerouArquivo) writer.writeNewFile(txt.toString());

    }

    return gerouArquivo;
}


//###############################################################################
/////////////////////////////////////////////////////////////////////////////////
// Envia e-mail de arquivo PENDENTE.
/////////////////////////////////////////////////////////////////////////////////
public void enviaEmailPendentes(String codEmpresa,
                                String nomeEmpresa,
                                String lote,
                                String nomeContabilidade,
                                String emailResponsavel,
                                String filename,
                                InoutLogger logger) throws Exception {


    String subject = "NECESSIDADE DE DEPARA >> Empresa: " + codEmpresa + "-" + nomeEmpresa + ", Lote: " + lote;
    String sendToName = nomeContabilidade + " -- OTTIMIZZA Contabil";
    StringBuilder msg = new StringBuilder();
    String link1 = "http://168.144.179.157:8475/contabil-server/dePara.jsp?contabilidade=" + nomeContabilidade;

    msg.append("<html>\n");
    msg.append("<head>\n");
    msg.append("</head>\n");
    msg.append("<body lang=\"en-US\" dir=\"ltr\">\n");
    msg.append("<p><font style=\"font-size: 10pt\"><b>Alguns lancamentos ficaram pendentes de conta contabil. Para finalizar, acesse o link abaixo: </b></font></p>\n\n");
    msg.append("<p><font style=\"font-size: 10pt\"> " + link1 + "</font></p>\n\n");
    msg.append("<p><font style=\"font-size: 10pt\">Caso nao consiga acessar, solicite ao responsavel pela infraestrutura a liberacao de acesso.</b></font></p>\n\n");
    msg.append("<p><font style=\"font-size: 10pt\">O manual para utilizacao do DeParaWeb encontra-se em http://www.ottimizza.com.br/Manual_Ottimizza.pdf</font></p>\n");
    msg.append("<p><font style=\"font-size: 10pt\">Atenciosamente,</font></p>\n");
    msg.append("<p><strong>SUPORTE OTTIMIZZA AUTOMACAO CONTABIL</strong>\n");
    msg.append("<br/>Rua 2 de setembro, 3753, Blumenau-SC \n");
    msg.append("<br/>+55 (47) 3035-3765 \n");
    msg.append("<br/>suporte@ottimizza.com.br</p>\n");
    msg.append("</body>\n");
    msg.append("</html>\n");

    lote = lote.toUpperCase();
    if (lote.contains("OTTIMIZZA") && !lote.contains("OTTIMIZZAAUTOMACAO")) emailResponsavel = "suporte@ottimizza.com.br";

    enviaEmail(subject, emailResponsavel, sendToName, msg.toString(), filename, logger);

}




public void enviaEmailDeParaRoteiro(String codEmpresa,
                                    String nomeEmpresa,
                                    String lote,
                                    String nomeContabilidade,
                                    String emailResponsavel,
                                    String filename,
                                    InoutLogger logger) throws Exception {


    String subject = "ARQUIVO AUXILIAR PARA ROTEIRO >> Empresa: " + codEmpresa + "-" + nomeEmpresa + ", Lote: " + lote;
    String sendToName = nomeContabilidade + " -- OTTIMIZZA Contabil";
    StringBuilder msg = new StringBuilder();

    msg.append("<html>\n");
    msg.append("<head>\n");
    msg.append("</head>\n");
    msg.append("<body lang=\"en-US\" dir=\"ltr\">\n");
    msg.append("<p><font style=\"font-size: 10pt\"><b>Anexo arquivo para auxiliar no roteiro. </b></font></p>\n\n");
    msg.append("<p><font style=\"font-size: 10pt\">Atenciosamente,</font></p>\n");
    msg.append("<p><strong>SUPORTE OTTIMIZZA AUTOMACAO CONTABIL</strong>\n");
    msg.append("<br/>Rua 2 de setembro, 3753, Blumenau-SC \n");
    msg.append("<br/>+55 (47) 3035-3765 \n");
    msg.append("<br/>suporte@ottimizza.com.br</p>\n");
    msg.append("</body>\n");
    msg.append("</html>\n");

    lote = lote.toUpperCase();
    //if (lote.contains("OTTIMIZZAF") && !lote.contains("OTTIMIZZAAUTOMACAO")) emailResponsavel = "suporte@ottimizza.com.br";
    //if (lote.contains("OTTIMIZZA")) enviaEmail(subject, emailResponsavel, sendToName, msg.toString(), filename, logger);

}

//###############################################################################

/////////////////////////////////////////////////////////////////////////////////
// Envia e-mail de lote LIBERADO.
/////////////////////////////////////////////////////////////////////////////////
public void enviaEmailLoteLiberado(String codEmpresa,
                                   String nomeEmpresa,
                                   String lote,
                                   String nomeContabilidade,
                                   String emailResponsavel,
                                   InoutLogger logger) throws Exception {

    SysProperties props = SysProperties.getInstance();
    props.load("contabil/" + nomeContabilidade + "/contabil.properties");
    String versaoPlataforma = props.get("VERSAO_PLATAFORMA");

    String subject = "LOTE INTEGRACAO LIBERADO, " + codEmpresa + "-" + nomeEmpresa + " Lote: " + lote;
    String sendToName = "OTTIMIZZA - " + nomeContabilidade;
    StringBuilder msg = new StringBuilder();
    msg.append("<html>\n");
    msg.append("<head>\n");
    msg.append("</head>\n");
    msg.append("<body lang=\"en-US\" dir=\"ltr\">\n");
    msg.append("<p><font style=\"font-size: 10pt\">OTTIMIZZA - LOTE LIBERADO PARA IMPORTA&Ccedil;&Atilde;O.</font></p>\n");
    msg.append("<p><font style=\"font-size: 10pt\"><b/>/ottimizzaft/" + nomeContabilidade + "/Arquivos</b></font></p>\n\n");
    msg.append("<p><font style=\"font-size: 10pt\">Atenciosamente,</font></p>\n");
    msg.append("<p><strong>SUPORTE OTTIMIZZA AUTOMACAO CONTABIL</strong>\n");
    msg.append("<br/>Rua 2 de setembro, 3753, Blumenau-SC \n");
    msg.append("<br/>+55 (47) 3035-3765 \n");
    msg.append("<br/>suporte@ottimizza.com.br</p>\n");
    msg.append("</body>\n");
    msg.append("</html>\n");

    lote = lote.toUpperCase();
    if (lote.contains("OTTIMIZZA") && !lote.contains("OTTIMIZZAAUTOMACAO")) emailResponsavel = "suporte@ottimizza.com.br";

    if (versaoPlataforma.equals("01_Conecta_Via_Ottimizza_FT")) enviaEmail(subject, emailResponsavel, sendToName, msg.toString(), null, logger);
}

public void enviaEmailGeral(String assunto,
                            String destinatarioNome,
                            String destinatarioEmail,
                            StringBuilder mensagem,
                            InoutLogger logger) throws Exception {

    String subject = assunto;
    String sendToName = destinatarioNome;
    StringBuilder msg = mensagem;
    enviaEmail(subject, destinatarioEmail, sendToName, msg.toString(), null, logger);
}

public void enviaEmailGeralComAnexo(String assunto,
                                    String destinatarioNome,
                                    String destinatarioEmail,
                                    StringBuilder mensagem,
                                    String filename,
                                    InoutLogger logger) throws Exception {

    String subject = assunto;
    String sendToName = destinatarioNome;
    StringBuilder msg = mensagem;
    enviaEmail(subject, destinatarioEmail, sendToName, msg.toString(), filename, logger);
}

/////////////////////////////////////////////////////////////////////////////////
// Envia e-mail de lote LIBERADO.
/////////////////////////////////////////////////////////////////////////////////
public void enviaEmailLoteLiberadoComAnexo(String codEmpresa,
                                           String nomeEmpresa,
                                           String lote,
                                           String nomeContabilidade,
                                           String emailResponsavel,
                                           String filename,
                                           InoutLogger logger) throws Exception {

	SysProperties props = SysProperties.getInstance();
    props.load("contabil/" + nomeContabilidade + "/contabil.properties");
    String versaoPlataforma = props.get("VERSAO_PLATAFORMA");

	String subject = "LOTE INTEGRACAO LIBERADO, " + codEmpresa + "-" + nomeEmpresa + " Lote: " + lote;
    String sendToName = "OTTIMIZZA - " + nomeContabilidade;
    StringBuilder msg = new StringBuilder();
    msg.append("<html>\n");
    msg.append("<head>\n");
    msg.append("</head>\n");
    msg.append("<body lang=\"en-US\" dir=\"ltr\">\n");
    msg.append("<p><font style=\"font-size: 10pt\">OTTIMIZZA - LOTE LIBERADO PARA IMPORTA&Ccedil;&Atilde;O.</font></p>\n");
    msg.append("<p><font style=\"font-size: 10pt\"><b/>.../contabil/" + nomeContabilidade + "/Arquivos</b></font></p>\n\n");
    msg.append("<p><font style=\"font-size: 10pt\">Atenciosamente,</font></p>\n");
    msg.append("<p><strong>SUPORTE OTTIMIZZA AUTOMACAO CONTABIL</strong>\n");
    msg.append("<br/>Rua 2 de setembro, 3753, Blumenau-SC \n");
    msg.append("<br/>+55 (47) 3035-3765 \n");
    msg.append("<br/>suporte@ottimizza.com.br</p>\n");
    msg.append("</body>\n");
    msg.append("</html>\n");

    lote = lote.toUpperCase();
    if (lote.contains("OTTIMIZZA") && !lote.contains("OTTIMIZZAAUTOMACAO")) emailResponsavel = "suporte@ottimizza.com.br";

    if (versaoPlataforma.equals("01_Conecta_Via_Ottimizza_FT")) enviaEmail(subject, emailResponsavel, sendToName, msg.toString(), filename, logger);
}


public void enviaEmailArquivoXLS(String filename,
                                 String nomeContabilidade,
                                 String empresa,
                                 InoutLogger logger) throws Exception {

    SysProperties props = SysProperties.getInstance();
    props.load("contabil/" + nomeContabilidade + "/contabil.properties");
    String emailResponsavel = props.get(empresa.toUpperCase() + "_EMAIL_RESPONSAVEL");

    String subject = "ARQUIVO .XLS NAO LIDO POR OTTIMIZZA CONTABIL";
    String sendToName = "OTTIMIZZA - " + nomeContabilidade;
    StringBuilder msg = new StringBuilder();
    msg.append("<html>\n");
    msg.append("<head>\n");
    msg.append("</head>\n");
    msg.append("<body lang=\"en-US\" dir=\"ltr\">\n");
    msg.append("<p><font style=\"font-size: 10pt\">Um arquivo com extensao (.xls) foi colocado em pasta:</font></p>\n");
    msg.append("<p><font style=\"font-size: 10pt\">").append(filename).append("</font></p>\n");
    msg.append("<p><font style=\"font-size: 10pt\">Pedimos que edite o arquivo e SALVE-O COMO  arquivo (.xlsx) (Pasta de Trabalho Excel) !</font></p>\n\n");
    msg.append("<p><font style=\"font-size: 10pt\">PS: atencao, favor nao renomear o arquivo e sim SALVAR COMO. o procedimento de renomear nao fara com que o OTTIMIZZA CONTABIL leia o arquivo.</font></p>\n\n");
    msg.append("<p><font style=\"font-size: 10pt\">Atenciosamente,</font></p>\n");
    msg.append("<p><strong>SUPORTE OTTIMIZZA AUTOMACAO CONTABIL</strong>\n");
    msg.append("<br/>Rua 2 de setembro, 3753, Blumenau-SC \n");
    msg.append("<br/>+55 (47) 3035-3765 \n");
    msg.append("<br/>suporte@ottimizza.com.br</p>\n");
    msg.append("</body>\n");
    msg.append("</html>\n");
    enviaEmail(subject, emailResponsavel, sendToName, msg.toString(), null, logger);
}



/////////////////////////////////////////////////////////////////////////////////
//              Envia e-mail de LAYOUT INVALIDO.
/////////////////////////////////////////////////////////////////////////////////
public void enviaEmailLayoutInvalido(String codEmpresa,
                                     String nomeEmpresa,
                                     String lote,
                                     String nomeContabilidade,
                                     String emailResponsavel,
                                     int cont,
                                     HashMap mapaLay,
                                     ttLayout layout,
                                     InoutLogger logger) throws Exception {

    String pdfHomologado = "";
    String tipoLancamento = "";

	SysProperties props = SysProperties.getInstance();
    props.load("contabil/" + nomeContabilidade + "/contabil.properties");
	String versaoPlataforma = props.get("VERSAO_PLATAFORMA");


    String subject = "Erro na Tentativa de Integrar " + codEmpresa + "-" + nomeEmpresa + " Lote: " + lote;
    String sendToName = "OTTIMIZZA CONTABIL - " + nomeContabilidade;
    StringBuilder msg = new StringBuilder();
    msg.append("<html>\n");
    msg.append("<head>\n");
    msg.append("</head>\n");
    msg.append("<body lang=\"en-US\" dir=\"ltr\">\n");
    msg.append("<p><font style=\"font-size: 10pt\">Prezado cliente.</font></p>\n");
    msg.append("<p><font style=\"font-size: 10pt\"><b/>Houve um erro na tentativa de importar o arquivo do cliente " + nomeEmpresa + ". </b></font></p>\n\n");

    Iterator iteLay = mapaLay.keySet().iterator();
    while (iteLay.hasNext()) {
        String key = (String)iteLay.next();
        ttLayout ttLay = (ttLayout)mapaLay.get(key);
        tipoLancamento = ttLay.tipoLancamento;
        if(!ttLay.codErroString.equals("00")) {

            ttLay.linhasProblema = ttLay.linhasProblema.substring(0,ttLay.linhasProblema.lastIndexOf(","));
            msg.append("<p><font style=\"font-size: 10pt\"><b/>_______________________________________________________________________________________________ </b> </font></p>\n");
            msg.append("<p><font style=\"font-size: 10pt; color: red\"><b/>Tipo problema: </b> </font><font style=\"font-size: 10pt\"> " + ttLay.texto + ". </font></p>\n");
            if(!ttLay.codErroString.equals("06")) msg.append("<p><font style=\"font-size: 10pt\"><b/>Mesmo erro encontrado nas linhas: </b>" + ttLay.linhasProblema + ". </font></p>\n");
            if(!ttLay.codErroString.equals("06")) msg.append("<p><font style=\"font-size: 10pt\"><b/>Quantidade de linhas com problema: </b>" + ttLay.qtdIgnoradas + ". </font></p>\n\n");
        }
    }
    msg.append("<p><font style=\"font-size: 10pt\"><b/>_______________________________________________________________________________________________ </b> </font></p>\n");
    msg.append("<p>Atenciosamente,</p>\n");

    pdfHomologado = RouteEngine.INOUT_HOME + "/contabil/" + getNomeContabilidade() + "/" + nomeEmpresa + "_#" + codEmpresa + "/A" + tipoLancamento + "/Processado/arquivo_homologado.pdf";
    File arquivo = new File(RouteEngine.INOUT_HOME + "/contabil/" + getNomeContabilidade() + "/" + nomeEmpresa + "_#" + codEmpresa + "/A" + tipoLancamento + "/Processado/arquivo_homologado.pdf");

    msg.append("<p><strong>SUPORTE OTTIMIZZA AUTOMACAO CONTABIL</strong>\n");
    msg.append("<br/>Rua 2 de setembro, 3753, Blumenau-SC \n");
    msg.append("<br/>+55 (47) 3035-3765 \n");
    msg.append("<br/>suporte@ottimizza.com.br</p>\n");
    msg.append("</body>\n");
    msg.append("</html>\n");
    lote = lote.toUpperCase();
    emailResponsavel = emailResponsavel + ", suporte@ottimizza.com.br";
    if (lote.contains("OTTIMIZZA") && !lote.contains("OTTIMIZZAAUTOMACAO")) emailResponsavel = "suporte@ottimizza.com.br";

    if(!arquivo.exists() ){
        if (versaoPlataforma.equals("01_Conecta_Via_Ottimizza_FT")) enviaEmail(subject, emailResponsavel, sendToName, msg.toString(), null, logger);
    }else{
        if (versaoPlataforma.equals("01_Conecta_Via_Ottimizza_FT")) enviaEmail(subject, emailResponsavel, sendToName, msg.toString(), pdfHomologado, logger);
    }
}

//###############################################################################

/////////////////////////////////////////////////////////////////////////////////
// Prepara trecho HTML com resumo da importacao da planilha para envio por e-mail
/////////////////////////////////////////////////////////////////////////////////
private String preparaResumoPlanilha(String lote, String resumoHistorico, String linhasNaoValidas, InoutLogger logger) {

    StringBuilder sb = new StringBuilder();

    sb.append("<br/>\n")
    .append("<p><font style=\"font-size: 10pt\"><b>Resumo da Planilha:</b></font></p>\n")
    .append("<p><font style=\"font-size: 10pt\">Lote: ")
    .append(lote)
    .append("</font></p>\n")
    .append("<p><font style=\"font-size: 10pt\">Exemplo: ")
    .append(resumoHistorico)
    .append("</font></p>\n")
    .append("<p><font style=\"font-size: 10pt\">LINHAS COM PROBLEMA: ")
    .append(linhasNaoValidas)
    .append("</font></p>\n");
    return sb.toString();
}


private double retornaValorTotal(String lote, InoutLogger logger) {
    StringBuilder sb = new StringBuilder();
    JSONObject jsrp = MemoryFile.getFileResume(lote, logger);

    double valorTotal = 0;
    if (jsrp != null) {
        valorTotal = jsrp.optDouble("docTotalValue");
    }
    return valorTotal;
}


private JSONObject retornaErroLayout(String lote, InoutLogger logger) {
    StringBuilder sb = new StringBuilder();
    JSONObject jsrp = MemoryFile.getFileResume(lote, logger);

    String valorBranco = "";
    if (jsrp != null) {
        valorBranco = jsrp.optString("VALORBRANCO");
    }
    return jsrp;
}



 
private JSONObject buscaContaSimples(String codEmpresa, String nomeFornecedor,
                              String cpfCnpj, String tipoLancamento, InoutLogger logger,
                              DataBase dbIOCont) throws Exception {

    JSONObject ret = new JSONObject();
    Calendar c = Calendar.getInstance();
    if (tipoLancamento.equals("PAGAR")) {
        ret.put("contaDebito", "");
    } else {
        ret.put("contaCredito", "");
    }
    ret.put("contaSugerida", false);
    ret.put("cnpjIOPessoa", "");

    if (nomeFornecedor == null || nomeFornecedor.trim().length() == 0 ||
        codEmpresa == null || codEmpresa.trim().length() == 0) {
        return ret;

    }
    if (nomeFornecedor.length() > 170) nomeFornecedor = nomeFornecedor.substring(0,170).trim();

    String fornecedorUnico = "SIM";
	String nomePessoa = "SIM";
    JSONArray records = null;
 
	try {
        records = findPessoaPorEmpresaNomeOrigem(dbIOCont, codEmpresa, nomeFornecedor, false);
        if (records.length() > 0) {
            JSONObject record = records.optJSONObject(0);
            String contaFor = record.optString("CONTACTBFOR").trim();
            String contaCli = record.optString("CONTACTBCLI").trim();
            nomePessoa = record.optString("NOMEPESSOA").trim();
            String cnpjIOPessoa = record.optString("CPFCNPJ").trim();
            if (tipoLancamento.equals("PAGAR")) {
                if (contaFor != null && contaFor.trim().length() > 0) {
                    logger.logDebug(">>> Achou a conta pelo 2o PASSO");
                    ret.put("contaDebito", contaFor);
                    ret.put("cnpjIOPessoa", cnpjIOPessoa);
                    ret.put("nomePessoa", nomePessoa);
                    ret.put("nomeOrigem", nomePessoa);
                    if (contaCli != null && contaCli.trim().length() > 0) ret.put("contaCredito", contaCli);
                    return ret;
                }
            } else {
                if (contaCli != null && contaCli.trim().length() > 0) {
                    logger.logDebug(">>> Achou a conta pelo 2o PASSO");
                    ret.put("contaCredito", contaCli);
                    ret.put("cnpjIOPessoa", cnpjIOPessoa);
                    ret.put("nomePessoa", nomePessoa);
                    ret.put("nomeOrigem", nomePessoa);
                    return ret;
                }
            }
        }
    } catch (Exception e2oPasso) {
        logger.logError("EndpointB: ERROR BUSCA CONTA - 2o PASSO", e2oPasso);
    }
	return ret;
}

//###############################################################################

/////////////////////////////////////////////////////////////////////////////////
// Busca Conta Fornecedor.
/////////////////////////////////////////////////////////////////////////////////
private JSONObject buscaConta(String codEmpresa, String nomeFornecedor,
                              String cpfCnpj, String tipoLancamento, InoutLogger logger,
                              DataBase dbIOCont) throws Exception {

    JSONObject ret = new JSONObject();
    Calendar c = Calendar.getInstance();
    if (tipoLancamento.equals("PAGAR")) {
        ret.put("contaDebito", "");
    } else {
        ret.put("contaCredito", "");
    }
    ret.put("contaSugerida", false);
    ret.put("cnpjIOPessoa", "");

    if (nomeFornecedor == null || nomeFornecedor.trim().length() == 0 ||
        codEmpresa == null || codEmpresa.trim().length() == 0) {
        return ret;

    }
    if (nomeFornecedor.length() > 170) nomeFornecedor = nomeFornecedor.substring(0,170).trim();

    String nomeCont = getNomeContabilidade();
	String empresaProp = INOUT_ROUTE_ID.substring(INOUT_ROUTE_ID.indexOf(".")+1);
    empresaProp = empresaProp.substring(0, empresaProp.indexOf("_")).toUpperCase();


    if (empresaProp.equals(getNomeContabilidade().toUpperCase())) {
        SysProperties prop = SysProperties.getInstance();
        prop.load("contabil/" + getNomeContabilidade() + "/empresa.properties");
        nomeCont = prop.get("NOME_CONTABILIDADE").toUpperCase();
    }
	
	
    nomeCont = nomeCont.replaceAll("DePara","").trim();
    SysProperties propriedades = SysProperties.getInstance();
    propriedades.load("contabil/" + nomeCont + "/contabil.properties");
    String fornecedorUnico = propriedades.get("FORNECEDOR_UNICO");
    JSONArray records = null;

    logger.logDebug(">>> Empresa: " + codEmpresa + " Fornecedor: " + nomeFornecedor + " CNPJ: " + cpfCnpj);
	
		 // numero de colunas para buscar fornecedor.
	String stringColunas = "";
	int    numeroColunas = 0;
	
	try {
		stringColunas = propriedades.get(codEmpresa + "_NUMERO_COLUNAS");
 		numeroColunas = Integer.parseInt(stringColunas);
	}
	 catch (Exception xx) { numeroColunas = 0; }


    // Monta o campo IO_PESSOA.CHAVE
    String chaveIoPessoa = codEmpresa + nomeFornecedor + cpfCnpj;
    logger.logDebug(">>> Chave IO_PESSOA: " + chaveIoPessoa);
    //------------------------------------------------------------------------------//
    // 1o PASSO - Busca a CONTA CONTABIL no IO_PESSOA pelo CPFCNPJ.                 //
    //------------------------------------------------------------------------------//

    String nomePessoa = "";
    if (cpfCnpj != null && cpfCnpj.trim().length() > 0) {

        try {
            records = findPessoaPorEmpresaCnpj(dbIOCont, codEmpresa, cpfCnpj);  // retirado 17.09 para ver performance
            if (records.length() > 0) {
                JSONObject rec = records.optJSONObject(0);
                String contaFor = rec.optString("CONTACTBFOR").trim();
                String contaCli = rec.optString("CONTACTBCLI").trim();
                String nomeOrigem = rec.optString("NOMEORIGEM").trim();
                nomePessoa = rec.optString("NOMEPESSOA").trim();
                if (tipoLancamento.equals("PAGAR")) {
                    if (contaFor != null && contaFor.trim().length() > 0) {
                        logger.logDebug(">>> Achou a conta pelo 1o PASSO");
                        ret.put("contaDebito", contaFor);
                        ret.put("nomeOrigem", nomeOrigem);
                        ret.put("nomePessoa", nomePessoa);
                        return ret;
                    }


                } else {
                    if (contaCli != null && contaCli.trim().length() > 0) {
                        logger.logDebug(">>> Achou a conta pelo 1o PASSO");
                        ret.put("contaCredito", contaCli);
                        ret.put("nomeOrigem", nomeOrigem);
                        ret.put("nomePessoa", nomePessoa);
                        return ret;
                    }

                }
            }
        } catch (Exception e1oPasso) {
            logger.logError("EndpointB: ERROR BUSCA CONTA - 1o PASSO", e1oPasso);
        }
    }

    //------------------------------------------------------------------------------//
    // 2o PASSO - Busca a CONTA CONTABIL no IO_PESSOA e IO_CONTA pelo NOME ORIGEM.  //
    //------------------------------------------------------------------------------//
    logger.logDebug(">>> 2o Passo");
    try {
        records = findPessoaPorEmpresaNomeOrigem(dbIOCont, codEmpresa, nomeFornecedor, false);
        if (records.length() > 0) {
            JSONObject record = records.optJSONObject(0);
            String contaFor = record.optString("CONTACTBFOR").trim();
            String contaCli = record.optString("CONTACTBCLI").trim();
            nomePessoa = record.optString("NOMEPESSOA").trim();
            String cnpjIOPessoa = record.optString("CPFCNPJ").trim();
            chaveIoPessoa = codEmpresa + nomeFornecedor + cnpjIOPessoa;
            if (tipoLancamento.equals("PAGAR")) {
                if (contaFor != null && contaFor.trim().length() > 0) {
                    logger.logDebug(">>> Achou a conta pelo 2o PASSO");
                    ret.put("contaDebito", contaFor);
                    ret.put("cnpjIOPessoa", cnpjIOPessoa);
                    ret.put("nomePessoa", nomePessoa);
                    ret.put("nomeOrigem", nomePessoa);
                    if (contaCli != null && contaCli.trim().length() > 0) ret.put("contaCredito", contaCli);
                    return ret;
                }
            } else {
                if (contaCli != null && contaCli.trim().length() > 0) {
                    logger.logDebug(">>> Achou a conta pelo 2o PASSO");
                    ret.put("contaCredito", contaCli);
                    ret.put("cnpjIOPessoa", cnpjIOPessoa);
                    ret.put("nomePessoa", nomePessoa);
                    ret.put("nomeOrigem", nomePessoa);
                    return ret;
                }
            }
        }
    } catch (Exception e2oPasso) {
        logger.logError("EndpointB: ERROR BUSCA CONTA - 2o PASSO", e2oPasso);
    }


    //------------------------------------------------------------------------------//
    // 2.1o PASSO - Busca a CONTA CONTABIL np plano de contas pelo nome da Planilha //
    //------------------------------------------------------------------------------//
    logger.logDebug(">>> 2.1o Passo");
    try {

        // ignora pois quando vem o portador no nome do fornececedor, nao podemos sugerir a conta
        if (!nomeFornecedor.contains("BANCO")     && !nomeFornecedor.contains("SICRED")   && !nomeFornecedor.contains("SANTANDER") &&
            !nomeFornecedor.contains("DO BRASIL") && !nomeFornecedor.contains("ITAU")     && !nomeFornecedor.contains("BRADESCO") &&
            !nomeFornecedor.contains("CAIXA")     && !nomeFornecedor.contains("CEF")      && !nomeFornecedor.contains("BESC") &&
            !nomeFornecedor.contains("HSBC")      && !nomeFornecedor.contains("UNIBANCO") && !nomeFornecedor.contains("SAFRA") &&
            !nomeFornecedor.contains("UNICRED")   && !nomeFornecedor.contains("BANRISUL") && !nomeFornecedor.contains("SUDAMERIS") &&
            !nomeFornecedor.contains("PREFEITURA") && !nomePessoa.contains("PREFEITURA") &&
            !nomePessoa.contains("BANCO")     && !nomePessoa.contains("SICRED")   && !nomePessoa.contains("SANTANDER") &&
            !nomePessoa.contains("DO BRASIL") && !nomePessoa.contains("ITAU")     && !nomePessoa.contains("BRADESCO") &&
            !nomePessoa.contains("CAIXA")     && !nomePessoa.contains("CEF")      && !nomePessoa.contains("BESC") &&
            !nomePessoa.contains("HSBC")      && !nomePessoa.contains("UNIBANCO") && !nomePessoa.contains("SAFRA") &&
            !nomePessoa.contains("UNICRED")   && !nomePessoa.contains("BANRISUL") && !nomePessoa.contains("SUDAMERIS")) {

 			
            String nomeConti = "";
            nomeConti = geraNomeContinuo(nomeFornecedor);
            records = findPessoaPorPlanoContas(dbIOCont, codEmpresa, nomeConti, numeroColunas);
            if (records.length() == 1) {
				
				
                JSONObject record = records.optJSONObject(0);
                String conta          = record.optString("CONTACONTABIL").trim();              
				
				
				String contaAnalitica = record.optString("CONTAANALITICA").trim();
                String descricaoPlano = record.optString("DESCRICAOPLANO").trim();
                chaveIoPessoa = codEmpresa + nomeConti;
                if (tipoLancamento.equals("PAGAR")) {
                    if (conta != null && conta.trim().length() > 0) {
                        logger.logDebug(">>> Achou a conta pelo 2o PASSO");
                        ret.put("contaDebito", conta);
                        ret.put("cnpjIOPessoa", "");
                        ret.put("nomePessoa", nomeConti);
                        ret.put("classificacao", contaAnalitica);
                        ret.put("descricaoPlano", descricaoPlano);
                        return ret;
                    }
                } else {
                    if (conta != null && conta.trim().length() > 0) {
                        logger.logDebug(">>> Achou a conta pelo 2o PASSO");
                        ret.put("contaCredito", conta);
                        ret.put("cnpjIOPessoa", "");
                        ret.put("nomePessoa", nomeConti);
                        ret.put("classificacao", contaAnalitica);
                        ret.put("descricaoPlano", descricaoPlano);
                        return ret;
                    }
                }
            }

            if (!nomePessoa.equals("")) {
                nomeConti = "";
                nomeConti = geraNomeContinuo(nomePessoa);
                records = findPessoaPorPlanoContas(dbIOCont, codEmpresa, nomeConti, numeroColunas);
                if (records.length() == 1) {
                    JSONObject record = records.optJSONObject(0);
                    String conta    = record.optString("CONTACONTABIL").trim();
                    chaveIoPessoa = codEmpresa + nomeConti;
                    if (tipoLancamento.equals("PAGAR")) {
                        if (conta != null && conta.trim().length() > 0) {
                            logger.logDebug(">>> Achou a conta pelo 2o PASSO");
                            ret.put("contaDebito", conta);
                            ret.put("cnpjIOPessoa", "");
                            ret.put("nomePessoa", nomeConti);
                            return ret;
                        }
                    } else {
                        if (conta != null && conta.trim().length() > 0) {
                            logger.logDebug(">>> Achou a conta pelo 2o PASSO");
                            ret.put("contaCredito", conta);
                            ret.put("cnpjIOPessoa", "");
                            ret.put("nomePessoa", nomeConti);
                            return ret;
                        }
                    }
                }
            }

        }
    } catch (Exception e2oPasso) {
        logger.logError("EndpointB: ERROR BUSCA PLANO CONTA - 2.1o PASSO", e2oPasso);
    }

    //------------------------------------------------------------------------------//
    // 3o PASSO - Busca a CONTA CONTABIL no IO_CONTA pelo NOME DO FORNECEDOR.       //
    //------------------------------------------------------------------------------//
    logger.logDebug(">>> 3o Passo");
    String contaCli = "";
    String contaFor = "";
    String chaveIoConta = "";
    nomePessoa = "";
    String nomeLike = "";
    String nomeOrigem = "";
    String cnpjIOPessoa = "";

    try {
        records = findContaPorNomePessoa(dbIOCont, codEmpresa, nomeFornecedor, false, fornecedorUnico);
        if (records.length() > 0) {
            JSONObject rec = records.optJSONObject(0);
            contaCli = rec.optString("CONTACTBCLI").trim();
            contaFor = rec.optString("CONTACTBFOR").trim();
            cpfCnpj = rec.optString("CPFCNPJ").trim();
            cnpjIOPessoa = rec.optString("CPFCNPJ").trim();
            chaveIoPessoa = codEmpresa + nomeFornecedor + cnpjIOPessoa;
            chaveIoConta = rec.optString("CHAVE").trim();
            nomePessoa = rec.optString("NOMEPESSOA").trim();
            if (tipoLancamento.equals("PAGAR")) {
                ret.put("contaDebito", contaFor);
            } else {
                ret.put("contaCredito", contaCli);
            }
            ret.put("cnpjIOPessoa", cnpjIOPessoa);
            ret.put("nomePessoa", nomePessoa);
            ret.put("nomeOrigem", nomePessoa);
            logger.logDebug(">>> Achou um fornecedor pelo 3o Passo. " + contaFor);
        }
    } catch (Exception e3oPasso) {
        logger.logError("EndpointB: ERROR BUSCA CONTA - 3o PASSO", e3oPasso);
    }

    //-----------------------------------------------------------------------------------------------------//
    // Gravar o IO_PESSOA com o relacionamento com o IO_CONTA.                                             //
    //-----------------------------------------------------------------------------------------------------//
    if ((contaFor != null && contaFor.trim().length() > 0) || (contaCli != null && contaCli.trim().length() > 0)) {

        if (hasPessoa(dbIOCont, chaveIoPessoa)) {
            try {
                updatePessoa(dbIOCont, codEmpresa, nomeFornecedor, nomePessoa, cpfCnpj, contaCli,
                             contaFor, chaveIoConta, chaveIoPessoa);
            } catch (Exception eUpdateIOPessoa) {
                logger.logError("EndpointB: ERROR UPDATE IO_PESSOA", eUpdateIOPessoa);
            }
        } else {
            try {
                insertPessoa(dbIOCont, codEmpresa, nomeFornecedor, nomePessoa, cpfCnpj, contaCli,
                             contaFor, chaveIoConta, chaveIoPessoa, fornecedorUnico);
            } catch (Exception eInsertIOPessoa) {
                logger.logError("EndpointB: ERROR INSERT IO_PESSOA", eInsertIOPessoa);
            }
        }
        if (tipoLancamento.equals("PAGAR")) {
            logger.logDebug(">>> Achou a conta pelo 3o PASSO. " + contaFor);
            ret.put("contaDebito", contaFor);
            ret.put("nomePessoa", nomePessoa);
            ret.put("nomeOrigem", nomePessoa);
            return ret;
        } else {
            logger.logDebug(">>> Achou a conta pelo 3o PASSO. " + contaCli);
            ret.put("contaCredito", contaCli);
            ret.put("nomePessoa", nomePessoa);
            ret.put("nomeOrigem", nomePessoa);
            return ret;
        }
    }

    //----------------------------------------------------------------------------------------------------//
    // 4o PASSO - Busca a CONTA CONTABIL no IO_CONTA pelos 20 primeiros caracteres do NOME DO FORNECEDOR. //
    //----------------------------------------------------------------------------------------------------//

    String codOrigem = "Sugerido";
    int tamanho = nomeFornecedor.trim().length();
    if (tamanho > 50) {
        nomeLike = nomeFornecedor.substring(0, 50) + "%";
    } else {
        nomeLike = nomeFornecedor.substring(0, tamanho) + "%";
    }
    try {
        records = findContaPorNomePessoa(dbIOCont, codEmpresa, nomeLike, true, fornecedorUnico);
        if (records.length() > 0) {
            JSONObject rec = records.optJSONObject(0);
            contaCli = rec.optString("CONTACTBCLI").trim();
            contaFor = rec.optString("CONTACTBFOR").trim();
            cpfCnpj = rec.optString("CPFCNPJ").trim();
            cnpjIOPessoa = rec.optString("CPFCNPJ").trim();
            chaveIoPessoa = codEmpresa + nomeFornecedor + cnpjIOPessoa;
            chaveIoConta = rec.optString("CHAVE").trim();
            nomePessoa = rec.optString("NOMEPESSOA").trim();
            if (tipoLancamento.equals("PAGAR")) {
                ret.put("contaDebito", contaFor);
            } else {
                ret.put("contaCredito", contaCli);
            }
            ret.put("cnpjIOPessoa", cnpjIOPessoa);
            ret.put("nomePessoa", nomePessoa);
            ret.put("nomeOrigem", nomePessoa);
            logger.logDebug(">>> Achou um fornecedor pelo 4o PASSO. " + contaFor);
        }
    } catch (Exception e4oPasso) {
        logger.logError("EndpointB: ERROR BUSCA CONTA - 4o PASSO", e4oPasso);
    }

    //-----------------------------------------------------------------------------------------------------//
    // Gravar o IO_PESSOA com o relacionamento com o IO_CONTA.                                             //
    //-----------------------------------------------------------------------------------------------------//
    if ((contaFor != null && contaFor.trim().length() > 0) || (contaCli != null && contaCli.trim().length() > 0)) {

        if (hasPessoa(dbIOCont, chaveIoPessoa)) {
            try {
                updatePessoa(dbIOCont, codEmpresa, nomeFornecedor, nomePessoa, cpfCnpj, contaCli,
                             contaFor, chaveIoConta, chaveIoPessoa);
            } catch (Exception eUpdateIOPessoa) {
                logger.logError("EndpointB: ERROR UPDATE IO_PESSOA ", eUpdateIOPessoa);
            }
        } else {
            try {
                insertPessoa(dbIOCont, codEmpresa, nomeFornecedor, nomePessoa, cpfCnpj, contaCli,
                             contaFor, chaveIoConta, chaveIoPessoa, fornecedorUnico);
            }
            catch (Exception eInsertIOPessoa) {
                logger.logError("EndpointB: ERROR INSERT IO_PESSOA ", eInsertIOPessoa);
            }
        }
        if (tipoLancamento.equals("PAGAR")) {
            logger.logDebug(">>> Achou a conta pelo 4o PASSO. " + contaFor);
            ret.put("contaDebito", contaFor);
            ret.put("contaSugerida", true);
            return ret;
        } else {
            logger.logDebug(">>> Achou a conta pelo 4o PASSO. " + contaCli);
            ret.put("contaCredito", contaCli);
            ret.put("contaSugerida", true);
            return ret;
        }
    }

    //-----------------------------------------------------------------------------------------------------//
    // 5o PASSO - Busca a CONTA CONTABIL no IO_PESSOA pelos 20 primeiros caracteres do NOME DO FORNECEDOR. //
    //-----------------------------------------------------------------------------------------------------//

    try {
        records = findPessoaPorEmpresaNomeOrigem(dbIOCont, codEmpresa, nomeLike, true);
        if (records.length() > 0) {
            JSONObject rec = records.optJSONObject(0);
            contaFor = rec.optString("CONTACTBFOR".trim());
            contaCli = rec.optString("CONTACTBCLI").trim();
            cnpjIOPessoa = rec.optString("CPFCNPJ").trim();
            chaveIoPessoa = codEmpresa + nomeFornecedor + cnpjIOPessoa;
            if (tipoLancamento.equals("PAGAR")) {
                if (contaFor != null && contaFor.trim().length() > 0) {
                    logger.logDebug(">>> Achou a conta pelo 5o PASSO. " + contaFor);
                    ret.put("contaDebito", contaFor);
                    ret.put("contaSugerida", true);
                    ret.put("cnpjIOPessoa", cnpjIOPessoa);
                    return ret;
                }
            } else {
                if (contaCli != null && contaCli.trim().length() > 0) {
                    logger.logDebug(">>> Achou a conta pelo 5o PASSO. " + contaCli);
                    ret.put("contaCredito", contaCli);
                    ret.put("contaSugerida", true);
                    ret.put("cnpjIOPessoa", cnpjIOPessoa);
                    return ret;
                }
            }

        }
    } catch (Exception e5oPasso) {
        logger.logError("EndpointB: ERROR BUSCA CONTA - 5o PASSO ", e5oPasso);
    }

    //-----------------------------------------------------------------------------------------------------//
    // Gravar o IO_PESSOA sem o relacionamento com o IO_CONTA para listar no DeParaFornecedores.           //
    //-----------------------------------------------------------------------------------------------------//
    logger.logDebug(">>> Atualiza IO_PESSOA sem relacionamento com IO_CONTA.");
    if (cpfCnpj == null || cpfCnpj.trim().length() == 0) {
        cpfCnpj = cnpjIOPessoa;
    }
    if (hasPessoa(dbIOCont, chaveIoPessoa)) {
        try {
            updatePessoa(dbIOCont, codEmpresa, nomeFornecedor, nomePessoa, cpfCnpj, "", "", "", chaveIoPessoa);
        } catch (Exception eUpdateIOPessoa) {
            logger.logError("EndpointB: ERROR UPDATE IO_PESSOA", eUpdateIOPessoa);
        }
    } else {
        try {
            insertPessoa(dbIOCont, codEmpresa, nomeFornecedor, nomePessoa, cpfCnpj, "", "", "", chaveIoPessoa, fornecedorUnico);
        }
        catch (Exception eInsertIOPessoa) {
            logger.logError("EndpointB: ERROR INSERT IO_PESSOA", eInsertIOPessoa);
        }
    }


    logger.logDebug(">>> Nao achou a conta");
    return ret;
}


private JSONObject buscaContaNovo(String codEmpresa, String nomeFornecedor,
                              String cpfCnpj, String classificacao, String tipoLancamento, InoutLogger logger,
                              DataBase dbIOCont) throws Exception {

    JSONObject ret = new JSONObject();
    Calendar c = Calendar.getInstance();
    if (tipoLancamento.equals("PAGAR")) {
        ret.put("contaDebito", "");
    } else {
        ret.put("contaCredito", "");
    }
    ret.put("contaSugerida", false);
    ret.put("cnpjIOPessoa", "");

    if (nomeFornecedor == null || nomeFornecedor.trim().length() == 0 ||
        codEmpresa == null || codEmpresa.trim().length() == 0) {
        return ret;

    }
    if (nomeFornecedor.length() > 170) nomeFornecedor = nomeFornecedor.substring(0,170).trim();

    String nomeCont = getNomeContabilidade();
	String empresaProp = INOUT_ROUTE_ID.substring(INOUT_ROUTE_ID.indexOf(".")+1);
    empresaProp = empresaProp.substring(0, empresaProp.indexOf("_")).toUpperCase();


    if (empresaProp.equals(getNomeContabilidade().toUpperCase())) {
        SysProperties prop = SysProperties.getInstance();
        prop.load("contabil/" + getNomeContabilidade() + "/empresa.properties");
        nomeCont = prop.get("NOME_CONTABILIDADE").toUpperCase();
    }
	

    nomeCont = nomeCont.replaceAll("DePara","").trim();
    SysProperties propriedades = SysProperties.getInstance();
    propriedades.load("contabil/" + nomeCont + "/contabil.properties");
    String fornecedorUnico = propriedades.get("FORNECEDOR_UNICO");
    JSONArray records = null;

    logger.logDebug(">>> Empresa: " + codEmpresa + " Fornecedor: " + nomeFornecedor + " CNPJ: " + cpfCnpj);
	
	 // numero de colunas para buscar fornecedor.
	String stringColunas = "";
	int    numeroColunas = 0;
	
	try {
		stringColunas = propriedades.get(codEmpresa + "_NUMERO_COLUNAS");
		numeroColunas = Integer.parseInt(stringColunas);
	}
	 catch (Exception xx) { numeroColunas = 0; }

    // Monta o campo IO_PESSOA.CHAVE
    String chaveIoPessoa = codEmpresa + nomeFornecedor + cpfCnpj;
    logger.logDebug(">>> Chave IO_PESSOA: " + chaveIoPessoa);
    //------------------------------------------------------------------------------//
    // 1o PASSO - Busca a CONTA CONTABIL no IO_PESSOA pelo CPFCNPJ.                 //
    //------------------------------------------------------------------------------//

    String nomePessoa = "";
    if (cpfCnpj != null && cpfCnpj.trim().length() > 0) {

        try {
            records = findPessoaPorEmpresaCnpj(dbIOCont, codEmpresa, cpfCnpj);  // retirado 17.09 para ver performance
            if (records.length() > 0) {
                JSONObject rec = records.optJSONObject(0);
                String contaFor = rec.optString("CONTACTBFOR").trim();
                String contaCli = rec.optString("CONTACTBCLI").trim();
                String nomeOrigem = rec.optString("NOMEORIGEM").trim();
                nomePessoa = rec.optString("NOMEPESSOA").trim();
                if (tipoLancamento.equals("PAGAR")) {
                    if (contaFor != null && contaFor.trim().length() > 0) {
                        logger.logDebug(">>> Achou a conta pelo 1o PASSO");
                        ret.put("contaDebito", contaFor);
                        ret.put("nomeOrigem", nomeOrigem);
                        ret.put("nomePessoa", nomePessoa);
                        return ret;
                    }


                } else {
                    if (contaCli != null && contaCli.trim().length() > 0) {
                        logger.logDebug(">>> Achou a conta pelo 1o PASSO");
                        ret.put("contaCredito", contaCli);
                        ret.put("nomeOrigem", nomeOrigem);
                        ret.put("nomePessoa", nomePessoa);
                        return ret;
                    }

                }
            }
        } catch (Exception e1oPasso) {
            logger.logError("EndpointB: ERROR BUSCA CONTA - 1o PASSO", e1oPasso);
        }
    }

    //------------------------------------------------------------------------------//
    // 2o PASSO - Busca a CONTA CONTABIL no IO_PESSOA e IO_CONTA pelo NOME ORIGEM.  //
    //------------------------------------------------------------------------------//
    logger.logDebug(">>> 2o Passo");
    try {
        records = findPessoaPorEmpresaNomeOrigem(dbIOCont, codEmpresa, nomeFornecedor, false);
        if (records.length() > 0) {
            JSONObject record = records.optJSONObject(0);
            String contaFor = record.optString("CONTACTBFOR").trim();
            String contaCli = record.optString("CONTACTBCLI").trim();
            nomePessoa = record.optString("NOMEPESSOA").trim();
            String cnpjIOPessoa = record.optString("CPFCNPJ").trim();
            chaveIoPessoa = codEmpresa + nomeFornecedor + cnpjIOPessoa;
            if (tipoLancamento.equals("PAGAR")) {
                if (contaFor != null && contaFor.trim().length() > 0) {
                    logger.logDebug(">>> Achou a conta pelo 2o PASSO");
                    ret.put("contaDebito", contaFor);
                    ret.put("cnpjIOPessoa", cnpjIOPessoa);
                    ret.put("nomePessoa", nomePessoa);
                    ret.put("nomeOrigem", nomePessoa);
                    if (contaCli != null && contaCli.trim().length() > 0) ret.put("contaCredito", contaCli);
                    return ret;
                }
            } else {
                if (contaCli != null && contaCli.trim().length() > 0) {
                    logger.logDebug(">>> Achou a conta pelo 2o PASSO");
                    ret.put("contaCredito", contaCli);
                    ret.put("cnpjIOPessoa", cnpjIOPessoa);
                    ret.put("nomePessoa", nomePessoa);
                    ret.put("nomeOrigem", nomePessoa);
                    return ret;
                }
            }
        }
    } catch (Exception e2oPasso) {
        logger.logError("EndpointB: ERROR BUSCA CONTA - 2o PASSO", e2oPasso);
    }


    //------------------------------------------------------------------------------//
    // 2.1o PASSO - Busca a CONTA CONTABIL np plano de contas pelo nome da Planilha //
    //------------------------------------------------------------------------------//
    logger.logDebug(">>> 2.1o Passo");
    try {

        // ignora pois quando vem o portador no nome do fornececedor, nao podemos sugerir a conta
        if (!nomeFornecedor.contains("BANCO")     && !nomeFornecedor.contains("SICRED")   && !nomeFornecedor.contains("SANTANDER") &&
            !nomeFornecedor.contains("DO BRASIL") && !nomeFornecedor.contains("ITAU")     && !nomeFornecedor.contains("BRADESCO") &&
            !nomeFornecedor.contains("CAIXA")     && !nomeFornecedor.contains("CEF")      && !nomeFornecedor.contains("BESC") &&
            !nomeFornecedor.contains("HSBC")      && !nomeFornecedor.contains("UNIBANCO") && !nomeFornecedor.contains("SAFRA") &&
            !nomeFornecedor.contains("UNICRED")   && !nomeFornecedor.contains("BANRISUL") && !nomeFornecedor.contains("SUDAMERIS") &&
            !nomeFornecedor.contains("PREFEITURA") && !nomePessoa.contains("PREFEITURA") &&
            !nomePessoa.contains("BANCO")     && !nomePessoa.contains("SICRED")   && !nomePessoa.contains("SANTANDER") &&
            !nomePessoa.contains("DO BRASIL") && !nomePessoa.contains("ITAU")     && !nomePessoa.contains("BRADESCO") &&
            !nomePessoa.contains("CAIXA")     && !nomePessoa.contains("CEF")      && !nomePessoa.contains("BESC") &&
            !nomePessoa.contains("HSBC")      && !nomePessoa.contains("UNIBANCO") && !nomePessoa.contains("SAFRA") &&
            !nomePessoa.contains("UNICRED")   && !nomePessoa.contains("BANRISUL") && !nomePessoa.contains("SUDAMERIS")) {

            String nomeConti = "";
            nomeConti = geraNomeContinuo(nomeFornecedor);
            records = findPessoaPorPlanoContasNovo(dbIOCont, codEmpresa, nomeConti, classificacao, numeroColunas);
			
			if (records.length() == 1) {
                JSONObject record = records.optJSONObject(0);
                String conta          = record.optString("CONTACONTABIL").trim();
				
 

                String contaAnalitica = record.optString("CONTAANALITICA").trim();
                String descricaoPlano = record.optString("DESCRICAOPLANO").trim();
                chaveIoPessoa = codEmpresa + nomeConti;
                if (tipoLancamento.equals("PAGAR")) {
                    if (conta != null && conta.trim().length() > 0) {
                        logger.logDebug(">>> Achou a conta pelo 2o PASSO");
                        ret.put("contaDebito", conta);
                        ret.put("cnpjIOPessoa", "");
                        ret.put("nomePessoa", nomeConti);
                        ret.put("classificacao", contaAnalitica);
                        ret.put("descricaoPlano", descricaoPlano);
                        return ret;
                    }
                } else {
                    if (conta != null && conta.trim().length() > 0) {
                        logger.logDebug(">>> Achou a conta pelo 2o PASSO");
                        ret.put("contaCredito", conta);
                        ret.put("cnpjIOPessoa", "");
                        ret.put("nomePessoa", nomeConti);
                        ret.put("classificacao", contaAnalitica);
                        ret.put("descricaoPlano", descricaoPlano);
                        return ret;
                    }
                }
            }

            if (!nomePessoa.equals("")) {
                nomeConti = "";
                nomeConti = geraNomeContinuo(nomePessoa);
                records = findPessoaPorPlanoContasNovo(dbIOCont, codEmpresa, nomeConti, classificacao, numeroColunas);
                if (records.length() == 1) {
                    JSONObject record = records.optJSONObject(0);
                    String conta    = record.optString("CONTACONTABIL").trim();
	
 
                    chaveIoPessoa = codEmpresa + nomeConti;
                    if (tipoLancamento.equals("PAGAR")) {
                        if (conta != null && conta.trim().length() > 0) {
                            logger.logDebug(">>> Achou a conta pelo 2o PASSO");
                            ret.put("contaDebito", conta);
                            ret.put("cnpjIOPessoa", "");
                            ret.put("nomePessoa", nomeConti);
                            return ret;
                        }
                    } else {
                        if (conta != null && conta.trim().length() > 0) {
                            logger.logDebug(">>> Achou a conta pelo 2o PASSO");
                            ret.put("contaCredito", conta);
                            ret.put("cnpjIOPessoa", "");
                            ret.put("nomePessoa", nomeConti);
                            return ret;
                        }
                    }
                }
            }


			/*
            if (records != null && records.length() > 0) {
                List resultados = new ArrayList();
                JSONObject result = new JSONObject();
                ttMemoria ttM = null;
                
                for(int i = 0; i < records.length(); i++){   
                    ttM = new ttMemoria();
                    result = records.optJSONObject(i);
                    ttM.memoria = calculate(nomeConti, result.optString("DESCRICAOCONTINUA")); // levenshtein distance
                    resultados.add(ttM);
                }
                int memoria = 1000000000;
                int alvo = 1000000000;
                boolean f = false;
                for(int t = 0; t < resultados.size(); t++){
                    ttMemoria m = (ttMemoria)resultados.get(t);
                    if(m.memoria <= memoria){
                        alvo = t;
                        f = false;
                        if(memoria == m.memoria) f = true;
                        memoria = m.memoria;
                    }
                }
                double tamanho = records.optJSONObject(alvo).optString("DESCRICAOCONTINUA").length();
                double calibragem = Math.floor(tamanho * 0.125);

                if((!f && memoria <= calibragem) || (true)) { // magia  cax
                    JSONObject record = records.optJSONObject(alvo);
                    String conta          = record.optString("CONTACONTABIL").trim();
                    String contaAnalitica = record.optString("CONTAANALITICA").trim();
                    String descricaoPlano = record.optString("DESCRICAOPLANO").trim();
                    chaveIoPessoa = codEmpresa + nomeConti;
                    if (tipoLancamento.equals("PAGAR")) {
                        if (conta != null && conta.trim().length() > 0) {
                            logger.logDebug(">>> Achou a conta pelo 2o PASSO");
                            ret.put("contaDebito", conta);
                            ret.put("cnpjIOPessoa", "");
                            ret.put("nomePessoa", nomeConti);
                            ret.put("classificacao", contaAnalitica);
                            ret.put("descricaoPlano", descricaoPlano);
                            return ret;
                        }
                    } else {
                        if (conta != null && conta.trim().length() > 0) {
                            logger.logDebug(">>> Achou a conta pelo 2o PASSO");
                            ret.put("contaCredito", conta);
                            ret.put("cnpjIOPessoa", "");
                            ret.put("nomePessoa", nomeConti);
                            ret.put("classificacao", contaAnalitica);
                            ret.put("descricaoPlano", descricaoPlano);
                            return ret;
                        }
                    }
                } 
                
            }
			
			

            if (!nomePessoa.equals("")) {
                nomeConti = "";
                nomeConti = geraNomeContinuo(nomePessoa);
                records = findPessoaPorPlanoContasNovo(dbIOCont, codEmpresa, nomeConti, classificacao, numeroColunas);
                if (records != null && records.length() > 0) {
                    List resultados = new ArrayList();
                    JSONObject result = new JSONObject();
                    ttMemoria ttM = null;
                    
                    for(int i = 0; i < records.length(); i++){   
                        ttM = new ttMemoria();
                        result = records.optJSONObject(i);
                        ttM.memoria = calculate(nomeConti, result.optString("DESCRICAOCONTINUA")); // levenshtein distance
                        resultados.add(ttM);
                    }
                    int memoria = 1000000000;
                    int alvo = 1000000000;
                    boolean f = false;
                    for(int t = 0; t < resultados.size(); t++){
                        ttMemoria m = (ttMemoria)resultados.get(t);
                        if(m.memoria <= memoria){
                            alvo = t;
                            f = false;
                            if(memoria == m.memoria) f = true;
                            memoria = m.memoria;
                        }
                    }
                    double tamanho = records.optJSONObject(alvo).optString("DESCRICAOCONTINUA").length();
                    double calibragem = Math.floor((tamanho / 85) * tamanho);

					if((!f && memoria <= calibragem) || (true)) { // magia  cax
					
                        JSONObject record = records.optJSONObject(0);
                        String conta    = record.optString("CONTACONTABIL").trim();
                        chaveIoPessoa = codEmpresa + nomeConti;
                        if (tipoLancamento.equals("PAGAR")) {
                            if (conta != null && conta.trim().length() > 0) {
                                logger.logDebug(">>> Achou a conta pelo 2o PASSO");
                                ret.put("contaDebito", conta);
                                ret.put("cnpjIOPessoa", "");
                                ret.put("nomePessoa", nomeConti);
                                return ret;
                            }
                        } else {
                            if (conta != null && conta.trim().length() > 0) {
                                logger.logDebug(">>> Achou a conta pelo 2o PASSO");
                                ret.put("contaCredito", conta);
                                ret.put("cnpjIOPessoa", "");
                                ret.put("nomePessoa", nomeConti);
                                return ret;
                            }
                        }
                    }
                
				}
				
				
            } */

        }
    } catch (Exception e2oPasso) {
        logger.logError("EndpointB: ERROR BUSCA PLANO CONTA - 2.1o PASSO", e2oPasso);
    }

    //------------------------------------------------------------------------------//
    // 3o PASSO - Busca a CONTA CONTABIL no IO_CONTA pelo NOME DO FORNECEDOR.       //
    //------------------------------------------------------------------------------//
    logger.logDebug(">>> 3o Passo");
    String contaCli = "";
    String contaFor = "";
    String chaveIoConta = "";
    nomePessoa = "";
    String nomeLike = "";
    String nomeOrigem = "";
    String cnpjIOPessoa = "";

    try {
        records = findContaPorNomePessoa(dbIOCont, codEmpresa, nomeFornecedor, false, fornecedorUnico);
        if (records.length() > 0) {
            JSONObject rec = records.optJSONObject(0);
            contaCli = rec.optString("CONTACTBCLI").trim();
            contaFor = rec.optString("CONTACTBFOR").trim();
            cpfCnpj = rec.optString("CPFCNPJ").trim();
            cnpjIOPessoa = rec.optString("CPFCNPJ").trim();
            chaveIoPessoa = codEmpresa + nomeFornecedor + cnpjIOPessoa;
            chaveIoConta = rec.optString("CHAVE").trim();
            nomePessoa = rec.optString("NOMEPESSOA").trim();
            if (tipoLancamento.equals("PAGAR")) {
                ret.put("contaDebito", contaFor);
            } else {
                ret.put("contaCredito", contaCli);
            }
            ret.put("cnpjIOPessoa", cnpjIOPessoa);
            ret.put("nomePessoa", nomePessoa);
            ret.put("nomeOrigem", nomePessoa);
            logger.logDebug(">>> Achou um fornecedor pelo 3o Passo. " + contaFor);
        }
    } catch (Exception e3oPasso) {
        logger.logError("EndpointB: ERROR BUSCA CONTA - 3o PASSO", e3oPasso);
    }

    //-----------------------------------------------------------------------------------------------------//
    // Gravar o IO_PESSOA com o relacionamento com o IO_CONTA.                                             //
    //-----------------------------------------------------------------------------------------------------//
    if ((contaFor != null && contaFor.trim().length() > 0) || (contaCli != null && contaCli.trim().length() > 0)) {

        if (hasPessoa(dbIOCont, chaveIoPessoa)) {
            try {
                updatePessoa(dbIOCont, codEmpresa, nomeFornecedor, nomePessoa, cpfCnpj, contaCli,
                             contaFor, chaveIoConta, chaveIoPessoa);
            } catch (Exception eUpdateIOPessoa) {
                logger.logError("EndpointB: ERROR UPDATE IO_PESSOA", eUpdateIOPessoa);
            }
        } else {
            try {
                insertPessoa(dbIOCont, codEmpresa, nomeFornecedor, nomePessoa, cpfCnpj, contaCli,
                             contaFor, chaveIoConta, chaveIoPessoa, fornecedorUnico);
            } catch (Exception eInsertIOPessoa) {
                logger.logError("EndpointB: ERROR INSERT IO_PESSOA", eInsertIOPessoa);
            }
        }
        if (tipoLancamento.equals("PAGAR")) {
            logger.logDebug(">>> Achou a conta pelo 3o PASSO. " + contaFor);
            ret.put("contaDebito", contaFor);
            ret.put("nomePessoa", nomePessoa);
            ret.put("nomeOrigem", nomePessoa);
            return ret;
        } else {
            logger.logDebug(">>> Achou a conta pelo 3o PASSO. " + contaCli);
            ret.put("contaCredito", contaCli);
            ret.put("nomePessoa", nomePessoa);
            ret.put("nomeOrigem", nomePessoa);
            return ret;
        }
    }

    //----------------------------------------------------------------------------------------------------//
    // 4o PASSO - Busca a CONTA CONTABIL no IO_CONTA pelos 20 primeiros caracteres do NOME DO FORNECEDOR. //
    //----------------------------------------------------------------------------------------------------//

    String codOrigem = "Sugerido";
    int tamanho = nomeFornecedor.trim().length();
    if (tamanho > 50) {
        nomeLike = nomeFornecedor.substring(0, 50) + "%";
    } else {
        nomeLike = nomeFornecedor.substring(0, tamanho) + "%";
    }
    try {
        records = findContaPorNomePessoa(dbIOCont, codEmpresa, nomeLike, true, fornecedorUnico);
        if (records.length() > 0) {
            JSONObject rec = records.optJSONObject(0);
            contaCli = rec.optString("CONTACTBCLI").trim();
            contaFor = rec.optString("CONTACTBFOR").trim();
            cpfCnpj = rec.optString("CPFCNPJ").trim();
            cnpjIOPessoa = rec.optString("CPFCNPJ").trim();
            chaveIoPessoa = codEmpresa + nomeFornecedor + cnpjIOPessoa;
            chaveIoConta = rec.optString("CHAVE").trim();
            nomePessoa = rec.optString("NOMEPESSOA").trim();
            if (tipoLancamento.equals("PAGAR")) {
                ret.put("contaDebito", contaFor);
            } else {
                ret.put("contaCredito", contaCli);
            }
            ret.put("cnpjIOPessoa", cnpjIOPessoa);
            ret.put("nomePessoa", nomePessoa);
            ret.put("nomeOrigem", nomePessoa);
            logger.logDebug(">>> Achou um fornecedor pelo 4o PASSO. " + contaFor);
        }
    } catch (Exception e4oPasso) {
        logger.logError("EndpointB: ERROR BUSCA CONTA - 4o PASSO", e4oPasso);
    }

    //-----------------------------------------------------------------------------------------------------//
    // Gravar o IO_PESSOA com o relacionamento com o IO_CONTA.                                             //
    //-----------------------------------------------------------------------------------------------------//
    if ((contaFor != null && contaFor.trim().length() > 0) || (contaCli != null && contaCli.trim().length() > 0)) {

        if (hasPessoa(dbIOCont, chaveIoPessoa)) {
            try {
                updatePessoa(dbIOCont, codEmpresa, nomeFornecedor, nomePessoa, cpfCnpj, contaCli,
                             contaFor, chaveIoConta, chaveIoPessoa);
            } catch (Exception eUpdateIOPessoa) {
                logger.logError("EndpointB: ERROR UPDATE IO_PESSOA ", eUpdateIOPessoa);
            }
        } else {
            try {
                insertPessoa(dbIOCont, codEmpresa, nomeFornecedor, nomePessoa, cpfCnpj, contaCli,
                             contaFor, chaveIoConta, chaveIoPessoa, fornecedorUnico);
            }
            catch (Exception eInsertIOPessoa) {
                logger.logError("EndpointB: ERROR INSERT IO_PESSOA ", eInsertIOPessoa);
            }
        }
        if (tipoLancamento.equals("PAGAR")) {
            logger.logDebug(">>> Achou a conta pelo 4o PASSO. " + contaFor);
            ret.put("contaDebito", contaFor);
            ret.put("contaSugerida", true);
            return ret;
        } else {
            logger.logDebug(">>> Achou a conta pelo 4o PASSO. " + contaCli);
            ret.put("contaCredito", contaCli);
            ret.put("contaSugerida", true);
            return ret;
        }
    }

    //-----------------------------------------------------------------------------------------------------//
    // 5o PASSO - Busca a CONTA CONTABIL no IO_PESSOA pelos 20 primeiros caracteres do NOME DO FORNECEDOR. //
    //-----------------------------------------------------------------------------------------------------//

    try {
        records = findPessoaPorEmpresaNomeOrigem(dbIOCont, codEmpresa, nomeLike, true);
        if (records.length() > 0) {
            JSONObject rec = records.optJSONObject(0);
            contaFor = rec.optString("CONTACTBFOR".trim());
            contaCli = rec.optString("CONTACTBCLI").trim();
            cnpjIOPessoa = rec.optString("CPFCNPJ").trim();
            chaveIoPessoa = codEmpresa + nomeFornecedor + cnpjIOPessoa;
            if (tipoLancamento.equals("PAGAR")) {
                if (contaFor != null && contaFor.trim().length() > 0) {
                    logger.logDebug(">>> Achou a conta pelo 5o PASSO. " + contaFor);
                    ret.put("contaDebito", contaFor);
                    ret.put("contaSugerida", true);
                    ret.put("cnpjIOPessoa", cnpjIOPessoa);
                    return ret;
                }
            } else {
                if (contaCli != null && contaCli.trim().length() > 0) {
                    logger.logDebug(">>> Achou a conta pelo 5o PASSO. " + contaCli);
                    ret.put("contaCredito", contaCli);
                    ret.put("contaSugerida", true);
                    ret.put("cnpjIOPessoa", cnpjIOPessoa);
                    return ret;
                }
            }

        }
    } catch (Exception e5oPasso) {
        logger.logError("EndpointB: ERROR BUSCA CONTA - 5o PASSO ", e5oPasso);
    }

    //-----------------------------------------------------------------------------------------------------//
    // Gravar o IO_PESSOA sem o relacionamento com o IO_CONTA para listar no DeParaFornecedores.           //
    //-----------------------------------------------------------------------------------------------------//
    logger.logDebug(">>> Atualiza IO_PESSOA sem relacionamento com IO_CONTA.");
    if (cpfCnpj == null || cpfCnpj.trim().length() == 0) {
        cpfCnpj = cnpjIOPessoa;
    }
    if (hasPessoa(dbIOCont, chaveIoPessoa)) {
        try {
            updatePessoa(dbIOCont, codEmpresa, nomeFornecedor, nomePessoa, cpfCnpj, "", "", "", chaveIoPessoa);
        } catch (Exception eUpdateIOPessoa) {
            logger.logError("EndpointB: ERROR UPDATE IO_PESSOA", eUpdateIOPessoa);
        }
    } else {
        try {
            insertPessoa(dbIOCont, codEmpresa, nomeFornecedor, nomePessoa, cpfCnpj, "", "", "", chaveIoPessoa, fornecedorUnico);
        }
        catch (Exception eInsertIOPessoa) {
            logger.logError("EndpointB: ERROR INSERT IO_PESSOA", eInsertIOPessoa);
        }
    }


    logger.logDebug(">>> Nao achou a conta");
    return ret;
}

private JSONObject buscaContaNovo(String codEmpresa, String nomeFornecedor,
                              String cpfCnpj, String classificacao, String tipoLancamento, InoutLogger logger,
                              DataBase dbIOCont, HashMap mapaPartPlano, HashMap mapaFornecedor, JSONObject futureObject) throws Exception {
    ttCache ttC = null;
    String keyPart = "";
    JSONObject ret = new JSONObject();
    Calendar c = Calendar.getInstance();
    if (tipoLancamento.equals("PAGAR")) {
        ret.put("contaDebito", "");
    } else {
        ret.put("contaCredito", "");
    }
    ret.put("contaSugerida", false);
    ret.put("cnpjIOPessoa", "");

    if (nomeFornecedor == null || nomeFornecedor.trim().length() == 0 ||
        codEmpresa == null || codEmpresa.trim().length() == 0) {
        return ret;

    }
    if (nomeFornecedor.length() > 170) nomeFornecedor = nomeFornecedor.substring(0,170).trim();

    String nomeCont = getNomeContabilidade();
    nomeCont = nomeCont.replaceAll("DePara","").trim();
	
	String empresaProp = INOUT_ROUTE_ID.substring(INOUT_ROUTE_ID.indexOf(".")+1);
    empresaProp = empresaProp.substring(0, empresaProp.indexOf("_")).toUpperCase();


    if (empresaProp.equals(getNomeContabilidade().toUpperCase())) {
        SysProperties prop = SysProperties.getInstance();
        prop.load("contabil/" + getNomeContabilidade() + "/empresa.properties");
        nomeCont = prop.get("NOME_CONTABILIDADE").toUpperCase();
    }
	
    SysProperties propriedades = SysProperties.getInstance();
    propriedades.load("contabil/" + nomeCont + "/contabil.properties");
    String fornecedorUnico = propriedades.get("FORNECEDOR_UNICO");
    JSONArray records = null;

    logger.logDebug(">>> Empresa: " + codEmpresa + " Fornecedor: " + nomeFornecedor + " CNPJ: " + cpfCnpj);
	
	 // numero de colunas para buscar fornecedor.
	String stringColunas = "";
	int    numeroColunas = 0;
	
	try {
		stringColunas = propriedades.get(codEmpresa + "_NUMERO_COLUNAS");
		numeroColunas = Integer.parseInt(stringColunas);
	}
	 catch (Exception xx) { numeroColunas = 0; }

    // Monta o campo IO_PESSOA.CHAVE
    String chaveIoPessoa = codEmpresa + nomeFornecedor + cpfCnpj;
    logger.logDebug(">>> Chave IO_PESSOA: " + chaveIoPessoa);
    //------------------------------------------------------------------------------//
    // 1o PASSO - Busca a CONTA CONTABIL no IO_PESSOA pelo CPFCNPJ.                 //
    //------------------------------------------------------------------------------//
    String nomePessoa = "";
    ttC = (ttCache)mapaFornecedor.get(nomeFornecedor);
    if(ttC == null){
        ttC = new ttCache();
        keyPart = nomeFornecedor;
        if (cpfCnpj != null && cpfCnpj.trim().length() > 0) {
            try {
                records = findPessoaPorEmpresaCnpj(dbIOCont, codEmpresa, cpfCnpj);  // retirado 17.09 para ver performance
                if (records.length() > 0) {
                    JSONObject rec = records.optJSONObject(0);
                    String contaFor = rec.optString("CONTACTBFOR").trim();
                    String contaCli = rec.optString("CONTACTBCLI").trim();
                    String nomeOrigem = rec.optString("NOMEORIGEM").trim();
                    nomePessoa = rec.optString("NOMEPESSOA").trim();
                    if (tipoLancamento.equals("PAGAR")) {
                        if (contaFor != null && contaFor.trim().length() > 0) {
                            logger.logDebug(">>> Achou a conta pelo 1o PASSO");
                            ret.put("contaDebito", contaFor);
                            ret.put("nomeOrigem", nomeOrigem);
                            ret.put("nomePessoa", nomePessoa);
                            ttC.ret = ret;
                            mapaFornecedor.put(keyPart, ttC); // cache
							
                             return ret;
                        }


                    } else {
                        if (contaCli != null && contaCli.trim().length() > 0) {
                            logger.logDebug(">>> Achou a conta pelo 1o PASSO");
                            ret.put("contaCredito", contaCli);
                            ret.put("nomeOrigem", nomeOrigem);
                            ret.put("nomePessoa", nomePessoa);
                            ttC.ret = ret;
                            mapaFornecedor.put(keyPart, ttC); // cache
                             return ret;
                        }

                    }
                }
            } catch (Exception e1oPasso) {
                logger.logError("EndpointB: ERROR BUSCA CONTA - 1o PASSO", e1oPasso);
            }
        }

        //------------------------------------------------------------------------------//
        // 2o PASSO - Busca a CONTA CONTABIL no IO_PESSOA e IO_CONTA pelo NOME ORIGEM.  //
        //------------------------------------------------------------------------------//
        logger.logDebug(">>> 2o Passo");
        try {
            records = findPessoaPorEmpresaNomeOrigem(dbIOCont, codEmpresa, nomeFornecedor, false);
            if (records.length() > 0) {
                
                JSONObject record = records.optJSONObject(0);
                String contaFor = record.optString("CONTACTBFOR").trim();
                String contaCli = record.optString("CONTACTBCLI").trim();
                nomePessoa = record.optString("NOMEPESSOA").trim();
                String cnpjIOPessoa = record.optString("CPFCNPJ").trim();
                chaveIoPessoa = codEmpresa + nomeFornecedor + cnpjIOPessoa;
                if (tipoLancamento.equals("PAGAR")) {
                    if (contaFor != null && contaFor.trim().length() > 0) {
                        logger.logDebug(">>> Achou a conta pelo 2o PASSO");
                        ret.put("contaDebito", contaFor);
                        ret.put("cnpjIOPessoa", cnpjIOPessoa);
                        ret.put("nomePessoa", nomePessoa);
                        ret.put("nomeOrigem", nomePessoa);
                        if (contaCli != null && contaCli.trim().length() > 0) ret.put("contaCredito", contaCli);
                        ttC.ret = ret;
                        mapaFornecedor.put(keyPart, ttC); // cache
                         return ret;
                    }
                } else {
                    if (contaCli != null && contaCli.trim().length() > 0) {
                        logger.logDebug(">>> Achou a conta pelo 2o PASSO");
                        ret.put("contaCredito", contaCli);
                        ret.put("cnpjIOPessoa", cnpjIOPessoa);
                        ret.put("nomePessoa", nomePessoa);
                        ret.put("nomeOrigem", nomePessoa);
                        ttC.ret = ret;
                        mapaFornecedor.put(keyPart, ttC); // cache
                         return ret;
                    }
                }
            }
        } catch (Exception e2oPasso) {
            logger.logError("EndpointB: ERROR BUSCA CONTA - 2o PASSO", e2oPasso);
        }
    } else {
        return ttC.ret;
    }

    ttC = (ttCache)mapaPartPlano.get(geraNomeContinuo(nomeFornecedor));
    if(ttC == null){ // sem cache
        try{
            ttC = new ttCache();
            String nomeConti = geraNomeContinuo(nomeFornecedor);
            keyPart = nomeConti;
            records = findParticipante(dbIOCont, nomeConti);

            if (records != null && records.length() == 1) {
                List resultados = new ArrayList();
                JSONObject result = new JSONObject();
                ttMemoria ttM = null;
                
                for(int i = 0; i < records.length(); i++){   
                    ttM = new ttMemoria();
                    result = records.optJSONObject(i);
                    ttM.memoria = calculate(nomeConti, result.optString("NOME")); // levenshtein distance
                    resultados.add(ttM);
                }
                int memoria = 1000000000;
                int alvo = 1000000000;
                boolean f = false;
                for(int par = 0; par < resultados.size(); par++){
                    ttM = (ttMemoria)resultados.get(par);
                    if( ttM.memoria <= memoria){
                        alvo = par;
                        f = memoria == ttM.memoria ? true : false;
                        memoria = ttM.memoria;
                    }
                }
                double tamanho = records.optJSONObject(alvo).optString("NOME").length();
                double calibragem = Math.floor(tamanho * 0.125);

                if(!f && memoria <= calibragem){
                    JSONObject record = records.optJSONObject(alvo);
                    String conta = records.optJSONObject(alvo).optString("CODIGO")+ "P";      
                    if (tipoLancamento.equals("PAGAR")) {
                        if (conta != null && conta.trim().length() > 0) {
                            ret.put("contaDebito", conta);
                            ttC.ret = ret;
                            mapaPartPlano.put(keyPart, ttC); // cache 
                            return ret;
                        }
                    }else{
                        if (conta != null && conta.trim().length() > 0) {
                            ret.put("contaCredito", conta);
                            ttC.ret = ret;
                            mapaPartPlano.put(keyPart, ttC); // cache
                            return ret;
                        }
                    }
                } 
            }
        }catch(Exception e){
            logger.logError("EndpointB: ERROR BUSCA PARTICIPANTE", e);
        }

        //------------------------------------------------------------------------------//
        // 2.1o PASSO - Busca a CONTA CONTABIL np plano de contas pelo nome da Planilha //
        //------------------------------------------------------------------------------//
        logger.logDebug(">>> 2.1o Passo");
        try {

            // ignora pois quando vem o portador no nome do fornececedor, nao podemos sugerir a conta
            if (!nomeFornecedor.contains("BANCO")     && !nomeFornecedor.contains("SICRED")   && !nomeFornecedor.contains("SANTANDER") &&
                !nomeFornecedor.contains("DO BRASIL") && !nomeFornecedor.contains("ITAU")     && !nomeFornecedor.contains("BRADESCO") &&
                !nomeFornecedor.contains("CAIXA")     && !nomeFornecedor.contains("CEF")      && !nomeFornecedor.contains("BESC") &&
                !nomeFornecedor.contains("HSBC")      && !nomeFornecedor.contains("UNIBANCO") && !nomeFornecedor.contains("SAFRA") &&
                !nomeFornecedor.contains("UNICRED")   && !nomeFornecedor.contains("BANRISUL") && !nomeFornecedor.contains("SUDAMERIS") &&
                !nomeFornecedor.contains("PREFEITURA") && !nomePessoa.contains("PREFEITURA") &&
                !nomePessoa.contains("BANCO")     && !nomePessoa.contains("SICRED")   && !nomePessoa.contains("SANTANDER") &&
                !nomePessoa.contains("DO BRASIL") && !nomePessoa.contains("ITAU")     && !nomePessoa.contains("BRADESCO") &&
                !nomePessoa.contains("CAIXA")     && !nomePessoa.contains("CEF")      && !nomePessoa.contains("BESC") &&
                !nomePessoa.contains("HSBC")      && !nomePessoa.contains("UNIBANCO") && !nomePessoa.contains("SAFRA") &&
                !nomePessoa.contains("UNICRED")   && !nomePessoa.contains("BANRISUL") && !nomePessoa.contains("SUDAMERIS")) {

                String nomeConti = "";
                nomeConti = geraNomeContinuo(nomeFornecedor);
                keyPart = nomeConti;
                records = findPessoaPorPlanoContasNovo(dbIOCont, codEmpresa, nomeConti, classificacao, numeroColunas);
				
				if (records.length() == 1) {
					JSONObject record = records.optJSONObject(0);
					String conta          = record.optString("CONTACONTABIL").trim();
					String contaAnalitica = record.optString("CONTAANALITICA").trim();
					String descricaoPlano = record.optString("DESCRICAOPLANO").trim();
					chaveIoPessoa = codEmpresa + nomeConti;
					if (tipoLancamento.equals("PAGAR")) {
						if (conta != null && conta.trim().length() > 0) {
							logger.logDebug(">>> Achou a conta pelo 2o PASSO");
							ret.put("contaDebito", conta);
							ret.put("cnpjIOPessoa", "");
							ret.put("nomePessoa", nomeConti);
							ret.put("classificacao", contaAnalitica);
							ret.put("descricaoPlano", descricaoPlano);
							return ret;
						}
					} else {
						if (conta != null && conta.trim().length() > 0) {
							logger.logDebug(">>> Achou a conta pelo 2o PASSO");
							ret.put("contaCredito", conta);
							ret.put("cnpjIOPessoa", "");
							ret.put("nomePessoa", nomeConti);
							ret.put("classificacao", contaAnalitica);
							ret.put("descricaoPlano", descricaoPlano);
							return ret;
						}
					}
				}

				if (!nomePessoa.equals("")) {
					nomeConti = "";
					nomeConti = geraNomeContinuo(nomePessoa);
					records = findPessoaPorPlanoContasNovo(dbIOCont, codEmpresa, nomeConti, classificacao, numeroColunas);
					if (records.length() == 1) {
						JSONObject record = records.optJSONObject(0);
						String conta    = record.optString("CONTACONTABIL").trim();
						chaveIoPessoa = codEmpresa + nomeConti;
						if (tipoLancamento.equals("PAGAR")) {
							if (conta != null && conta.trim().length() > 0) {
								logger.logDebug(">>> Achou a conta pelo 2o PASSO");
								ret.put("contaDebito", conta);
								ret.put("cnpjIOPessoa", "");
								ret.put("nomePessoa", nomeConti);
								return ret;
							}
						} else {
							if (conta != null && conta.trim().length() > 0) {
								logger.logDebug(">>> Achou a conta pelo 2o PASSO");
								ret.put("contaCredito", conta);
								ret.put("cnpjIOPessoa", "");
								ret.put("nomePessoa", nomeConti);
								return ret;
							}
						}
					}

				}
			}
        } catch (Exception e2oPasso) {
            logger.logError("EndpointB: ERROR BUSCA PLANO CONTA - 2.1o PASSO", e2oPasso);
        }
    } else {
        return ttC.ret;
    }
    //------------------------------------------------------------------------------//
    // 3o PASSO - Busca a CONTA CONTABIL no IO_CONTA pelo NOME DO FORNECEDOR.       //
    //------------------------------------------------------------------------------//
    ttC = (ttCache)mapaFornecedor.get(nomeFornecedor);
    if(ttC == null){
        logger.logDebug(">>> 3o Passo");
        String contaCli = "";
        String contaFor = "";
        String chaveIoConta = "";
        nomePessoa = "";
        String nomeLike = "";
        String nomeOrigem = "";
        String cnpjIOPessoa = "";
        ttC = new ttCache();
        keyPart = nomeFornecedor;
        try {
            records = findContaPorNomePessoa(dbIOCont, codEmpresa, nomeFornecedor, false, fornecedorUnico);
            if (records.length() > 0) {
                JSONObject rec = records.optJSONObject(0);
                contaCli = rec.optString("CONTACTBCLI").trim();
                contaFor = rec.optString("CONTACTBFOR").trim();
                cpfCnpj = rec.optString("CPFCNPJ").trim();
                cnpjIOPessoa = rec.optString("CPFCNPJ").trim();
                chaveIoPessoa = codEmpresa + nomeFornecedor + cnpjIOPessoa;
                chaveIoConta = rec.optString("CHAVE").trim();
                nomePessoa = rec.optString("NOMEPESSOA").trim();
                if (tipoLancamento.equals("PAGAR")) {
                    ret.put("contaDebito", contaFor);
                } else {
                    ret.put("contaCredito", contaCli);
                }
                ret.put("cnpjIOPessoa", cnpjIOPessoa);
                ret.put("nomePessoa", nomePessoa);
                ret.put("nomeOrigem", nomePessoa);
                logger.logDebug(">>> Achou um fornecedor pelo 3o Passo. " + contaFor);
            }
        } catch (Exception e3oPasso) {
            logger.logError("EndpointB: ERROR BUSCA CONTA - 3o PASSO", e3oPasso);
        }

        //-----------------------------------------------------------------------------------------------------//
        // Gravar o IO_PESSOA com o relacionamento com o IO_CONTA.                                             //
        //-----------------------------------------------------------------------------------------------------//
        if ((contaFor != null && contaFor.trim().length() > 0) || (contaCli != null && contaCli.trim().length() > 0)) {

            if (hasPessoa(dbIOCont, chaveIoPessoa)) {
                try {
                    updatePessoa(dbIOCont, codEmpresa, nomeFornecedor, nomePessoa, cpfCnpj, contaCli,
                                contaFor, chaveIoConta, chaveIoPessoa);
                } catch (Exception eUpdateIOPessoa) {
                    logger.logError("EndpointB: ERROR UPDATE IO_PESSOA", eUpdateIOPessoa);
                }
            } else {
                try {
                    insertPessoa(dbIOCont, codEmpresa, nomeFornecedor, nomePessoa, cpfCnpj, contaCli,
                                contaFor, chaveIoConta, chaveIoPessoa, fornecedorUnico);
                } catch (Exception eInsertIOPessoa) {
                    logger.logError("EndpointB: ERROR INSERT IO_PESSOA", eInsertIOPessoa);
                }
            }
            if (tipoLancamento.equals("PAGAR")) {
                logger.logDebug(">>> Achou a conta pelo 3o PASSO. " + contaFor);
                ret.put("contaDebito", contaFor);
                ret.put("nomePessoa", nomePessoa);
                ret.put("nomeOrigem", nomePessoa);
                ttC.ret = ret;
                mapaPartPlano.put(keyPart, ttC);   // cache
                return ret;
            } else {
                logger.logDebug(">>> Achou a conta pelo 3o PASSO. " + contaCli);
                ret.put("contaCredito", contaCli);
                ret.put("nomePessoa", nomePessoa);
                ret.put("nomeOrigem", nomePessoa);
                ttC.ret = ret;
                mapaPartPlano.put(keyPart, ttC);   // cache
                return ret;
            }
        }

        //----------------------------------------------------------------------------------------------------//
        // 4o PASSO - Busca a CONTA CONTABIL no IO_CONTA pelos 20 primeiros caracteres do NOME DO FORNECEDOR. //
        //----------------------------------------------------------------------------------------------------//

        String codOrigem = "Sugerido";
        int tamanho = nomeFornecedor.trim().length();
        if (tamanho > 50) {
            nomeLike = nomeFornecedor.substring(0, 50) + "%";
        } else {
            nomeLike = nomeFornecedor.substring(0, tamanho) + "%";
        }
        try {
            records = findContaPorNomePessoa(dbIOCont, codEmpresa, nomeLike, true, fornecedorUnico);
            if (records.length() > 0) {
                JSONObject rec = records.optJSONObject(0);
                contaCli = rec.optString("CONTACTBCLI").trim();
                contaFor = rec.optString("CONTACTBFOR").trim();
                cpfCnpj = rec.optString("CPFCNPJ").trim();
                cnpjIOPessoa = rec.optString("CPFCNPJ").trim();
                chaveIoPessoa = codEmpresa + nomeFornecedor + cnpjIOPessoa;
                chaveIoConta = rec.optString("CHAVE").trim();
                nomePessoa = rec.optString("NOMEPESSOA").trim();
                if (tipoLancamento.equals("PAGAR")) {
                    ret.put("contaDebito", contaFor);
                } else {
                    ret.put("contaCredito", contaCli);
                }
                ret.put("cnpjIOPessoa", cnpjIOPessoa);
                ret.put("nomePessoa", nomePessoa);
                ret.put("nomeOrigem", nomePessoa);
                logger.logDebug(">>> Achou um fornecedor pelo 4o PASSO. " + contaFor);
            }
        } catch (Exception e4oPasso) {
            logger.logError("EndpointB: ERROR BUSCA CONTA - 4o PASSO", e4oPasso);
        }

        //-----------------------------------------------------------------------------------------------------//
        // Gravar o IO_PESSOA com o relacionamento com o IO_CONTA.                                             //
        //-----------------------------------------------------------------------------------------------------//
        if ((contaFor != null && contaFor.trim().length() > 0) || (contaCli != null && contaCli.trim().length() > 0)) {

            if (hasPessoa(dbIOCont, chaveIoPessoa)) {
                try {
                    updatePessoa(dbIOCont, codEmpresa, nomeFornecedor, nomePessoa, cpfCnpj, contaCli,
                                contaFor, chaveIoConta, chaveIoPessoa);
                } catch (Exception eUpdateIOPessoa) {
                    logger.logError("EndpointB: ERROR UPDATE IO_PESSOA ", eUpdateIOPessoa);
                }
            } else {
                try {
                    insertPessoa(dbIOCont, codEmpresa, nomeFornecedor, nomePessoa, cpfCnpj, contaCli,
                                contaFor, chaveIoConta, chaveIoPessoa, fornecedorUnico);
                }
                catch (Exception eInsertIOPessoa) {
                    logger.logError("EndpointB: ERROR INSERT IO_PESSOA ", eInsertIOPessoa);
                }
            }
            if (tipoLancamento.equals("PAGAR")) {
                logger.logDebug(">>> Achou a conta pelo 4o PASSO. " + contaFor);
                ret.put("contaDebito", contaFor);
                ret.put("contaSugerida", true);
                ttC.ret = ret;
                mapaPartPlano.put(keyPart, ttC);   // cache
                return ret;
            } else {
                logger.logDebug(">>> Achou a conta pelo 4o PASSO. " + contaCli);
                ret.put("contaCredito", contaCli);
                ret.put("contaSugerida", true);
                ttC.ret = ret;
                mapaPartPlano.put(keyPart, ttC);   // cache
                return ret;
            }
        }

        //-----------------------------------------------------------------------------------------------------//
        // 5o PASSO - Busca a CONTA CONTABIL no IO_PESSOA pelos 20 primeiros caracteres do NOME DO FORNECEDOR. //
        //-----------------------------------------------------------------------------------------------------//

        try {
            records = findPessoaPorEmpresaNomeOrigem(dbIOCont, codEmpresa, nomeLike, true);
            if (records.length() > 0) {
                JSONObject rec = records.optJSONObject(0);
                contaFor = rec.optString("CONTACTBFOR".trim());
                contaCli = rec.optString("CONTACTBCLI").trim();
                cnpjIOPessoa = rec.optString("CPFCNPJ").trim();
                chaveIoPessoa = codEmpresa + nomeFornecedor + cnpjIOPessoa;
                if (tipoLancamento.equals("PAGAR")) {
                    if (contaFor != null && contaFor.trim().length() > 0) {
                        logger.logDebug(">>> Achou a conta pelo 5o PASSO. " + contaFor);
                        ret.put("contaDebito", contaFor);
                        ret.put("contaSugerida", true);
                        ret.put("cnpjIOPessoa", cnpjIOPessoa);
                        ttC.ret = ret;
                        mapaPartPlano.put(keyPart, ttC);   // cache
                        return ret;
                    }
                } else {
                    if (contaCli != null && contaCli.trim().length() > 0) {
                        logger.logDebug(">>> Achou a conta pelo 5o PASSO. " + contaCli);
                        ret.put("contaCredito", contaCli);
                        ret.put("contaSugerida", true);
                        ret.put("cnpjIOPessoa", cnpjIOPessoa);
                        ttC.ret = ret;
                        mapaPartPlano.put(keyPart, ttC);   // cache
                        return ret;
                    }
                }

            }
        } catch (Exception e5oPasso) {
            logger.logError("EndpointB: ERROR BUSCA CONTA - 5o PASSO ", e5oPasso);
        }

        //-----------------------------------------------------------------------------------------------------//
        // Gravar o IO_PESSOA sem o relacionamento com o IO_CONTA para listar no DeParaFornecedores.           //
        //-----------------------------------------------------------------------------------------------------//
        logger.logDebug(">>> Atualiza IO_PESSOA sem relacionamento com IO_CONTA.");
        if (cpfCnpj == null || cpfCnpj.trim().length() == 0) {
            cpfCnpj = cnpjIOPessoa;
        }
        if (hasPessoa(dbIOCont, chaveIoPessoa)) {
            try {
                updatePessoa(dbIOCont, codEmpresa, nomeFornecedor, nomePessoa, cpfCnpj, "", "", "", chaveIoPessoa);
            } catch (Exception eUpdateIOPessoa) {
                logger.logError("EndpointB: ERROR UPDATE IO_PESSOA", eUpdateIOPessoa);
            }
        } else {
            try {
                insertPessoa(dbIOCont, codEmpresa, nomeFornecedor, nomePessoa, cpfCnpj, "", "", "", chaveIoPessoa, fornecedorUnico);
            }
            catch (Exception eInsertIOPessoa) {
                logger.logError("EndpointB: ERROR INSERT IO_PESSOA", eInsertIOPessoa);
            }
        }
    } else {
        return ttC.ret;
    }


    logger.logDebug(">>> Nao achou a conta");
    return ret;
}



class ttCache {
    public JSONObject ret;
    public ttCache(){}
    public ttCache(ttCache ttC){
        ret 	 = ttC.ret;
    }
}


class ttMemoria {
    public int memoria;
    public ttMemoria(){}
    public ttMemoria(ttMemoria ttP){
        memoria 	 = ttP.memoria;
    }
}



/* calculo da distancia de levenshtein*/
public int calculate(String x, String y) {
    int[][] dp = new int[x.length() + 1][y.length() + 1];
 
    for (int i = 0; i <= x.length(); i++) {
        for (int j = 0; j <= y.length(); j++) {
            if (i == 0) {
                dp[i][j] = j;
            }
            else if (j == 0) {
                dp[i][j] = i;
            }
            else {
                dp[i][j] = min(dp[i - 1][j - 1] 
                 + costOfSubstitution(x.charAt(i - 1), y.charAt(j - 1)), 
                  dp[i - 1][j] + 1, 
                  dp[i][j - 1] + 1);
            }
        }
    }
 
    return dp[x.length()][y.length()];
}
public int costOfSubstitution(char a, char b) {
    return a == b ? 0 : 1;
}
public int min(int... numbers) {
    return Arrays.stream(numbers)
      .min().orElse(Integer.MAX_VALUE);
}


//###############################################################################

/////////////////////////////////////////////////////////////////////////////////
// Implementa o metodo RUN dos ENDPOINTs B das rotas de importacao de planilha.
/////////////////////////////////////////////////////////////////////////////////
public void runPlanilhasEndpointB(Object dataIn, InoutLogger logger) throws Exception {

    List list = (List)dataIn;
    Calendar c = Calendar.getInstance();
	
	// gera seguranca nas conexoes com Heroku
	// Create a trust manager that does not validate certificate chains
    javax.net.ssl.TrustManager[] trustAllCerts = new javax.net.ssl.TrustManager[] {
        new javax.net.ssl.X509TrustManager(){
            public java.security.cert.X509Certificate[] getAcceptedIssuers(){ return null; }

            public void checkClientTrusted(java.security.cert.X509Certificate[] certs, String authType) { }

            public void checkServerTrusted(java.security.cert.X509Certificate[] certs, String authType) { }
        }
    };

    // Install the all-trusting trust manager
    try {
        javax.net.ssl.SSLContext sc = javax.net.ssl.SSLContext.getInstance("TLS");
        sc.init(null, trustAllCerts, new java.security.SecureRandom());
        javax.net.ssl.HttpsURLConnection.setDefaultSSLSocketFactory(sc.getSocketFactory());
    } catch (Exception e) {
        // 
    }
	
    String nomeContabilidade = getNomeContabilidade();
	//String nomeContabilidade = getNomeContabilidadeEmpresaProperties();

	logger.logDebug("CONTABILIADE " + nomeContabilidade);

    String empresa = getNomeEmpresa();

    // Carrega as propriedades
    SysProperties props = SysProperties.getInstance();
    props.load("contabil/" + nomeContabilidade + "/contabil.properties");

    logger.logDebug(">>> EndpointB: Entrada no ENDPOINT B ");

    // Conecta na Base de Dados IO_CONTABIL.
    DataBase dbIOCont = connectIOContabil(props, logger);
    if (dbIOCont == null || !dbIOCont.connectionIsValid()) {
        throw new Exception("EndpointB: Nao foi possivel conectar no BANCO IO_CONTABIL");
    }

    logger.logDebug(">>> EndpointB: Banco de dados CONECTADO ");

    String codEmp = props.get(empresa + "_COD_EMPRESA");
    String nomeEmp = props.get(empresa + "_NOME_EMPRESA");
    String ERPEmpresa = props.get("ERP_CONTABILIDADE");
    String versaoPlataforma = props.get("VERSAO_PLATAFORMA");
    String compDirName = nomeEmp + "_#" + codEmp;

    String deParaDirName = RouteEngine.INOUT_HOME + "/contabil/" + nomeContabilidade + "/" + compDirName + "/DePara";
    String emailResponsavel2 = props.get(empresa + "_EMAIL_RESPONSAVEL");
    String emailCanal = props.get("EMAIL_CANAL");
    //if (!emailCanal.equals("")) emailResponsavel2 = emailResponsavel2 + "," + emailCanal;

    String geraTudoNoDePara = "";
    try {
        geraTudoNoDePara = props.get(empresa + "_EXIBE_TUDO_NO_DEPARA");
        if (geraTudoNoDePara == null) geraTudoNoDePara = "FALSE";
    }
    catch (Exception xx) {geraTudoNoDePara = "FALSE";}


    String chavePlanilha  = "";
    String lote           = "";
    String codEmpresa     = "";
    String tipoMovimento  = "";
    String tipoLancamento = "";
    String contaDebito    = "";
    String contaCredito   = "";
    String historico      = "";
    String nomeOrigem     = "";
    String cpfCnpj        = "";
    String nomeEmpresa    = "";
    String cnpjIOPessoa   = "";
    String statusMovimento = "";
    HashMap mapaLotes = new HashMap();
	String loteFila  = "";


    try {

        for (int i=0; i<list.size(); i++) {
            // Obtem a mensagem da FILA
            FilaInout  filaInout = (FilaInout)list.get(i);
            String message = filaInout.getMessage();
            JSONObject messg = new JSONObject(message);
            // Obtem o lote.
            loteFila  = messg.optString("LOTE");

            JSONArray array = null;
            if (mapaLotes.containsKey(loteFila)) {
                // Ja tem um array para o lote
                array = (JSONArray)mapaLotes.get(loteFila);
            } else {
                // Ainda nao tem um array para o lote
                array = new JSONArray();
                mapaLotes.put(loteFila, array);
            }
            array.put(messg);
        }

        Iterator it = mapaLotes.keySet().iterator();
        while (it.hasNext()) {
            String lotekey = it.next().toString();

            JSONArray array = (JSONArray)mapaLotes.get(lotekey);

            try{
                for (int i=0; i<array.length(); i++) {

                    JSONObject msg = array.getJSONObject(i);

                    chavePlanilha  = msg.optString("CHAVE").trim();
                    lote           = msg.optString("LOTE").trim();

                    codEmpresa     = msg.optString("CODEMPRESA").trim();
                    tipoMovimento  = msg.optString("TIPOMOVIMENTO").trim();
                    tipoLancamento = msg.optString("TIPOLANCAMENTO").trim();
                    contaDebito    = msg.optString("CONTADEBITO").trim();
                    contaCredito   = msg.optString("CONTACREDITO").trim();
                    historico      = msg.optString("HISTORICO").trim();
                    cpfCnpj        = msg.optString("CPFCNPJ").trim();
                    nomeEmpresa    = msg.optString("NOMEEMPRESA").trim();
                    nomeOrigem     = msg.optString("NOMEORIGEM").trim();

					String classificacao = msg.optString("CLASSIFICACAO").trim();
					String nomeArquivo = msg.optString("NOMEARQUIVO").toUpperCase();
					String dataMovimento = msg.optString("DATAMOVIMENTO").trim();

					if (nomeArquivo.toUpperCase().contains("FILTRO_")) {
						String dataInicial = cutString(nomeArquivo.toUpperCase(), "FILTRO_", "-");
						String dataFinal   = cutString(nomeArquivo, dataInicial + "-", "_");


						if (dataInicial.length() == 6) {
							dataInicial = dataInicial.substring(4) + dataInicial.substring(2,4) + dataInicial.substring(0,2);
						}


						if (dataFinal.length() == 6) {
							dataFinal = dataFinal.substring(4) + dataFinal.substring(2,4) + dataFinal.substring(0,2);
						}


						if (dataMovimento.length() == 10) {
							String dataValidaMovimento = dataMovimento.substring(8) + dataMovimento.substring(3,5) + dataMovimento.substring(0,2);

							try {
								int intDataMovimento = Integer.parseInt(String.valueOf(dataValidaMovimento));
								int intdataInicial   = Integer.parseInt(String.valueOf(dataInicial));
								int intdataFinal = Integer.parseInt(String.valueOf(dataFinal));
								if (intDataMovimento < intdataInicial || intDataMovimento > intdataFinal) {

									continue;
								}
							} catch (Exception xx) {
								continue;
							}

						}
					}

					boolean deparaFuncional = false;
					if (lote.contains("RECEBER") && (codEmpresa.equals("222") || codEmpresa.equals("223")) && nomeContabilidade.toUpperCase().contains("FUNCIONAL")) deparaFuncional = true;

					double valorJuros = msg.optDouble("VALORJUROS");
					double valorDesconto = msg.optDouble("VALORDESCONTO");
					double valorMulta = msg.optDouble("VALORMULTA");
                    statusMovimento  =  msg.optString("STATUSMOVIMENTO").trim();

                    //if (historico.length() > 500)     historico     = historico.substring(0,500);
                    if (chavePlanilha.length() > 200) chavePlanilha = chavePlanilha.substring(0,200);
                    if (nomeOrigem.length() > 200)    nomeOrigem    = nomeOrigem.substring(0,200);

                    // =========================================================================
                    // IGNORAR FORNECEDORESE CLIENTES QUE CONTENHAM NA CONTA O TERMO IGNORAR
                    // =========================================================================
                    if (contaDebito.contains("IGNORA")) continue;
                    if (contaCredito.contains("IGNORA")) continue;

                    if (contaDebito.contains("?")) contaDebito = "PENDENTE";
                    if (contaCredito.contains("?")) contaCredito = "PENDENTE";

                   /* 20180607 
				   if (ERPEmpresa.contains("SCI UNICO") && !nomeContabilidade.toUpperCase().contains("FISCONTALCONTABIL")) {
                        if (tipoMovimento.equals("CTB") && tipoLancamento.equals("PAGAR")   && contaDebito.length() > 8) cpfCnpj = contaDebito;
                        if (tipoMovimento.equals("CTB") && tipoLancamento.equals("PAGAR")   && cpfCnpj.length() > 7) contaDebito = "100005";
                    }
*/
                    boolean contaSugerida = false;
                    cnpjIOPessoa = "";

                    // ====================================================
                    // ENCONTRA CONTA CONTABIL = PROCESSO CONTAS  A PAGAR
                    // ====================================================
                    if (tipoMovimento.equals("CTB") && tipoLancamento.equals("PAGAR")) {
                        logger.logDebug(">>> EndpointB: Tipo Movimento CTB.");

                        if (contaDebito == null || contaDebito.trim().length() == 0) {
                            JSONObject ret = buscaContaSimples(codEmpresa, nomeOrigem, cpfCnpj, tipoLancamento, logger, dbIOCont);  // simplificar
                            contaDebito = ret.optString("contaDebito").trim();
                            contaSugerida = ret.optBoolean("contaSugerida");
                            cnpjIOPessoa = ret.optString("cnpjIOPessoa").trim();
                        }
                        if (contaDebito == null || contaDebito.trim().length() == 0) {
                            contaDebito = "PENDENTE";
                        }
						if (!nomeContabilidade.toUpperCase().contains("DEPAULA") &&
							(!nomeContabilidade.toUpperCase().contains("FUNCIONAL") || deparaFuncional) &&
						    !nomeContabilidade.toUpperCase().equals("META") &&
							!nomeContabilidade.toUpperCase().contains("ESCONTEC") &&
							!nomeContabilidade.toUpperCase().contains("ESCRITORIOGOMES") &&
							versaoPlataforma.equals("02_Conecta_Via_Portal_Ottimizza") &&
							contaCredito.equals("") && ((valorJuros+valorMulta+valorDesconto) == 0) && classificacao.startsWith("X")) {
							contaCredito = "PENDENTE";
						}
                    }


                    // ====================================================
                    // ENCONTRA CONTA CONTABIL = PROCESSO CONTAS  A RECEBER
                    // ====================================================
                    if (tipoMovimento.equals("CTB") && tipoLancamento.equals("RECEBER")) {
                        logger.logDebug(">>> EndpointB: Tipo Movimento CTB.");
                        if (contaCredito == null || contaCredito.trim().length() == 0) {
                            JSONObject ret = buscaContaSimples(codEmpresa, nomeOrigem, cpfCnpj, tipoLancamento, logger, dbIOCont); // simplificar
                            contaCredito = ret.optString("contaCredito").trim();
                            contaSugerida = ret.optBoolean("contaSugerida");
                            cnpjIOPessoa = ret.optString("cnpjIOPessoa").trim();
                        }
                        if (contaCredito == null || contaCredito.trim().length() == 0) {
                            contaCredito = "PENDENTE";
                        }
						if (!nomeContabilidade.toUpperCase().contains("DEPAULA") &&
							(!nomeContabilidade.toUpperCase().contains("FUNCIONAL") || deparaFuncional) &&
						    !nomeContabilidade.toUpperCase().equals("META") &&
							!nomeContabilidade.toUpperCase().contains("ESCONTEC") &&
							!nomeContabilidade.toUpperCase().contains("ESCRITORIOGOMES") &&
							versaoPlataforma.equals("02_Conecta_Via_Portal_Ottimizza") &&
							contaDebito.equals("")&& ((valorJuros+valorMulta+valorDesconto) == 0) && classificacao.startsWith("X")) {
							contaDebito = "PENDENTE";
						}

                    }

					if (!nomeContabilidade.toUpperCase().contains("DEPAULA") &&
						!nomeContabilidade.toUpperCase().contains("ESCONTEC") &&
						(!nomeContabilidade.toUpperCase().contains("FUNCIONAL") || deparaFuncional) &&
						!nomeContabilidade.toUpperCase().equals("META") &&
						!nomeContabilidade.toUpperCase().contains("ESCRITORIOGOMES") &&
						versaoPlataforma.equals("02_Conecta_Via_Portal_Ottimizza") && tipoMovimento.equals("CTBPORT") && tipoLancamento.equals("PAGAR") && contaCredito.equals(""))  {
						contaCredito = "PENDENTE";
					}
					if (!nomeContabilidade.toUpperCase().contains("DEPAULA") &&
						!nomeContabilidade.toUpperCase().contains("ESCONTEC") &&
						(!nomeContabilidade.toUpperCase().contains("FUNCIONAL") || deparaFuncional) &&
						!nomeContabilidade.toUpperCase().equals("META") &&
						!nomeContabilidade.toUpperCase().contains("ESCRITORIOGOMES") &&
						versaoPlataforma.equals("02_Conecta_Via_Portal_Ottimizza") && tipoMovimento.equals("CTBPORT") && tipoLancamento.equals("RECEBER") && contaDebito.equals(""))  {
						contaDebito = "PENDENTE";
					}


                    if (cpfCnpj == null || cpfCnpj.trim().length() == 0) {
                        cpfCnpj = cnpjIOPessoa;
                    }

                    //=============================================================================================
                    // VERIFICA SE CONTA CONTABIL EXISTE PLANO DE CONTAS DO CLIENTE.
                    //=============================================================================================
                    if (tipoLancamento.equals("PAGAR") && tipoMovimento.equals("CTB") && contaDebito != null && !contaDebito.equals("") && !contaDebito.toUpperCase().contains("T") && !contaDebito.toUpperCase().contains("P")) {
                        JSONArray recordConta = verificaPlanoContas(dbIOCont, codEmpresa, contaDebito);
                        if (!nomeContabilidade.equals("Escritoriogomes") && !nomeContabilidade.contains("Funcionalconsultoria")) {
                            if (recordConta == null || recordConta.length() < 1) contaDebito = "PENDENTE";
                        }
                    }
                    if (tipoLancamento.equals("RECEBER") && tipoMovimento.equals("CTB") && contaCredito != null && !contaCredito.equals("") && !contaCredito.toUpperCase().contains("T") && !contaCredito.toUpperCase().contains("P")) {
                        JSONArray recordConta = verificaPlanoContas(dbIOCont, codEmpresa, contaCredito);

                        if (!nomeContabilidade.equals("Escritoriogomes") && !nomeContabilidade.contains("Funcionalconsultoria")) {
                            if (recordConta == null || recordConta.length() < 1) contaCredito = "PENDENTE";
                        }
                    }


                    if (tipoLancamento.equals("PAGAR"))   msg.put("CONTADEBITO", contaDebito);
                    if (tipoLancamento.equals("RECEBER")) msg.put("CONTACREDITO", contaCredito);

					if (contaCredito.equals("PENDENTE")) msg.put("CONTACREDITO", contaCredito);
					if (contaDebito.equals("PENDENTE")) msg.put("CONTADEBITO", contaDebito);


                    msg.put("HISTORICO", historico);
                    msg.put("CPFCNPJ", cpfCnpj);
                    msg.put("STATUSMOVIMENTO", statusMovimento);

                    JSONObject record = findMovimentoPorChave(dbIOCont, chavePlanilha);

                    if (record != null)  {
                        try {

                            updateMovimento(dbIOCont, msg);
                            //filaInout.setStatusCode(InoutConstants.STATUS_SENT);
                            //filaInout.setStatusDesc("");
                        } catch (Exception eUpdateMovimento) {
                            //filaInout.setStatusCode(InoutConstants.STATUS_TRANSFORMATION_ERROR);
                            //filaInout.setStatusDesc(eUpdateMovimento.getMessage());
                            logger.logError("EndpointB: Erro ao Atualizar Movimento", eUpdateMovimento);
                        }
                    } else {
                        try {

                            insertMovimento(dbIOCont, msg);
                            //filaInout.setStatusCode(InoutConstants.STATUS_SENT);
                            //filaInout.setStatusDesc("");
                        } catch (Exception eInsertMovimento) {
                            //filaInout.setStatusCode(InoutConstants.STATUS_TRANSFORMATION_ERROR);
                            //filaInout.setStatusDesc(eInsertMovimento.getMessage());
                            logger.logError("EndpointB: Erro ao fazer insert no Movimento", eInsertMovimento);
                        }
                    }
                } // FIM - For da leitura dos arquivos na fila.
            }
            catch (Exception arq) {}



        }

		//==============================================//
		// PREPARA GERACAO ARQUIVO DE-PARA FORNECEDORES //
		//==============================================//
		if (!loteFila.equals("")) {
			String dt = DateUtil.dateToString(new Date(), "yyyyMMddHHmmss");
			String filename = deParaDirName + "/DeParaConta_" + loteFila + "_" + dt + "000.csv";
			String filenameH = deParaDirName + "/Processado/HistDePara_" + loteFila + ".csv";

			if (versaoPlataforma.equals("02_Conecta_Via_Portal_Ottimizza")) {
				boolean gerouArquivo = gravaArquivoDeParaVersaoPortal(dbIOCont, nomeContabilidade, codEmpresa, loteFila, filename, filenameH, geraTudoNoDePara, logger);
				
				///////////////////////////////////////////////////////////
				// GERA ARQUIVO PARA IMPORTACAO ///////////////////////////
				///////////////////////////////////////////////////////////
				if (!gerouArquivo) {
					File txtGeraArquivo = new File(String.format("%s\\contabil\\Ottimizza\\GeraArquivo\\Gera_%s.txt", RouteEngine.INOUT_HOME, nomeContabilidade));

					if(!txtGeraArquivo.exists()) {
						try {
							if (txtGeraArquivo.createNewFile()) {
								logger.logDebug(String.format("Sucessfully created file at '%s'...", txtGeraArquivo.getAbsolutePath()));

								FileWriter writer = new FileWriter(txtGeraArquivo.getAbsolutePath());
								writer.writeNewFile("NOME CONTABILIDADE : " + nomeContabilidade);

							} else {
								logger.logDebug(String.format("Something went wrong while trying to create file at '%s'...\nMake sure the specified path doesn't already exists!", txtGeraArquivo.getAbsolutePath()));
							}   
						} catch(Exception createFileException) {
							logger.logError(String.format("Error trying to create file '%s'", txtGeraArquivo.getAbsolutePath()), createFileException);
						}
					} else {
						logger.logDebug(String.format("File '%s' not created. \nThe file already exists!", txtGeraArquivo.getAbsolutePath()));
					}
					String rotaGera = "Ottimizza.GeraArquivoParaImportacao";
					RouteEngine.execRoute(rotaGera);
				}
			}
		}
		JSONObject jStatus = new JSONObject();
		putStatus(deParaDirName, "", jStatus, logger);

		File txtGeraArquivo = new File(String.format("%s\\contabil\\Ottimizza\\GeraArquivo\\Gera_%s.txt", RouteEngine.INOUT_HOME, nomeContabilidade));

		if(!txtGeraArquivo.exists()) {
			try {
				if (txtGeraArquivo.createNewFile()) {
					logger.logDebug(String.format("Sucessfully created file at '%s'...", txtGeraArquivo.getAbsolutePath()));

					FileWriter writer = new FileWriter(txtGeraArquivo.getAbsolutePath());
					writer.writeNewFile("NOME CONTABILIDADE : " + nomeContabilidade);

				} else {
					logger.logDebug(String.format("Something went wrong while trying to create file at '%s'...\nMake sure the specified path doesn't already exists!", txtGeraArquivo.getAbsolutePath()));
				}   
			} catch(Exception createFileException) {
				logger.logError(String.format("Error trying to create file '%s'", txtGeraArquivo.getAbsolutePath()), createFileException);
			}
		} else {
			logger.logDebug(String.format("File '%s' not created. \nThe file already exists!", txtGeraArquivo.getAbsolutePath()));
		}
		String rotaGera = "Ottimizza.GeraArquivoParaImportacao";
		RouteEngine.execRoute(rotaGera);

    } catch (Exception e) {
        logger.logError("EndpointB:", e);
    } finally {
        if (dbIOCont != null) {
            try {
                dbIOCont.closeConnection();
            } catch (Exception e) {}
        }

    }
	logger.logDebug("FINALIZOU " + nomeEmp);
	
	



}


//###############################################################################

/////////////////////////////////////////////////////////////////////////////////
// Extrai do ROUTE_ID o nome da Contabilidade
/////////////////////////////////////////////////////////////////////////////////
private String getNomeContabilidade() throws Exception {
    String contabilidade = INOUT_ROUTE_ID.substring(0, INOUT_ROUTE_ID.indexOf("."));

    return contabilidade;
}


private String getNomeContabilidadeDePara() {
    return INOUT_ROUTE_ID.substring(0, INOUT_ROUTE_ID.indexOf("DePara"));
}


//###############################################################################

/////////////////////////////////////////////////////////////////////////////////
// Extrai do ROUTE_ID o nome da Empresa
/////////////////////////////////////////////////////////////////////////////////
private String getNomeEmpresa() throws Exception {
    String empresa = INOUT_ROUTE_ID.substring(INOUT_ROUTE_ID.indexOf(".")+1);
    empresa = empresa.substring(0, empresa.indexOf("_")).toUpperCase();


    if (empresa.equals(getNomeContabilidade().toUpperCase())) {
        SysProperties prop = SysProperties.getInstance();
        prop.load("contabil/" + getNomeContabilidade() + "/empresa.properties");
        empresa = prop.get("NOME_EMPRESA").toUpperCase();
    }
    return empresa;
}

private String getNomeEmpresa2() {
    String empresa = INOUT_ROUTE_ID.substring(INOUT_ROUTE_ID.indexOf(".")+1);
    empresa = empresa.substring(0, empresa.indexOf("_")).toUpperCase();

    return empresa;
}


/////////////////////////////////////////////////////////////////////////////////
// Extrai do ROUTE_ID o nome da Empresa
/////////////////////////////////////////////////////////////////////////////////
private String getNomeContabilidadeEmpresaProperties() throws Exception {
    String empresa = INOUT_ROUTE_ID.substring(INOUT_ROUTE_ID.indexOf(".")+1);
	String contabilidade = getNomeContabilidade();
   /* empresa = empresa.substring(0, empresa.indexOf("_")).toUpperCase();


    if (empresa.equals(getNomeContabilidade().toUpperCase())) {
        SysProperties prop = SysProperties.getInstance();
        prop.load("contabil/" + getNomeContabilidade() + "/empresa.properties");
        empresa = prop.get("NOME_EMPRESA").toUpperCase();
        contabilidade = prop.get("NOME_CONTABILIDADE").toUpperCase();
    } */
    return contabilidade;
}


private String getNomeRota() {
    String rota = INOUT_ROUTE_ID.substring(INOUT_ROUTE_ID.indexOf(".")+1);
    rota = rota.substring(rota.indexOf("_")+1).toUpperCase();
    return rota;
}


/////////////////////////////////////////////////////////////////////////////////
//              Envia e-mail de lote NAOEXISTEROTA.                    //
/////////////////////////////////////////////////////////////////////////////////
public void enviaEmailNaoExisteRota(JSONObject jsNaoExiste,
                                    InoutLogger logger) throws Exception {

    String subject          = "";
    String sendToName       = "";
    String emailResponsavel = "";
    String tipoIntegracao   = "";
    String nomeArquivo      = "";
    String nomeEmpresa      = "";

    if(jsNaoExiste.has("SUBJECT")) subject = jsNaoExiste.optString("SUBJECT");
    if(jsNaoExiste.has("SENDTONAME")) sendToName = jsNaoExiste.optString("SENDTONAME");
    if(jsNaoExiste.has("EMAILRESPONSAVEL")) emailResponsavel = jsNaoExiste.optString("EMAILRESPONSAVEL");
    if(jsNaoExiste.has("TIPOINTEGRACAO")) tipoIntegracao = jsNaoExiste.optString("TIPOINTEGRACAO");
    if(jsNaoExiste.has("NOMEARQUIVO")) nomeArquivo = jsNaoExiste.optString("NOMEARQUIVO");
    if(jsNaoExiste.has("NOMEEMPRESA")) nomeEmpresa = jsNaoExiste.optString("NOMEEMPRESA");

    StringBuilder msg = new StringBuilder();
    msg.append("<html>\n");
    msg.append("<head>\n");
    msg.append("</head>\n");
    msg.append("<body lang=\"en-US\" dir=\"ltr\">\n");

    msg.append("<p><font style=\"font-size: 10pt\"></font>Prezado cliente, </p>\n");
    msg.append("<p><font style=\"font-size: 10pt\"><b/>A empresa " + nomeEmpresa + " n&atilde;o possui integra&ccedil;&atilde;o de contas "+tipoIntegracao+".</b></font></p>\n\n");

    msg.append("<p><font style=\"font-size: 10pt\">Atenciosamente,</font></p>\n");
    msg.append("<p><strong>SUPORTE OTTIMIZZA AUTOMACAO CONTABIL</strong>\n");
    msg.append("<br/>Rua 2 de setembro, 3753, Blumenau-SC \n");
    msg.append("<br/>+55 (47) 3035-3765 \n");
    msg.append("<br/>suporte@ottimizza.com.br</p>\n");
    msg.append("</body>\n");
    msg.append("</html>\n");

    if (nomeArquivo.contains("OTTIMIZZA") && !nomeArquivo.contains("OTTIMIZZAAUTOMACAO")) emailResponsavel = "suporte@ottimizza.com.br";

    enviaEmail(subject, emailResponsavel, sendToName, msg.toString(), null, logger);

}
//###############################################################################

/////////////////////////////////////////////////////////////////////////////////
////////////////////  ////   WORKFLOW   ////  ////////////////////
/////////////////////////////////////////////////////////////////////////////////
public JSONArray runEndpointAWorkflow(InoutLogger logger) throws Exception {
    JSONArray records    = new JSONArray();
    SysProperties props  = SysProperties.getInstance();
    SysProperties props2 = SysProperties.getInstance();
	ConnectorConfig config = new ConnectorConfig();
	config.setUsername("fabrica@ottimizza.com.br");
	config.setPassword("ottimizza@123HU4ssqt1HCiLyCzj6QStgteM2");
	config.setTraceMessage(false);
	
	logger.logInfo("API SALES SHR: runEndpointAWorkflow RegrasWorkflowT 1");
	
    String servDinamic = "";
	try{
		servDinamic = buscaServidor(logger).toLowerCase();
		if(servDinamic.equals("")) servDinamic = "zeus";
	}catch(Exception e){
		logger.logInfo("ERRO AO BUSCAR - "+e.getMessage());
        servDinamic = "zeus";
	}

    try {
		String contabilidade = getNomeContabilidade();
        String dirName = RouteEngine.INOUT_HOME + "/contabil/" + getNomeContabilidade() + "/";
        File file = new File(dirName);
        String[] rotasLO = file.list();

        String arquivoGrande = "";
        String jSdir = "";
        boolean rotasOk = false;
        String filename = "";
        String filenameCanal = "";
        String extensaoSuportada = ".csv.xlsx.txt.ofx.dat.pdf.prn.ofc.omc";
        String sendToName       = getNomeContabilidade() + " -- OTTIMIZZA Contabil";
        double sizeLimit = 3.2;               //tamanho maximo processavel                        //-
        /*
		if (sizeLimit < 15 && getNomeContabilidade().toUpperCase().contains("IGNIS")) sizeLimit = 15;
		if (sizeLimit < 50 && getNomeContabilidade().toUpperCase().contains("TECOLMG")) sizeLimit = 50;
		if (sizeLimit < 5 && getNomeContabilidade().toUpperCase().contains("ESCOLBE")) sizeLimit = 5;
        */

        sizeLimit = sizeLimit * (Math.pow(1024,2)); //MiB                                       //-

        String extensaoArquivo  = "";

        // Carrega as propriedades
        props.load("contabil/" + getNomeContabilidade() + "/contabil.properties");
        props2.load("contabil/" + getNomeContabilidade() + "/empresa.properties");

        String oicContabil  = props.get("OIC_LIBERADO");
        String emailCanal   = props.get("EMAIL_CANAL");
        String codigoCanal  = props.get("CODIGO_CANAL");
		String versaoPlataforma = props.get("VERSAO_PLATAFORMA");
	    String versaoOtzWebApp = "02_Conecta_Via_Portal_Ottimizza";


        String emailOic     = emailCanal;
        String subject      = "";
        String empresa      = "";
        String operacao     = "";

        /*String horaWorkflow = DateUtil.dateToString(new Date(), "HHmm");
        String logWorkflow  = RouteEngine.INOUT_HOME +  "/logs/workflow/" + getNomeContabilidade() + ".log";
        FileWriter writerWorkflow = new FileWriter(logWorkflow);
        StringBuilder txtWorkflow = new StringBuilder();
        txtWorkflow.append(horaWorkflow);
        writerWorkflow.writeNewFile(txtWorkflow.toString());
		*/
		
		//-------------------------------------------------------------------------------------
		// GERA ARQUIVO COM log da ultima contabilidade que foi rodada.
		//-------------------------------------------------------------------------------------
		String fileLog = "/inout/logs/workflow/" + INOUT_ROUTE_ID.substring(0, INOUT_ROUTE_ID.indexOf(".")) + "_ultimaRota.csv";
		Date ultimoLog = new Date();

		String conteudo = contabilidade + ";" + ultimoLog.getTime();

		FileWriter writerLog = new FileWriter(fileLog);
		writerLog.writeNewFile(conteudo.toString());
		
		postStatus(servDinamic.toUpperCase(), contabilidade, "Ocioso", "Nada Pendente", "Sem Arquivo Para Processar", INOUT_ROUTE_ID.substring(0, INOUT_ROUTE_ID.indexOf(".")));

		

        if (codigoCanal == null) codigoCanal = "Admin";

        if (rotasLO != null) {

            for (String nome : rotasLO) {

                try {

                    if (nome.contains("_#")) {
                        empresa = nome.substring(0,nome.indexOf("_#")).toUpperCase();
						
						//logger.logInfo("LENDO NOME DA EMPRESA  = " + nome);


						//logger.logDebug("LENDO EMPRESA = " + empresa);
						
                        String emailResponsavel = props.get(nome.substring(0,nome.indexOf("_#")).toUpperCase() + "_EMAIL_RESPONSAVEL");
                        String oicEmpresa = props.get(nome.substring(0,nome.indexOf("_#")).toUpperCase() + "_LIBERA_OIC");

						//-------------------------------------------------------------------------------------
						// GERA ARQUIVO COM log da ultima contabilidade que foi rodada.
						//-------------------------------------------------------------------------------------
						ultimoLog = new Date();

						conteudo = contabilidade + "_" + nome + ";" + ultimoLog.getTime();

						// caso outra rota esteja travando o arquivo 
						for (int xxx = 0;xxx < 30000;xxx++) {
							try{
								writerLog = new FileWriter(fileLog);
								writerLog.writeNewFile(conteudo.toString());
								break;
							} catch (Exception xx) {}
						}
						
                        ///////////////////////////////////////////////////////////
                        // DEPARA /////////////////////////////////////////////////
                        ///////////////////////////////////////////////////////////
                        operacao = "DePara";
						String diretorio = dirName + nome + "/DePara";
						File file2 = new File(diretorio);
                        File [] files = file2.listFiles();
                        try {
                            if (FileUtil.dirHasFiles(diretorio)) {
                                for (File fileDePara: files) {

                                    if(fileDePara.length() < sizeLimit || !fileDePara.getName().toUpperCase().endsWith(".XLSX")){

                                        if (fileDePara.isFile()){
                                            //DE PARA
                                            if(fileDePara.getName().startsWith("OK_DePara") && fileDePara.getName().toLowerCase().endsWith(".csv")){
												
 
                                                String rotaDePara = contabilidade+"DePara" + ".AtualizaPendenciasIOMovimento";
												if (versaoPlataforma.equals(versaoOtzWebApp)) {
													rotaDePara = "Ottimizza.AtualizaPendenciasIOMovimento";
													 
													File txtImportaPlanoContas = new File(String.format("%s/contabil/Ottimizza/AtualizaPendenciaIOMovimento/Atualiza_%s.txt", RouteEngine.INOUT_HOME, nome));

													// Criar diretorio ottimizza/AtualizaPendenciaIOMovimento se não existe.
													if (!txtImportaPlanoContas.getParentFile().exists()) txtImportaPlanoContas.getParentFile().mkdirs();

													if (!txtImportaPlanoContas.exists()) {
														try {
															String txtIPCContent = "";

															txtIPCContent += String.format("NOME_CONTABILIDADE : %s%n", contabilidade);
															txtIPCContent += String.format("NOME_EMPRESA : %s%n", nome.substring(0, nome.indexOf("_#")));
															txtIPCContent += String.format("CODIGO_EMPRESA : %s%n", nome.substring(nome.indexOf("#") + 1));

															// Escrever texto no arquivo
															FileWriter writerDePara = new FileWriter(txtImportaPlanoContas.getAbsolutePath());
															writerDePara.writeNewFile(txtIPCContent);
														} catch(Exception createFileException) {
															logger.logError(String.format("Error trying to create file '%s'!", txtImportaPlanoContas.getAbsolutePath()), createFileException);
														}
													} else {
														logger.logDebug(String.format("File '%s' not created. \nThe file already exists!", txtImportaPlanoContas.getAbsolutePath()));
													}
												}
 
                                                RouteEngine.execRoute(rotaDePara);
                                                rotasOk = true;

											}

											//participante
											if (fileDePara.getName().toUpperCase().contains("PARTICIPANTE") &&
												(fileDePara.getName().toUpperCase().endsWith(".CSV") )){
												File ImportaParticipante = new File(String.format("%s/contabil/Ottimizza/ImportaParticipante/Participante_%s.txt", RouteEngine.INOUT_HOME, nome));
												// Criar diretorio ottimizza/ImportaPlanoContas se n?o existe.
												if (!ImportaParticipante.getParentFile().exists()) ImportaParticipante.getParentFile().mkdirs();

												if (!ImportaParticipante.exists()) {
													try {
														if (ImportaParticipante.createNewFile()) {
															// String com conteudos do Arquivo '.txt' com os dados para importacao
															// do Plano de Contas da Empresa.
															String txtIPContent = "";
															txtIPContent += String.format("NOME_CONTABILIDADE : %s%n", contabilidade);
															txtIPContent += String.format("NOME_EMPRESA : %s%n", nome.substring(0, nome.indexOf("_#")));
															txtIPContent += String.format("CODIGO_EMPRESA : %s%n", nome.substring(nome.indexOf("#") + 1));
															// Escrever texto no arquivo
															FileWriter writerDePara = new FileWriter(ImportaParticipante.getAbsolutePath());
															writerDePara.writeNewFile(txtIPContent);
														} else {
															logger.logDebug(String.format("Something went wrong while trying to create file at '%s'...\nMake sure the specified path doesn't already exists!", ImportaParticipante.getAbsolutePath()));
														}
													} catch(Exception createFileException) {
														logger.logError(String.format("Error trying to create file '%s'!", ImportaParticipante.getAbsolutePath()), createFileException);
													}
												} else {
													logger.logDebug(String.format("File '%s' not created. \nThe file already exists!", ImportaParticipante.getAbsolutePath()));
												}
												String rotaImportaPlano = "Ottimizza.Participante";
												RouteEngine.execRoute(rotaImportaPlano);
											}
											//PLANO CONTAS
											 if (!fileDePara.getName().toUpperCase().contains("PARTICIPANTE") && 
												fileDePara.getName().toUpperCase().contains("PLANO") &&
												((fileDePara.getName().toUpperCase().startsWith("PLANO DE CONTA") && fileDePara.getName().toUpperCase().endsWith(".CSV")) || 
												 fileDePara.getName().toUpperCase().endsWith(".XLSX") || fileDePara.getName().toUpperCase().endsWith(".LST") || fileDePara.getName().toUpperCase().endsWith(".TXT"))) {                    
												File txtImportaPlanoContas = new File(String.format("%s/contabil/Ottimizza/ImportaPlanoContas/PlanoContas_%s.txt", RouteEngine.INOUT_HOME, nome));


												// Criar diretorio ottimizza/ImportaPlanoContas se n?o existe.
												if (!txtImportaPlanoContas.getParentFile().exists()) txtImportaPlanoContas.getParentFile().mkdirs();

												// QUANDO FOR CSV, joga em pasta /inout/contabil/ottimizza/planocontas para poder importar
												// sem dar conflito com os .csv de depara. 
												if (fileDePara.getName().toUpperCase().endsWith(".CSV")) {
													filename = fileDePara.getAbsolutePath();
													filename = filename.replaceAll("\\\\", "/");

													if (!FileUtil.fileExists(String.format("%s/contabil/Ottimizza/ImportaPlanoContas/%s", RouteEngine.INOUT_HOME, contabilidade))) {
														FileUtil.mkDir(String.format("%s/contabil/Ottimizza/ImportaPlanoContas/%s", RouteEngine.INOUT_HOME, contabilidade));
													}

													
													 FileUtil.moveToDir(filename, String.format("%s/contabil/Ottimizza/ImportaPlanoContas/%s", RouteEngine.INOUT_HOME, contabilidade));

												}
                                                if (!txtImportaPlanoContas.exists()) {
                                                    try {
                                                        if (txtImportaPlanoContas.createNewFile()) {
                                                            // String com conteudos do Arquivo '.txt' com os dados para importacao
                                                            // do Plano de Contas da Empresa.
                                                            String txtIPCContent = "";

                                                            txtIPCContent += String.format("NOME_CONTABILIDADE : %s%n", contabilidade);
                                                            txtIPCContent += String.format("NOME_EMPRESA : %s%n", nome.substring(0, nome.indexOf("_#")));
                                                            txtIPCContent += String.format("CODIGO_EMPRESA : %s%n", nome.substring(nome.indexOf("#") + 1));

                                                            // Escrever texto no arquivo
                                                            FileWriter writerDePara = new FileWriter(txtImportaPlanoContas.getAbsolutePath());
                                                            writerDePara.writeNewFile(txtIPCContent);
                                                        } else {
                                                            logger.logDebug(String.format("Something went wrong while trying to create file at '%s'...\nMake sure the specified path doesn't already exists!", txtImportaPlanoContas.getAbsolutePath()));
                                                        }
                                                    } catch(Exception createFileException) {
                                                        logger.logError(String.format("Error trying to create file '%s'!", txtImportaPlanoContas.getAbsolutePath()), createFileException);
                                                    }
                                                } else {
                                                    logger.logDebug(String.format("File '%s' not created. \nThe file already exists!", txtImportaPlanoContas.getAbsolutePath()));
                                                }
                                                String rotaImportaPlano = "Ottimizza.ImportaPlanoContas";
                                                RouteEngine.execRoute(rotaImportaPlano);
                                            }
                                        }
                                    }else{                  // envia email e move pra processado

                                        subject = "ARQUIVO GRANDE ("+fileDePara.length()/1024/1024+" MiB) -" + getNomeContabilidade() + "-" + empresa + "-" + operacao;
                                        StringBuilder msg = new StringBuilder();
                                        msg.append("<html>\n");
                                        msg.append("<head>\n");
                                        msg.append("</head>\n");
                                        msg.append("<body lang=\"en-US\" dir=\"ltr\">\n");
                                        msg.append("<p><font style=\"font-size: 10pt\">to big, max size (" + sizeLimit/1024/1024 + " MiB).</font></p>\n");
                                        msg.append("</body>\n");
                                        msg.append("</html>\n");

                                        enviaEmail(subject, "suporte@ottimizza.com.br", "TAMANHO ARQUIVO", msg.toString(), null, logger);

                                        filename = fileDePara.getAbsolutePath();
                                        filename = filename.replaceAll("\\\\", "/");
                                        FileUtil.moveToDir(filename, diretorio + "/Processado");

                                    }
                                }
                            }
                        } catch (Exception deParaException) {
                            logger.logError("Erro executando DePara " + diretorio, deParaException);
                        }

                        ///////////////////////////////////////////////////////////
                        // APAGAR /////////////////////////////////////////////////
                        ///////////////////////////////////////////////////////////
                        operacao = "APagar";
                        diretorio = dirName + nome + "/"+ operacao;
                        file2 = new File(diretorio);


						// renomeia arquivos com extensão .XLSX
                        File []  arquivosCaixaAlta = file2.listFiles();
                        if (FileUtil.dirHasFiles(diretorio)) {



                            for (File fl: arquivosCaixaAlta) {

                                if(fl.length() < sizeLimit || !fl.getName().toUpperCase().endsWith(".XLSX")){
								// if(fl.length() < sizeLimit) {                    // processar apenas arquivos MENORES que o limite
                                    try {
										String arquivoDestino = fl.getAbsolutePath().replaceAll("\\.XLSX","_\\.xlsx").toLowerCase();
										if (fl.getAbsolutePath().contains(".XLSX")) {

											File fileDestino = new File(arquivoDestino);
											FileUtil.copyFolder(fl, fileDestino);
											FileUtil.deleteFile(fl);
										}
									}
									catch (Exception xx) {}
								}
							}
						}


						// FINAL renomeia arquivos com extensão .XLSX


                        files = file2.listFiles();


                        if (FileUtil.dirHasFiles(diretorio)) {

                            if (FileUtil.dirHasFiles(diretorio)) {
							
								postStatus(servDinamic.toUpperCase(), contabilidade, "Processando", nome.substring(0,nome.indexOf("_#")), "PAGAR", INOUT_ROUTE_ID.substring(0, INOUT_ROUTE_ID.indexOf(".")));

                                for (File fl: files) {
								
									if (fl.getAbsolutePath().toUpperCase().contains("ROTA.TXT")) {
													
										File arquivoDeploy  = new File("C:/ottimizza/Dropbox/Deploy/routes/" + contabilidade + "/" + nome.substring(0,nome.indexOf("_#")) + "_ContasPagasEndpointA.script");
										File arquivoPortal  = new File(RouteEngine.INOUT_HOME + "/contabil/" + contabilidade + "/arquivos/" + nome.substring(0,nome.indexOf("_#")) + "_ContasPagasEndpoint.script_APAGAR.txt");
										
										FileUtil.copyFolder(arquivoDeploy, arquivoPortal);
										
										continue;
									}
									
									if (fl.getAbsolutePath().toUpperCase().contains(".SCRIPT")) {
									
										File arquivoDeploy  = new File("C:/ottimizza/Dropbox/Deploy/routes/" + contabilidade + "/" + nome.substring(0,nome.indexOf("_#")) + "_ContasPagasEndpointA.script");
										 
										FileUtil.copyFolder(fl, arquivoDeploy);

										try { 
												FileUtil.deleteFile(fl);
										} catch (Exception XX) {} 
										
										 
										continue;
									}
								
                                    if((fl.length() >= sizeLimit * 5) || (fl.length() >= sizeLimit && fl.getAbsolutePath().toUpperCase().contains(".XLSX"))){                    // processar apenas arquivos MENORES que o limite
                                        arquivoGrande = fl.getName();
                                        // jogar um erro de planilha com o nome do arquivo que eh muito grande!!!!!
                                        jSdir = fl.getAbsolutePath();
                                        jSdir = jSdir.replaceAll("\\\\", "/");
                                        jSdir = cutString(jSdir, 0, jSdir.lastIndexOf("/"));
                                        arquivoGrande = "Arquivo-Grande" + arquivoGrande + "_PAGAR";
                                        // jStatus = new JSONObject();
                                        // putStatus(dirName, "", jStatus, logger);
                                        //    putStatus(jSdir, arquivoGrande/* .replaceAll(" ", "-") */ + ".err", jStatus, logger);
                                    }
                                }
                                for (File fl: files) {
                                    if (arquivoGrande.equals("")) {
                                        try {

										//renomear arquivo que nao possua extensao para (.txt)
										if(fl.isFile() && !fl.getName().contains(".")){
											String flStr = fl.getAbsolutePath()+".txt";
											File flTemp = new File(flStr);
											fl.renameTo(flTemp);
										}

										if (fl.isFile() && oicContabil.equals("NAO")) {

                                            //envia email CONTABILIDADE INATIVA (canal,machado)
                                            subject = "Contabilidade INATIVA com arquivos a serem processados";
                                            enviaEmailContabilidadeInativa(getNomeContabilidade(), fl.getName(), nome, subject, emailOic, sendToName, "CONTABILIDADE INATIVA", "APagar", logger);
                                            //mover para processado arquivo
                                            filename = fl.getAbsolutePath();
                                            filename = filename.replaceAll("\\\\", "/");
                                            FileUtil.moveToDir(filename, diretorio + "/Processado");

                                        }else if(fl.isFile() && oicContabil.equals("SIM")){

                                            extensaoArquivo = fl.getName().substring(fl.getName().lastIndexOf(".")).toLowerCase();
 


                                            if(oicEmpresa.equals("NAO")){

                                                //envia email EMPRESA INATIVA (canal,machado,fechamento)
                                                emailOic = emailOic + ", " + emailResponsavel;
                                                subject = "Empresa INATIVA com arquivos a serem processados";
                                                enviaEmailEmpresaInativa(getNomeContabilidade(), fl.getName(), nome, subject, emailOic, sendToName, "EMPRESA INATIVA", "APagar", logger);

                                                //mover para processado arquivo
                                                filename = fl.getAbsolutePath();
                                                filename = filename.replaceAll("\\\\", "/");
                                                FileUtil.moveToDir(filename, diretorio + "/Processado");

                                            }else if (extensaoSuportada.contains(extensaoArquivo) && !extensaoArquivo.equals(".xls")) {
 
                                                //executa a rota
                                                String nomeRota = getNomeContabilidade() + "." + nome.substring(0,nome.indexOf("_#")) + "_ContasPagas";
												
												
                                                try{

 
													// executa rota que atualiza os roteiros das empresas
													// RouteEngine.execRoute("Ottimizza.Oud_AtualizacaoRoteiros");

														
 														String rodaPadrao = props.get(nome.substring(0,nome.indexOf("_#")).toUpperCase() + "_PLANILHA_PADRAO_PAGAR");
														String idRoteiro  = props.get(nome.substring(0,nome.indexOf("_#")).toUpperCase() + "_ID_ROTEIRO_PAGAR");
														String codRoteiro  = props.get(nome.substring(0,nome.indexOf("_#")).toUpperCase() + "_ROTEIRO_PAGAR");
														
 													try {

 														
														if (rodaPadrao.toUpperCase().trim().equals("TRUE")) {															
															//PartnerConnection connection = Connector.newConnection(config);
															//preparaArquivo(idRoteiro, "Contas PAGAS", contabilidade, nome.substring(0,nome.indexOf("_#")), dirName, connection, logger);
															// PartnerConnection connection = Connector.newConnection(config);  
															preparaArquivo(idRoteiro, "Contas PAGAS", contabilidade, nome.substring(0,nome.indexOf("_#")), dirName, dirName, config, logger);
															
															
															nomeRota = getNomeContabilidade() + "." + getNomeContabilidade() +  "_ContasPagas";
															RouteEngine.execRoute(nomeRota);
														} 
													


														// Atualia o peoperties eperara para rodar a rota especifica
														// caso o arquvo nao tenha sido rodado na rota padrao
														
														preparaArquivoEspecifico(idRoteiro, "Contas PAGAS", contabilidade, nome.substring(0,nome.indexOf("_#")), dirName, dirName, logger);


														StringBuilder txt1 = new StringBuilder();    
														String empresaProperties = dirName + "empresa.properties";
														FileWriter writer = new FileWriter(empresaProperties);
														txt1.append("NOME_EMPRESA = " + nome.substring(0,nome.indexOf("_#")));
														txt1.append("\r\n");
														txt1.append("NOME_CONTABILIDADE = " + contabilidade);
														txt1.append("\r\n");
														txt1.append("MANTEM_ARQUIVO = NAO");
														writer.writeNewFile(txt1.toString());
	 

														File arquivoDeploy  = new File("C:/ottimizza/Dropbox/Deploy/routes/" + getNomeContabilidade() + "/" + nome.substring(0,nome.indexOf("_#")) + "_ContasPagasEndpointA.script");
														File eServidor  = new File("C:/inout/docs/processos/producao.txt");
														File arquivoOrigem  = new File(RouteEngine.INOUT_HOME + "/routes/" + getNomeContabilidade() + "/" + nome.substring(0,nome.indexOf("_#")) + "_ContasPagasEndpointA.script");
														if(eServidor.exists()) {
															FileUtil.copyFolder(arquivoDeploy, arquivoOrigem);
															arquivoOrigem = new File("C:/ottimizza/Dropbox/Deploy/routes/" + getNomeContabilidade() + "/" + nome.substring(0,nome.indexOf("_#")) + "_ContasPagasEndpointA.script");
														}

														arquivoOrigem  = new File(RouteEngine.INOUT_HOME + "/routes/" + getNomeContabilidade() + "/" + nome.substring(0,nome.indexOf("_#")) + "_ContasPagasEndpointA.script");
														File arquivoDestino = new File(RouteEngine.INOUT_HOME + "/routes/" + getNomeContabilidade() + "/" + getNomeContabilidade() + "_ContasPagasEndpointA.script");
														if (nome.substring(0,nome.indexOf("_#")).toUpperCase().contains("BUSSOLA")) arquivoDestino = new File(RouteEngine.INOUT_HOME + "/routes/OTWBussola/LeituraBalanceteEndpointA.script");

														logger.logDebug("ORIGEM  " + arquivoOrigem.getName());
														logger.logDebug("DESTINO " + arquivoDestino.getName());
														FileUtil.copyFolder(arquivoOrigem, arquivoDestino);

														int antesRodar =  files.length;

														nomeRota = getNomeContabilidade() + "." + getNomeContabilidade() +  "_ContasPagas";
														if (nome.substring(0,nome.indexOf("_#")).toUpperCase().contains("BUSSOLA")) nomeRota = "OTWBussola.LeituraBalancete";

														logger.logInfo("PAGAR " + "empresa  = " + nome);

														RouteEngine.execRoute(nomeRota);
														rotasOk = true;

														File fileDepoisLista = new File(diretorio);
														File [] filesDepois = fileDepoisLista.listFiles();
														int depoisRodar =  filesDepois.length;

	/*
														if (antesRodar == depoisRodar) {
															String planilhaErro = dirName + nome + "/DePara" + "/empresa_PAGAR.err";
															FileWriter writerErro = new FileWriter(planilhaErro);
															writerErro.writeNewFile(planilhaErro.toString());
															if(fl.exists()) {
																//fl.delete();
																filename = fl.getAbsolutePath();
																filename = filename.replaceAll("\\\\", "/");
																FileUtil.moveToDir(filename, diretorio + "/Processado");
															}
															antesRodar--;
														} 
														*/
														
														if (FileUtil.fileExists(dirName + nome + "/DePara" + "/02--Etapa 2 de 4--PAGAR.status")) {
															criaAvisoErroLayout( dirName + nome + "/DePara" + "/02--Etapa 2 de 4--PAGAR.status", logger);

														}
														
													}	

													catch (Exception xx) {
														logger.logDebug("ERRO AO RODAR ROTEIRO");
													}	

                                                }catch(Exception aa){
                                                    subject = "Nao existe integracao de contas Pagas";

                                                    JSONObject jsNaoExiste = new JSONObject();
                                                    jsNaoExiste.put("NOMECONTABILIDADE", getNomeContabilidade());
                                                    jsNaoExiste.put("SENDTONAME", sendToName);
                                                    jsNaoExiste.put("SUBJECT", subject);
                                                    //jsNaoExiste.put("EMAILRESPONSAVEL", emailResponsavel+",suporte@ottimizza.com.br");
                                                    //if(filename.toUpperCase().contains("OTTIMIZZAF"))
                                                    jsNaoExiste.put("EMAILRESPONSAVEL", "suporte@ottimizza.com.br");
                                                    jsNaoExiste.put("NOMEARQUIVO", fl.getName());
                                                    jsNaoExiste.put("TIPOINTEGRACAO", "Pagas");
                                                    jsNaoExiste.put("NOMEEMPRESA", nome);

                                                    enviaEmailNaoExisteRota(jsNaoExiste, logger);

                                                    //mover
                                                    filename = fl.getAbsolutePath();
                                                    filename = filename.replaceAll("\\\\", "/");
                                                    FileUtil.moveToDir(filename, diretorio + "/Processado");

                                                }

                                            } else if(extensaoArquivo.equals(".xls")) {
                                                //emailArquivoErrado xls
                                                subject = "Arquivo .xls nao suportado por OTTIMIZZA Contabil";

                                                enviaAvisoSobreArquivoErrado(fl.getName(), nome, subject, emailResponsavel, sendToName, "XLS", "APagar", logger);

                                                //mover para processado qualquer arquivo
                                                filename = fl.getAbsolutePath();
                                                filename = filename.replaceAll("\\\\", "/");
                                                FileUtil.moveToDir(filename, diretorio + "/Processado");

                                            } else {
                                                //emailArquivoErrado outros arquivos
                                                subject = "Arquivo nao suportado por OTTIMIZZA Contabil";

                                                enviaAvisoSobreArquivoErrado(fl.getName(), nome, subject, emailResponsavel, sendToName, "OUTROS", "APagar", logger);

                                                //mover para processado qualquer arquivo
                                                filename = fl.getAbsolutePath();
                                                filename = filename.replaceAll("\\\\", "/");
                                                FileUtil.moveToDir(filename, diretorio + "/Processado");
                                            }
                                        }
                                    } catch (Exception eee) {
                                        logger.logError("Erro processando o arquivo " + fl.getAbsolutePath(), eee);
                                    }
                                }else{ // envia email e move pra processado
                                    //////////////////
                                    subject = "ARQUIVO GRANDE ("+fl.length()/1024/1024+" MiB) -" + getNomeContabilidade() + "-" + empresa + "-" + operacao;
                                    StringBuilder msg = new StringBuilder();
                                    msg.append("<html>\n");
                                    msg.append("<head>\n");
                                    msg.append("</head>\n");
                                    msg.append("<body lang=\"en-US\" dir=\"ltr\">\n");
                                    msg.append("<p><font style=\"font-size: 10pt\">O arquivo \"" + arquivoGrande + "\" muito grande, tamanho maximo permitido para XLSX: (" + sizeLimit/1024/1024 + " Mb).</font></p>\n");
                                    msg.append("</body>\n");
                                    msg.append("</html>\n");

                                    enviaEmail(subject, "suporte@ottimizza.com.br", "TAMANHO ARQUIVO", msg.toString(), null, logger);
									
									// logger.logDebug("PATH " + fl.getAbsolutePath());

                                    filename = fl.getAbsolutePath();
                                    filename = filename.replaceAll("\\\\", "/");
                                    if (!filename.endsWith("/Processado"))
                                    FileUtil.moveToDir(filename, diretorio + "/Processado");
								
									// logger.logDebug("PATHPROCESS " + fl.getAbsolutePath() + " | " + filename);

                                }
                            }
                        }
                    }

                        ///////////////////////////////////////////////////////////
                        // ARECEBER ///////////////////////////////////////////////
                        ///////////////////////////////////////////////////////////
                        operacao = "AReceber";
                        diretorio = dirName + nome + "/"+ operacao;
                        file2 = new File(diretorio);

						// renomeia arquivos com extensão .XLSX
                        arquivosCaixaAlta = file2.listFiles();
                        if (FileUtil.dirHasFiles(diretorio)) {

                            for (File fl: arquivosCaixaAlta) {

                                if(fl.length() < sizeLimit || !fl.getName().toUpperCase().endsWith(".XLSX")){
								//if(fl.length() < sizeLimit ) {                    // processar apenas arquivos MENORES que o limite
                                    try {
										String arquivoDestino = fl.getAbsolutePath().replaceAll("\\.XLSX","_\\.xlsx").toLowerCase();
										if (fl.getAbsolutePath().contains(".XLSX")) {

											File fileDestino = new File(arquivoDestino);
											FileUtil.copyFolder(fl, fileDestino);
											FileUtil.deleteFile(fl);
										}
									}
									catch (Exception xx) {}
								}
							}
						}

                        files = file2.listFiles();
                        emailOic = emailCanal;
                        if (FileUtil.dirHasFiles(diretorio)) {

                            if (FileUtil.dirHasFiles(diretorio)) {
							
								postStatus(servDinamic.toUpperCase(), contabilidade, "Processando", nome.substring(0,nome.indexOf("_#")), "RECEBER", INOUT_ROUTE_ID.substring(0, INOUT_ROUTE_ID.indexOf(".")));

                                for (File fl: files) {
								
									if (fl.getAbsolutePath().toUpperCase().contains("ROTA.TXT")) {

										File arquivoDeploy  = new File("C:/ottimizza/Dropbox/Deploy/routes/" + contabilidade + "/" + nome.substring(0,nome.indexOf("_#")) + "_ContasRecebidasEndpointA.script");
										File arquivoPortal  = new File(RouteEngine.INOUT_HOME + "/contabil/" + contabilidade + "/arquivos/" + nome.substring(0,nome.indexOf("_#")) + "_ContasRecebidasEndpointA.script_RECEBER.txt");

										FileUtil.copyFolder(arquivoDeploy, arquivoPortal);

										continue;
									}

									if (fl.getAbsolutePath().toUpperCase().contains(".SCRIPT")) {

										File arquivoDeploy  = new File("C:/ottimizza/Dropbox/Deploy/routes/" + contabilidade + "/" + nome.substring(0,nome.indexOf("_#")) + "_ContasRecebidasEndpointA.script");

										FileUtil.copyFolder(fl, arquivoDeploy);


										try { 
											FileUtil.deleteFile(fl);
										} catch (Exception XX) {} 


										continue;
									}
									if((fl.length() >= sizeLimit * 5) || (fl.length() >= sizeLimit && fl.getAbsolutePath().toUpperCase().contains(".XLSX"))){                    // processar apenas arquivos MENORES que o limite
                                        arquivoGrande = fl.getName();
                                        // jogar um erro de planilha com o nome do arquivo que eh muito grande!!!!!
                                        jSdir = fl.getAbsolutePath();
                                        jSdir = jSdir.replaceAll("\\\\", "/");
                                        jSdir = cutString(jSdir, 0, jSdir.lastIndexOf("/"));
                                        arquivoGrande = "Arquivo-Grande" + arquivoGrande + "_PAGAR";
                                        // jStatus = new JSONObject();
                                        // putStatus(dirName, "", jStatus, logger);
                                        //     putStatus(jSdir, arquivoGrande/* .replaceAll(" ", "-") */ + ".err", jStatus, logger);
                                    }
                                }
                                for (File fl: files) {
                                    if (arquivoGrande.equals("")) {
                                        try {
										//renomear arquivo que nao possua extensao para (.txt)
										if(fl.isFile() && !fl.getName().contains(".")){
											String flStr = fl.getAbsolutePath()+".txt";
											File flTemp = new File(flStr);
											fl.renameTo(flTemp);
										}

                                        if (fl.isFile() && oicContabil.equals("NAO")) {

                                            //envia email CONTABILIDADE INATIVA (canal,machado)
                                            subject = "Contabilidade INATIVA com arquivos a serem processados";
                                            enviaEmailContabilidadeInativa(getNomeContabilidade(), fl.getName(), nome, subject, emailOic, sendToName, "CONTABILIDADE INATIVA", "AReceber", logger);
                                            //mover para processado arquivo
                                            filename = fl.getAbsolutePath();
                                            filename = filename.replaceAll("\\\\", "/");
                                            FileUtil.moveToDir(filename, diretorio + "/Processado");
                                        }
										else if(fl.isFile() && oicContabil.equals("SIM")){

                                            extensaoArquivo = fl.getName().substring(fl.getName().lastIndexOf(".")).toLowerCase();
                                            if(oicEmpresa.equals("NAO")){

                                                //envia email EMPRESA INATIVA (canal,machado,fechamento)
                                                subject = "Empresa INATIVA com arquivos a serem processados";
                                                emailOic = emailOic + ", " + emailResponsavel;
                                                enviaEmailEmpresaInativa(getNomeContabilidade(), fl.getName(), nome, subject, emailOic, sendToName, "EMPRESA INATIVA", "AReceber", logger);

                                                //mover para processado arquivo
                                                filename = fl.getAbsolutePath();
                                                filename = filename.replaceAll("\\\\", "/");
                                                FileUtil.moveToDir(filename, diretorio + "/Processado");
                                            }else if (extensaoSuportada.contains(extensaoArquivo) && !extensaoArquivo.equals(".xls")) {

                                                //executa a rota
                                                String nomeRota = getNomeContabilidade() + "." + nome.substring(0,nome.indexOf("_#")) + "_ContasRecebidas";
                                                try{

													// executa rota que atualiza os roteiros das empresas
													// RouteEngine.execRoute("Ottimizza.Oud_AtualizacaoRoteiros");



													String rodaPadrao = props.get(nome.substring(0,nome.indexOf("_#")).toUpperCase() + "_PLANILHA_PADRAO_RECEBER");
													String idRoteiro  = props.get(nome.substring(0,nome.indexOf("_#")).toUpperCase() + "_ID_ROTEIRO_RECEBER");
													String codRoteiro  = props.get(nome.substring(0,nome.indexOf("_#")).toUpperCase() + "_ROTEIRO_RECEBER");
													
													logger.logInfo("RPR " + rodaPadrao + " | " + nomeRota);
			
													try {

														if (rodaPadrao.toUpperCase().trim().equals("TRUE")) {															
															//PartnerConnection connection = Connector.newConnection(config);
															//preparaArquivo(idRoteiro, "Contas RECEBIDAS", contabilidade,  nome.substring(0,nome.indexOf("_#")), dirName, connection, logger);
															// PartnerConnection connection = Connector.newConnection(config);  
															preparaArquivo(idRoteiro, "Contas RECEBIDAS", contabilidade,  nome.substring(0,nome.indexOf("_#")), dirName, dirName, config, logger);
  
 
															nomeRota = getNomeContabilidade() + "." + getNomeContabilidade() +  "_ContasRecebidas";
															RouteEngine.execRoute(nomeRota);
														} 


														

														preparaArquivoEspecifico(idRoteiro, "Contas RECEBIDAS", contabilidade,  nome.substring(0,nome.indexOf("_#")), dirName, dirName,  logger);


														StringBuilder txt1 = new StringBuilder();    
														String empresaProperties = dirName + "empresa.properties";
														FileWriter writer = new FileWriter(empresaProperties);
														txt1.append("NOME_EMPRESA = " + nome.substring(0,nome.indexOf("_#")));
														txt1.append("\r\n");
														txt1.append("NOME_CONTABILIDADE = " + contabilidade);
														txt1.append("\r\n");
														txt1.append("MANTEM_ARQUIVO = NAO");
														writer.writeNewFile(txt1.toString());
	 


														File arquivoDeploy  = new File("C:/ottimizza/Dropbox/Deploy/routes/" + getNomeContabilidade() + "/" + nome.substring(0,nome.indexOf("_#")) + "_ContasRecebidasEndpointA.script");
														File eServidor  = new File("C:/inout/docs/processos/producao.txt");
														File arquivoOrigem  = new File(RouteEngine.INOUT_HOME + "/routes/" + getNomeContabilidade() + "/" + nome.substring(0,nome.indexOf("_#")) + "_ContasRecebidasEndpointA.script");
														if(eServidor.exists()) {
															FileUtil.copyFolder(arquivoDeploy, arquivoOrigem);
															arquivoOrigem = new File("C:/ottimizza/Dropbox/Deploy/routes/" + getNomeContabilidade() + "/" + nome.substring(0,nome.indexOf("_#")) + "_ContasRecebidasEndpointA.script");
														}

														arquivoOrigem       = new File(RouteEngine.INOUT_HOME + "/routes/" + getNomeContabilidade() + "/" + nome.substring(0,nome.indexOf("_#")) + "_ContasRecebidasEndpointA.script");
														File arquivoDestino = new File(RouteEngine.INOUT_HOME + "/routes/" + getNomeContabilidade() + "/" + getNomeContabilidade() + "_ContasRecebidasEndpointA.script");

														FileUtil.copyFolder(arquivoOrigem, arquivoDestino);
														nomeRota = getNomeContabilidade() + "." + getNomeContabilidade() +  "_ContasRecebidas";

														int antesRodar =  files.length;
														
														logger.logInfo("RECEBER " + "empresa  = " + nome);

														RouteEngine.execRoute(nomeRota);
														rotasOk = true;

														File fileDepoisLista = new File(diretorio);
														File [] filesDepois = fileDepoisLista.listFiles();
														int depoisRodar =  filesDepois.length;

														if (antesRodar == depoisRodar) {
															String planilhaErro = dirName + nome + "/DePara" + "/empresa_RECEBER.err";
															FileWriter writerErro = new FileWriter(planilhaErro);
															writerErro.writeNewFile(planilhaErro.toString());
															if(fl.exists()) {
																//fl.delete();
																filename = fl.getAbsolutePath();
																filename = filename.replaceAll("\\\\", "/");
																FileUtil.moveToDir(filename, diretorio + "/Processado");
															}
															antesRodar--;
														}
														
														 if (FileUtil.fileExists(dirName + nome + "/DePara" + "/02--Etapa 2 de 4--RECEBER.status")) {
															//criaAvisoErroLayout( dirName + nome + "/DePara" + "/02--Etapa 2 de 4--RECEBER.status", logger);

														}
													}

													catch (Exception xx) {
														logger.logDebug("ERRO AO RODAR ROTEIRO");
													}


                                                }catch(Exception aa){
                                                    subject = "Nao existe integracao de contas Recebidas";

                                                    JSONObject jsNaoExiste = new JSONObject();
                                                    jsNaoExiste.put("NOMECONTABILIDADE", getNomeContabilidade());
                                                    jsNaoExiste.put("SENDTONAME", sendToName);
                                                    jsNaoExiste.put("SUBJECT", subject);
                                                    //jsNaoExiste.put("EMAILRESPONSAVEL", emailResponsavel+",suporte@ottimizza.com.br");
                                                    //if(filename.toUpperCase().contains("OTTIMIZZAF"))
                                                    jsNaoExiste.put("EMAILRESPONSAVEL", "suporte@ottimizza.com.br");
                                                    jsNaoExiste.put("TIPOINTEGRACAO", "Recebidas");
                                                    jsNaoExiste.put("NOMEARQUIVO", fl.getName());
                                                    jsNaoExiste.put("NOMEEMPRESA", nome);

                                                    enviaEmailNaoExisteRota(jsNaoExiste, logger);
                                                    //mover
                                                    filename = fl.getAbsolutePath();
                                                    filename = filename.replaceAll("\\\\", "/");
                                                    FileUtil.moveToDir(filename, diretorio + "/Processado");
                                                }

                                            } else if (extensaoArquivo.equals(".xls")) {
                                                //enviaAvisoSobreArquivo xls
                                                subject = "Arquivo .xls nao suportado por OTTIMIZZA Contabil";
                                                enviaAvisoSobreArquivoErrado(fl.getName(), nome,  subject, emailResponsavel, sendToName, "XLS", "AReceber", logger);

                                                //mover para processado qualquer arquivo
                                                filename = fl.getAbsolutePath();
                                                filename = filename.replaceAll("\\\\", "/");
                                                FileUtil.moveToDir(filename, diretorio + "/Processado");

                                            } else {
                                                //enviaAvisoSobreArquivo outros arquivos
                                                subject = "Arquivo nao suportado por OTTIMIZZA Contabil";
                                                enviaAvisoSobreArquivoErrado(fl.getName(), nome,  subject, emailResponsavel, sendToName, "OUTROS", "AReceber", logger);

                                                //mover para processado qualquer arquivo
                                                filename = fl.getAbsolutePath();
                                                filename = filename.replaceAll("\\\\", "/");
                                                FileUtil.moveToDir(filename, diretorio + "/Processado");
                                            }
                                        }
                                    } catch (Exception eee) {
                                        logger.logError("Erro processando o arquivo " + fl.getAbsolutePath(), eee);
                                    }
                                }else{                  // envia email e move pra processado

                                    subject = "ARQUIVO GRANDE ("+fl.length()/1024/1024+" MiB) -" + getNomeContabilidade() + "-" + empresa + "-" + operacao;
                                    StringBuilder msg = new StringBuilder();
                                    msg.append("<html>\n");
                                    msg.append("<head>\n");
                                    msg.append("</head>\n");
                                    msg.append("<body lang=\"en-US\" dir=\"ltr\">\n");
                                    msg.append("<p><font style=\"font-size: 10pt\">O arquivo \"" + arquivoGrande + "\" muito grande, tamanho maximo permitido para XLSX: (" + sizeLimit/1024/1024 + " Mb).</font></p>\n");
                                    msg.append("</body>\n");
                                    msg.append("</html>\n");

                                    enviaEmail(subject, "suporte@ottimizza.com.br", "TAMANHO ARQUIVO", msg.toString(), null, logger);

                                    filename = fl.getAbsolutePath();
                                    filename = filename.replaceAll("\\\\", "/");
                                    if (!filename.endsWith("/Processado"))
                                        FileUtil.moveToDir(filename, diretorio + "/Processado");

                                }
                            }
                        }
                    }

                    }
                } catch (Exception ee) {
                    logger.logError(ee);
                }
            }

			/*
            ///////////////////////////////////////////////////////////
            // GERA ARQUIVO PARA IMPORTACAO ///////////////////////////
            ///////////////////////////////////////////////////////////
            if (rotasOk) {
                File txtGeraArquivo = new File(String.format("%s\\contabil\\Ottimizza\\GeraArquivo\\Gera_%s.txt", RouteEngine.INOUT_HOME, getNomeContabilidade()));

				String rotaGera = "Ottimizza.GeraArquivoParaImportacao";
				if (!getNomeContabilidade().toUpperCase().equals("ESCRILEX") && 
				    !getNomeContabilidade().toUpperCase().equals("DEPAULA") &&
					!getNomeContabilidade().toUpperCase().equals("RUICADETE")) {
					if(!txtGeraArquivo.exists()) {
						try {
							if (txtGeraArquivo.createNewFile()) {
								logger.logDebug(String.format("Sucessfully created file at '%s'...", txtGeraArquivo.getAbsolutePath()));

								FileWriter writer = new FileWriter(txtGeraArquivo.getAbsolutePath());
								writer.writeNewFile("NOME CONTABILIDADE : " + getNomeContabilidade());

							} else {
								logger.logDebug(String.format("Something went wrong while trying to create file at '%s'...\nMake sure the specified path doesn't already exists!", txtGeraArquivo.getAbsolutePath()));
							}
						} catch(Exception createFileException) {
							logger.logError(String.format("Error trying to create file '%s'", txtGeraArquivo.getAbsolutePath()), createFileException);
						}
					} else {
						logger.logDebug(String.format("File '%s' not created. \nThe file already exists!", txtGeraArquivo.getAbsolutePath()));
					}
				} else {
					rotaGera = toDisplayCase(getNomeContabilidade()) + ".GeraArquivoParaImportacao";
				}
				
                RouteEngine.execRoute(rotaGera);
                rotasOk = false;
            }
			*/
			
        }
    } catch (Exception e) {
        logger.logError(e);
    }

    return records;
}


public JSONObject runEndpointBWorkflow(Object dataIn, InoutLogger logger) throws Exception {
    List list = (List)dataIn;

    // Percorre a lista de objetos
    for (int i=0; i<list.size(); i++) {

        // Obtem objeto de FilaInout
        FilaInout filaInout = (FilaInout)list.get(i);
        String msg = filaInout.getMessage();
        JSONObject record = new JSONObject(msg);
        try {



        } catch (Exception e) {
            filaInout.setStatusCode(InoutConstants.STATUS_TRANSFORMATION_ERROR);
            filaInout.setStatusDesc(e.getMessage());
            logger.logError(e);
        }
    }

    return new JSONObject();
}

/////////////////////////////////////////////////////////////////////////////////////
/////////////////////////enviaAvisoSobreArquivoErrado////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////

private void enviaAvisoSobreArquivoErrado(String filename, String nome, String subject,
                                          String emailResponsavel, String sendToName, String tipoMsg,
                                          String tipo, InoutLogger logger) throws Exception {

    StringBuilder msg = new StringBuilder();
    msg.append("<html>\n")
    .append("<head>\n")
    .append("</head>\n")
    .append("<body lang=\"en-US\" dir=\"ltr\">\n")
    .append("<p><font style=\"font-size: 10pt\">\n")
    .append("<br/>O arquivo<b> ").append(filename)
    .append(" </b>copiado no diretorio<b> ").append(nome)
    .append("/").append(tipo).append("</b>\n")
    .append("<br/>nao pode ser importado pela OTTIMIZZA.");

    if (tipoMsg.equals("XLS")) {
        msg.append("<br/>Favor editar o arquivo e SALVAR COMO extensao .xlsx(planilha de trabalho Excel)\n")
        .append("<br/>Atencao: renomear o arquivo nao funcionara, deve-se edita-lo e salvar como.\n");


    } else if (tipoMsg.equals("OUTRO")) {
        msg.append("<br/>Favor verificar o tipo de arquivo salvo.\n")
        .append("<br/>Atencao: arquivos suportados '.txt', '.xlsx', '.csv', '.dat', '.ofx'\n");
    }

    msg.append("<br/><br/>Atenciosamente,")
    .append("<p><strong>SUPORTE OTTIMIZZA AUTOMACAO CONTABIL</strong>\n")
    .append("<br/>Rua 2 de setembro, 3753, Blumenau-SC \n")
    .append("<br/>+55 (47) 3035-3765 \n")
    .append("<br/>suporte@ottimizza.com.br</p>\n")
    .append("</body>\n")
    .append("</html>\n");

    if (filename.contains("OTTIMIZZA") && !nome.contains("OTTIMIZZAAUTOMACAO")) emailResponsavel = "suporte@ottimizza.com.br";
    enviaEmail(subject, emailResponsavel, sendToName, msg.toString(), null, logger);


}
////////////////////////////////////////////////////////////////////////
////////////////  email Contabilidade Inativa   ////////////////////////
////////////////////////////////////////////////////////////////////////
private void enviaEmailContabilidadeInativa(String contabilidade, String filename, String nome, String subject,
                                            String emailResponsavel, String sendToName, String tipoMsg,
                                            String tipo, InoutLogger logger) throws Exception {

    String emailCanal = emailResponsavel.substring(0,emailResponsavel.indexOf(","));

    StringBuilder msg = new StringBuilder();
    msg.append("<html>\n")
    .append("<head>\n")
    .append("</head>\n")
    .append("<body lang=\"en-US\" dir=\"ltr\">\n")
    .append("<p><font style=\"font-size: 10pt\">\n")
    .append("<br/>Prezado cliente, ")
    .append("<br/><br/>Detectamos que foi enviada planilha da empresa <b>").append(nome)
    .append("</b> para ser processada pela Ottimizza.")
    .append("<br/>No momento o serviço não encontra-se operante.")
    .append("<br/><br/>Pedimos que entre em contato com seu canal de atendimento, atraves do e-mail: ").append(emailCanal);

    msg.append("<br/><br/>Atenciosamente,")
    .append("<p><strong>SUPORTE OTTIMIZZA AUTOMACAO CONTABIL</strong>\n")
    .append("<br/>Rua 2 de setembro, 3753, Blumenau-SC \n")
    .append("<br/>+55 (47) 3035-3765 \n")
    .append("<br/>suporte@ottimizza.com.br</p>\n")
    .append("</body>\n")
    .append("</html>\n");

    enviaEmail(subject, emailResponsavel, sendToName, msg.toString(), null, logger);

}
////////////////////////////////////////////////////////////////////////
////////////////////  email Empresa Inativa   //////////////////////////
////////////////////////////////////////////////////////////////////////
private void enviaEmailEmpresaInativa(String contabilidade,String filename, String nome, String subject,
                                      String emailResponsavel, String sendToName, String tipoMsg,
                                      String tipo, InoutLogger logger) throws Exception {
    String emailCanal = emailResponsavel.substring(0,emailResponsavel.indexOf(","));

    StringBuilder msg = new StringBuilder();
    msg.append("<html>\n")
    .append("<head>\n")
    .append("</head>\n")
    .append("<body lang=\"en-US\" dir=\"ltr\">\n")
    .append("<p><font style=\"font-size: 10pt\">\n")
    .append("<br/>Prezado cliente, ")
    .append("<br/><br/>Detectamos que foi enviada planilha da empresa <b>").append(nome)
    .append("</b> para ser processada pela Ottimizza.")
    .append("<br/>Informamos que a ").append(nome).append(" encontra-se com situacao igual a <b>'inativo'</b> em nosso sistema.")
    .append("<br/><br/>Pedimos que entre em contato com seu canal de atendimento, atraves do e-mail: ").append(emailCanal);

    msg.append("<br/><br/>Atenciosamente,")
    .append("<p><strong>SUPORTE OTTIMIZZA AUTOMACAO CONTABIL</strong>\n")
    .append("<br/>Rua 2 de setembro, 3753, Blumenau-SC \n")
    .append("<br/>+55 (47) 3035-3765 \n")
    .append("<br/>suporte@ottimizza.com.br</p>\n")
    .append("</body>\n")
    .append("</html>\n");
    enviaEmail(subject, emailResponsavel, sendToName, msg.toString(), null, logger);


}
////////////////////////////////////////////////////////////////////////
////////////////////  gera Nome Continuo   /////////////////////////////
////////////////////////////////////////////////////////////////////////
public String geraNomeContinuo(String nomeNormal) throws Exception {

    String nomeContinuo = nomeNormal.toUpperCase();
    nomeContinuo = nomeContinuo.replaceAll("[^A-Z]*", "").trim();
    nomeContinuo = nomeContinuo.replaceAll("ME","");
    nomeContinuo = nomeContinuo.replaceAll("EPP","");
    nomeContinuo = nomeContinuo.replaceAll("LTDA","");
    nomeContinuo = nomeContinuo.replaceAll("EIRELI","");
    nomeContinuo = nomeContinuo.replaceAll("SA","");

    return nomeContinuo;

}


//###############################################################################
/////////////////////////////////////////////////////////////////////////////////
//                              TESTE DE LAYOUT
/////////////////////////////////////////////////////////////////////////////////
/*
valida (valorDocumento, nomeOrigem, contaPortador, dataMovimento, valorDocumento - valorJuros)
utilizada em rotas a Receber e a Pagar
*/

public String validaLayout(String contaMovimento, String nomeOrigem, String documento, String nomePortador,
                           String complemento01, String complemento02, String complemento03,
                           String nomeArquivo, String codCentroCusto, double valorDocumento, double valorDesconto, int cont,
                           String contaPortador, String dataMovimento, String linhasProblema, JSONObject roteiro) throws Exception {
							   							   
    String exemplo  = "";
    String texto    = "";
    String codigoErro = "";

    if(!nomeArquivo.toUpperCase().contains("OTTIMIZZA") || nomeArquivo.toUpperCase().contains("ROTEIRO")){
        if(roteiro.has("erroCabecalho")) codigoErro = roteiro.optString("erroCabecalho");

        if(!codigoErro.equals("06")){
            codigoErro = "";

            if((valorDocumento-valorDesconto) == 0){
                codigoErro      = "01";
                linhasProblema  = "IGNORAR";
            }
            if(valorDocumento   == 0){
                codigoErro      = "02";
                linhasProblema  = "IGNORAR";
            }
            if(nomeOrigem.equals("") && contaMovimento.equals("")){
                codigoErro      = "03";
                linhasProblema  = "";
            }
            if(contaPortador.equals("")){
                codigoErro      = "04";
                linhasProblema  = "IGNORAR";
            }
            if(dataMovimento.equals("") ){
                codigoErro      = "05";
                linhasProblema  = "IGNORAR";
            }

            if(!contaPortador.equals("") && contaPortador.equals(contaMovimento) ){
                codigoErro      = "07";
                linhasProblema  = "";
            }
        }
    }else if(nomeArquivo.toUpperCase().contains("OTTIMIZZA") && !nomeArquivo.toUpperCase().contains("ROTEIRO")){
        if(contaPortador.equals("")) contaPortador = "999333";
        if(contaMovimento.equals("")) contaMovimento = "999333";
    }
    if(codigoErro.equals("01")) texto = "O valor DESCONTO igual ao valor do DOCUMENTO. Exemplo: Linha " + cont + " Fornec/Cliente" + nomeOrigem + " Data " + dataMovimento + " Portador " + nomePortador + "/" + contaPortador;
    if(codigoErro.equals("02")) texto = "O campo VALOR DOCUMENTO = Zero. Exemplo: Linha " + cont + " Fornec/Cliente" + nomeOrigem + " Data " + dataMovimento + " Portador " + nomePortador + "/" + contaPortador;
    if(codigoErro.equals("03")) texto = "Campo FORNEC/CLIENTE em branco. Exemplo: Linha " + cont + ", Data " + dataMovimento + ", Valor " + valorDocumento + ", Portador " + nomePortador + "/" + contaPortador;
    if(codigoErro.equals("04")) texto = "O PORTADOR " + nomePortador + " nao teve conta contabil encontrada. Exemplo: Linha " + cont + " Fornec/Cliente " + nomeOrigem + ", Data " + dataMovimento + ", Valor " + valorDocumento;
    if(codigoErro.equals("05")) texto = "O campo DATA nao econtrado. Exemplo: Linha " + cont + ", Fornec/Cliente " + nomeOrigem + ", Valor " + valorDocumento + ", Portador " + nomePortador + "/" + contaPortador;
    if(codigoErro.equals("06")) {
        linhasProblema  = "IGNORAR";
        texto = "Planilha lida a partir do CABECALHO que nao foi encontrado";
    }
    if(codigoErro.equals("07")) texto = "ATENCAO! Ha lancamentos com conta de CREDITO igual a conta de DEBITO. Exemplo: Linha " + cont + " Fornec/Cliente " + nomeOrigem + " Data " + dataMovimento + " Portador " + nomePortador + "/" + contaPortador;

    exemplo = codigoErro +"|;"+ linhasProblema +"|;"+ texto;
	exemplo = "";	 // NAO e mais uma validacao util, apos o fim do ottimizzaFT. retornando vazio desde 04.10.18
	
    return exemplo;
}

public class ttLayout {
    public String lote;
    public String codErroString;
    public String linhasProblema;
    public String texto;
    public int qtdIgnoradas;
    public String tipoLancamento;

    public ttLayout(){}
    public ttLayout(ttLayout tt){
        lote=tt.lote;
        codErroString=tt.codErroString;
        linhasProblema=tt.linhasProblema;
        texto=tt.texto;
        qtdIgnoradas=tt.qtdIgnoradas;
        tipoLancamento=tt.tipoLancamento;
    }
}



public class ttPortador {
    public String nomePortador;
    public String contaPortador;

    public ttPortador(){}
    public ttPortador(ttPortador tt){
        nomePortador=tt.nomePortador;
        contaPortador=tt.contaPortador;
    }
}

public class ttDePara {
    public String nomeOrigem;
    public String complemento01;
    public String complemento02;
    public String complemento03;
    public String complemento04;
    public String complemento05;
    public String codCentroCusto;
    public String documento;

    public ttDePara(){}
    public ttDePara(ttDePara tt){
        nomeOrigem=tt.nomeOrigem;
        complemento01=tt.complemento01;
        complemento02=tt.complemento02;
        complemento03=tt.complemento03;
        complemento04=tt.complemento04;
        complemento05=tt.complemento05;
        codCentroCusto=tt.codCentroCusto;
        documento=tt.documento;
    }
}


public int getParcelaFinanciamento(String mesAnoAtual, String mesAnoBase, int parcelaInicial, int numeroParcelas) {
    int mesRef = 0;
    int anoRef = 0;
    if(mesAnoBase.charAt(2) == '/'){
        mesRef = Integer.parseInt(mesAnoBase.substring(0,2));
        anoRef = Integer.parseInt(mesAnoBase.substring(3));
    }
    String mesAnoRef = StringUtil.leftPad(String.valueOf(mesRef),2,"0") + "/" + String.valueOf(anoRef);
    if (mesAnoRef.equals(mesAnoAtual)) return parcelaInicial;

    for (int xx = parcelaInicial + 1;xx <= numeroParcelas;xx++) {
        mesRef = mesRef + 1;
        if (mesRef == 13) {
            mesRef = 1;
            anoRef = anoRef + 1;
        }
        mesAnoRef = StringUtil.leftPad(String.valueOf(mesRef),2,"0") + "/" + String.valueOf(anoRef);

        if (mesAnoRef.equals(mesAnoAtual)) return xx;
    }

    return 0;
}

/**
 * Funcao para deletar extratos na tabela IO_EXTRATO pelo LOTE.
 * Retorna uma booleana verdadeira caso consiga apagar os registros.
 *
 * @param nomeArquivo Nome do Arquivo para apagar registros da Base de Dados.
 * @param dbIOCont    Base de Dados para deletar extratos.
 * @param logger      Logger do InoutManager para mostrar informacoes no log.
 *
 * @return            boolean True se conseguir deletar os registros com Lote igual ao nome do arquivo passado.
 */
public boolean limparIOExtrato(String nomeArquivo, DataBase dbIOCont, InoutLogger logger) throws Exception {
    try {
        dbIOCont.delete("IO_EXTRATO")
        .where("LOTE=?")
        .param(nomeArquivo.toUpperCase())
        .execute();
    } catch (Exception e) {
        logger.logError("\nError trying to delete IO_EXTRATO\n\t", e);
        return false;
    }

    return true;
}

/**
 * Funcao para deletar extratos na tabela IO_EXTRATO pelo CODIGO DA EMPRESA.
 * Retorna uma booleana verdadeira caso consiga apagar os registros.
 *
 * @param codEmpresa  Codigo da Empresa para apagar registros da Base de Dados.
 * @param dbIOCont    Base de Dados para deletar extratos.
 * @param logger      Logger do InoutManager para mostrar informacoes no log.
 *
 * @return            boolean True se conseguir deletar os registros com Lote igual ao nome do arquivo passado.
 */
public boolean limparIOExtratoPorEmpresa(String codEmpresa, DataBase dbIOCont, InoutLogger logger) throws Exception {
    try {
        dbIOCont.delete("IO_EXTRATO")
        .where("CODEMPRESA=?")
        .param(codEmpresa)
        .execute();
    } catch (Exception e) {
        logger.logError("\nError trying to delete IO_EXTRATO\n\t", e);
        return false;
    }

    return true;
}

/**
 * Funcao para retornar um Objeto ttMovimentoPadrao baseado nos dados de um Extrato.
 *
 * @param jDados       Dados para criacao do Objeto ttMovimento.
 * @param recMov       Dados do Extratos capturados do Banco de Dados
 * @param logger       InoutLogger.
 *
 * @return             Retorna um Objeto ttMovimento de um Extrato.
 */
public ttMovimentoPadrao getMovimentoExtrato(JSONObject recMov, InoutLogger logger) throws Exception {

    // Inicializacao de Variaveis
    String codEmpresa      = "";  // FORA ok
    String nomeEmpresa     = "";  // FORA ok
    String nomeArquivo     = "";  // FORA ok
    String tipoLancamento  = "";  // FORA ok
    String contaMovimento  = "";  // FORA ok
    String contaPortador   = "";  // FORA ok
    String contLinha       = "";  // FORA ok

    String nomeOrigem      = "";  // INSIDE ok
    String nomePortador    = "";  // INSIDE ok
    String dataMovimento   = "";  // INSIDE ok
    double valorDocumento  = 0.0; // INSIDE ok
    String complemento02   = "";  // INSIDE ok
    String debitoCredito   = "";  // INSIDE ok
    String chaveExtrato    = "";  // INSIDE ok
    String arquivoOriginal = "";  // INSIDE ok

    String dataLote        = "";  // INSIDE ok
    String contLinhaTexto  = "";  // INSIDE ok
    String consolidaClass  = "";  // INSIDE ok
    String classificacao   = "";  // INSIDE ok
    String tipoPlanilha    = "";  // INSIDE ok
    String lote            = "";  // INSIDE ok
    String chave           = "";  // INSIDE ok
    String key             = "";  // INSIDE ok

    // Receber Variaveis Externas
    if(recMov.has("CODEMPRESA"))      codEmpresa     = recMov.optString("CODEMPRESA").trim();
    if(recMov.has("NOMEEMPRESA"))     nomeEmpresa    = recMov.optString("NOMEEMPRESA").trim();
    if(recMov.has("NOMEARQUIVO"))     nomeArquivo    = recMov.optString("NOMEARQUIVO").trim();
    if(recMov.has("TIPOLANCAMENTO"))  tipoLancamento = recMov.optString("TIPOLANCAMENTO").trim();
    if(recMov.has("CONTAMOVIMENTO"))  contaMovimento = recMov.optString("CONTAMOVIMENTO").trim();
    if(recMov.has("CONTAPORTADOR"))   contaPortador  = recMov.optString("CONTAPORTADOR").trim();
    if(recMov.has("CONTLINHATEXTO"))  contLinha      = recMov.optString("CONTLINHATEXTO").trim();

    // Receber JSONObject
    nomeOrigem      = recMov.optString("HISTORICO");
    nomePortador    = recMov.optString("PORTADOR");
    dataMovimento   = recMov.optString("DATAMOVIMENTO");
    valorDocumento  = recMov.optDouble("VALORDOCUMENTO");
    complemento02   = recMov.optString("COMPLEMENTO");
    debitoCredito   = recMov.optString("DEBITOCREDITO");
    chaveExtrato    = recMov.optString("CHAVE");
    arquivoOriginal = recMov.optString("LOTE");
    if (nomeArquivo.equals("")) nomeArquivo = arquivoOriginal;


    contLinhaTexto  = StringUtil.leftPad(contLinha, 06, "0");
    consolidaClass  = contLinhaTexto;

    classificacao   = dataMovimento.replace("/","")+ "9" + consolidaClass;
	logger.logDebug("LENDO DATA EXTRATO "  + nomeOrigem + "<>" + dataMovimento);

    tipoPlanilha    = "EXTRATO-" + nomePortador.trim();
    Date dtLote     = DateUtil.stringToDate(dataMovimento,"dd/MM/yyyy");
    dataLote        = DateUtil.dateToString(dtLote,"yyyy-MM");

    lote  = nomeEmpresa + "_" + codEmpresa + "__" + nomeArquivo  + "__" + dataLote + "_" + tipoLancamento;

    chave = lote + "-EXTRATO-" + contLinha;

    if(chave.length() > 200)  chave = chave.substring(0, 199);

    key  = chave  + "-CTB";

    ttMovimentoPadrao ttMovExtrato = new ttMovimentoPadrao();

    ttMovExtrato.lote              = lote;
    ttMovExtrato.documento         = "";
    ttMovExtrato.codEmpresa        = codEmpresa;
    ttMovExtrato.nomeEmpresa       = nomeEmpresa;
    ttMovExtrato.dataMovimento     = dataMovimento;
    ttMovExtrato.tipoMovimento     = "CTB";
    ttMovExtrato.tipoLancamento    = tipoLancamento;
    ttMovExtrato.historico         = "";
    ttMovExtrato.valorDocumento    = valorDocumento;
    ttMovExtrato.valorDesconto     = 0;
    ttMovExtrato.valorMulta        = 0;
    ttMovExtrato.valorJuros        = 0;
    ttMovExtrato.contaJuros        = "";
    ttMovExtrato.contaMulta        = "";
    ttMovExtrato.contaDesconto     = "";
    ttMovExtrato.nomePortador      = nomePortador;
    ttMovExtrato.centroCusto       = "";
    ttMovExtrato.nomeOrigem        = nomeOrigem;
    ttMovExtrato.cpfCnpj           = "";
    ttMovExtrato.chave             = chave + "-CTB";
    ttMovExtrato.classificacao     = classificacao;
    ttMovExtrato.codFilial         = "";

    ttMovExtrato.complemento01     = nomePortador;
    ttMovExtrato.complemento02     = complemento02;
    ttMovExtrato.complemento03     = "";
    ttMovExtrato.complemento04     = nomeOrigem;
    ttMovExtrato.complemento05     = "";
    ttMovExtrato.complemento06     = "";
    ttMovExtrato.complemento07     = "";
    ttMovExtrato.complemento08     = "";
    ttMovExtrato.complemento09     = "";
    ttMovExtrato.complemento10     = "";
    ttMovExtrato.nomeArquivo       = arquivoOriginal;
    ttMovExtrato.tipoPlanilha      = tipoPlanilha;
    ttMovExtrato.chaveExtrato      = chaveExtrato;
    ttMovExtrato.debitoCredito     = debitoCredito;
    ttMovExtrato.historicoMulta    = "";
    ttMovExtrato.historicoJuros    = "";
    ttMovExtrato.historicoDesconto = "";

    if(tipoLancamento.contains("PAGAR")){
        ttMovExtrato.naturezaContabil  = "D";
        ttMovExtrato.contaDebito       = contaMovimento;
        ttMovExtrato.contaCredito      = contaPortador;
    }

    if(tipoLancamento.contains("RECEBER")){
        ttMovExtrato.naturezaContabil  = "C";
        ttMovExtrato.contaDebito       = contaPortador;
        ttMovExtrato.contaCredito      = contaMovimento;
    }

    ttMovExtrato.contador = 0;
	return ttMovExtrato;
}

/**
 * Funcao para busca de Extratos no Banco de Dados pelo codigo da empresa. Retorna um JSONArray com os Extratos obtidos.
 *
 * @param codEmpresa Codigo da Empresa para busca na table IO_EXTRATO do DataBase.
 * @param dbIOCont   DataBase para realizar a busca de Extratos.
 * @param logger     InoutLogger.
 *
 * @return           JSONArray com Extratos da Empresa passada, caso encontrados. Caso nao encontrando retorna null.
 */
public JSONArray getExtratosEmpresa(String codEmpresa, DataBase dbIOCont, InoutLogger logger) throws Exception {
    JSONArray extratoEmpresa = new JSONArray();

    try {
        extratoEmpresa = dbIOCont.sql("SELECT CHAVE,CODEMPRESA, DATAMOVIMENTO, PORTADOR, HISTORICO, LOTE, COMPLEMENTO, VALORDOCUMENTO, DEBITOCREDITO, EXTRATOLIDO FROM IO_EXTRATO WHERE CODEMPRESA = ?")
        .fields("CHAVE,CODEMPRESA, DATAMOVIMENTO, PORTADOR, HISTORICO, LOTE, COMPLEMENTO, VALORDOCUMENTO, DEBITOCREDITO, EXTRATOLIDO")
        .param(codEmpresa)
        .query();
    } catch(Exception e) {
        logger.logError("Error: ", e);
        return null;
    }

    return extratoEmpresa;
}

/* ##################################################################################################### @EXTRATO-OFX ##
Leitura de Planilha Padrão EXTRATO - OFX
## ################################################################################################################## */
public boolean readOFXDefault(MemoryFile memFile, JSONObject jDados, DataBase dbIOCont, InoutLogger logger) throws Exception {

    JSONObject extratoEmpresa = new JSONObject();

    // Inicializacao de Variaveis
    String codEmpresa        = "";
    String nomeArquivo       = "";
    String chaveExtrato      = "";
    String nomeEmpresa       = "";

    String documento         = "";
    String nomeOrigem        = "";
    String nomePortador      = "";
    String dataMovimento     = "";
    String dataLote          = "";
    String complemento01     = "";
    String complemento02     = "";
    String complemento03     = "";
    String complemento04     = "";
    String complemento05     = "";
    String complemento06     = "";
    String complemento07     = "";
    String complemento08     = "";
    String complemento09     = "";
    String complemento10     = "";
    String debitoCredito     = "";
    String cpfCnpj           = "";
    String historico         = "";

    String strValorDocumento = "";
    String contLinhaExtrato  = "";

    double valorDocumento    = 0.0;
    double valorJuros        = 0.0;
    double valorDesconto     = 0.0;
    double valorMulta        = 0.0;
    double valorPagamento    = 0.0;

	boolean leDocumento = false;
	boolean leDocumentoFitId = false;
    if(jDados.has("CODEMPRESA"))   codEmpresa   = jDados.optString("CODEMPRESA").trim();
    if(jDados.has("NOMEARQUIVO"))  nomeArquivo  = jDados.optString("NOMEARQUIVO").trim();
	if(jDados.has("NOMEEMPRESA"))  nomeEmpresa  = jDados.optString("NOMEEMPRESA").trim();
    if(jDados.has("CHECKNUM"))     leDocumento = true;
    if(jDados.has("FITID"))     leDocumentoFitId = true;


    while (memFile.hasNextLine()) {
        try {
            String line = memFile.nextLine();
            line = StringUtil.removeSpecialCharsToUC(line);

            // Limpa todas as variaveis
            if (line.contains("<STMTTRN>")) {
                complemento02   = "";
                complemento03   = "";
                complemento04   = "";
                complemento05   = "";

                complemento06   = "";
                complemento07   = "";
                complemento08   = "";
                complemento09   = "";
                complemento10   = "";

                cpfCnpj         = "";

                nomeOrigem      = "";
                documento       = "";
                historico       = "";

                valorDocumento  = 0;
                valorJuros      = 0;
                valorDesconto   = 0;
                valorMulta      = 0;
                valorPagamento  = 0;
            }

            // Retorna nomePortador
            //     complemento01 = nomePortador
            if (line.contains("<ACCTID>")) {
                nomePortador  = line.substring(line.indexOf("<ACCTID>")+8);
                nomePortador  = nomePortador.replaceAll("</ACCTID>","");
                complemento01 = nomePortador;
            }

            // Retorna String data -> "dd/MM/yyyy|MM-yyyy".
            //     Pega dataMovimento e dataLote
            if (line.contains("<DTPOSTED>")) {
                String dtPosted = line.substring(line.indexOf("<DTPOSTED>")+10);
                dataMovimento   = dtPosted.substring(6,8) + "/" +  dtPosted.substring(4,6) + "/" + dtPosted.substring(0,4);

                try {
                    Date dt       = DateUtil.stringToDate(dataMovimento, "dd/MM/yyyy");
                    dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                    dataLote      = DateUtil.dateToString(dt, "yyyy-MM");
                } catch (Exception dt1) {
                    dataMovimento = "";
                }
            }

            // Retorna String ValorDocumento -> "1234.56|EXTRATO-????" -> ???? = Credito/Debito.
            //     Pega Valor Documento e debitoCredito
            //     complemento02 = debitoCredito
            if (line.contains("<TRNAMT>")) {
                strValorDocumento = line.substring(line.indexOf("<TRNAMT>")+8);
                strValorDocumento = strValorDocumento.replaceAll("</TRNAMT>","");
                try {
                    valorDocumento = DecimalUtil.toDecimal(strValorDocumento);
                } catch(Exception e) {
                    valorDocumento = 0;
                }

                if(valorDocumento < 0) debitoCredito = "EXTRATO-DEBITO";
                if(valorDocumento > 0) debitoCredito = "EXTRATO-CREDITO";

                valorDocumento = Math.abs(valorDocumento);
            }

			if (leDocumento && line.contains("<CHECKNUM>")) {
				complemento01   = line.substring(line.indexOf("<CHECKNUM>")+10);
                complemento01   = complemento01.replaceAll("</CHECKNUM>","");
			}else if (leDocumento && line.contains("<REFNUM>")) {
				complemento01   = line.substring(line.indexOf("<REFNUM>")+8);
                complemento01   = complemento01.replaceAll("</REFNUM>","");
			}

			if (leDocumentoFitId && line.contains("<FITID>")) {
				//complemento01   = line.substring(line.indexOf("<FITID>")+7);
				complemento01   = cutString(line, "<FITID>");
                complemento01   = complemento01.replaceAll("</FITID>","");
			}


            // Retorna Nome Origem
            if (line.contains("<MEMO>")) {
                nomeOrigem   = nomeOrigem + " " + line.substring(line.indexOf("<MEMO>")+6);
                nomeOrigem   = nomeOrigem.replaceAll("</MEMO>","");
            }  
			
			if (!line.contains("</STMTTRN>")) continue;
			
			if (valorDocumento == 0) continue;

			
			if(codEmpresa.equals("8") && nomeEmpresa.contains("Institutoelo") &&
			(nomeOrigem.contains("CHEQUE")||nomeOrigem.contains("PAG") && nomeOrigem.contains("BOLETO")))
				nomeOrigem = nomeOrigem + " " + complemento01;
            
            contLinhaExtrato = StringUtil.leftPad(String.valueOf(memFile.getCurrentIndex()), 05, "0");

            // Gerar Chave Extrato;
            chaveExtrato = codEmpresa + "-" +  dataMovimento + "-" + debitoCredito + "-" + String.format("%.2f", valorDocumento) + "-" + nomePortador + "-" + contLinhaExtrato;


            // Buscar Extrato por Chave na Tabela IO_EXTRATO.
            extratoEmpresa = dbIOCont.sql("SELECT CHAVE FROM IO_EXTRATO WHERE CHAVE = ?")
            .fields("CHAVE")
            .param(chaveExtrato)
            .queryUnique();

            // Inserir caso Chave nao encontrada.
            if (extratoEmpresa == null || !extratoEmpresa.has("CHAVE")) {
                try {
                    dbIOCont.insert("IO_EXTRATO")
                    .fields("CHAVE,CODEMPRESA, DATAMOVIMENTO, PORTADOR, HISTORICO, LOTE, COMPLEMENTO, VALORDOCUMENTO, DEBITOCREDITO, EXTRATOLIDO")
                    .param(chaveExtrato)
                    .param(codEmpresa)
                    .param(dataMovimento)
                    .param(nomePortador)
                    .param(nomeOrigem)
                    .param(nomeArquivo.toUpperCase())
                    .param(complemento01)
                    .param(valorDocumento)
                    .param(debitoCredito)
                    .param(0)
                    .execute();
                } catch(Exception e) {
                    logger.logError("Error inserting to IO_EXTRATO", e);
                    continue;
                }
                // Atualizar Chave caso encontrada.
            } else {
                try {
                    dbIOCont.update("IO_EXTRATO")
                    .fields("EXTRATOLIDO")
                    .where("CHAVE = ? ")
                    .param(0)
                    .param(chaveExtrato)
                    .execute();
                } catch(Exception e1) {
                    logger.logError("Error updating IO_EXTRATO", e1);
                    continue;
                }
            }
        } catch(Exception e) {
            logger.logError("ERRO: ", e);
        }
    }

    return true;
}

/* #################################################################################################### @EXTRATO-ITAU ##
Leitura de Planilha Padrão EXTRATO - ITAU
## ################################################################################################################## */
public boolean readExtratoItauDefault(MemoryFile memFile, String anoData, String tipoExtrato, String nomePortador, JSONObject jDados, DataBase dbIOCont, InoutLogger logger) throws Exception {

    JSONObject extratoEmpresa = new JSONObject();

    // Inicializacao de Variaveis
    String codEmpresa        = "";
    String nomeArquivo       = "";
    String chaveExtrato      = "";

    String documento         = "";
    String nomeOrigem        = "";
    String dataMovimento     = "";
    String dataLote          = "";
    String complemento01     = "";
    String complemento02     = "";
    String complemento03     = "";
    String complemento04     = "";
    String complemento05     = "";
    String complemento06     = "";
    String complemento07     = "";
    String complemento08     = "";
    String complemento09     = "";
    String complemento10     = "";
    String debitoCredito     = "";
    String cpfCnpj           = "";
    String historico         = "";

    String strValorDocumento = "";
    String contLinhaExtrato  = "";

    double valorDocumento    = 0.0;
    double valorJuros        = 0.0;
    double valorDesconto     = 0.0;
    double valorMulta        = 0.0;
    double valorPagamento    = 0.0;

    if(jDados.has("CODEMPRESA"))   codEmpresa   = jDados.optString("CODEMPRESA").trim();
    if(jDados.has("NOMEARQUIVO"))  nomeArquivo  = jDados.optString("NOMEARQUIVO").trim();

    while (memFile.hasNextLine()) {

        try {
            String line = memFile.nextLine();
            line = StringUtil.removeSpecialCharsToUC(line);


            complemento01   = nomePortador;
            complemento02   = "";
            complemento03   = "";
            complemento04   = "";
            complemento05   = "";

            complemento06   = "";
            complemento07   = "";
            complemento08   = "";
            complemento09   = "";
            complemento10   = "";

            cpfCnpj         = "";

            nomeOrigem      = "";
            documento       = "";
            historico       = "";

            valorDocumento  = 0;
            valorJuros      = 0;
            valorDesconto   = 0;
            valorMulta      = 0;
            valorPagamento  = 0;
            dataMovimento = "";

            try {
                Date dt = memFile.getDateField(1);
                dataMovimento = DateUtil.dateToString(dt, "dd/MM");
                dataLote = DateUtil.dateToString(dt, "yyyy-MM");
            } catch (Exception dt1) {
                try {
                    Date dt = memFile.getDateField(1, "dd/MM/yyyy");    // --- VERIFICAR
                    dataMovimento = DateUtil.dateToString(dt, "dd/MM");
                    dataLote = DateUtil.dateToString(dt, "yyyy-MM");
                } catch (Exception dt2) {
                    dataMovimento = memFile.getStringFieldRemoveEspCharsUpper(1).trim();
                    if(dataMovimento.length() >= 5) dataMovimento = dataMovimento.substring(0, 5);
                }
            }

            dataMovimento = dataMovimento + "/" + anoData;

            try {
                Date dt = DateUtil.stringToDate(dataMovimento, "dd/MM/yyyy");
            } catch (Exception dateException) {
                continue;
            }

            if (tipoExtrato.equals("TIPO01")) {
                try {
                    valorDocumento = memFile.getDoubleField(5);
                } catch(Exception e) {
                    valorDocumento = 0;
                }
            }

            if (tipoExtrato.equals("TIPO02")) {
                try {
                    valorDocumento = memFile.getDoubleField(6);
                } catch(Exception e) {
                    valorDocumento = 0;
                }
                complemento02 = memFile.getStringFieldRemoveEspCharsUpper(5);
            }
            if(valorDocumento < 0) debitoCredito = "EXTRATO-DEBITO";
            if(valorDocumento > 0) debitoCredito = "EXTRATO-CREDITO";
            valorDocumento = Math.abs(valorDocumento);

            if (valorDocumento == 0) continue;

            nomeOrigem    = memFile.getStringFieldRemoveEspCharsUpper(4);
			if (tipoExtrato.equals("TIPO01") && !memFile.getStringFieldRemoveEspCharsUpper(8).equals("")) {
				nomeOrigem    = memFile.getStringFieldRemoveEspCharsUpper(8);
				complemento02 = memFile.getStringFieldRemoveEspCharsUpper(4);
			}

            contLinhaExtrato = StringUtil.leftPad(String.valueOf(memFile.getCurrentIndex()), 05, "0");
            chaveExtrato = codEmpresa + "-" +  dataMovimento + "-" + debitoCredito + "-" + String.format("%.2f", valorDocumento) + "-" + nomePortador + "-" + contLinhaExtrato;

            // Buscar Extrato por Chave na Tabela IO_EXTRATO.
            extratoEmpresa = dbIOCont.sql("SELECT CHAVE FROM IO_EXTRATO WHERE CHAVE = ?")
            .fields("CHAVE")
            .param(chaveExtrato)
            .queryUnique();

            // Inserir caso Chave nao encontrada.
            if (extratoEmpresa == null || !extratoEmpresa.has("CHAVE")) {
                try {
                    dbIOCont.insert("IO_EXTRATO")
                    .fields("CHAVE,CODEMPRESA, DATAMOVIMENTO, PORTADOR, HISTORICO, LOTE, COMPLEMENTO, VALORDOCUMENTO, DEBITOCREDITO, EXTRATOLIDO")
                    .param(chaveExtrato)
                    .param(codEmpresa)
                    .param(dataMovimento)
                    .param(nomePortador)
                    .param(nomeOrigem)
                    .param(nomeArquivo.toUpperCase())
                    .param(complemento02)
                    .param(valorDocumento)
                    .param(debitoCredito)
                    .param(0)
                    .execute();
                } catch(Exception e) {
                    logger.logError("Error inserting to IO_EXTRATO", e);
                    continue;
                }
                // Atualizar Chave caso encontrada.
            } else {
                try {
                    dbIOCont.update("IO_EXTRATO")
                    .fields("EXTRATOLIDO")
                    .where("CHAVE = ? ")
                    .param(0)
                    .param(chaveExtrato)
                    .execute();
                } catch(Exception e1) {
                    logger.logError("Error updating IO_EXTRATO", e1);
                    continue;
                }
            }
        } catch(Exception e) {
            logger.logError("ERRO: ", e);
        }
    }

    return true;
}

/* ################################################################################################ @EXTRATO-BRADESCO ##
                                        Leitura de Planilha Padrão EXTRATO - BRADESCO
                                        ## ################################################################################################################## */
public boolean readExtratoBradescoDefault(MemoryFile memFile, String nomePortador, JSONObject jDados, DataBase dbIOCont, InoutLogger logger) throws Exception {

    JSONObject extratoEmpresa = new JSONObject();

    // Inicializacao de Variaveis
    String codEmpresa        = "";
    String nomeArquivo       = "";
    String chaveExtrato      = "";

    String documento         = "";
    String nomeOrigem        = "";
    String dataMovimento     = "";
    String dataLote          = "";
    String complemento01     = "";
    String complemento02     = "";
    String complemento03     = "";
    String complemento04     = "";
    String complemento05     = "";
    String complemento06     = "";
    String complemento07     = "";
    String complemento08     = "";
    String complemento09     = "";
    String complemento10     = "";
    String debitoCredito     = "";
    String cpfCnpj           = "";
    String historico         = "";

    String strValorDocumento = "";
    String contLinhaExtrato  = "";

    double valorDocumento    = 0.0;
    double valorJuros        = 0.0;
    double valorDesconto     = 0.0;
    double valorMulta        = 0.0;
    double valorPagamento    = 0.0;

    boolean naoLeMais = false;

    if(jDados.has("CODEMPRESA"))   codEmpresa   = jDados.optString("CODEMPRESA").trim();
    if(jDados.has("NOMEARQUIVO"))  nomeArquivo  = jDados.optString("NOMEARQUIVO").trim();

    while (memFile.hasNextLine()) {

        try {
            String line = memFile.nextLine();
            line = StringUtil.removeSpecialCharsToUC(line);

            complemento01   = nomePortador;
            complemento02   = "";
            complemento03   = "";
            complemento04   = "";
            complemento05   = "";

            complemento06   = "";
            complemento07   = "";
            complemento08   = "";
            complemento09   = "";
            complemento10   = "";

            cpfCnpj         = "";

            nomeOrigem      = "";
            documento       = "";
            historico       = "";

            valorDocumento  = 0;
            valorJuros      = 0;
            valorDesconto   = 0;
            valorMulta      = 0;
            valorPagamento  = 0;

            if(line.contains("ULTIMOS") && line.contains("LANCAMENTOS")) naoLeMais = true;

            if (memFile.getStringField(0).equals("")) continue;
            try {
                Date dt = memFile.getDateField(0);
                dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                dataLote = DateUtil.dateToString(dt, "yyyy-MM");
            } catch (Exception dt1) {
                try {
                    Date dt = memFile.getDateField(0, "dd/MM/yyyy");    // --- VERIFICAR
                    dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                    dataLote = DateUtil.dateToString(dt, "yyyy-MM");
                } catch (Exception dt2) {
                    continue;
                }
            }

            try {
                valorDocumento = Math.abs(memFile.getDoubleField(3));
            } catch(Exception e) {
                valorDocumento = 0;
            }
            if (valorDocumento > 0) debitoCredito = "EXTRATO-CREDITO";
            else {
                try {
                    valorDocumento = Math.abs(memFile.getDoubleField(4));
                } catch(Exception e) {
                    valorDocumento = 0;
                }

                if(valorDocumento > 0) debitoCredito = "EXTRATO-DEBITO"; else continue;
            }


            nomeOrigem    = memFile.getStringFieldRemoveEspCharsUpper(1);
            complemento02 = memFile.getStringFieldRemoveEspCharsUpper(2);


            if(naoLeMais) continue;

            contLinhaExtrato = StringUtil.leftPad(String.valueOf(memFile.getCurrentIndex()), 05, "0");
            chaveExtrato = codEmpresa + "-" +  dataMovimento + "-" + debitoCredito + "-" + String.format("%.2f", valorDocumento) + "-" + nomePortador + "-" + contLinhaExtrato;

            // Buscar Extrato por Chave na Tabela IO_EXTRATO.
            extratoEmpresa = dbIOCont.sql("SELECT CHAVE FROM IO_EXTRATO WHERE CHAVE = ?")
            .fields("CHAVE")
            .param(chaveExtrato)
            .queryUnique();

            // Inserir caso Chave nao encontrada.
            if (extratoEmpresa == null || !extratoEmpresa.has("CHAVE")) {
                try {
                    dbIOCont.insert("IO_EXTRATO")
                    .fields("CHAVE,CODEMPRESA, DATAMOVIMENTO, PORTADOR, HISTORICO, LOTE, COMPLEMENTO, VALORDOCUMENTO, DEBITOCREDITO, EXTRATOLIDO")
                    .param(chaveExtrato)
                    .param(codEmpresa)
                    .param(dataMovimento)
                    .param(nomePortador)
                    .param(nomeOrigem)
                    .param(nomeArquivo.toUpperCase())
                    .param(complemento02)
                    .param(valorDocumento)
                    .param(debitoCredito)
                    .param(0)
                    .execute();
                } catch(Exception e) {
                    logger.logError("Error inserting to IO_EXTRATO", e);
                    continue;
                }
                // Atualizar Chave caso encontrada.
            } else {
                try {
                    dbIOCont.update("IO_EXTRATO")
                    .fields("EXTRATOLIDO")
                    .where("CHAVE = ? ")
                    .param(0)
                    .param(chaveExtrato)
                    .execute();
                } catch(Exception e1) {
                    logger.logError("Error updating IO_EXTRATO", e1);
                    continue;
                }
            }
        } catch(Exception e) {
            logger.logError("ERRO: ", e);
        }
    }

    return true;
}


/* ################################################################################################ @EXTRATO-UNICRED ##
Leitura de Planilha Padrão EXTRATO - UNICRED
## ################################################################################################################## */
public boolean readExtratoUnicredDefault(MemoryFile memFile, String nomePortador, JSONObject jDados, DataBase dbIOCont, InoutLogger logger) throws Exception {

    JSONObject extratoEmpresa = new JSONObject();

    // Inicializacao de Variaveis
    String codEmpresa        = "";
    String nomeArquivo       = "";
    String chaveExtrato      = "";

    String documento         = "";
    String nomeOrigem        = "";
    String dataMovimento     = "";
    String dataLote          = "";
    String complemento01     = "";
    String complemento02     = "";
    String complemento03     = "";
    String complemento04     = "";
    String complemento05     = "";
    String complemento06     = "";
    String complemento07     = "";
    String complemento08     = "";
    String complemento09     = "";
    String complemento10     = "";
    String debitoCredito     = "";
    String cpfCnpj           = "";
    String historico         = "";

    String strValorDocumento = "";
    String contLinhaExtrato  = "";

    double valorDocumento    = 0.0;
    double valorJuros        = 0.0;
    double valorDesconto     = 0.0;
    double valorMulta        = 0.0;
    double valorPagamento    = 0.0;

    boolean naoLeMais = false;

    if(jDados.has("CODEMPRESA"))   codEmpresa   = jDados.optString("CODEMPRESA").trim();
    if(jDados.has("NOMEARQUIVO"))  nomeArquivo  = jDados.optString("NOMEARQUIVO").trim();

    while (memFile.hasNextLine()) {

        try {
            String line = memFile.nextLine();
            line = StringUtil.removeSpecialCharsToUC(line);

            complemento01   = nomePortador;
            complemento02   = "";
            complemento03   = "";
            complemento04   = "";
            complemento05   = "";

            complemento06   = "";
            complemento07   = "";
            complemento08   = "";
            complemento09   = "";
            complemento10   = "";

            cpfCnpj         = "";

            nomeOrigem      = "";
            documento       = "";
            historico       = "";

            valorDocumento  = 0;
            valorJuros      = 0;
            valorDesconto   = 0;
            valorMulta      = 0;
            valorPagamento  = 0;

            if(line.replaceAll(" ","").contains("LIMITEDECREDITO")) naoLeMais = true;

            if(naoLeMais) continue;
              try {
                Date dt = memFile.getDateField(1);
                dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                dataLote = DateUtil.dateToString(dt, "yyyy-MM");
            } catch (Exception dt1) {
                try {
                    Date dt = memFile.getDateField(1, "dd/MM/yyyy");
                    dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                    dataLote = DateUtil.dateToString(dt, "yyyy-MM");
                } catch (Exception dt2) {
                    continue;
                }
            }

            try {
                valorDocumento = memFile.getDoubleField(4);
            } catch(Exception e) {
                continue;
            }
            
            if (valorDocumento < 0){
                debitoCredito = "EXTRATO-DEBITO";
            }else if (valorDocumento > 0){
                debitoCredito = "EXTRATO-CREDITO";
            }
            valorDocumento = Math.abs(valorDocumento);
            if(valorDocumento == 0) continue;

            nomeOrigem    = memFile.getStringFieldRemoveEspCharsUpper(3);
            complemento01 = nomeArquivo;

            contLinhaExtrato = StringUtil.leftPad(String.valueOf(memFile.getCurrentIndex()), 05, "0");
            chaveExtrato = codEmpresa + "-" +  dataMovimento + "-" + debitoCredito + "-" + String.format("%.2f", valorDocumento) + "-" + nomePortador + "-" + contLinhaExtrato;

            // Buscar Extrato por Chave na Tabela IO_EXTRATO.
            extratoEmpresa = dbIOCont.sql("SELECT CHAVE FROM IO_EXTRATO WHERE CHAVE = ?")
            .fields("CHAVE")
            .param(chaveExtrato)
            .queryUnique();

            // Inserir caso Chave nao encontrada.
            if (extratoEmpresa == null || !extratoEmpresa.has("CHAVE")) {
                try {
                    dbIOCont.insert("IO_EXTRATO")
                    .fields("CHAVE,CODEMPRESA, DATAMOVIMENTO, PORTADOR, HISTORICO, LOTE, COMPLEMENTO, VALORDOCUMENTO, DEBITOCREDITO, EXTRATOLIDO")
                    .param(chaveExtrato)
                    .param(codEmpresa)
                    .param(dataMovimento)
                    .param(nomePortador)
                    .param(nomeOrigem)
                    .param(nomeArquivo.toUpperCase())
                    .param(complemento02)
                    .param(valorDocumento)
                    .param(debitoCredito)
                    .param(0)
                    .execute();
                } catch(Exception e) {
                    logger.logError("Error inserting to IO_EXTRATO", e);
                    continue;
                }
                // Atualizar Chave caso encontrada.
            } else {
                try {
                    dbIOCont.update("IO_EXTRATO")
                    .fields("EXTRATOLIDO")
                    .where("CHAVE = ? ")
                    .param(0)
                    .param(chaveExtrato)
                    .execute();
                } catch(Exception e1) {
                    logger.logError("Error updating IO_EXTRATO", e1);
                    continue;
                }
            }
        } catch(Exception e) {
            logger.logError("ERRO: ", e);
        }
    }

    return true;
}


/* ################################################################################################ @EXTRATO-REDECARD ##
                                        Leitura de Planilha Padrão EXTRATO - BRADESCO
                                        ## ################################################################################################################## */
public HashMap readCartaoRedecardDefault(MemoryFile memFile, JSONObject jDados, HashMap mapaVariavel, InoutLogger logger) throws Exception {

    JSONObject extratoEmpresa = new JSONObject();

    // Inicializacao de Variaveis
    // Inicializacao de Variaveis
    String codFilial         = "";
    String nomeEmpresa       = "";
    String nomeArquivo       = "";

    String codEmpresa        = "";
    String chaveExtrato      = "";

    String documento         = "";
    String nomeOrigem        = "";
    String nomePortador      = "";
    String dataMovimento     = "";
    String dataRecebimento   = "";
    String dataLote          = "";
    String complemento01     = "";
    String complemento02     = "";
    String complemento03     = "";
    String complemento04     = "";
    String complemento05     = "";
    String complemento06     = "";
    String complemento07     = "";
    String complemento08     = "";
    String complemento09     = "";
    String complemento10     = "";
    String debitoCredito     = "";
    String cpfCnpj           = "";
    String historico         = "";

    String strValorDocumento = "";
    String contLinhaExtrato  = "";

    double valorDocumento    = 0.0;
    double valorJuros        = 0.0;
    double valorDesconto     = 0.0;
    double valorMulta        = 0.0;
    double valorPagamento    = 0.0;
    double valorLiquido      = 0.0;
    int    cont              = 0;
    String tipoVenda         = "";

    String tipoLancamento    = "";
    String tipoPlanilha      = "EXTRATO-REDECARD";
    String chave             = "";
    String key               = "";
    String lote              = "";

    String consolidaClass    = "";
    String classificacao     = "";

    // Indices para planilha xlsx/csv.
    int idocumento      =  -1;
    int ivalorDocumento =  -1;
    int ivalorPagamento =  -1;

    boolean naoLeMais = false;

    if(jDados.has("CODEMPRESA"))      codEmpresa      = jDados.optString("CODEMPRESA").trim();
    if(jDados.has("NOMEEMPRESA"))     nomeEmpresa     = jDados.optString("NOMEEMPRESA").trim();
    if(jDados.has("NOMEARQUIVO"))     nomeArquivo     = jDados.optString("NOMEARQUIVO").trim();
    if(jDados.has("TIPOLANCAMENTO"))  tipoLancamento  = jDados.optString("TIPOLANCAMENTO").trim();

    while (memFile.hasNextLine()) {

        try {
            String line = memFile.nextLine();
            line = StringUtil.removeSpecialCharsToUC(line);

            if (line.startsWith("VENDAS COM CARTOES DE CREDITO")) {
                tipoPlanilha = "REDECARD-CREDITO";
                continue;
            }
            if (line.startsWith("VENDAS COM CARTOES DE DEBITO")) {
                tipoPlanilha = "REDECARD-DEBITO";
                continue;
            }

            if (line.startsWith("MOVIMENTO FINANCEIRO")) {
                tipoPlanilha = "REDECARD-FINANCEIRO";
                continue;
            }
            if (tipoPlanilha.contains("REDECARD") && line.startsWith("LANCAMENTOS FUTUROS")) {
                naoLeMais = true;
                continue;
            }
            if (naoLeMais) continue;

            cont++;

            if (tipoPlanilha.equals("REDECARD-CREDITO")) {
                if (line.contains("VENDA") && line.contains("BRUTO") && line.contains("VENDA") && line.contains("LIQUIDO") && line.contains("RECEBIM")) {
                    ivalorDocumento = line.indexOf("BRUTO")-5;
                    ivalorPagamento = line.indexOf("LIQUIDO")-5;
                    continue;

                }

                if (line.length() < 87) continue;

                complemento01   = "";
                complemento02   = "";
                complemento03   = "";
                complemento04   = "";
                complemento05   = "";

                complemento06   = "";
                complemento07   = "";
                complemento08   = "";
                complemento09   = "";
                complemento10   = "";

                cpfCnpj         = "";

                nomeOrigem      = "";
                documento       = "";
                nomePortador    = "";
                historico       = "";

                valorDocumento  = 0;
                valorJuros      = 0;
                valorDesconto   = 0;
                valorMulta      = 0;
                valorPagamento  = 0;
                valorLiquido    = 0;
                dataMovimento   = "";

                if (line.substring(48,60).contains("A VISTA")) {
                    tipoVenda = "A VISTA";


                    nomeOrigem = line.substring(38, 42).trim();
                    dataMovimento = line.substring(0, 8).trim();
                    try {
                        Date dt = DateUtil.stringToDate(dataMovimento, "dd/MM/yy");
                        dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                        dataLote = DateUtil.dateToString(dt, "yyyy-MM");
                    } catch (Exception dt1) {
                        continue;
                    }

                    String valorString = line.substring(ivalorDocumento,ivalorDocumento+12).trim();
                    valorString = valorString.replaceAll("\\.","");
                    try {
                        valorDocumento = DecimalUtil.toDecimal(valorString);
                    }
                    catch (Exception xx) {
                        valorDocumento = 0;
                        continue;
                    }

                    dataRecebimento = line.substring(9, 17).trim();
                    try {
                        Date dt = DateUtil.stringToDate(dataRecebimento, "dd/MM/yy");
                        dataRecebimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                    } catch (Exception dt1) {
                        dataRecebimento = "";
                    }

                    if (line.length() > 110) {
                        valorString = line.substring(ivalorPagamento).trim();
                        valorString = valorString.replaceAll("\\.","");
                        try {
                            valorLiquido = DecimalUtil.toDecimal(valorString);
                        }
                        catch (Exception xx) {
                            valorLiquido = 0;
                        }
                    }
                }

                if (line.substring(48,66).contains("PARC.ESTAB")) {
                    tipoVenda = "PARCELADO";

                    nomeOrigem = line.substring(38, 42).trim();
                    dataMovimento = line.substring(0, 8).trim();
                    try {
                        Date dt = DateUtil.stringToDate(dataMovimento, "dd/MM/yy");
                        dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                        dataLote = DateUtil.dateToString(dt, "yyyy-MM");
                    } catch (Exception dt1) {
                        continue;
                    }

                    documento      = line.substring(29, 39).trim();

                    String valorString = line.substring(ivalorDocumento,ivalorDocumento+12).trim();
                    valorString = valorString.replaceAll("\\.","");
                    try {
                        valorDocumento = DecimalUtil.toDecimal(valorString);
                    }
                    catch (Exception xx) {
                        valorDocumento = 0;
                        continue;
                    }

                    dataRecebimento = line.substring(9, 17).trim();
                    try {
                        Date dt = DateUtil.stringToDate(dataRecebimento, "dd/MM/yy");
                        dataRecebimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                    } catch (Exception dt1) {
                        dataRecebimento = "";
                    }

                    if (line.length() > 110) {
                        valorString = line.substring(ivalorPagamento).trim();
                        valorString = valorString.replaceAll("\\.","");
                        try {
                            valorLiquido = DecimalUtil.toDecimal(valorString);
                        }
                        catch (Exception xx) {
                            valorLiquido = 0;
                        }
                    }
                }

            }

            if (tipoPlanilha.equals("REDECARD-DEBITO")) {
                if (line.contains("VENDA") && line.contains("BRUTO") && line.contains("LIQUIDO") && line.contains("RECEBIM")) {
                    ivalorDocumento = line.indexOf("BRUTO")-5;
                    ivalorPagamento = line.indexOf("LIQUIDO")-5;
                    continue;

                }

                if (line.length() < 87) continue;

                complemento01   = "";
                complemento02   = "";
                complemento03   = "";
                complemento04   = "";
                complemento05   = "";

                complemento06   = "";
                complemento07   = "";
                complemento08   = "";
                complemento09   = "";
                complemento10   = "";

                cpfCnpj         = "";

                nomeOrigem      = "";
                documento       = "";
                nomePortador    = "";
                historico       = "";

                valorDocumento  = 0;
                valorJuros      = 0;
                valorDesconto   = 0;
                valorMulta      = 0;
                valorPagamento  = 0;
                valorLiquido    = 0;

                nomeOrigem = line.substring(38, 42).trim();
                dataMovimento = line.substring(0, 8).trim();
                try {
                    Date dt = DateUtil.stringToDate(dataMovimento, "dd/MM/yy");
                    dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                    dataLote = DateUtil.dateToString(dt, "yyyy-MM");
                } catch (Exception dt1) {
                    continue;
                }

                String valorString = line.substring(ivalorDocumento,ivalorDocumento+11).trim();
                valorString = valorString.replaceAll("\\.","");
                try {
                    valorDocumento = DecimalUtil.toDecimal(valorString);
                }
                catch (Exception xx) {
                    valorDocumento = 0;
                    continue;
                }

                dataRecebimento = line.substring(9, 17).trim();
                try {
                    Date dt = DateUtil.stringToDate(dataRecebimento, "dd/MM/yy");
                    dataRecebimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                    dataLote = DateUtil.dateToString(dt, "yyyy-MM");
                } catch (Exception dt1) {
                    dataRecebimento = "";
                }

                if (line.length() > 110) {
                    valorString = line.substring(ivalorPagamento,ivalorPagamento+12).trim();
                    valorString = valorString.replaceAll("\\.","");
                    try {
                        valorLiquido = DecimalUtil.toDecimal(valorString);
                    }
                    catch (Exception xx) {
                        valorLiquido = 0;
                    }
                }
            }

            if (tipoPlanilha.equals("REDECARD-FINANCEIRO")) {
                if (line.length() < 87) continue;

                complemento01   = "";
                complemento02   = "";
                complemento03   = "";
                complemento04   = "";
                complemento05   = "";

                complemento06   = "";
                complemento07   = "";
                complemento08   = "";
                complemento09   = "";
                complemento10   = "";

                cpfCnpj         = "";

                nomeOrigem      = "";
                documento       = "";
                nomePortador    = "";
                historico       = "";

                valorDocumento  = 0;
                valorJuros      = 0;
                valorDesconto   = 0;
                valorMulta      = 0;
                valorPagamento  = 0;
                valorLiquido    = 0;

                dataMovimento = line.substring(0, 8).trim();
                try {
                    Date dt = DateUtil.stringToDate(dataMovimento, "dd/MM/yy");
                    dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                    dataLote = DateUtil.dateToString(dt, "yyyy-MM");
                } catch (Exception dt1) {
                    continue;
                }

                String valorString = line.substring(74,84).trim();
                valorString = valorString.replaceAll("\\.","");
                try {
                    valorDocumento = DecimalUtil.toDecimal(valorString);
                }
                catch (Exception xx) {
                    valorDocumento = 0;
                    continue;
                }

                dataRecebimento = "";
                valorLiquido = 0;
            }

            complemento01   = nomePortador;

            if (dataMovimento.equals("")) continue;

            String contLinhaTexto = String.valueOf(cont);
            contLinhaTexto = StringUtil.leftPad(contLinhaTexto, 05, "0");
            consolidaClass = contLinhaTexto;
            classificacao  = dataMovimento + consolidaClass;

            Date dt = DateUtil.stringToDate(dataMovimento, "dd/MM/yyyy");
            dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
            dataLote = DateUtil.dateToString(dt, "yyyy-MM");

            lote = String.format( "%s_%s_%s_%s_%s", nomeEmpresa, codEmpresa, nomeArquivo, dataLote, tipoLancamento );

            if (tipoPlanilha.equals("REDECARD-CREDITO") && tipoVenda.equals("A VISTA")) {

                chave = lote + "-AVISTA-" + contLinhaTexto;
                if(chave.length() > 200)  chave = chave.substring(0, 200);
                key = chave  + "-CTB";

                ttMovimentoPadrao ttMov2      = (ttMovimentoPadrao)mapaVariavel.get(key);
                if (ttMov2 == null) {
                    ttMov2 = new ttMovimentoPadrao();
                }
                ttMov2.lote             = lote;
                ttMov2.documento        = documento;
                ttMov2.codEmpresa       = codEmpresa;
                ttMov2.nomeEmpresa      = nomeEmpresa;
                ttMov2.dataMovimento    = dataMovimento;
                ttMov2.tipoMovimento    = "CTB";
                ttMov2.tipoLancamento   = tipoLancamento;
                ttMov2.historico        = "";
                ttMov2.valorDocumento   = valorDocumento;
                ttMov2.valorDesconto    = 0;
                ttMov2.valorMulta       = 0;
                ttMov2.valorJuros       = 0;
                ttMov2.contaJuros       = "";
                ttMov2.contaMulta       = "";
                ttMov2.contaDesconto    = "";
                ttMov2.nomePortador     = "REDECARD";
                ttMov2.centroCusto      = "";
                ttMov2.nomeOrigem       = nomeOrigem;
                ttMov2.cpfCnpj          = cpfCnpj;
                ttMov2.chave            = chave + "-CTB";
                ttMov2.classificacao    = classificacao;

                ttMov2.complemento01    = "REDECARD";
                ttMov2.complemento02    = "VENDA";
                ttMov2.complemento03    = complemento03;
                ttMov2.complemento04    = complemento04;
                ttMov2.complemento05    = complemento05;
                ttMov2.complemento06    = complemento06;
                ttMov2.complemento07    = complemento07;
                ttMov2.complemento08    = complemento08;
                ttMov2.complemento09    = complemento09;
                ttMov2.complemento10    = complemento10;
                ttMov2.nomeArquivo      = nomeArquivo;
                ttMov2.naturezaContabil  = "C";
                ttMov2.contaDebito       = "";
                ttMov2.contaCredito      = "";
                mapaVariavel.put(key,ttMov2);

                chave = lote + "-TARIFA-" + contLinhaTexto;
                if(chave.length() > 200)  chave = chave.substring(0, 200);
                key = chave  + "-CTB";

                if (valorDocumento > valorLiquido && valorLiquido > 0) {
                    ttMovimentoPadrao ttMov3      = (ttMovimentoPadrao)mapaVariavel.get(key);
                    if (ttMov3 == null) {
                        ttMov3 = new ttMovimentoPadrao(ttMov2);
                    }

                    ttMov3.chave            = key;
                    ttMov3.dataMovimento    = dataMovimento;
                    ttMov3.valorDocumento   = valorDocumento - valorLiquido;
                    ttMov3.nomePortador     = "TARIFA-REDECARD";
                    ttMov3.complemento02    = "TARIFA";
                    mapaVariavel.put(key,ttMov3);
                }

            }

            if (tipoPlanilha.equals("REDECARD-CREDITO") && tipoVenda.equals("PARCELADO")) {

                chave = lote + "-PARCELADO-" + documento + dataMovimento;
                if(chave.length() > 200)  chave = chave.substring(0, 200);
                key = chave  + "-CTB";

                ttMovimentoPadrao ttMov2      = (ttMovimentoPadrao)mapaVariavel.get(key);
                if (ttMov2 == null) {
                    ttMov2 = new ttMovimentoPadrao();
                }
                ttMov2.lote             = lote;
                ttMov2.documento        = documento;
                ttMov2.codEmpresa       = codEmpresa;
                ttMov2.nomeEmpresa      = nomeEmpresa;
                ttMov2.dataMovimento    = dataMovimento;
                ttMov2.tipoMovimento    = "CTB";
                ttMov2.tipoLancamento   = tipoLancamento;
                ttMov2.historico        = "";
                ttMov2.valorDocumento   = ttMov2.valorDocumento + valorDocumento;
                ttMov2.valorDesconto    = 0;
                ttMov2.valorMulta       = 0;
                ttMov2.valorJuros       = 0;
                ttMov2.contaJuros       = "";
                ttMov2.contaMulta       = "";
                ttMov2.contaDesconto    = "";
                ttMov2.nomePortador     = "REDECARD";
                ttMov2.centroCusto      = "";
                ttMov2.nomeOrigem       = nomeOrigem;
                ttMov2.cpfCnpj          = cpfCnpj;
                ttMov2.chave            = chave + "-CTB";
                ttMov2.classificacao    = classificacao;

                ttMov2.complemento01    = "REDECARD";
                ttMov2.complemento02    = "VENDA";
                ttMov2.complemento03    = complemento03;
                ttMov2.complemento04    = complemento04;
                ttMov2.complemento05    = complemento05;
                ttMov2.complemento06    = complemento06;
                ttMov2.complemento07    = complemento07;
                ttMov2.complemento08    = complemento08;
                ttMov2.complemento09    = complemento09;
                ttMov2.complemento10    = complemento10;
                ttMov2.nomeArquivo      = nomeArquivo;
                ttMov2.naturezaContabil  = "C";
                ttMov2.contaDebito       = "";
                ttMov2.contaCredito      = "";
                mapaVariavel.put(key,ttMov2);

                chave = lote + "-PARCELADOTARIFA-" + documento + dataMovimento;
                if(chave.length() > 200)  chave = chave.substring(0, 200);
                key = chave  + "-CTB";

                if (valorDocumento > valorLiquido && valorLiquido > 0) {
                    ttMovimentoPadrao ttMov3      = (ttMovimentoPadrao)mapaVariavel.get(key);
                    if (ttMov3 == null) {
                        ttMov3 = new ttMovimentoPadrao(ttMov2);
                        ttMov3.valorDocumento = 0;
                    }
                    ttMov3.chave            = key;
                    ttMov3.dataMovimento    = dataMovimento;
                    ttMov3.valorDocumento   = ttMov3.valorDocumento + valorDocumento - valorLiquido;
                    ttMov3.nomePortador     = "TARIFA-REDECARD";
                    ttMov3.complemento02    = "TARIFA";
                    mapaVariavel.put(key,ttMov3);

                }
            }

            if (tipoPlanilha.equals("REDECARD-DEBITO")) {

                chave = lote + "-DEBITO-" + contLinhaTexto;
                if(chave.length() > 200)  chave = chave.substring(0, 200);
                key = chave  + "-CTB";

                ttMovimentoPadrao ttMov2      = (ttMovimentoPadrao)mapaVariavel.get(key);
                if (ttMov2 == null) {
                    ttMov2 = new ttMovimentoPadrao();
                }
                ttMov2.lote             = lote;
                ttMov2.documento        = documento;
                ttMov2.codEmpresa       = codEmpresa;
                ttMov2.nomeEmpresa      = nomeEmpresa;
                ttMov2.dataMovimento    = dataMovimento;
                ttMov2.tipoMovimento    = "CTB";
                ttMov2.tipoLancamento   = tipoLancamento;
                ttMov2.historico        = "";
                ttMov2.valorDocumento   = ttMov2.valorDocumento + valorDocumento;
                ttMov2.valorDesconto    = 0;
                ttMov2.valorMulta       = 0;
                ttMov2.valorJuros       = 0;
                ttMov2.contaJuros       = "";
                ttMov2.contaMulta       = "";
                ttMov2.contaDesconto    = "";
                ttMov2.nomePortador     = "REDECARD";
                ttMov2.centroCusto      = "";
                ttMov2.nomeOrigem       = nomeOrigem;
                ttMov2.cpfCnpj          = cpfCnpj;
                ttMov2.chave            = chave + "-CTB";
                ttMov2.classificacao    = classificacao;

                ttMov2.complemento01    = "REDECARD";
                ttMov2.complemento02    = "VENDA DEBITO";
                ttMov2.complemento03    = complemento03;
                ttMov2.complemento04    = complemento04;
                ttMov2.complemento05    = complemento05;
                ttMov2.complemento06    = complemento06;
                ttMov2.complemento07    = complemento07;
                ttMov2.complemento08    = complemento08;
                ttMov2.complemento09    = complemento09;
                ttMov2.complemento10    = complemento10;
                ttMov2.nomeArquivo      = nomeArquivo;
                ttMov2.naturezaContabil  = "C";
                ttMov2.contaDebito       = "";
                ttMov2.contaCredito      = "";

                mapaVariavel.put(key,ttMov2);

                chave = lote + "-TARIFADEBITO-" + contLinhaTexto;
                if(chave.length() > 200)  chave = chave.substring(0, 200);
                key = chave  + "-CTB";

                if (valorDocumento > valorLiquido && valorLiquido > 0) {
                    ttMovimentoPadrao ttMov3      = (ttMovimentoPadrao)mapaVariavel.get(key);
                    if (ttMov3 == null) {
                        ttMov3 = new ttMovimentoPadrao(ttMov2);
                    }
                    ttMov3.chave            = key;
                    ttMov3.dataMovimento    = dataMovimento;
                    ttMov3.valorDocumento   = valorDocumento - valorLiquido;
                    ttMov3.nomePortador     = "TARIFA DEBITO-REDECARD";
                    ttMov3.complemento02    = "TARIFA DEBITO";
                    mapaVariavel.put(key,ttMov3);
                }
                chave = lote + "-RECEBEDEBITO-" + contLinhaTexto;
                if(chave.length() > 200)  chave = chave.substring(0, 200);
                key = chave  + "-CTB";
                if (valorLiquido > 0) {
                    ttMovimentoPadrao ttMov3      = (ttMovimentoPadrao)mapaVariavel.get(key);
                    if (ttMov3 == null) {
                        ttMov3 = new ttMovimentoPadrao(ttMov2);
                    }
                    ttMov3.chave            = key;
                    ttMov3.dataMovimento    = dataRecebimento;
                    ttMov3.valorDocumento   = valorLiquido;
                    ttMov3.nomePortador     = "REDECARD";
                    ttMov3.complemento02    = "RECEBIMENTO DEBITO";
                    mapaVariavel.put(key,ttMov3);
                }
            }

            if (tipoPlanilha.equals("REDECARD-FINANCEIRO")) {

                chave = lote + "-FINANCEIRO-" + contLinhaTexto;
                if(chave.length() > 200)  chave = chave.substring(0, 200);
                key = chave  + "-CTB";

                ttMovimentoPadrao ttMov2      = (ttMovimentoPadrao)mapaVariavel.get(key);
                if (ttMov2 == null) {
                    ttMov2 = new ttMovimentoPadrao();
                }
                ttMov2.lote             = lote;
                ttMov2.documento        = documento;
                ttMov2.codEmpresa       = codEmpresa;
                ttMov2.nomeEmpresa      = nomeEmpresa;
                ttMov2.dataMovimento    = dataMovimento;
                ttMov2.tipoMovimento    = "CTB";
                ttMov2.tipoLancamento   = tipoLancamento;
                ttMov2.historico        = "";
                ttMov2.valorDocumento   = ttMov2.valorDocumento + valorDocumento;
                ttMov2.valorDesconto    = 0;
                ttMov2.valorMulta       = 0;
                ttMov2.valorJuros       = 0;
                ttMov2.contaJuros       = "";
                ttMov2.contaMulta       = "";
                ttMov2.contaDesconto    = "";
                ttMov2.nomePortador     = "REDCARD";
                ttMov2.centroCusto      = "";
                ttMov2.nomeOrigem       = nomeOrigem;
                ttMov2.cpfCnpj          = cpfCnpj;
                ttMov2.chave            = chave + "-CTB";
                ttMov2.classificacao    = classificacao;

                ttMov2.complemento01    = "REDECARD";
                ttMov2.complemento02    = "RECEBIMENTO";
                ttMov2.complemento03    = complemento03;
                ttMov2.complemento04    = complemento04;
                ttMov2.complemento05    = complemento05;
                ttMov2.complemento06    = complemento06;
                ttMov2.complemento07    = complemento07;
                ttMov2.complemento08    = complemento08;
                ttMov2.complemento09    = complemento09;
                ttMov2.complemento10    = complemento10;
                ttMov2.nomeArquivo      = nomeArquivo;
                ttMov2.naturezaContabil  = "C";
                ttMov2.contaDebito       = "";
                ttMov2.contaCredito      = "";
                mapaVariavel.put(key,ttMov2);
            }

        }
        catch (Exception xx) {}
    }

    return mapaVariavel;
}



/* ################################################################################################ @EXTRATO-SICREDI ##
    Leitura de Planilha Padrão EXTRATO - SICREDI
    ## ################################################################################################################## */
public boolean readExtratoSicrediDefault(MemoryFile memFile, String nomePortador, JSONObject jDados, DataBase dbIOCont, InoutLogger logger) throws Exception {
    JSONObject extratoEmpresa = new JSONObject();

    // Inicializacao de Variaveis
        String codEmpresa        = "";
        String nomeArquivo       = "";
        String chaveExtrato      = "";

        String documento         = "";
        String nomeOrigem        = "";
        String dataMovimento     = "";
        String dataLote          = "";
        String complemento01     = "";
        String complemento02     = "";
        String complemento03     = "";
        String complemento04     = "";
        String complemento05     = "";
        String complemento06     = "";
        String complemento07     = "";
        String complemento08     = "";
        String complemento09     = "";
        String complemento10     = "";
        String debitoCredito     = "";
        String cpfCnpj           = "";
        String historico         = "";

        String strValorDocumento = "";
        String contLinhaExtrato  = "";

        double valorDocumento    = 0.0;
        double valorJuros        = 0.0;
        double valorDesconto     = 0.0;
        double valorMulta        = 0.0;
        double valorPagamento    = 0.0;

        boolean naoLeMais = false;

        if(jDados.has("CODEMPRESA"))   codEmpresa   = jDados.optString("CODEMPRESA");
        if(jDados.has("NOMEARQUIVO"))  nomeArquivo  = jDados.optString("NOMEARQUIVO");

        while (memFile.hasNextLine()) {

            try {
                String line = memFile.nextLine();
                line = StringUtil.removeSpecialCharsToUC(line);

                complemento01   = nomePortador;
                complemento02   = "";
                complemento03   = "";
                complemento04   = "";
                complemento05   = "";

                complemento06   = "";
                complemento07   = "";
                complemento08   = "";
                complemento09   = "";
                complemento10   = "";

                cpfCnpj         = "";
                nomeOrigem      = "";
                documento       = "";
                historico       = "";

                valorDocumento  = 0;
                valorJuros      = 0;
                valorDesconto   = 0;
                valorMulta      = 0;
                valorPagamento  = 0;

                if (memFile.getStringField(0).equals("")) continue;
                try {
                    Date dt = memFile.getDateField(0, "dd/MM/yyyy");
                    dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                    dataLote = DateUtil.dateToString(dt, "yyyy-MM");
                } catch (Exception dt1) {
                    try {
                       Date dt = memFile.getDateField(0);
                       dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                       dataLote = DateUtil.dateToString(dt, "yyyy-MM");
                   } catch (Exception dt2) {
                       continue;
                   }
                }

                try {valorDocumento = memFile.getDoubleField(3);}
                catch(Exception e) { valorDocumento = 0;}

                if (valorDocumento > 0) debitoCredito = "EXTRATO-CREDITO";
                if (valorDocumento < 0) debitoCredito = "EXTRATO-DEBITO";
                if (valorDocumento == 0) continue;

                valorDocumento = Math.abs(valorDocumento);

                nomeOrigem    = memFile.getStringFieldRemoveEspCharsUpper(1);
                complemento02 = memFile.getStringFieldRemoveEspCharsUpper(2);


                if(naoLeMais) continue;

                contLinhaExtrato = StringUtil.leftPad(String.valueOf(memFile.getCurrentIndex()), 05, "0");
                chaveExtrato = codEmpresa + "-" +  dataMovimento + "-" + debitoCredito + "-" + String.format("%.2f", valorDocumento) + "-" + nomePortador + "-" + contLinhaExtrato;

                // Buscar Extrato por Chave na Tabela IO_EXTRATO.
                extratoEmpresa = dbIOCont.sql("SELECT CHAVE FROM IO_EXTRATO WHERE CHAVE = ?")
                .fields("CHAVE")
                .param(chaveExtrato)
                .queryUnique();

                // Inserir caso Chave nao encontrada.
                if (extratoEmpresa == null || !extratoEmpresa.has("CHAVE")) {
                try {
                    dbIOCont.insert("IO_EXTRATO")
                    .fields("CHAVE,CODEMPRESA, DATAMOVIMENTO, PORTADOR, HISTORICO, LOTE, COMPLEMENTO, VALORDOCUMENTO, DEBITOCREDITO, EXTRATOLIDO")
                    .param(chaveExtrato)
                    .param(codEmpresa)
                    .param(dataMovimento)
                    .param(nomePortador)
                    .param(nomeOrigem)
                    .param(nomeArquivo.toUpperCase())
                    .param(complemento02)
                    .param(valorDocumento)
                    .param(debitoCredito)
                    .param(0)
                    .execute();
                } catch(Exception e) {
                    logger.logError("Error inserting to IO_EXTRATO", e);
                    continue;
                }
            // Atualizar Chave caso encontrada.
            } else {
                try {
                    dbIOCont.update("IO_EXTRATO")
                    .fields("EXTRATOLIDO")
                    .where("CHAVE = ? ")
                    .param(0)
                    .param(chaveExtrato)
                    .execute();
                } catch(Exception e1) {
                    logger.logError("Error updating IO_EXTRATO", e1);
                    continue;
                }
            }
        } catch(Exception e) {
            logger.logError("ERRO: ", e);
        }
    }

    return true;
}


/* ############################################################################################### @EXTRATO-SANTANDER ##
                                        Leitura de Planilha Padrão EXTRATO - SANTANDER
## ################################################################################################################## */
public boolean readExtratoSantanderDefault(MemoryFile memFile, String nomePortador, JSONObject jDados, DataBase dbIOCont, InoutLogger logger) throws Exception {

    JSONObject extratoEmpresa = new JSONObject();

    // Inicializacao de Variaveis
    String codEmpresa        = "";
    String nomeArquivo       = "";
    String chaveExtrato      = "";

    String documento         = "";
    String nomeOrigem        = "";
    String dataMovimento     = "";
    String dataLote          = "";
    String complemento01     = "";
    String complemento02     = "";
    String complemento03     = "";
    String complemento04     = "";
    String complemento05     = "";
    String complemento06     = "";
    String complemento07     = "";
    String complemento08     = "";
    String complemento09     = "";
    String complemento10     = "";
    String debitoCredito     = "";
    String cpfCnpj           = "";
    String historico         = "";

    String strValorDocumento = "";
    String contLinhaExtrato  = "";

    double valorDocumento    = 0.0;
    double valorJuros        = 0.0;
    double valorDesconto     = 0.0;
    double valorMulta        = 0.0;
    double valorPagamento    = 0.0;

    if(jDados.has("CODEMPRESA"))   codEmpresa   = jDados.optString("CODEMPRESA");
    if(jDados.has("NOMEARQUIVO"))  nomeArquivo  = jDados.optString("NOMEARQUIVO");

    while (memFile.hasNextLine()) {

        try {
            String line = memFile.nextLine();
            line = StringUtil.removeSpecialCharsToUC(line);

            complemento01   = nomePortador;
            complemento02   = "";
            complemento03   = "";
            complemento04   = "";
            complemento05   = "";

            complemento06   = "";
            complemento07   = "";
            complemento08   = "";
            complemento09   = "";
            complemento10   = "";

            cpfCnpj         = "";

            nomeOrigem      = "";
            documento       = "";
            historico       = "";

            valorDocumento  = 0;
            valorJuros      = 0;
            valorDesconto   = 0;
            valorMulta      = 0;
            valorPagamento  = 0;

            if (memFile.getStringField(0).equals("")) continue;

            try {
                Date dt = memFile.getDateField(0);
                dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                dataLote = DateUtil.dateToString(dt, "yyyy-MM");
            } catch (Exception dateException01) {
                try {
                    Date dt = memFile.getDateField(0, "dd/MM/yyyy");    // --- VERIFICAR
                    dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                    dataLote = DateUtil.dateToString(dt, "yyyy-MM");
                } catch (Exception dateException02) {
                    continue;
                }
            }

            try {
                valorDocumento = memFile.getDoubleField(4);
            } catch (Exception valorException01) {
                valorDocumento = 0;
            }

            if (valorDocumento > 0) debitoCredito = "EXTRATO-CREDITO";
            if (valorDocumento < 0) debitoCredito = "EXTRATO-DEBITO";
            if (valorDocumento == 0) continue;

            valorDocumento = Math.abs(valorDocumento);

            nomeOrigem = memFile.getStringFieldRemoveEspCharsUpper(2);
            complemento02 = memFile.getStringFieldRemoveEspCharsUpper(2);
            if (nomeOrigem.contains("INTERNET")) nomeOrigem = nomeOrigem.substring(nomeOrigem.indexOf("INTERNET")+8).trim();

            contLinhaExtrato = StringUtil.leftPad(String.valueOf(memFile.getCurrentIndex()), 05, "0");

            chaveExtrato = codEmpresa + "-" +  dataMovimento + "-" + debitoCredito + "-" + String.format("%.2f", valorDocumento) + "-" + nomePortador + "-" + contLinhaExtrato;

            // Buscar Extrato por Chave na Tabela IO_EXTRATO.
            extratoEmpresa = dbIOCont.sql("SELECT CHAVE FROM IO_EXTRATO WHERE CHAVE = ?")
            .fields("CHAVE")
            .param(chaveExtrato)
            .queryUnique();

            // Inserir caso Chave nao encontrada.
            if (extratoEmpresa == null || !extratoEmpresa.has("CHAVE")) {
                try {
                    dbIOCont.insert("IO_EXTRATO")
                    .fields("CHAVE,CODEMPRESA, DATAMOVIMENTO, PORTADOR, HISTORICO, LOTE, COMPLEMENTO, VALORDOCUMENTO, DEBITOCREDITO, EXTRATOLIDO")
                    .param(chaveExtrato)
                    .param(codEmpresa)
                    .param(dataMovimento)
                    .param(nomePortador)
                    .param(nomeOrigem)
                    .param(nomeArquivo.toUpperCase())
                    .param(complemento02)
                    .param(valorDocumento)
                    .param(debitoCredito)
                    .param(0)
                    .execute();
                } catch (Exception sqlInsertException) {
                    logger.logError("Error inserting to IO_EXTRATO", sqlInsertException);
                    continue;
                }
                // Atualizar Chave caso encontrada.
            } else {
                try {
                    dbIOCont.update("IO_EXTRATO")
                    .fields("EXTRATOLIDO")
                    .where("CHAVE = ? ")
                    .param(0)
                    .param(chaveExtrato)
                    .execute();
                } catch (Exception sqlUpdateException) {
                    logger.logError("Error updating IO_EXTRATO", sqlUpdateException);
                    continue;
                }
            }
        } catch (Exception readExtratoException) {
            logger.logError("Erro de leitura de Extrato Padrão Santander", readExtratoException);
        }
    }
    return true;
}


/* ########################################################################################### @EXTRATO-BANCODOBRASIL ##
                                        Leitura de Planilha Padrao EXTRATO - BANCODOBRASIL
## ################################################################################################################## */
public boolean readExtratoBancoDoBrasilDefault(MemoryFile memFile, String nomePortador, JSONObject jDados, DataBase dbIOCont, InoutLogger logger) throws Exception {

    JSONObject extratoEmpresa = new JSONObject();

    // Inicializacao de Variaveis
    String codEmpresa        = "";
    String nomeArquivo       = "";
    String chaveExtrato      = "";

    String documento         = "";
    String nomeOrigem        = "";
    String dataMovimento     = "";
    String dataLote          = "";
    String complemento01     = "";
    String complemento02     = "";
    String complemento03     = "";
    String complemento04     = "";
    String complemento05     = "";
    String complemento06     = "";
    String complemento07     = "";
    String complemento08     = "";
    String complemento09     = "";
    String complemento10     = "";
    String debitoCredito     = "";
    String cpfCnpj           = "";
    String historico         = "";

    String strValorDocumento = "";
    String contLinhaExtrato  = "";

    double valorDocumento    = 0.0;
    double valorJuros        = 0.0;
    double valorDesconto     = 0.0;
    double valorMulta        = 0.0;
    double valorPagamento    = 0.0;

    boolean naoLeMais = false;

    if(jDados.has("CODEMPRESA"))   codEmpresa   = jDados.optString("CODEMPRESA");
    if(jDados.has("NOMEARQUIVO"))  nomeArquivo  = jDados.optString("NOMEARQUIVO");

    while (memFile.hasNextLine()) {

        try {
            String line = memFile.nextLine();
            line = StringUtil.removeSpecialCharsToUC(line);

            if (line.startsWith("AGENCIA") || (line.startsWith("CONTA") && line.contains("CORRENTE"))) {
                String nomePortadorAuxiliar = line.substring(line.indexOf("  ")).trim();
                if (nomePortadorAuxiliar.contains(" ")) {
                    nomePortadorAuxiliar = nomePortadorAuxiliar.substring(0, nomePortadorAuxiliar.indexOf(" "));
                }
                nomePortador = String.format(
                    "%s %s",
                    nomePortador,
                    nomePortadorAuxiliar
                );

                continue;
            }

            complemento01   = nomePortador;
            complemento02   = "";
            complemento03   = "";
            complemento04   = "";
            complemento05   = "";

            complemento06   = "";
            complemento07   = "";
            complemento08   = "";
            complemento09   = "";
            complemento10   = "";

            cpfCnpj         = "";

            documento       = "";
            historico       = "";

            valorJuros      = 0;
            valorDesconto   = 0;
            valorMulta      = 0;
            valorPagamento  = 0;


            if (line.substring(2,3).equals("/") && line.substring(5,6).equals("/")) {

                if (line.length() < 128) continue;
                if (line.contains("S A L D O")) continue;

                // Data Movimento.
                if (line.substring(2,3).equals("/") && line.substring(5,6).equals("/")) {
                    try {
                        dataMovimento = line.substring( 0, 10 );
                        Date dt 	  = DateUtil.stringToDate( dataMovimento, "dd/MM/yyyy" );
                        dataMovimento = DateUtil.dateToString( dt, "dd/MM/yyyy" );
                        dataLote      = DateUtil.dateToString( dt,"yyyy-MM" );
                    } catch (Exception dte) { continue; }
                }
                if (dataMovimento.equals("")) continue;

                debitoCredito = StringUtil.removeSpecialCharsToUC(line.substring( 127, 128 )).trim();

                nomeOrigem    = StringUtil.removeSpecialChars(line.substring( 57, 90 )).trim().toUpperCase();

                strValorDocumento = "0";
                try{
                    strValorDocumento    = StringUtil.removeSpecialChars(line.substring( 111, 127 )).trim().toUpperCase();
                    strValorDocumento    = strValorDocumento.replaceAll("\\.","").replaceAll("-","");

                    valorDocumento = DecimalUtil.toDecimal(strValorDocumento);
                } catch (Exception vlrx) {
                    valorDocumento = 0;
                }

                if(valorDocumento == 0) dataMovimento = "";
                if(valorDocumento == 0) continue;

                if (debitoCredito.contains("C")) debitoCredito = "EXTRATO-CREDITO";
                else if (debitoCredito.contains("D")) debitoCredito = "EXTRATO-DEBITO";

                contLinhaExtrato = StringUtil.leftPad(String.valueOf(memFile.getCurrentIndex()), 05, "0");
            } else {
                complemento02 = line.trim();
            }

            if (dataMovimento.trim().equals("")) continue;

            if(naoLeMais) continue;

            // Chave para Insert/Update no Banco de Dados.
            chaveExtrato = codEmpresa + "-" +  dataMovimento + "-" + debitoCredito + "-" + String.format("%.2f", valorDocumento) + "-" + nomePortador + "-" + contLinhaExtrato;

            // Buscar Extrato por Chave na Tabela IO_EXTRATO.
            extratoEmpresa = dbIOCont.sql("SELECT CHAVE FROM IO_EXTRATO WHERE CHAVE = ?")
            .fields("CHAVE")
            .param(chaveExtrato)
            .queryUnique();

            if (extratoEmpresa == null || !extratoEmpresa.has("CHAVE")) {
                try {

                    dbIOCont.insert("IO_EXTRATO")
                    .fields("CHAVE,CODEMPRESA, DATAMOVIMENTO, PORTADOR, HISTORICO, LOTE, COMPLEMENTO, VALORDOCUMENTO, DEBITOCREDITO, EXTRATOLIDO")
                    .param(chaveExtrato)
                    .param(codEmpresa)
                    .param(dataMovimento)
                    .param(nomePortador)
                    .param(nomeOrigem)
                    .param(nomeArquivo.toUpperCase())
                    .param(complemento02)
                    .param(valorDocumento)
                    .param(debitoCredito)
                    .param(0)
                    .execute();
                } catch(Exception e) {
                    logger.logError("Error inserting to IO_EXTRATO", e);
                    continue;
                }
            } else {
                try {

                    dbIOCont.update("IO_EXTRATO")
                    .fields("COMPLEMENTO, EXTRATOLIDO")
                    .where("CHAVE = ? ")
                    .param(complemento02)
                    .param(0)
                    .param(chaveExtrato)
                    .execute();
                } catch(Exception e1) {
                    logger.logError("Error updating IO_EXTRATO", e1);
                    continue;
                }
            }
        } catch(Exception e) {
            logger.logError("ERRO: ", e);
        }
    }

    return true;
}

/* ########################################################################################### @EXTRATO-BANCODOBRASIL ##
                                        Leitura de Planilha Padrao EXTRATO - BANCODOBRASIL - C/ DOCUMENTO
## ################################################################################################################## */
public boolean readExtratoBancoDoBrasilDoc(MemoryFile memFile, String nomePortador, JSONObject jDados, DataBase dbIOCont, InoutLogger logger) throws Exception {

  //USADO -> Vipcontabilidade.MiequipamentosContas_Pagas
  JSONObject extratoEmpresa = new JSONObject();

  //Inicializacao de Variaveis
  String codEmpresa        = "";
  String nomeArquivo       = "";
  String chaveExtrato      = "";

  String documento         = "";
  String nomeOrigem        = "";
  String dataMovimento     = "";
  String dataLote          = "";
  String complemento01     = "";
  String complemento02     = "";
  String complemento03     = "";
  String complemento04     = "";
  String complemento05     = "";
  String complemento06     = "";
  String complemento07     = "";
  String complemento08     = "";
  String complemento09     = "";
  String complemento10     = "";
  String debitoCredito     = "";
  String cpfCnpj           = "";
  String historico         = "";

  String strValorDocumento = "";
  String contLinhaExtrato  = "";
  String qualPadrao        = "";

  double valorDocumento    = 0.0;
  double valorJuros        = 0.0;
  double valorDesconto     = 0.0;
  double valorMulta        = 0.0;
  double valorPagamento    = 0.0;

  boolean naoLeMais = false;

  if(jDados.has("CODEMPRESA"))   codEmpresa   = jDados.optString("CODEMPRESA");
  if(jDados.has("NOMEARQUIVO"))  nomeArquivo  = jDados.optString("NOMEARQUIVO");

  while (memFile.hasNextLine()) {

      try {
          String line = memFile.nextLine();
          line = StringUtil.removeSpecialCharsToUC(line);

          if (line.startsWith("AGENCIA") || (line.startsWith("CONTA") && line.contains("CORRENTE"))) {
              String nomePortadorAuxiliar = line.substring(line.indexOf("  ")).trim();
              if (nomePortadorAuxiliar.contains(" ")) {
                  nomePortadorAuxiliar = nomePortadorAuxiliar.substring(0, nomePortadorAuxiliar.indexOf(" "));
              }
              nomePortador = String.format(
                  "%s %s",
                  nomePortador,
                  nomePortadorAuxiliar
              );

              continue;
          }


          complemento01   = nomePortador;
          complemento02   = "";
          complemento03   = "";
          complemento04   = "";
          complemento05   = "";

          complemento06   = "";
          complemento07   = "";
          complemento08   = "";
          complemento09   = "";
          complemento10   = "";

          cpfCnpj         = "";

          historico       = "";

          valorJuros      = 0;
          valorDesconto   = 0;
          valorMulta      = 0;
          valorPagamento  = 0;

          if (line.startsWith("DT. MOVIMENTO") && line.contains("LOTE")){
            qualPadrao = "PADRAO 1";
          }
          if (line.startsWith("DT. MOVIMENTO") && !line.contains("LOTE")){
            qualPadrao = "PADRAO 2";
          }

          if (line.substring(2,3).equals("/") && line.substring(5,6).equals("/")) {
              if (qualPadrao.equals("PADRAO 1") && line.length() < 128) continue;
              if (qualPadrao.equals("PADRAO 2") && line.length() > 128) continue;
              if (line.contains("S A L D O")) continue;

              //Data Movimento.
              if (line.substring(2,3).equals("/") && line.substring(5,6).equals("/")) {
                  try {
                      dataMovimento = line.substring( 0, 10 );
                      Date dt 	  = DateUtil.stringToDate( dataMovimento, "dd/MM/yyyy" );
                      dataMovimento = DateUtil.dateToString( dt, "dd/MM/yyyy" );
                      dataLote      = DateUtil.dateToString( dt,"yyyy-MM" );
                  } catch (Exception dte) { continue; }
              }
              if (dataMovimento.equals("")) continue;
              if (qualPadrao.equals("PADRAO 1")){
                  debitoCredito = StringUtil.removeSpecialCharsToUC(line.substring( 127, 128 )).trim();

                  nomeOrigem    = StringUtil.removeSpecialChars(line.substring( 57, 90 )).trim().toUpperCase();

                  documento = StringUtil.removeSpecialChars(line.substring( 92, 112 )).trim().toUpperCase();

                  complemento02 = "Documento:" + documento;

                  strValorDocumento = "0";
                  try{
                      strValorDocumento    = StringUtil.removeSpecialChars(line.substring( 111, 127 )).trim().toUpperCase();
                      strValorDocumento    = strValorDocumento.replaceAll("\\.","").replaceAll("-","");

                      valorDocumento = DecimalUtil.toDecimal(strValorDocumento);
                  } catch (Exception vlrx) {
                      valorDocumento = 0;
                  }
                }
                if (qualPadrao.equals("PADRAO 2")){
					debitoCredito = StringUtil.removeSpecialChars(line.substring( 87, 90 )).trim().toUpperCase();
					//debitoCredito = StringUtil.removeSpecialCharsToUC(line.substring( line.trim().length() - 1, line.trim().length() )).trim();

                  nomeOrigem    = StringUtil.removeSpecialChars(line.substring( 28, 52 )).trim().toUpperCase();

                  documento = StringUtil.removeSpecialChars(line.substring( 53, 71 )).trim().toUpperCase();

                  complemento02 = "Documento:" + documento;

                  strValorDocumento = "0";
                  try{
                      strValorDocumento    = StringUtil.removeSpecialChars(line.substring( 72, 86 )).trim().toUpperCase();
                      strValorDocumento    = strValorDocumento.replaceAll("\\.","").replaceAll("-","");

                      valorDocumento = DecimalUtil.toDecimal(strValorDocumento);
 
                  } catch (Exception vlrx) {
                      valorDocumento = 0;
                  }
                }

                if(valorDocumento == 0) dataMovimento = "";
                if(valorDocumento == 0) continue;

                if (debitoCredito.contains("C")) {
                  debitoCredito = "EXTRATO-CREDITO";
                } else {
                  if (debitoCredito.contains("D")) {
                    debitoCredito = "EXTRATO-DEBITO";
                  } else {
                    continue;
                  }
                }

                contLinhaExtrato = StringUtil.leftPad(String.valueOf(memFile.getCurrentIndex()), 05, "0");

              } else {
              complemento02 = line.trim();

              complemento02 = String.format("%s Documento:%s", complemento02, documento);
          }

          if (dataMovimento.trim().equals("")) continue;

          if(naoLeMais) continue;

          //Chave para Insert/Update no Banco de Dados.
          chaveExtrato = codEmpresa + "-" +  dataMovimento + "-" + debitoCredito + "-" + String.format("%.2f", valorDocumento) + "-" + nomePortador + "-" + contLinhaExtrato;

          //Buscar Extrato por Chave na Tabela IO_EXTRATO.
          extratoEmpresa = dbIOCont.sql("SELECT CHAVE FROM IO_EXTRATO WHERE CHAVE = ?")
          .fields("CHAVE")
          .param(chaveExtrato)
          .queryUnique();

          if (extratoEmpresa == null || !extratoEmpresa.has("CHAVE")) {
              try {

                  dbIOCont.insert("IO_EXTRATO")
                  .fields("CHAVE,CODEMPRESA, DATAMOVIMENTO, PORTADOR, HISTORICO, LOTE, COMPLEMENTO, VALORDOCUMENTO, DEBITOCREDITO, EXTRATOLIDO")
                  .param(chaveExtrato)
                  .param(codEmpresa)
                  .param(dataMovimento)
                  .param(nomePortador)
                  .param(nomeOrigem)
                  .param(nomeArquivo.toUpperCase())
                  .param(complemento02)
                  .param(valorDocumento)
                  .param(debitoCredito)
                  .param(0)
                  .execute();
              } catch(Exception e) {
                  logger.logError("Error inserting to IO_EXTRATO", e);
                  continue;
              }
          } else {
              try {

                  dbIOCont.update("IO_EXTRATO")
                  .fields("COMPLEMENTO, EXTRATOLIDO")
                  .where("CHAVE = ? ")
                  .param(complemento02)
                  .param(0)
                  .param(chaveExtrato)
                  .execute();
              } catch(Exception e1) {
                  logger.logError("Error updating IO_EXTRATO", e1);
                  continue;
              }
          }
      } catch(Exception e) {
          logger.logError("ERRO: ", e);
      }
  }

  return true;
}

/* ########################################################################################### @EXTRATO-BANCODOBRASIL ##
                                        Leitura de Planilha Padrao EXTRATO - BANCODOBRASIL - C/ DOCUMENTO
## ################################################################################################################## */
public boolean readExtratoBancoDoBrasilDoc2(MemoryFile memFile, String nomePortador, JSONObject jDados, DataBase dbIOCont, InoutLogger logger) throws Exception {

    //USADO -> Vipcontabilidade.MiequipamentosContas_Pagas
    JSONObject extratoEmpresa = new JSONObject();
  
    //Inicializacao de Variaveis
    String codEmpresa        = "";
    String nomeArquivo       = "";
    String chaveExtrato      = "";
  
    String documento         = "";
    String nomeOrigem        = "";
    String dataMovimento     = "";
    String dataLote          = "";
    String complemento01     = "";
    String complemento02     = "";
    String complemento03     = "";
    String complemento04     = "";
    String complemento05     = "";
    String complemento06     = "";
    String complemento07     = "";
    String complemento08     = "";
    String complemento09     = "";
    String complemento10     = "";
    String debitoCredito     = "";
    String cpfCnpj           = "";
    String historico         = "";
  
    String strValorDocumento = "";
    String contLinhaExtrato  = "";
    String qualPadrao        = "";
  
    double valorDocumento    = 0.0;
    double valorJuros        = 0.0;
    double valorDesconto     = 0.0;
    double valorMulta        = 0.0;
    double valorPagamento    = 0.0;
  	boolean f = false;

    boolean naoLeMais = false;
  
    if(jDados.has("CODEMPRESA"))   codEmpresa   = jDados.optString("CODEMPRESA");
    if(jDados.has("NOMEARQUIVO"))  nomeArquivo  = jDados.optString("NOMEARQUIVO");
  
    while (memFile.hasNextLine()) {
  
        try {
            String line = memFile.nextLine();
            line = StringUtil.removeSpecialCharsToUC(line);
				if (line.contains("S A L D O")){  
					f = true; 
					continue;
				}
				if(f) continue;
            if (line.startsWith("AGENCIA") || (line.startsWith("CONTA") && line.contains("CORRENTE"))) {
                String nomePortadorAuxiliar = line.substring(line.indexOf("  ")).trim();
                if (nomePortadorAuxiliar.contains(" ")) {
                    nomePortadorAuxiliar = nomePortadorAuxiliar.substring(0, nomePortadorAuxiliar.indexOf(" "));
                }
                nomePortador = String.format(
                    "%s %s",
                    nomePortador,
                    nomePortadorAuxiliar
                );
  
                continue;
            }
  
  
            complemento01   = nomePortador;
            complemento02   = "";
            complemento03   = "";
            complemento04   = "";
            complemento05   = "";
  
            complemento06   = "";
            complemento07   = "";
            complemento08   = "";
            complemento09   = "";
            complemento10   = "";
  
            cpfCnpj         = "";
  
            historico       = "";
  
            valorJuros      = 0;
            valorDesconto   = 0;
            valorMulta      = 0;
            valorPagamento  = 0;
  
            if (line.startsWith("DT. MOVIMENTO") && line.contains("LOTE")){
              qualPadrao = "PADRAO 1";
            }
            if (line.startsWith("DT. MOVIMENTO") && !line.contains("LOTE")){
              qualPadrao = "PADRAO 2";
            }
  
            if (line.substring(2,3).equals("/") && line.substring(5,6).equals("/")) {
                if (qualPadrao.equals("PADRAO 1") && line.length() < 128) continue;
                if (qualPadrao.equals("PADRAO 2") && line.length() > 128) continue;
                
   
                //Data Movimento.
                if (line.substring(2,3).equals("/") && line.substring(5,6).equals("/")) {
                    try {
                        dataMovimento = line.substring( 0, 10 );
                        Date dt 	  = DateUtil.stringToDate( dataMovimento, "dd/MM/yyyy" );
                        dataMovimento = DateUtil.dateToString( dt, "dd/MM/yyyy" );
                        dataLote      = DateUtil.dateToString( dt,"yyyy-MM" );
                        contLinhaExtrato = StringUtil.leftPad(String.valueOf(memFile.getCurrentIndex()), 05, "0");

                    } catch (Exception dte) { continue; }
                }
                if (dataMovimento.equals("")) continue;
                if (qualPadrao.equals("PADRAO 1")){
                    debitoCredito = StringUtil.removeSpecialCharsToUC(line.substring( 127, 128 )).trim();
  
                    nomeOrigem    = StringUtil.removeSpecialChars(line.substring( 57, 90 )).trim().toUpperCase();
  
                    documento = StringUtil.removeSpecialChars(line.substring( 92, 112 )).trim().toUpperCase();
  
                    complemento02 = "Documento:" + documento;
  
                    strValorDocumento = "0";
                    try{
                        strValorDocumento    = StringUtil.removeSpecialChars(line.substring( 111, 127 )).trim().toUpperCase();
                        strValorDocumento    = strValorDocumento.replaceAll("\\.","").replaceAll("-","");
  
                        valorDocumento = DecimalUtil.toDecimal(strValorDocumento);
                    } catch (Exception vlrx) {
                        valorDocumento = 0;
                    }
                  }
                  if (qualPadrao.equals("PADRAO 2")){
                      debitoCredito = StringUtil.removeSpecialChars(line.substring( 87, 90 )).trim().toUpperCase();
                      //debitoCredito = StringUtil.removeSpecialCharsToUC(line.substring( line.trim().length() - 1, line.trim().length() )).trim();
  
                    nomeOrigem    = StringUtil.removeSpecialChars(line.substring( 28, 52 )).trim().toUpperCase();
  
                    documento = StringUtil.removeSpecialChars(line.substring( 53, 71 )).trim().toUpperCase();
  
                    complemento02 = "Documento:" + documento;
  
                    strValorDocumento = "0";
                    try{
                        strValorDocumento    = StringUtil.removeSpecialChars(line.substring( 72, 86 )).trim().toUpperCase();
                        strValorDocumento    = strValorDocumento.replaceAll("\\.","").replaceAll("-","");
  
                        valorDocumento = DecimalUtil.toDecimal(strValorDocumento);
                    } catch (Exception vlrx) {
                        valorDocumento = 0;
                    }
                  }
  
                  if(valorDocumento == 0) dataMovimento = "";
                  if(valorDocumento == 0) continue;
  
                  if (debitoCredito.contains("C")) {
                    debitoCredito = "EXTRATO-CREDITO";
                  } else {
                    if (debitoCredito.contains("D")) {
                      debitoCredito = "EXTRATO-DEBITO";
                    } else {
                      continue;
                    }
                  }
  
  
                } else {
                complemento02 = line.trim();
  
                nomeOrigem += " " + complemento02.trim();
                complemento02 = String.format("%s Documento:%s", complemento02, documento);
            }
  
            if (dataMovimento.trim().equals("")) continue;
  
            if(naoLeMais) continue;
            if(nomeOrigem.length() > 200)  nomeOrigem = nomeOrigem.substring(0, 199);
            //Chave para Insert/Update no Banco de Dados.
            chaveExtrato = codEmpresa + "-" +  dataMovimento + "-" + debitoCredito + "-" + String.format("%.2f", valorDocumento) + "-" + nomePortador + "-" + contLinhaExtrato;
  
            //Buscar Extrato por Chave na Tabela IO_EXTRATO.
            extratoEmpresa = dbIOCont.sql("SELECT CHAVE FROM IO_EXTRATO WHERE CHAVE = ?")
            .fields("CHAVE")
            .param(chaveExtrato)
            .queryUnique();
  
            if (extratoEmpresa == null || !extratoEmpresa.has("CHAVE")) {
                try {
  
                    dbIOCont.insert("IO_EXTRATO")
                    .fields("CHAVE,CODEMPRESA, DATAMOVIMENTO, PORTADOR, HISTORICO, LOTE, COMPLEMENTO, VALORDOCUMENTO, DEBITOCREDITO, EXTRATOLIDO")
                    .param(chaveExtrato)
                    .param(codEmpresa)
                    .param(dataMovimento)
                    .param(nomePortador)
                    .param(nomeOrigem)
                    .param(nomeArquivo.toUpperCase())
                    .param(complemento02)
                    .param(valorDocumento)
                    .param(debitoCredito)
                    .param(0)
                    .execute();
                } catch(Exception e) {
                    logger.logError("Error inserting to IO_EXTRATO", e);
                    continue;
                }
            } else {
                try {
  
                    dbIOCont.update("IO_EXTRATO")
                    .fields("COMPLEMENTO, EXTRATOLIDO, HISTORICO")
                    .where("CHAVE = ? ")
                    .param(complemento02)
                    .param(0)
                    .param(nomeOrigem)
                    .param(chaveExtrato)
                    .execute();
                } catch(Exception e1) {
                    logger.logError("Error updating IO_EXTRATO", e1);
                    continue;
                }
            }
        } catch(Exception e) {
            logger.logError("ERRO: ", e);
        }
    }
  
    return true;
}


/* ########################################################################################### @EXTRATO-BANCODOBRASIL ##
                                        Leitura de Planilha Padrao EXTRATO - BANCODOBRASIL - Financiamentos
## ################################################################################################################## */
public boolean readExtratoBancoDoBrasilFinanciamentos(MemoryFile memFile, String nomePortador, JSONObject jDados, DataBase dbIOCont, InoutLogger logger) throws Exception {

    // USADO -> Vipcontabilidade.MiequipamentosContas_Pagas
    JSONObject extratoEmpresa = new JSONObject();

    // Inicializacao de Variaveis
    String codEmpresa        = "";
    String nomeArquivo       = "";
    String chaveExtrato      = "";

    String documento         = "";
    String nomeOrigem        = "";
    String dataMovimento     = "";
    String dataLote          = "";
    String complemento01     = "";
    String complemento02     = "";
    String complemento03     = "";
    String complemento04     = "";
    String complemento05     = "";
    String complemento06     = "";
    String complemento07     = "";
    String complemento08     = "";
    String complemento09     = "";
    String complemento10     = "";
    String debitoCredito     = "";
    String cpfCnpj           = "";
    String historico         = "";

    String strValorDocumento = "";
    String contLinhaExtrato  = "";

    double valorDocumento    = 0.0;
    double valorJuros        = 0.0;
    double valorDesconto     = 0.0;
    double valorMulta        = 0.0;
    double valorPagamento    = 0.0;

    boolean naoLeMais = false;

    if(jDados.has("CODEMPRESA"))   codEmpresa   = jDados.optString("CODEMPRESA");
    if(jDados.has("NOMEARQUIVO"))  nomeArquivo  = jDados.optString("NOMEARQUIVO");

    int idataMovimento  =  0; // Coluna Data.
    int inomeOrigem     =  1; // Coluna Descricao.
    int inomePortador   = -1; // Valor do Campo Agencia.
    int idocumento      = -1;
    int ivalorDocumento =  2; // Coluna Valor.
    int ivalorPagamento = -1;
    int ivalorDesconto  = -1;
    int ivalorJuros     = -1;
    int icomplemento01  = -1;
    int icomplemento02  = -1; // Coluna Valor.
    int icomplemento03  = -1;
    int icomplemento04  = -1;

    while (memFile.hasNextLine()) {

        try {
            String line = memFile.nextLine();
            line = StringUtil.removeSpecialCharsToUC(line);

            if (memFile.getStringFieldRemoveEspCharsUpper(idataMovimento).contains("SALDO")
                && memFile.getStringFieldRemoveEspCharsUpper(idataMovimento).contains("PROJETADO")) {
                    naoLeMais = true;

            }
            if(naoLeMais) continue;

            if (line.contains("AGENCIA")) {
                complemento01 = memFile.getStringFieldRemoveEspCharsUpper(0).replaceAll("\"", "");
                if (complemento01.contains(":")) complemento01 = complemento01.substring(complemento01.indexOf(":")+1).trim();

                nomePortador = nomePortador +  " " + complemento01;
            }
            if (line.contains("OPERACAO")) {
                String numeroContrato = memFile.getStringFieldRemoveEspCharsUpper(0);
                if (numeroContrato.contains("OPERACAO")) {
                    nomePortador = nomePortador + " " + numeroContrato.substring(numeroContrato.indexOf("OPERACAO")+9).replaceAll("\"", "").trim();
                }
            }
            if (line.contains("SALDO") && line.contains("ANTERIOR")) continue;

            complemento01   = nomePortador;
            complemento02   = "";
            complemento03   = "";
            complemento04   = "";
            complemento05   = "";

            complemento06   = "";
            complemento07   = "";
            complemento08   = "";
            complemento09   = "";
            complemento10   = "";

            cpfCnpj         = "";

            nomeOrigem      = "";
            documento       = "";
            historico       = "";

            valorDocumento	= 0;
            valorJuros		= 0;
            valorDesconto	= 0;
            valorMulta		= 0;
            valorPagamento	= 0;


            if (memFile.getStringField(idataMovimento).equals("")) continue;


            try {
                Date dt = memFile.getDateField(idataMovimento);
                dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                dataLote = DateUtil.dateToString(dt, "yyyy-MM");
            } catch (Exception dt1) {
                try {
                    Date dt = memFile.getDateField(idataMovimento, "dd/MM/yyyy");	// --- VERIFICAR
                    dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                    dataLote = DateUtil.dateToString(dt, "yyyy-MM");
                } catch (Exception dt2) {
                    try {
                        dataMovimento = memFile.getStringFieldRemoveEspCharsUpper(idataMovimento).replaceAll("\"","");
                        Date dt  = DateUtil.stringToDate(dataMovimento, "dd/MM/yyyy");
                        dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                        dataLote = DateUtil.dateToString(dt, "yyyy-MM");
                    } catch (Exception dt2) { continue;}
                }
            }
            nomeOrigem      = memFile.getStringFieldRemoveEspCharsUpper(inomeOrigem).replaceAll("\"", "");

            complemento01   = nomePortador;
            // complemento02   = memFile.getStringFieldRemoveEspCharsUpper(icomplemento02); NAO USADO.


            if(ivalorDocumento >=0){
                try{valorDocumento = memFile.getDoubleField(ivalorDocumento);}
                catch (Exception vlrd) { valorDocumento = 0; }

                if (valorDocumento == 0) continue;

                if (valorDocumento < 0) debitoCredito = "EXTRATO-DEBITO";
                if (valorDocumento > 0) debitoCredito = "EXTRATO-CREDITO";

                valorDocumento = Math.abs( valorDocumento );
            }



            if (dataMovimento.trim().equals("")) continue;



            contLinhaExtrato = StringUtil.leftPad(String.valueOf(memFile.getCurrentIndex()), 05, "0");

            // Chave para Insert/Update no Banco de Dados.
            chaveExtrato = codEmpresa + "-" +  dataMovimento + "-" + debitoCredito + "-" + String.format("%.2f", valorDocumento) + "-" + nomePortador + "-" + contLinhaExtrato;

            // Buscar Extrato por Chave na Tabela IO_EXTRATO.
            extratoEmpresa = dbIOCont.sql("SELECT CHAVE FROM IO_EXTRATO WHERE CHAVE = ?")
            .fields("CHAVE")
            .param(chaveExtrato)
            .queryUnique();

            if (extratoEmpresa == null || !extratoEmpresa.has("CHAVE")) {
                try {

                    dbIOCont.insert("IO_EXTRATO")
                    .fields("CHAVE,CODEMPRESA, DATAMOVIMENTO, PORTADOR, HISTORICO, LOTE, COMPLEMENTO, VALORDOCUMENTO, DEBITOCREDITO, EXTRATOLIDO")
                    .param(chaveExtrato)
                    .param(codEmpresa)
                    .param(dataMovimento)
                    .param(nomePortador)
                    .param(nomeOrigem)
                    .param(nomeArquivo.toUpperCase())
                    .param(complemento02)
                    .param(valorDocumento)
                    .param(debitoCredito)
                    .param(0)
                    .execute();
                } catch(Exception e) {
                    logger.logError("Error inserting to IO_EXTRATO", e);
                    continue;
                }
            } else {
                try {

                    dbIOCont.update("IO_EXTRATO")
                    .fields("CHAVE,CODEMPRESA, DATAMOVIMENTO, PORTADOR, HISTORICO, LOTE, COMPLEMENTO, VALORDOCUMENTO, DEBITOCREDITO, EXTRATOLIDO")
                    .param(chaveExtrato)
                    .param(codEmpresa)
                    .param(dataMovimento)
                    .param(nomePortador)
                    .param(nomeOrigem)
                    .param(nomeArquivo.toUpperCase())
                    .param(complemento02)
                    .param(valorDocumento)
                    .param(debitoCredito)
                    .param(0)
                    .execute();
                } catch(Exception e1) {
                    logger.logError("Error updating IO_EXTRATO", e1);
                    continue;
                }
            }
        } catch(Exception e) {
            logger.logError("ERRO: ", e);
        }
    }

    return true;
}

/* ################################################################################################ @EXTRATO-CEF ##
    Leitura de txt Padrão EXTRATO - CEF
    ## ################################################################################################################## */
public boolean readExtratoCEFDefault(MemoryFile memFile, String nomePortador, JSONObject jDados, DataBase dbIOCont, InoutLogger logger) throws Exception {

    JSONObject extratoEmpresa = new JSONObject();

    // Inicializacao de Variaveis
    String codEmpresa        = "";
    String nomeArquivo       = "";
    String chaveExtrato      = "";

    String documento         = "";
    String nomeOrigem        = "";
    String dataMovimento     = "";
    String dataLote          = "";
    String complemento01     = "";
    String complemento02     = "";
    String complemento03     = "";
    String complemento04     = "";
    String complemento05     = "";
    String complemento06     = "";
    String complemento07     = "";
    String complemento08     = "";
    String complemento09     = "";
    String complemento10     = "";
    String debitoCredito     = "";
    String cpfCnpj           = "";
    String historico         = "";

    String strValorDocumento = "";
    String contLinhaExtrato  = "";

    double valorDocumento    = 0.0;
    double valorJuros        = 0.0;
    double valorDesconto     = 0.0;
    double valorMulta        = 0.0;
    double valorPagamento    = 0.0;

	int idataMovimento	= 1;
	int idocumento		= 2;
	int inomeOrigem		= 3;
	int ivalorDocumento	= 4;
	int icomplemento02	= 5;
	int icomplemento03	= 0;

    if(jDados.has("CODEMPRESA"))   codEmpresa   = jDados.optString("CODEMPRESA");
    if(jDados.has("NOMEARQUIVO"))  nomeArquivo  = jDados.optString("NOMEARQUIVO");

	memFile.setFieldSeparator(";");

    while (memFile.hasNextLine()) {

        try {
            String line = memFile.nextLine();
            line = StringUtil.removeSpecialCharsToUC(line);

            if (memFile.getStringFieldRemoveEspCharsUpper(idataMovimento).replaceAll("\"","").equals("")) continue;
			if (memFile.getStringFieldRemoveEspCharsUpper(idataMovimento).replaceAll("\"","").length() != 8) continue;

            try {
				String dataString = memFile.getStringFieldRemoveEspCharsUpper(idataMovimento).replaceAll("\"","");
				Date dt  = DateUtil.stringToDate(dataString, "yyyyMMdd");
                dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                dataLote = DateUtil.dateToString(dt, "yyyy-MM");
            } catch (Exception dateException01) {
				continue;
			}


            valorDocumento  = 0;
			try{valorDocumento = Math.abs(memFile.getDoubleField(ivalorDocumento));}
			catch (Exception vlrd) { valorDocumento = 0; }
            if (valorDocumento == 0) continue;

			nomeOrigem      = "";
            nomeOrigem		= memFile.getStringFieldRemoveEspCharsUpper(inomeOrigem).replaceAll("\"","");
			complemento01   = nomePortador;
            complemento02	= "";
            complemento02	= memFile.getStringFieldRemoveEspCharsUpper(icomplemento02).replaceAll("\"","");
			complemento03	= "";
            complemento03	= memFile.getStringFieldRemoveEspCharsUpper(icomplemento03).replaceAll("\"","");
			documento		= "";
            documento		= memFile.getStringFieldRemoveEspCharsUpper(idocumento).replaceAll("\"","");

            if (complemento02.equals("C")) debitoCredito = "EXTRATO-CREDITO";
            if (complemento02.equals("D")) debitoCredito = "EXTRATO-DEBITO";

            contLinhaExtrato = StringUtil.leftPad(String.valueOf(memFile.getCurrentIndex()), 05, "0");

            chaveExtrato = codEmpresa + "-" +  dataMovimento + "-" + debitoCredito + "-" + String.format("%.2f", valorDocumento) + "-" + nomePortador + "-" + contLinhaExtrato;

            // Buscar Extrato por Chave na Tabela IO_EXTRATO.
            extratoEmpresa = dbIOCont.sql("SELECT CHAVE FROM IO_EXTRATO WHERE CHAVE = ?")
            .fields("CHAVE")
            .param(chaveExtrato)
            .queryUnique();

            // Inserir caso Chave nao encontrada.
            if (extratoEmpresa == null || !extratoEmpresa.has("CHAVE")) {
                try {
                    dbIOCont.insert("IO_EXTRATO")
                    .fields("CHAVE,CODEMPRESA, DATAMOVIMENTO, PORTADOR, HISTORICO, LOTE, COMPLEMENTO, VALORDOCUMENTO, DEBITOCREDITO, EXTRATOLIDO")
                    .param(chaveExtrato)
                    .param(codEmpresa)
                    .param(dataMovimento)
                    .param(nomePortador+"_"+complemento03+"_"+documento)
                    .param(nomeOrigem)
                    .param(nomeArquivo.toUpperCase())
                    .param(complemento02)
                    .param(valorDocumento)
                    .param(debitoCredito)
                    .param(0)
                    .execute();
                } catch (Exception sqlInsertException) {
                    logger.logError("Error inserting to IO_EXTRATO", sqlInsertException);
                    continue;
                }
                // Atualizar Chave caso encontrada.
            } else {
                try {
                    dbIOCont.update("IO_EXTRATO")
                    .fields("EXTRATOLIDO")
                    .where("CHAVE = ? ")
                    .param(0)
                    .param(chaveExtrato)
                    .execute();
                } catch (Exception sqlUpdateException) {
                    logger.logError("Error updating IO_EXTRATO", sqlUpdateException);
                    continue;
                }
            }
        } catch (Exception readExtratoException) {
            logger.logError("Erro de leitura de Extrato Padrão Santander", readExtratoException);
        }
    }
    return true;
}

    
// /* ################################################################################################ @EXTRATO-CEF ##
//     Leitura de txt Padrão EXTRATO - CEF
//     ## ################################################################################################################## */
public boolean readExtratoCEFDefaultNovo(MemoryFile memFile, String nomePortador, JSONObject jDados, DataBase dbIOCont, InoutLogger logger) throws Exception {

    JSONObject extratoEmpresa = new JSONObject();

    // Inicializacao de Variaveis
    String codEmpresa        = "";
    String nomeArquivo       = "";
    String chaveExtrato      = "";

    String documento         = "";
    String nomeOrigem        = "";
    String dataMovimento     = "";
    String dataLote          = "";
    String complemento01     = "";
    String complemento02     = "";
    String complemento03     = "";
    String complemento04     = "";
    String complemento05     = "";
    String complemento06     = "";
    String complemento07     = "";
    String complemento08     = "";
    String complemento09     = "";
    String complemento10     = "";
    String debitoCredito     = "";
    String cpfCnpj           = "";
    String historico         = "";

    String strValorDocumento = "";
    String contLinhaExtrato  = "";

    double valorDocumento    = 0.0;
    double valorJuros        = 0.0;
    double valorDesconto     = 0.0;
    double valorMulta        = 0.0;
    double valorPagamento    = 0.0;

	int idataMovimento	= 1;
	int idocumento		= 2;
	int inomeOrigem		= 3;
	int ivalorDocumento	= 4;
	int icomplemento02	= 2;
	int icomplemento03	= 0;
	int icomplemento04	= 5;

    if(jDados.has("CODEMPRESA"))   codEmpresa   = jDados.optString("CODEMPRESA");
    if(jDados.has("NOMEARQUIVO"))  nomeArquivo  = jDados.optString("NOMEARQUIVO");

	memFile.setFieldSeparator(";");

    while (memFile.hasNextLine()) {

        try {
            String line = memFile.nextLine();
            line = StringUtil.removeSpecialCharsToUC(line);

            if (memFile.getStringFieldRemoveEspCharsUpper(idataMovimento).replaceAll("\"","").equals("")) continue;
			if (memFile.getStringFieldRemoveEspCharsUpper(idataMovimento).replaceAll("\"","").length() != 8) continue;

            try {
				String dataString = memFile.getStringFieldRemoveEspCharsUpper(idataMovimento).replaceAll("\"","");
				Date dt  = DateUtil.stringToDate(dataString, "yyyyMMdd");
                dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                dataLote = DateUtil.dateToString(dt, "yyyy-MM");
            } catch (Exception dateException01) {
				continue;
			}


            valorDocumento  = 0;
			try{valorDocumento = Math.abs(memFile.getDoubleField(ivalorDocumento));}
			catch (Exception vlrd) { valorDocumento = 0; }
            if (valorDocumento == 0) continue;

			nomeOrigem      = "";
            nomeOrigem		= memFile.getStringFieldRemoveEspCharsUpper(inomeOrigem).replaceAll("\"","");
			complemento01   = nomePortador;
            complemento02	= "";
            complemento02	= memFile.getStringFieldRemoveEspCharsUpper(icomplemento02).replaceAll("\"","");
			complemento03	= "";
            complemento03	= memFile.getStringFieldRemoveEspCharsUpper(icomplemento03).replaceAll("\"","");
			documento		= "";
            documento		= memFile.getStringFieldRemoveEspCharsUpper(idocumento).replaceAll("\"","");

            if (memFile.getStringFieldRemoveEspCharsUpper(icomplemento04).contains("C")) debitoCredito = "EXTRATO-CREDITO";
            if (memFile.getStringFieldRemoveEspCharsUpper(icomplemento04).contains("D")) debitoCredito = "EXTRATO-DEBITO";

            contLinhaExtrato = StringUtil.leftPad(String.valueOf(memFile.getCurrentIndex()), 05, "0");

            chaveExtrato = codEmpresa + "-" +  dataMovimento + "-" + debitoCredito + "-" + String.format("%.2f", valorDocumento) + "-" + nomePortador + "-" + contLinhaExtrato;

            // Buscar Extrato por Chave na Tabela IO_EXTRATO.
            extratoEmpresa = dbIOCont.sql("SELECT CHAVE FROM IO_EXTRATO WHERE CHAVE = ?")
            .fields("CHAVE")
            .param(chaveExtrato)
            .queryUnique();

            // Inserir caso Chave nao encontrada.
            if (extratoEmpresa == null || !extratoEmpresa.has("CHAVE")) {
                try {
                    dbIOCont.insert("IO_EXTRATO")
                    .fields("CHAVE,CODEMPRESA, DATAMOVIMENTO, PORTADOR, HISTORICO, LOTE, COMPLEMENTO, VALORDOCUMENTO, DEBITOCREDITO, EXTRATOLIDO")
                    .param(chaveExtrato)
                    .param(codEmpresa)
                    .param(dataMovimento)
                    .param(nomePortador+"_"+complemento03+"_"+documento)
                    .param(nomeOrigem)
                    .param(nomeArquivo.toUpperCase())
                    .param(complemento02)
                    .param(valorDocumento)
                    .param(debitoCredito)
                    .param(0)
                    .execute();
                } catch (Exception sqlInsertException) {
                    logger.logError("Error inserting to IO_EXTRATO", sqlInsertException);
                    continue;
                }
                // Atualizar Chave caso encontrada.
            } else {
                try {
                    dbIOCont.update("IO_EXTRATO")
                    .fields("EXTRATOLIDO")
                    .where("CHAVE = ? ")
                    .param(0)
                    .param(chaveExtrato)
                    .execute();
                } catch (Exception sqlUpdateException) {
                    logger.logError("Error updating IO_EXTRATO", sqlUpdateException);
                    continue;
                }
            }
        } catch (Exception readExtratoException) {
            logger.logError("Erro de leitura de Extrato Padrão Santander", readExtratoException);
        }
    }
    return true;
}


/* ################################################################################################ @EXTRATO-BANRISUL ##
                            Leitura de txt Padrão EXTRATO - BANRISUL
#################################################################################################################### */
public boolean readExtratoBANRISULDefault(MemoryFile memFile, String nomePortador, JSONObject jDados, DataBase dbIOCont, InoutLogger logger) throws Exception {

    JSONObject extratoEmpresa = new JSONObject();

    // Inicializacao de Variaveis
    String codEmpresa        = "";
    String nomeArquivo       = "";
    String chaveExtrato      = "";

    String documento         = "";
    String nomeOrigem        = "";
    String dataMovimento     = "";
    String dataLote          = "";
    String complemento01     = "";
    String complemento02     = "";
    String complemento03     = "";
    String complemento04     = "";
    String complemento05     = "";
    String complemento06     = "";
    String complemento07     = "";
    String complemento08     = "";
    String complemento09     = "";
    String complemento10     = "";
    String debitoCredito     = "";
    String cpfCnpj           = "";
    String historico         = "";

    String strValorDocumento = "";
    String contLinhaExtrato  = "";

    double valorDocumento    = 0.0;
    double valorJuros        = 0.0;
    double valorDesconto     = 0.0;
    double valorMulta        = 0.0;
    double valorPagamento    = 0.0;
	
	String contaPortador = "";

    if(jDados.has("CODEMPRESA"))   codEmpresa   = jDados.optString("CODEMPRESA");
    if(jDados.has("NOMEARQUIVO"))  nomeArquivo  = jDados.optString("NOMEARQUIVO");

    while (memFile.hasNextLine()) {

        try {
            String line = memFile.nextLine();
            line = StringUtil.removeSpecialCharsToUC(line);

            if(line.contains("PERIODO:")){ 
                complemento06 = cutString(line, "PERIODO: ");
                //continue;
            }
			
			//BATISTELLA #FABRICA
			 if(line.contains("MOVIMENTOS") && line.contains("/")){ 
					String dataLimpa = cutString(line, 15, 23).trim();
					complemento06 = dataLimpa;
				
			 }
			 
			 if(line.contains("CONTA..:")){
				 contaPortador = cutString(line, 9, line.length()).trim();
				 continue;
			 }
			
			if(line.length()<70) continue;
            
			//if (memFile.getStringFieldRemoveEspCharsUpper(idataMovimento).replaceAll("\"","").equals("")) continue;
			//if (memFile.getStringFieldRemoveEspCharsUpper(idataMovimento).replaceAll("\"","").length() != 8) continue;
			
			try {
				if(line.charAt(72) == ','){
					line = StringUtil.leftPad(line, line.length()+4, " ");
				}
			} catch (Exception xx){}
			
			if(!line.substring(0,2).trim().equals("")) complemento07 = cutString(line,0,2).trim();
			String dataString = complemento07 + "/" + complemento06;
			
			try {
				//String dataString = memFile.getStringFieldRemoveEspCharsUpper(idataMovimento).replaceAll("\"","");
				//Date dt  = DateUtil.stringToDate(dataString, "dd/MMM/yyyy");
				dataString = getCampoDate(dataString, "dd/MMM/yyyy");
				dataMovimento = dataString;
                dataLote = getCampoDate(dataString, "", "yyyy-MM");
				
            } catch (Exception dateException01) {
				try{
					dataString = getCampoDate(dataString, "dd/MMMM/yyyy");
				dataMovimento = dataString;
                dataLote = getCampoDate(dataString, "", "yyyy-MM");
				}catch(Exception qqq){
					continue;
				}
			}
			if(line.length() < 79) continue;
            String valorString = line.substring(69,79).trim();
            valorString = valorString.replaceAll("\\.","");
            try {
                valorDocumento = DecimalUtil.toDecimal(valorString);
            } catch (Exception xx) {
                valorDocumento = 0;
                continue;
            }
			
			nomeOrigem      = "";
			complemento02	= "";
			documento		= "";
            
			nomeOrigem		= line.substring(4,52).trim();
			complemento01   = nomePortador;
			documento		= line.substring(54,60).trim();
			if(documento.equals(""))continue;
            
            try{complemento02	= line.substring(79,80).trim();} catch(Exception xx){}
			//complemento03	= "";
            //complemento03	= memFile.getStringFieldRemoveEspCharsUpper(icomplemento03).replaceAll("\"","");

            if (!complemento02.contains("-")) debitoCredito = "EXTRATO-CREDITO";
            if (complemento02.contains("-")) debitoCredito = "EXTRATO-DEBITO";

            contLinhaExtrato = StringUtil.leftPad(String.valueOf(memFile.getCurrentIndex()), 05, "0");

            chaveExtrato = codEmpresa + "-" +  dataMovimento + "-" + debitoCredito + "-" + String.format("%.2f", valorDocumento) + "-" + nomePortador + "-" + contLinhaExtrato;

            // Buscar Extrato por Chave na Tabela IO_EXTRATO.
            extratoEmpresa = dbIOCont.sql("SELECT CHAVE FROM IO_EXTRATO WHERE CHAVE = ?")
            .fields("CHAVE")
            .param(chaveExtrato)
            .queryUnique();

            // Inserir caso Chave nao encontrada.
			//.param(nomePortador+"_"+complemento03+"_"+documento)
            if (extratoEmpresa == null || !extratoEmpresa.has("CHAVE")) {
				try {
                    dbIOCont.insert("IO_EXTRATO")
                    .fields("CHAVE,CODEMPRESA, DATAMOVIMENTO, PORTADOR, HISTORICO, LOTE, COMPLEMENTO, VALORDOCUMENTO, DEBITOCREDITO, EXTRATOLIDO")
                    .param(chaveExtrato)
                    .param(codEmpresa)
                    .param(dataMovimento)
                    .param(nomePortador + "_" + contaPortador)
                    .param(nomeOrigem)
                    .param(nomeArquivo.toUpperCase())
                    .param(complemento02)
                    .param(valorDocumento)
                    .param(debitoCredito)
                    .param(0)
                    .execute();
                } catch (Exception sqlInsertException) {
                    logger.logError("Error inserting to IO_EXTRATO", sqlInsertException);
                    continue;
                }
                // Atualizar Chave caso encontrada.
            } else {
                try {
                    dbIOCont.update("IO_EXTRATO")
                    .fields("EXTRATOLIDO")
                    .where("CHAVE = ? ")
                    .param(0)
                    .param(chaveExtrato)
                    .execute();
                } catch (Exception sqlUpdateException) {
                    logger.logError("Error updating IO_EXTRATO", sqlUpdateException);
                    continue;
                }
            }
        } catch (Exception readExtratoException) {
            logger.logError("Erro de leitura de Extrato Padrão Banrisul", readExtratoException);
        }
    }
    return true;
}

/* ################################################################################################ @EXTRATO-UNICRED ##
                            Leitura de txt Padrão EXTRATO - UNICRED
#################################################################################################################### */
public boolean readExtratoUNICREDDefault(MemoryFile memFile, JSONObject jDados, DataBase dbIOCont, InoutLogger logger) throws Exception {

    JSONObject extratoEmpresa = new JSONObject();

    // Inicializacao de Variaveis
    String codEmpresa        = "";
    String nomeArquivo       = "";
    String chaveExtrato      = "";

    String documento         = "";
    String nomeOrigem        = "";
    String nomePortador      = "";
    String dataMovimento     = "";
    String dataLote          = "";
    String complemento01     = "";
    String complemento02     = "";
    String complemento03     = "";
    String complemento04     = "";
    String complemento05     = "";
    String complemento06     = "";
    String complemento07     = "";
    String complemento08     = "";
    String complemento09     = "";
    String complemento10     = "";
    String debitoCredito     = "";
    String cpfCnpj           = "";
    String historico         = "";

    String strValorDocumento = "";
    String contLinhaExtrato  = "";

    double valorDocumento    = 0.0;
    double valorJuros        = 0.0;
    double valorDesconto     = 0.0;
    double valorMulta        = 0.0;
    double valorPagamento    = 0.0;

    if(jDados.has("CODEMPRESA"))   codEmpresa   = jDados.optString("CODEMPRESA");
    if(jDados.has("NOMEARQUIVO"))  nomeArquivo  = jDados.optString("NOMEARQUIVO");

    while (memFile.hasNextLine()) {

        try {
            String line = memFile.nextLine();
            line = StringUtil.removeSpecialCharsToUC(line);
			
			if(line.contains("CONTA:")) nomePortador = cutString(line, "CONTA:   "," ");
            
			//if (memFile.getStringFieldRemoveEspCharsUpper(idataMovimento).replaceAll("\"","").equals("")) continue;
			//if (memFile.getStringFieldRemoveEspCharsUpper(idataMovimento).replaceAll("\"","").length() != 8) continue;
			
			//if(!line.substring(0,2).trim().equals("")) complemento07 = cutString(line,0,2).trim();
			
			if(line.length()<75) continue;
			
			try {
				//String dataString = memFile.getStringFieldRemoveEspCharsUpper(idataMovimento).replaceAll("\"","");
				//Date dt  = DateUtil.stringToDate(dataString, "dd/MMM/yyyy");
				String dataString = line.substring(0,10);
				dataMovimento = getCampoDate(dataString);
                dataLote = getCampoDate(dataString, "", "yyyy-MM");
				if(dataMovimento.equals("")) continue;
            } catch (Exception dateException01) {
				continue;
			}

            String valorString = line.substring(62,77).trim();
			complemento02	= "";
            complemento02 = valorString;
            valorString = valorString.replaceAll("\\.","").replaceAll("-","");
            try {
                valorDocumento = DecimalUtil.toDecimal(valorString);
            } catch (Exception xx) {
                valorDocumento = 0;
                continue;
            }
			
			nomeOrigem      = "";
			documento		= "";
            
			nomeOrigem		= line.substring(23,59).trim();
			complemento01   = nomeOrigem;
			//documento		= line.substring(54,60).trim();
			//if(documento.equals(""))continue;
            
            //try{complemento02	= line.substring(79,80).trim();} catch(Exception xx){}
			//complemento03	= "";
            //complemento03	= memFile.getStringFieldRemoveEspCharsUpper(icomplemento03).replaceAll("\"","");

            if (!complemento02.contains("-")) debitoCredito = "EXTRATO-CREDITO";
            if (complemento02.contains("-")) debitoCredito = "EXTRATO-DEBITO";

			
            contLinhaExtrato = StringUtil.leftPad(String.valueOf(memFile.getCurrentIndex()), 05, "0");

            chaveExtrato = codEmpresa + "-" +  dataMovimento + "-" + debitoCredito + "-" + String.format("%.2f", valorDocumento) + "-" + nomePortador + "-" + contLinhaExtrato;

            // Buscar Extrato por Chave na Tabela IO_EXTRATO.
            extratoEmpresa = dbIOCont.sql("SELECT CHAVE FROM IO_EXTRATO WHERE CHAVE = ?")
            .fields("CHAVE")
            .param(chaveExtrato)
            .queryUnique();

            // Inserir caso Chave nao encontrada.
			//.param(nomePortador+"_"+complemento03+"_"+documento)
            if (extratoEmpresa == null || !extratoEmpresa.has("CHAVE")) {
				try {
                    dbIOCont.insert("IO_EXTRATO")
                    .fields("CHAVE,CODEMPRESA, DATAMOVIMENTO, PORTADOR, HISTORICO, LOTE, COMPLEMENTO, VALORDOCUMENTO, DEBITOCREDITO, EXTRATOLIDO")
                    .param(chaveExtrato)
                    .param(codEmpresa)
                    .param(dataMovimento)
                    .param(nomePortador)
                    .param(nomeOrigem)
                    .param(nomeArquivo.toUpperCase())
                    .param(complemento02)
                    .param(valorDocumento)
                    .param(debitoCredito)
                    .param(0)
                    .execute();
                } catch (Exception sqlInsertException) {
                    logger.logError("Error inserting to IO_EXTRATO", sqlInsertException);
                    continue;
                }
                // Atualizar Chave caso encontrada.
            } else {
                try {
                    dbIOCont.update("IO_EXTRATO")
                    .fields("EXTRATOLIDO")
                    .where("CHAVE = ? ")
                    .param(0)
                    .param(chaveExtrato)
                    .execute();
                } catch (Exception sqlUpdateException) {
                    logger.logError("Error updating IO_EXTRATO", sqlUpdateException);
                    continue;
                }
            }
        } catch (Exception readExtratoException) {
            logger.logError("Erro de leitura de Extrato Padrão UNICRED", readExtratoException);
        }
    }
    return true;
}


/* ################################################################# @EXTRATO-BRADESCO-TXT ##############################################################
                                        Leitura de Txt Padrao EXTRATO - BRADESCO - C/ DOCUMENTO
    ################################################################################################################################################## */
    public boolean readExtratoBradescoTxt(MemoryFile memFile, String nomePortador, JSONObject jDados, DataBase dbIOCont, InoutLogger logger) throws Exception {

        //USADO -> Vipcontabilidade.MiequipamentosContas_Pagas
        JSONObject extratoEmpresa = new JSONObject();
      
        //Inicializacao de Variaveis
        String codEmpresa        = "";
        String nomeArquivo       = "";
        String chaveExtrato      = "";
      
        String documento         = "";
        String nomeOrigem        = "";
        String dataMovimento     = "";
		String auxData			 = "";
        String dataLote          = "";
        String complemento01     = "";
        String complemento02     = "";
        String complemento03     = "";
        String complemento04     = "";
        String complemento05     = "";
        String complemento06     = "";
        String complemento07     = "";
        String complemento08     = "";
        String complemento09     = "";
        String complemento10     = "";
        String debitoCredito     = "";
        String cpfCnpj           = "";
        String historico         = "";
    
        String strValorDocumento = "";
        String contLinhaExtrato  = "";
        String qualPadrao        = "";
		
      
        double valorDocumento    = 0.0;
        double valorJuros        = 0.0;
        double valorDesconto     = 0.0;
        double valorMulta        = 0.0;
        double valorPagamento    = 0.0;
		
    
        boolean naoLeMais        = false;
        
        if(jDados.has("CODEMPRESA"))   codEmpresa   = jDados.optString("CODEMPRESA");
        if(jDados.has("NOMEARQUIVO"))  nomeArquivo  = jDados.optString("NOMEARQUIVO");
      
        while (memFile.hasNextLine()) {
            try {
                String line = memFile.nextLine();
                line = StringUtil.removeSpecialCharsToUC(line);
	
                // if (line.substring(2,3).equals("/") && line.substring(5,6).equals("/")) {
                    complemento01   = nomePortador;
                    complemento02   = "";
                    complemento03   = "";
                    complemento04   = "";
                    complemento05   = "";
        
                    complemento06   = "";
                    complemento07   = "";
                    complemento08   = "";
                    complemento09   = "";
                    complemento10   = "";
        
                    cpfCnpj         = "";
        
                    historico       = "";
				  
        
                    valorJuros      = 0;
                    valorDesconto   = 0;
                    valorMulta      = 0;
                    valorPagamento  = 0;
                // }
                if (line.contains("SALDO ANTERIOR") || line.equals("") || (line.contains("DCTO") && line.contains("DATA") && line.contains("SALDO"))) {
                    continue;
                }
                if (line.startsWith("TOTAL")) {
                    naoLeMais = true;
                    continue;
                }
				if (line.contains("LTIMOS") && line.contains("AMENTOS")){
					naoLeMais = false;
					continue;
				}
				
				// if (line.length() <= 50) continue; // @DiMaz 20210118
	
                if (line.substring(2,3).equals("/") && line.substring(5,6).equals("/")) {
                    //Data Movimento.
                   
	 
	 
					// if (line.substring(2,3).equals("/") && line.substring(5,6).equals("/")) {
						
	  
                        try {
                            dataMovimento = line.substring(0, 11);
                            Date dt 	  = DateUtil.stringToDate( dataMovimento, "dd/MM/yyyy" );
                            dataMovimento = DateUtil.dateToString( dt, "dd/MM/yyyy" );						
                            dataLote      = DateUtil.dateToString( dt,"yyyy-MM" );
							
                        } catch (Exception dte) { }
                    // }
					
                        nomeOrigem = StringUtil.removeSpecialChars(line.substring( 11, 38 )).trim().toUpperCase();
                        documento = StringUtil.removeSpecialChars(line.substring( 41, 50 )).trim().toUpperCase();  // @DiMaz 20210118 42 -> 41
                        complemento02 = "Documento: " + documento;
      
                    strValorDocumento = "0";
                    try{
                        strValorDocumento    = StringUtil.removeSpecialChars(line.substring( 52, 69 )).trim().toUpperCase().replaceAll("\\.","").trim();
                        strValorDocumento    = strValorDocumento.replaceAll("\\,","").replaceAll("-","");
                        debitoCredito = "EXTRATO-CREDITO";
                        valorDocumento = (Math.abs(DecimalUtil.toDecimal(strValorDocumento)))/100;
                    } catch (Exception vlrx) {
                        valorDocumento = 0;
                    }
					
                    if (valorDocumento == 0){
                        strValorDocumento = "0";
                        try{
                            strValorDocumento    = StringUtil.removeSpecialChars(line.substring( 70, 85 )).trim().toUpperCase().replaceAll("\\.","").trim();
                            strValorDocumento    = strValorDocumento.replaceAll("\\,","").replaceAll("-","");
                            debitoCredito = "EXTRATO-DEBITO";
                            valorDocumento = (Math.abs(DecimalUtil.toDecimal(strValorDocumento)))/100;
                        } catch (Exception vlrx) {
                            valorDocumento = 0;
                        }
                    }
	 
	 
                    // if(valorDocumento == 0) dataMovimento = "";
                    if(valorDocumento == 0) continue;
    
                    contLinhaExtrato = StringUtil.leftPad(String.valueOf(memFile.getCurrentIndex()), 05, "0");
                 
                }else {
                        nomeOrigem = String.format("%s %s", nomeOrigem, line.trim());
				}
                if (dataMovimento.trim().equals("")) continue;
	
      
                if(naoLeMais) continue;

                //Chave para Insert/Update no Banco de Dados.
                chaveExtrato = codEmpresa + "-" +  dataMovimento + "-" + debitoCredito + "-" + String.format("%.2f", valorDocumento) + "-" + nomePortador + "-" + contLinhaExtrato;
                //Buscar Extrato por Chave na Tabela IO_EXTRATO.
                extratoEmpresa = dbIOCont.sql("SELECT CHAVE FROM IO_EXTRATO WHERE CHAVE = ?")
                .fields("CHAVE")
                .param(chaveExtrato)
                .queryUnique();
				
				if (nomeOrigem.length() > 198) nomeOrigem = cutString(nomeOrigem, 0, 180);
                if (extratoEmpresa == null || !extratoEmpresa.has("CHAVE")) {
                    try {
                        dbIOCont.insert("IO_EXTRATO")
                        .fields("CHAVE,CODEMPRESA, DATAMOVIMENTO, PORTADOR, HISTORICO, LOTE, COMPLEMENTO, VALORDOCUMENTO, DEBITOCREDITO, EXTRATOLIDO")
                        .param(chaveExtrato)
                        .param(codEmpresa)
                        .param(dataMovimento)
                        .param(nomePortador)
                        .param(nomeOrigem)
                        .param(nomeArquivo.toUpperCase())
                        .param(complemento02)
                        .param(valorDocumento)
                        .param(debitoCredito)
                        .param(0)
                        .execute();
                    } catch(Exception e) {
                        logger.logError("Error inserting to IO_EXTRATO", e);
                        continue;
                    }
                } else {
                    try {
                        dbIOCont.update("IO_EXTRATO")
                        .fields("HISTORICO, COMPLEMENTO, EXTRATOLIDO")
                        .where("CHAVE = ? ")
                        .param(nomeOrigem)
                        .param(complemento02)
                        .param(0)
                        .param(chaveExtrato)
                        .execute();
                    } catch(Exception e1) {
                        logger.logError("Error updating IO_EXTRATO", e1);
                        continue;
                    }
                }
            } catch(Exception e) {
                logger.logError("ERRO: ", e);
            }
        }
        return true;
      }
    



/* ################################################################################################ @EXTRATO-BRADESCO ##
                            Leitura de txt Padrão EXTRATO - BRADESCO
#################################################################################################################### */
public boolean readExtratoBRADESCODefault(MemoryFile memFile, String nomePortador, JSONObject jDados, DataBase dbIOCont, InoutLogger logger) throws Exception {

    JSONObject extratoEmpresa = new JSONObject();

    // Inicializacao de Variaveis
    String codEmpresa        = "";
    String nomeArquivo       = "";
    String chaveExtrato      = "";

    String documento         = "";
    String nomeOrigem        = "";
    String dataMovimento     = "";
    String dataLote          = "";
    String complemento01     = "";
    String complemento02     = "";
    String complemento03     = "";
    String complemento04     = "";
    String complemento05     = "";
    String complemento06     = "";
    String complemento07     = "";
    String complemento08     = "";
    String complemento09     = "";
    String complemento10     = "";
    String debitoCredito     = "";
    String cpfCnpj           = "";
    String historico         = "";

    String strValorDocumento = "";
    String contLinhaExtrato  = "";

    double valorDocumento    = 0.0;
    double valorJuros        = 0.0;
    double valorDesconto     = 0.0;
    double valorMulta        = 0.0;
    double valorPagamento    = 0.0;

    if(jDados.has("CODEMPRESA"))   codEmpresa   = jDados.optString("CODEMPRESA");
    if(jDados.has("NOMEARQUIVO"))  nomeArquivo  = jDados.optString("NOMEARQUIVO");

    while (memFile.hasNextLine()) {

        try {
            String line = memFile.nextLine();
            line = StringUtil.removeSpecialCharsToUC(line);
			
			//if (memFile.getStringFieldRemoveEspCharsUpper(idataMovimento).replaceAll("\"","").equals("")) continue;
			//if (memFile.getStringFieldRemoveEspCharsUpper(idataMovimento).replaceAll("\"","").length() != 8) continue;
			
			try {
				//String dataString = memFile.getStringFieldRemoveEspCharsUpper(idataMovimento).replaceAll("\"","");
				//Date dt  = DateUtil.stringToDate(dataString, "dd/MMM/yyyy");
				String dataString = line.substring(0,10);
				dataMovimento = getCampoDate(dataString);
                dataLote = getCampoDate(dataString, "", "yyyy-MM");
				
            } catch (Exception dateException01) {
				continue;
			}

            String valorString = line.substring(55,85).trim();
            complemento02 = valorString;
            valorString = valorString.replaceAll("\\.","").replaceAll("-","");
            try {
                valorDocumento = DecimalUtil.toDecimal(valorString);
            } catch (Exception xx) {
                valorDocumento = 0;
                continue;
            }
			
			nomeOrigem      = "";
			complemento02	= "";
			documento		= "";
            
			nomeOrigem		= line.substring(10,40).trim();
			complemento01   = nomePortador;
			documento		= line.substring(41,50).trim();
			if(documento.equals(""))continue;
            
            //try{complemento02	= line.substring(79,80).trim();} catch(Exception xx){}
			//complemento03	= "";
            //complemento03	= memFile.getStringFieldRemoveEspCharsUpper(icomplemento03).replaceAll("\"","");

            if (!complemento02.contains("-")) debitoCredito = "EXTRATO-CREDITO";
            if (complemento02.contains("-")) debitoCredito = "EXTRATO-DEBITO";

            contLinhaExtrato = StringUtil.leftPad(String.valueOf(memFile.getCurrentIndex()), 05, "0");

            chaveExtrato = codEmpresa + "-" +  dataMovimento + "-" + debitoCredito + "-" + String.format("%.2f", valorDocumento) + "-" + nomePortador + "-" + contLinhaExtrato;

            // Buscar Extrato por Chave na Tabela IO_EXTRATO.
            extratoEmpresa = dbIOCont.sql("SELECT CHAVE FROM IO_EXTRATO WHERE CHAVE = ?")
            .fields("CHAVE")
            .param(chaveExtrato)
            .queryUnique();

            // Inserir caso Chave nao encontrada.
			//.param(nomePortador+"_"+complemento03+"_"+documento)
            if (extratoEmpresa == null || !extratoEmpresa.has("CHAVE")) {
				try {
                    dbIOCont.insert("IO_EXTRATO")
                    .fields("CHAVE,CODEMPRESA, DATAMOVIMENTO, PORTADOR, HISTORICO, LOTE, COMPLEMENTO, VALORDOCUMENTO, DEBITOCREDITO, EXTRATOLIDO")
                    .param(chaveExtrato)
                    .param(codEmpresa)
                    .param(dataMovimento)
                    .param(nomePortador)
                    .param(nomeOrigem)
                    .param(nomeArquivo.toUpperCase())
                    .param(complemento02)
                    .param(valorDocumento)
                    .param(debitoCredito)
                    .param(0)
                    .execute();
                } catch (Exception sqlInsertException) {
                    logger.logError("Error inserting to IO_EXTRATO", sqlInsertException);
                    continue;
                }
                // Atualizar Chave caso encontrada.
            } else {
                try {
                    dbIOCont.update("IO_EXTRATO")
                    .fields("EXTRATOLIDO")
                    .where("CHAVE = ? ")
                    .param(0)
                    .param(chaveExtrato)
                    .execute();
                } catch (Exception sqlUpdateException) {
                    logger.logError("Error updating IO_EXTRATO", sqlUpdateException);
                    continue;
                }
            }
        } catch (Exception readExtratoException) {
            logger.logError("Erro de leitura de Extrato Padrão Bradesco", readExtratoException);
        }
    }
    return true;
}

/* ################################################################################################ @EXTRATO-CEF-EXCEL ##
    Leitura de txt Padrão EXTRATO - CEF EXCEL
    ## ################################################################################################################## */
public boolean readExtratoCEFExcel(MemoryFile memFile, String nomePortador, JSONObject jDados, DataBase dbIOCont, InoutLogger logger) throws Exception {

    JSONObject extratoEmpresa = new JSONObject();

    // Inicializacao de Variaveis
    String codEmpresa        = "";
    String nomeArquivo       = "";
    String chaveExtrato      = "";

    String documento         = "";
    String nomeOrigem        = "";
    String dataMovimento     = "";
    String dataLote          = "";
    String complemento01     = "";
    String complemento02     = "";
    String complemento03     = "";
    String complemento04     = "";
    String complemento05     = "";
    String complemento06     = "";
    String complemento07     = "";
    String complemento08     = "";
    String complemento09     = "";
    String complemento10     = "";
    String debitoCredito     = "";
    String cpfCnpj           = "";
    String historico         = "";

    String strValorDocumento = "";
    String contLinhaExtrato  = "";

    double valorDocumento    = 0.0;
    double valorJuros        = 0.0;
    double valorDesconto     = 0.0;
    double valorMulta        = 0.0;
    double valorPagamento    = 0.0;

	int idataMovimento	= 0;
	int idocumento		= 1;
	int inomeOrigem		= 2;
	int ivalorDocumento	= 3;
	int icomplemento02	= 3;

    if(jDados.has("CODEMPRESA"))   codEmpresa   = jDados.optString("CODEMPRESA");
    if(jDados.has("NOMEARQUIVO"))  nomeArquivo  = jDados.optString("NOMEARQUIVO");

    while (memFile.hasNextLine()) {

        try {
            String line = memFile.nextLine();
            line = StringUtil.removeSpecialCharsToUC(line);
            if (memFile.getStringFieldRemoveEspCharsUpper(idataMovimento).replaceAll("\"","").equals("")) continue;

            try {
                Date dt = memFile.getDateField(idataMovimento, "dd/MM/yyyy");
                dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                dataLote = DateUtil.dateToString(dt, "yyyy-MM");
            } catch (Exception dt1) {
                try {
                    Date dt = memFile.getDateField(idataMovimento);
                    dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                    dataLote = DateUtil.dateToString(dt, "yyyy-MM");
                } catch (Exception dt2) {
                    try {
                        String dataString = memFile.getStringFieldRemoveEspCharsUpper(idataMovimento).replaceAll("\"","");
                        Date dt  = DateUtil.stringToDate(dataString, "dd/MM/yyyy");
                        dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                        dataLote = DateUtil.dateToString(dt, "yyyy-MM");
                    } catch (Exception dt2) { }
                }
            }

            valorDocumento  = 0;
			try{valorDocumento = Math.abs(memFile.getDoubleField(ivalorDocumento));}
			catch (Exception vlrd) { valorDocumento = 0; }
            if (valorDocumento == 0) continue;

			nomeOrigem      = "";
            nomeOrigem		= memFile.getStringFieldRemoveEspCharsUpper(inomeOrigem).replaceAll("\"","");
			complemento01   = nomePortador;
            complemento02	= "";
            complemento02	= memFile.getStringFieldRemoveEspCharsUpper(icomplemento02).replaceAll("\"","");
			documento		= "";
            documento		= memFile.getStringFieldRemoveEspCharsUpper(idocumento).replaceAll("\"","");

            if (complemento02.contains("C")) debitoCredito = "EXTRATO-CREDITO";
            if (complemento02.contains("D")) debitoCredito = "EXTRATO-DEBITO";

            contLinhaExtrato = StringUtil.leftPad(String.valueOf(memFile.getCurrentIndex()), 05, "0");

            chaveExtrato = codEmpresa + "-" +  dataMovimento + "-" + debitoCredito + "-" + String.format("%.2f", valorDocumento) + "-" + nomePortador + "-" + contLinhaExtrato;

            // Buscar Extrato por Chave na Tabela IO_EXTRATO.
            extratoEmpresa = dbIOCont.sql("SELECT CHAVE FROM IO_EXTRATO WHERE CHAVE = ?")
            .fields("CHAVE")
            .param(chaveExtrato)
            .queryUnique();

            // Inserir caso Chave nao encontrada.
            if (extratoEmpresa == null || !extratoEmpresa.has("CHAVE")) {
                try {
                    dbIOCont.insert("IO_EXTRATO")
                    .fields("CHAVE,CODEMPRESA, DATAMOVIMENTO, PORTADOR, HISTORICO, LOTE, COMPLEMENTO, VALORDOCUMENTO, DEBITOCREDITO, EXTRATOLIDO")
                    .param(chaveExtrato)
                    .param(codEmpresa)
                    .param(dataMovimento)
                    .param(nomePortador)
                    .param(nomeOrigem)
                    .param(nomeArquivo.toUpperCase())
                    .param(complemento02)
                    .param(valorDocumento)
                    .param(debitoCredito)
                    .param(0)
                    .execute();
                } catch (Exception sqlInsertException) {
                    logger.logError("Error inserting to IO_EXTRATO", sqlInsertException);
                    continue;
                }
                // Atualizar Chave caso encontrada.
            } else {
                try {
                    dbIOCont.update("IO_EXTRATO")
                    .fields("EXTRATOLIDO")
                    .where("CHAVE = ? ")
                    .param(0)
                    .param(chaveExtrato)
                    .execute();
                } catch (Exception sqlUpdateException) {
                    logger.logError("Error updating IO_EXTRATO", sqlUpdateException);
                    continue;
                }
            }
        } catch (Exception readExtratoException) {
            logger.logError("Erro de leitura de Extrato CEF Excel", readExtratoException);
        }
    }
    return true;
}

/* ################################################################################################ @EXTRATO-SICOOB ##
    Leitura de txt Padrão EXTRATO - SICOOB
    ## ################################################################################################################## */
public boolean readExtratoSicoobDefault(MemoryFile memFile, String nomePortador, JSONObject jDados, DataBase dbIOCont, InoutLogger logger) throws Exception {
    JSONObject extratoEmpresa = new JSONObject();

    // Inicializacao de Variaveis
    String codEmpresa        = "";
    String nomeArquivo       = "";
    String chaveExtrato      = "";

    String documento         = "";
    String nomeOrigem        = "";
    String dataMovimento     = "";
    String dataLote          = "";
    String complemento01     = "";
    String complemento02     = "";
    String complemento03     = "";
    String complemento04     = "";
    String complemento05     = "";
    String complemento06     = "";
    String complemento07     = "";
    String complemento08     = "";
    String complemento09     = "";
    String complemento10     = "";
    String debitoCredito     = "";
    String cpfCnpj           = "";
    String historico         = "";

    String strValorDocumento = "";
    String contLinhaExtrato  = "";

    double valorDocumento    = 0.0;
    double valorJuros        = 0.0;
    double valorDesconto     = 0.0;
    double valorMulta        = 0.0;
    double valorPagamento    = 0.0;

	int idataMovimento	= 0;
	int idocumento		= 1;
	int inomeOrigem		= 2;
	int ivalorDocumento	= 3;
	int icomplemento02	= 3;
    String dataAux = "";
    String cont = "";
    if(jDados.has("CODEMPRESA"))   codEmpresa   = jDados.optString("CODEMPRESA");
    if(jDados.has("NOMEARQUIVO"))  nomeArquivo  = jDados.optString("NOMEARQUIVO");

    while (memFile.hasNextLine()) {

        try {
            String line = memFile.nextLine();
            line = StringUtil.removeSpecialCharsToUC(line);
            if(memFile.getStringFieldRemoveEspCharsUpper(inomeOrigem).toUpperCase().trim().startsWith("SALDO")) continue;
            if (memFile.getStringFieldRemoveEspCharsUpper(idataMovimento).replaceAll("\"","").equals("")) dataAux = dataMovimento;

            try {
                Date dt = memFile.getDateField(idataMovimento, "dd/MM/yyyy");
                dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                dataLote = DateUtil.dateToString(dt, "yyyy-MM");
            } catch (Exception dt1) {
                try {
                    Date dt = memFile.getDateField(idataMovimento);
                    dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                    dataLote = DateUtil.dateToString(dt, "yyyy-MM");
                } catch (Exception dt2) {
                    try {
                        String dataString = memFile.getStringFieldRemoveEspCharsUpper(idataMovimento).replaceAll("\"","");
                        Date dt  = DateUtil.stringToDate(dataString, "dd/MM/yyyy");
                        dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                        dataLote = DateUtil.dateToString(dt, "yyyy-MM");
                    } catch (Exception dt2) { }
                }
            }

            // valorDocumento  = 0;
			if(memFile.getDoubleField(ivalorDocumento) != 0){	
				try{valorDocumento = Math.abs(memFile.getDoubleField(ivalorDocumento));}
				catch (Exception vlrd) { valorDocumento = 0; }
				nomeOrigem = "";
				cont = StringUtil.leftPad(String.valueOf(memFile.getCurrentIndex()), 05, "0");
            }
            nomeOrigem		+= " " + memFile.getStringFieldRemoveEspCharsUpper(inomeOrigem).replaceAll("\"","").trim();
			complemento01   = nomePortador;
            complemento02	= "";
            complemento02	= memFile.getStringFieldRemoveEspCharsUpper(icomplemento02).replaceAll("\"","");
			documento		= "";
            documento		= memFile.getStringFieldRemoveEspCharsUpper(idocumento).replaceAll("\"","");
            if (complemento02.contains("C")) debitoCredito = "EXTRATO-CREDITO";
			if (complemento02.contains("*")) continue;
            if (complemento02.contains("D")) debitoCredito = "EXTRATO-DEBITO";

            contLinhaExtrato = cont;

            chaveExtrato = codEmpresa + "-" +  dataMovimento + "-" + debitoCredito + "-" + String.format("%.2f", valorDocumento) + "-" + nomePortador + "-" + contLinhaExtrato;
            // Buscar Extrato por Chave na Tabela IO_EXTRATO.
            extratoEmpresa = dbIOCont.sql("SELECT CHAVE FROM IO_EXTRATO WHERE CHAVE = ?")
            .fields("CHAVE")
            .param(chaveExtrato)
            .queryUnique();

            // Inserir caso Chave nao encontrada.
            if (extratoEmpresa == null || !extratoEmpresa.has("CHAVE")) {
                try {
                    dbIOCont.insert("IO_EXTRATO")
                    .fields("CHAVE,CODEMPRESA, DATAMOVIMENTO, PORTADOR, HISTORICO, LOTE, COMPLEMENTO, VALORDOCUMENTO, DEBITOCREDITO, EXTRATOLIDO")
                    .param(chaveExtrato)
                    .param(codEmpresa)
                    .param(dataMovimento)
                    .param(nomePortador)
                    .param(nomeOrigem)
                    .param(nomeArquivo.toUpperCase())
                    .param(complemento02)
                    .param(valorDocumento)
                    .param(debitoCredito)
                    .param(0)
                    .execute();
                } catch (Exception sqlInsertException) {
                    logger.logError("Error inserting to IO_EXTRATO", sqlInsertException);
                    continue;
                }
                // Atualizar Chave caso encontrada.
            } else {
                try {
                    dbIOCont.update("IO_EXTRATO")
                    .fields("EXTRATOLIDO, HISTORICO")
                    .where("CHAVE = ? ")
                    .param(0)
                    .param(nomeOrigem)
                    .param(chaveExtrato)
                    .execute();
                } catch (Exception sqlUpdateException) {
                    logger.logError("Error updating IO_EXTRATO", sqlUpdateException);
                    continue;
                }
            }
        } catch (Exception readExtratoException) {
            logger.logError("Erro de leitura de Extrato Padrão Sicoob", readExtratoException);
        }
    }
    return true;
}

// /* ################################################################################################ @EXTRATO-SICOOB ##
//     Leitura de txt Padrão EXTRATO - SICOOB
//     ## ################################################################################################################## */
    public boolean readExtratoSicoobDefaultNovo(MemoryFile memFile, String nomePortador, JSONObject jDados, DataBase dbIOCont, InoutLogger logger) throws Exception {

        JSONObject extratoEmpresa = new JSONObject();
    
        // Inicializacao de Variaveis
        String codEmpresa        = "";
        String nomeArquivo       = "";
        String chaveExtrato      = "";
    
        String documento         = "";
        String nomeOrigem        = "";
        String dataMovimento     = "";
        String dataLote          = "";
        String complemento01     = "";
        String complemento02     = "";
        String complemento03     = "";
        String complemento04     = "";
        String complemento05     = "";
        String complemento06     = "";
        String complemento07     = "";
        String complemento08     = "";
        String complemento09     = "";
        String complemento10     = "";
        String debitoCredito     = "";
        String cpfCnpj           = "";
        String historico         = "";
    
        String strValorDocumento = "";
        String contLinhaExtrato  = "";
    
        double valorDocumento    = 0.0;
        double valorJuros        = 0.0;
        double valorDesconto     = 0.0;
        double valorMulta        = 0.0;
        double valorPagamento    = 0.0;
    
        int idataMovimento	= 0;
        int idocumento		= 1;
        int inomeOrigem		= 2;
        int ivalorDocumento	= 3;
        int icomplemento02	= 1;
    
        if(jDados.has("CODEMPRESA"))   codEmpresa   = jDados.optString("CODEMPRESA");
        if(jDados.has("NOMEARQUIVO"))  nomeArquivo  = jDados.optString("NOMEARQUIVO");
    
        while (memFile.hasNextLine()) {
    
            try {
                String line = memFile.nextLine();
                line = StringUtil.removeSpecialCharsToUC(line);
                if (memFile.getStringFieldRemoveEspCharsUpper(idataMovimento).replaceAll("\"","").equals("")) continue;
    
                try {
                    Date dt = memFile.getDateField(idataMovimento, "dd/MM/yyyy");
                    dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                    dataLote = DateUtil.dateToString(dt, "yyyy-MM");
                } catch (Exception dt1) {
                    try {
                        Date dt = memFile.getDateField(idataMovimento);
                        dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                        dataLote = DateUtil.dateToString(dt, "yyyy-MM");
                    } catch (Exception dt2) {
                        try {
                            String dataString = memFile.getStringFieldRemoveEspCharsUpper(idataMovimento).replaceAll("\"","");
                            Date dt  = DateUtil.stringToDate(dataString, "dd/MM/yyyy");
                            dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                            dataLote = DateUtil.dateToString(dt, "yyyy-MM");
                        } catch (Exception dt2) { }
                    }
                }
    
                valorDocumento  = 0;
                try{valorDocumento = Math.abs(memFile.getDoubleField(ivalorDocumento));}
                catch (Exception vlrd) { valorDocumento = 0; }
                if (valorDocumento == 0) continue;
    
                nomeOrigem      = "";
                nomeOrigem		= memFile.getStringFieldRemoveEspCharsUpper(inomeOrigem).replaceAll("\"","");
                complemento01   = nomePortador;
                complemento02	= "";
                complemento02	= memFile.getStringFieldRemoveEspCharsUpper(icomplemento02).replaceAll("\"","");
                documento		= "";
                documento		= memFile.getStringFieldRemoveEspCharsUpper(idocumento).replaceAll("\"","");
    
                if (memFile.getStringFieldRemoveEspCharsUpper(ivalorDocumento).contains("C")) debitoCredito = "EXTRATO-CREDITO";
                if (memFile.getStringFieldRemoveEspCharsUpper(ivalorDocumento).contains("D")) debitoCredito = "EXTRATO-DEBITO";
    
                contLinhaExtrato = StringUtil.leftPad(String.valueOf(memFile.getCurrentIndex()), 05, "0");
    
                chaveExtrato = codEmpresa + "-" +  dataMovimento + "-" + debitoCredito + "-" + String.format("%.2f", valorDocumento) + "-" + nomePortador + "-" + contLinhaExtrato;
    // Buscar Extrato por Chave na Tabela IO_EXTRATO.
                extratoEmpresa = dbIOCont.sql("SELECT CHAVE FROM IO_EXTRATO WHERE CHAVE = ?")
                .fields("CHAVE")
                .param(chaveExtrato)
                .queryUnique();
    
                // Inserir caso Chave nao encontrada.
                if (extratoEmpresa == null || !extratoEmpresa.has("CHAVE")) {
                    try {
                        dbIOCont.insert("IO_EXTRATO")
                        .fields("CHAVE,CODEMPRESA, DATAMOVIMENTO, PORTADOR, HISTORICO, LOTE, COMPLEMENTO, VALORDOCUMENTO, DEBITOCREDITO, EXTRATOLIDO")
                        .param(chaveExtrato)
                        .param(codEmpresa)
                        .param(dataMovimento)
                        .param(nomePortador)
                        .param(nomeOrigem)
                        .param(nomeArquivo.toUpperCase())
                        .param(complemento02)
                        .param(valorDocumento)
                        .param(debitoCredito)
                        .param(0)
                        .execute();
                    } catch (Exception sqlInsertException) {
                        logger.logError("Error inserting to IO_EXTRATO", sqlInsertException);
                        continue;
                    }
                    // Atualizar Chave caso encontrada.
                } else {
                    try {
                        dbIOCont.update("IO_EXTRATO")
                        .fields("EXTRATOLIDO")
                        .where("CHAVE = ? ")
                        .param(0)
                        .param(chaveExtrato)
                        .execute();
                    } catch (Exception sqlUpdateException) {
                        logger.logError("Error updating IO_EXTRATO", sqlUpdateException);
                        continue;
                    }
                }
            } catch (Exception readExtratoException) {
                logger.logError("Erro de leitura de Extrato Padrão Sicoob", readExtratoException);
            }
        }
        return true;
    }
    

/* ################################################################################################ @EXTRATO-SAFRA-EXCEL ##
    Leitura de txt Padrão EXTRATO - SAFRA EXCEL
    ## ################################################################################################################## */
public boolean readExtratoSafraExcel(MemoryFile memFile, String nomePortador, JSONObject jDados, DataBase dbIOCont, InoutLogger logger) throws Exception {

  JSONObject extratoEmpresa = new JSONObject();

  // Inicializacao de Variaveis
  String codEmpresa        = "";
  String nomeArquivo       = "";
  String chaveExtrato      = "";

  String documento         = "";
  String nomeOrigem        = "";
  String dataMovimento     = "";
  String dataLote          = "";
  String complemento01     = "";
  String complemento02     = "";
  String complemento03     = "";
  String complemento04     = "";
  String complemento05     = "";
  String complemento06     = "";
  String complemento07     = "";
  String complemento08     = "";
  String complemento09     = "";
  String complemento10     = "";
  String debitoCredito     = "";
  String cpfCnpj           = "";
  String historico         = "";
  String anoRef			 = "";

  String strValorDocumento = "";
  String contLinhaExtrato  = "";

  double valorDocumento    = 0.0;
  double valorJuros        = 0.0;
  double valorDesconto     = 0.0;
  double valorMulta        = 0.0;
  double valorPagamento    = 0.0;

  int idataMovimento	= 0;
  int inomePortador	= 1;
  int inomeOrigem	    = 3;
  int ivalorDocumento	= 6;
  int icomplemento01	= 6;
  String tipoSafra    = "PADRAO02";


  if(jDados.has("CODEMPRESA"))	codEmpresa   = jDados.optString("CODEMPRESA");
  if(jDados.has("NOMEARQUIVO"))	nomeArquivo  = jDados.optString("NOMEARQUIVO");
  if(jDados.has("ANO")){
  anoRef = jDados.optString("ANO");
  anoRef = cutString(anoRef, "/");
  }
  while (memFile.hasNextLine()) {

      try {
          String line = memFile.nextLine();
          line = StringUtil.removeSpecialCharsToUC(line);

          if(line.contains("EMPRESA:") && line.contains("CNPJ:")){
             idataMovimento	  = 0;
             inomePortador	  = 0;
             inomeOrigem		  = 1;
             ivalorDocumento  = 3;
             icomplemento01	  = 3;

              tipoSafra = "PADRAO01";
          }
          if(tipoSafra.contains("PADRAO01")){
              if(line.contains("EXTRATO") && line.contains("MOVIMENTACAO") && line.contains("PERIODO:")){
                  String dataAux = cutString(line, "PERIODO:");
                  dataAux = cutString(dataAux, 0, "ATE");
                  try{
                      Date dta = DateUtil.stringToDate(dataAux, "dd/MM/yyyy");
                      anoRef	 = DateUtil.dateToString(dta, "yyyy");
                  }catch(Exception dt) {}
              }

              if (line.contains("AGENCIA") && !nomePortador.contains("SAFRA")) nomePortador  = "SAFRA "+ line.replaceAll("\\|","");

              if (memFile.getStringFieldRemoveEspCharsUpper(idataMovimento).replaceAll("\"","").equals("")) continue;
              if (memFile.getStringFieldRemoveEspCharsUpper(idataMovimento).replaceAll("\"","").length() < 10){
                  try {
                      String dataString = memFile.getStringFieldRemoveEspCharsUpper(idataMovimento).replaceAll("\"","") +"/"+anoRef;
                      Date dt  = DateUtil.stringToDate(dataString, "dd/MM/yyyy");
                      dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                      dataLote = DateUtil.dateToString(dt, "yyyy-MM");
                  } catch (Exception dt2) { }
              }else{
                  try {
                      Date dt = memFile.getDateField(idataMovimento, "dd/MM/yyyy");
                      dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                      dataLote = DateUtil.dateToString(dt, "yyyy-MM");
                  } catch (Exception dt1) {
                      try {
                          Date dt = memFile.getDateField(idataMovimento);
                          dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                          dataLote = DateUtil.dateToString(dt, "yyyy-MM");
                      } catch (Exception dt2) {
                          try {
                              String dataString = memFile.getStringFieldRemoveEspCharsUpper(idataMovimento).replaceAll("\"","");
                              Date dt  = DateUtil.stringToDate(dataString, "dd/MM/yyyy");
                              dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                              dataLote = DateUtil.dateToString(dt, "yyyy-MM");
                          } catch (Exception dt2) {

                          }
                      }
                  }
              }
              if (dataMovimento.equals("")) continue;

              valorDocumento  = 0;
              try{
                  if (memFile.getStringFieldRemoveEspCharsUpper(ivalorDocumento).contains("-")) {
                      valorDocumento = Math.abs(DecimalUtil.toDecimal(memFile.getStringFieldRemoveEspCharsUpper(ivalorDocumento).replace("'", "").replaceAll("\\.", "").replaceAll(",", "\\.")));
                  }
                  else valorDocumento = Math.abs(memFile.getDoubleField(ivalorDocumento));
              }catch (Exception vlrd) { valorDocumento = 0; }
              if (valorDocumento == 0) continue;


              nomeOrigem      = "";
              nomeOrigem		= memFile.getStringFieldRemoveEspCharsUpper(inomeOrigem).replaceAll("\"","");
              complemento01   = "";
              complemento01   = memFile.getStringFieldRemoveEspCharsUpper(icomplemento01).replaceAll("\"","");
          }
          if(tipoSafra.contains("PADRAO02")){
              if (line.startsWith("PERIODO") && line.contains("DE")) {
                  String dataAux = cutString(line, "PERIODO DE");
                  dataAux = cutString(dataAux, 0, "A");
                  try{
                    Date dta = DateUtil.stringToDate(dataAux, "dd/MM/yyyy");
                    anoRef	 = DateUtil.dateToString(dta, "yyyy");
                  }catch(Exception dt) {}
                }

                if ((line.contains("AGENCIA") || line.contains("AG.")) && !nomePortador.contains("SAFRA")) {
                  nomePortador  = "SAFRA "+ line.replaceAll("\\|","");
                }

                if (memFile.getStringFieldRemoveEspCharsUpper(idataMovimento).replaceAll("\"","").equals("")) continue;
                if (memFile.getStringFieldRemoveEspCharsUpper(idataMovimento).replaceAll("\"","").length() < 10){
                  try {
                    String dataString = memFile.getStringFieldRemoveEspCharsUpper(idataMovimento).replaceAll("\"","") +"/"+anoRef;
                    Date dt  = DateUtil.stringToDate(dataString, "dd/MM/yyyy");
                    dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                    dataLote = DateUtil.dateToString(dt, "yyyy-MM");
                  } catch (Exception dt2) { }
                }else{
                  try {
                    Date dt = memFile.getDateField(idataMovimento, "dd/MM/yyyy");
                    dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                    dataLote = DateUtil.dateToString(dt, "yyyy-MM");
                  } catch (Exception dt1) {
                    try {
                      Date dt = memFile.getDateField(idataMovimento);
                      dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                      dataLote = DateUtil.dateToString(dt, "yyyy-MM");
                    } catch (Exception dt2) {
                      try {
                        String dataString = memFile.getStringFieldRemoveEspCharsUpper(idataMovimento).replaceAll("\"","");
                        Date dt  = DateUtil.stringToDate(dataString, "dd/MM/yyyy");
                        dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                        dataLote = DateUtil.dateToString(dt, "yyyy-MM");
                      } catch (Exception dt2) {

                      }
                    }
                  }
                }
                if (dataMovimento.equals("")) continue;
                      valorDocumento  = 0;
                      try{
                          if (memFile.getStringFieldRemoveEspCharsUpper(ivalorDocumento).contains("-")) {
                              strValorDocumento = memFile.getStringFieldRemoveEspCharsUpper(ivalorDocumento).replaceAll("\"","") ;
                              strValorDocumento = strValorDocumento.replace("'", "").replace("-","").replaceAll(",", "\\.");
                              valorDocumento = Math.abs(NumberUtil.toDecimal(strValorDocumento));
                          }
                          else  valorDocumento = Math.abs(memFile.getDoubleField(ivalorDocumento));
                      }catch (Exception vlrd) { valorDocumento = 0; }
                          if (valorDocumento == 0) continue;

              nomeOrigem      = "";
              nomeOrigem		= memFile.getStringFieldRemoveEspCharsUpper(inomeOrigem).replaceAll("\"","");
              complemento01   = "";
              complemento01   = memFile.getStringFieldRemoveEspCharsUpper(icomplemento01).replaceAll("\"","");
          }
          if (!complemento01.contains("-")) debitoCredito = "EXTRATO-CREDITO";
          if ( complemento01.contains("-")) debitoCredito = "EXTRATO-DEBITO";

          contLinhaExtrato = StringUtil.leftPad(String.valueOf(memFile.getCurrentIndex()), 05, "0");

    if (nomePortador.equals("")) nomePortador = "SAFRA";

          chaveExtrato = codEmpresa + "-" +  dataMovimento + "-" + debitoCredito + "-" + String.format("%.2f", valorDocumento) + "-" + nomePortador + "-" + contLinhaExtrato;

          // Buscar Extrato por Chave na Tabela IO_EXTRATO.
          extratoEmpresa = dbIOCont.sql("SELECT CHAVE FROM IO_EXTRATO WHERE CHAVE = ?")
          .fields("CHAVE")
          .param(chaveExtrato)
          .queryUnique();

          // Inserir caso Chave nao encontrada.
          if (extratoEmpresa == null || !extratoEmpresa.has("CHAVE")) {
              try {
                  dbIOCont.insert("IO_EXTRATO")
                  .fields("CHAVE,CODEMPRESA, DATAMOVIMENTO, PORTADOR, HISTORICO, LOTE, COMPLEMENTO, VALORDOCUMENTO, DEBITOCREDITO, EXTRATOLIDO")
                  .param(chaveExtrato)
                  .param(codEmpresa)
                  .param(dataMovimento)
                  .param(nomePortador)
                  .param(nomeOrigem)
                  .param(nomeArquivo.toUpperCase())
                  .param(complemento02)
                  .param(valorDocumento)
                  .param(debitoCredito)
                  .param(0)
                  .execute();
              } catch (Exception sqlInsertException) {
                  logger.logError("Error inserting to IO_EXTRATO", sqlInsertException);
                  continue;

              }
              // Atualizar Chave caso encontrada.
          } else {
              try {
                  dbIOCont.update("IO_EXTRATO")
                  .fields("EXTRATOLIDO")
                  .where("CHAVE = ? ")
                  .param(0)
                  .param(chaveExtrato)
                  .execute();
              } catch (Exception sqlUpdateException) {
                  logger.logError("Error updating IO_EXTRATO", sqlUpdateException);
                  continue;
              }
          }
      } catch (Exception readExtratoException) {
          logger.logError("Erro de leitura de Extrato Safra Excel", readExtratoException);
      }
  }
  return true;
}


public boolean readExtratoTopazioExcel(MemoryFile memFile, String nomePortador, JSONObject jDados, DataBase dbIOCont, InoutLogger logger) throws Exception {

    JSONObject extratoEmpresa = new JSONObject();

    // Inicializacao de Variaveis
    String codEmpresa        = "";
    String nomeArquivo       = "";
    String chaveExtrato      = "";

    String documento         = "";
    String nomeOrigem        = "";
    String dataMovimento     = "";
    String dataLote          = "";
    String complemento01     = "";
    String complemento02     = "";
    String complemento03     = "";
    String complemento04     = "";
    String complemento05     = "";
    String complemento06     = "";
    String complemento07     = "";
    String complemento08     = "";
    String complemento09     = "";
    String complemento10     = "";
    String debitoCredito     = "";
    String cpfCnpj           = "";
    String historico         = "";

    String strValorDocumento = "";
    String contLinhaExtrato  = "";

    double valorDocumento    = 0.0;
    double valorJuros        = 0.0;
    double valorDesconto     = 0.0;
    double valorMulta        = 0.0;
    double valorPagamento    = 0.0;

	int idataMovimento	= 0;
	int idocumento      = 2;
	int inomePortador	=-1;
	int inomeOrigem		= 1;
	int ivalorDocumento	= 3;
	int icomplemento01	= 4;

    if(jDados.has("CODEMPRESA"))   codEmpresa   = jDados.optString("CODEMPRESA");
    if(jDados.has("NOMEARQUIVO"))  nomeArquivo  = jDados.optString("NOMEARQUIVO");

    while (memFile.hasNextLine()) {

        try {
            String line = memFile.nextLine();
            line = StringUtil.removeSpecialCharsToUC(line);

			if(line.contains("CONTA:")) nomePortador = "TOPAZ BANKING " + memFile.getStringFieldRemoveEspCharsUpper(1).replaceAll("\"","");
            if (memFile.getStringFieldRemoveEspCharsUpper(idataMovimento).replaceAll("\"","").equals("")) continue;

            try {
                Date dt = memFile.getDateField(idataMovimento, "dd/MM/yyyy");
                dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                dataLote = DateUtil.dateToString(dt, "yyyy-MM");
            } catch (Exception dt1) {
                try {
                    Date dt = memFile.getDateField(idataMovimento);
                    dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                    dataLote = DateUtil.dateToString(dt, "yyyy-MM");
                } catch (Exception dt2) {
                    try {
                        String dataString = memFile.getStringFieldRemoveEspCharsUpper(idataMovimento).replaceAll("\"","");
                        Date dt  = DateUtil.stringToDate(dataString, "dd/MM/yyyy");
                        dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                        dataLote = DateUtil.dateToString(dt, "yyyy-MM");
                    } catch (Exception dt2) { }
                }
            }

            valorDocumento  = 0;
			try{valorDocumento = Math.abs(memFile.getDoubleField(ivalorDocumento));}
			catch (Exception vlrd) { valorDocumento = 0; }

            if (valorDocumento == 0) continue;

			nomeOrigem      = "";
            nomeOrigem		= memFile.getStringFieldRemoveEspCharsUpper(inomeOrigem).replaceAll("\"","");
            complemento01   = "";
			complemento01   = memFile.getStringFieldRemoveEspCharsUpper(icomplemento01).replaceAll("\"","");

            if (!complemento01.contains("-")) debitoCredito = "EXTRATO-CREDITO";
            if ( complemento01.contains("-")) debitoCredito = "EXTRATO-DEBITO";

            contLinhaExtrato = StringUtil.leftPad(String.valueOf(memFile.getCurrentIndex()), 05, "0");

            chaveExtrato = codEmpresa + "-" +  dataMovimento + "-" + debitoCredito + "-" + String.format("%.2f", valorDocumento) + "-" + nomePortador + "-" + contLinhaExtrato;

            // Buscar Extrato por Chave na Tabela IO_EXTRATO.
            extratoEmpresa = dbIOCont.sql("SELECT CHAVE FROM IO_EXTRATO WHERE CHAVE = ?")
            .fields("CHAVE")
            .param(chaveExtrato)
            .queryUnique();

            // Inserir caso Chave nao encontrada.
            if (extratoEmpresa == null || !extratoEmpresa.has("CHAVE")) {
                try {
                    dbIOCont.insert("IO_EXTRATO")
                    .fields("CHAVE,CODEMPRESA, DATAMOVIMENTO, PORTADOR, HISTORICO, LOTE, COMPLEMENTO, VALORDOCUMENTO, DEBITOCREDITO, EXTRATOLIDO")
                    .param(chaveExtrato)
                    .param(codEmpresa)
                    .param(dataMovimento)
                    .param(nomePortador)
                    .param(nomeOrigem)
                    .param(nomeArquivo.toUpperCase())
                    .param(complemento02)
                    .param(valorDocumento)
                    .param(debitoCredito)
                    .param(0)
                    .execute();
                } catch (Exception sqlInsertException) {
                    logger.logError("Error inserting to IO_EXTRATO", sqlInsertException);
                    continue;

                }

                // Atualizar Chave caso encontrada.
            } else {
                try {
                    dbIOCont.update("IO_EXTRATO")
                    .fields("EXTRATOLIDO")
                    .where("CHAVE = ? ")
                    .param(0)
                    .param(chaveExtrato)
                    .execute();
                } catch (Exception sqlUpdateException) {
                    logger.logError("Error updating IO_EXTRATO", sqlUpdateException);
                    continue;
                }
            }

		} catch (Exception readExtratoException) {
            logger.logError("Erro de leitura de Extrato Correntete Excel", readExtratoException);
        }
    }
    return true;
}

/* ########################################################################################### @EXTRATO-SICOOB ##
                                        Leitura de Planilha Padrao EXTRATO - SICOOB (Planilha base - Acncontadores - Martiflex)
## ################################################################################################################## */
public boolean readExtratoSicoobTxt(MemoryFile memFile, String nomePortador, JSONObject jDados, DataBase dbIOCont, InoutLogger logger) throws Exception {

    JSONObject extratoEmpresa = new JSONObject();

    // Inicializacao de Variaveis
    String codEmpresa        = "";
    String nomeArquivo       = "";
    String chaveExtrato      = "";

    String documento         = "";
    String nomeOrigem        = "";
    String dataMovimento     = "";
    String dataLote          = "";
    String complemento01     = "";
    String complemento02     = "";
    String complemento03     = "";
    String complemento04     = "";
    String complemento05     = "";
    String complemento06     = "";
    String complemento07     = "";
    String complemento08     = "";
    String complemento09     = "";
    String complemento10     = "";
    String debitoCredito     = "";
    String cpfCnpj           = "";
    String historico         = "";

    String strValorDocumento = "";
    String contLinhaExtrato  = "";

    double valorDocumento    = 0.0;
    double valorJuros        = 0.0;
    double valorDesconto     = 0.0;
    double valorMulta        = 0.0;
    double valorPagamento    = 0.0;

    boolean naoLeMais = false;

    String cont = "";

    if(jDados.has("CODEMPRESA"))   codEmpresa   = jDados.optString("CODEMPRESA");
    if(jDados.has("NOMEARQUIVO"))  nomeArquivo  = jDados.optString("NOMEARQUIVO");

    while (memFile.hasNextLine()) {

        try {
            String line = memFile.nextLine();
            line = StringUtil.removeSpecialCharsToUC(line);
            if(line.contains("-----------------------------")) continue;
            if(line.contains(".........................")) continue;
            if (line.contains("SALDO")) continue;
            if (line.contains("RESUMO") && line.length()==6) continue;
            if (line.contains("EXTRATO NO.:")) continue;
            if (line.contains("OUVIDORIA SICOOB:")) continue;
			if (line.length() > 85 && line.endsWith("*")) continue;

            if (line.startsWith("CONTA:")) {
                nomePortador = line.substring(line.indexOf("CONTA:")).trim();
                nomePortador = nomePortador.substring(0, line.indexOf("-") + 2).trim();
                continue;
            }

            complemento01   = "";
            complemento02   = "";
            complemento03   = "";
            complemento04   = "";
            complemento05   = "";

            complemento06   = "";
            complemento07   = "";
            complemento08   = "";
            complemento09   = "";
            complemento10   = "";

            cpfCnpj         = "";

            documento       = "";
            historico       = "";

            valorJuros      = 0;
            valorDesconto   = 0;
            valorMulta      = 0;
            valorPagamento  = 0;


            if (line.substring(2,3).equals("/") && line.substring(5,6).equals("/")) {

                //if (line.length() < 128) continue;

                // Data Movimento.
                if (line.substring(2,3).equals("/") && line.substring(5,6).equals("/")) {
                    try {
                        dataMovimento = line.substring( 0, 10 );
                        Date dt 	  = DateUtil.stringToDate( dataMovimento, "dd/MM/yyyy" );
                        dataMovimento = DateUtil.dateToString( dt, "dd/MM/yyyy" );
                        dataLote      = DateUtil.dateToString( dt,"yyyy-MM" );
                    } catch (Exception dte) { }
                }
                if (dataMovimento.equals("")) continue;
			
                String valorDocumentoAux = line.substring( 75, line.length());
                if (valorDocumentoAux.contains("C")) debitoCredito = "EXTRATO-CREDITO";
                else if (valorDocumentoAux.contains("D")) debitoCredito = "EXTRATO-DEBITO";
				
				complemento01 = StringUtil.removeSpecialChars(line.substring( 12, 30 )).trim().toUpperCase();

                strValorDocumento = "0";
                try{
                    strValorDocumento    = StringUtil.removeSpecialChars(valorDocumentoAux.replaceAll("[A-Za-z]", "")).trim().toUpperCase();
                    strValorDocumento    = strValorDocumento.replaceAll("\\.","").replaceAll("-","");

                    valorDocumento = DecimalUtil.toDecimal(strValorDocumento);
               
                } catch (Exception vlrx) {
                    valorDocumento = 0;
                }
                nomeOrigem    = StringUtil.removeSpecialChars(line.substring( 32, 75 )).trim().toUpperCase();
                cont = StringUtil.leftPad(String.valueOf(memFile.getCurrentIndex()), 05, "0");

                if(valorDocumento == 0) dataMovimento = "";
                if(valorDocumento == 0) continue;

                contLinhaExtrato = cont;
            } else {
                complemento02 = line.trim();
                nomeOrigem	   += " " + line.trim();
            }
            
            if (dataMovimento.trim().equals("")) continue;

            if(naoLeMais) continue;

            // Chave para Insert/Update no Banco de Dados.
            chaveExtrato = codEmpresa + "-" +  dataMovimento + "-" + debitoCredito + "-" + String.format("%.2f", valorDocumento) + "-" + nomePortador + "-" + contLinhaExtrato;
            // Buscar Extrato por Chave na Tabela IO_EXTRATO.
            extratoEmpresa = dbIOCont.sql("SELECT CHAVE FROM IO_EXTRATO WHERE CHAVE = ?")
            .fields("CHAVE")
            .param(chaveExtrato)
            .queryUnique();

            if (extratoEmpresa == null || !extratoEmpresa.has("CHAVE")) {
                try {

                    dbIOCont.insert("IO_EXTRATO")
                    .fields("CHAVE,CODEMPRESA, DATAMOVIMENTO, PORTADOR, HISTORICO, LOTE, COMPLEMENTO, VALORDOCUMENTO, DEBITOCREDITO, EXTRATOLIDO")
                    .param(chaveExtrato)
                    .param(codEmpresa)
                    .param(dataMovimento)
                    .param(nomePortador)
                    .param(nomeOrigem)
                    .param(nomeArquivo.toUpperCase())
                    .param(complemento01)
                    .param(valorDocumento)
                    .param(debitoCredito)
                    .param(0)
                    .execute();
                } catch(Exception e) {
                    logger.logError("Error inserting to IO_EXTRATO", e);
                    continue;
                }
            } else {
                try {

                    dbIOCont.update("IO_EXTRATO")
                    .fields("EXTRATOLIDO, HISTORICO")
                    .where("CHAVE = ? ")
                    .param(0)
                    .param(nomeOrigem)
                    .param(chaveExtrato)
                    .execute();
                } catch(Exception e1) {
                    logger.logError("Error updating IO_EXTRATO", e1);
                    continue;
                }
            }
        } catch(Exception e) {
            logger.logError("ERRO: ", e);
        }
    }

    return true;
}
/* ########################################################################################### @EXTRATO-UNIPRIME ##
                                        Leitura de Planilha Padrao EXTRATO - UNIPRIME - C/ DOCUMENTO
## ################################################################################################################## */
public boolean readExtratoBancoUniprime(MemoryFile memFile, String nomePortador, JSONObject jDados, DataBase dbIOCont, InoutLogger logger) throws Exception {

    // USADO -> Vipcontabilidade.MiequipamentosContas_Pagas
    JSONObject extratoEmpresa = new JSONObject();

    // Inicializacao de Variaveis
    String codEmpresa        = "";
    String nomeArquivo       = "";
    String chaveExtrato      = "";

    String documento         = "";
    String nomeOrigem        = "";
    String dataMovimento     = "";
    String dataLote          = "";
    String complemento01     = "";
    String complemento02     = "";
    String complemento03     = "";
    String complemento04     = "";
    String complemento05     = "";
    String complemento06     = "";
    String complemento07     = "";
    String complemento08     = "";
    String complemento09     = "";
    String complemento10     = "";
    String debitoCredito     = "";
    String cpfCnpj           = "";
    String historico         = "";

    String strValorDocumento = "";
    String contLinhaExtrato  = "";

    double valorDocumento    = 0.0;
    double valorJuros        = 0.0;
    double valorDesconto     = 0.0;
    double valorMulta        = 0.0;
    double valorPagamento    = 0.0;

    boolean naoLeMais = false;

    if(jDados.has("CODEMPRESA"))   codEmpresa   = jDados.optString("CODEMPRESA");
    if(jDados.has("NOMEARQUIVO"))  nomeArquivo  = jDados.optString("NOMEARQUIVO");

    while (memFile.hasNextLine()) {

        try {
            String line = memFile.nextLine();
            line = StringUtil.removeSpecialCharsToUC(line);

            if (line.contains("CONTA:")) {
                nomePortador = cutString(line, "CONTA:");
                continue;
            }

            complemento01   = "";
            complemento02   = "";
            complemento03   = "";
            complemento04   = "";
            complemento05   = "";

            complemento06   = "";
            complemento07   = "";
            complemento08   = "";
            complemento09   = "";
            complemento10   = "";

            cpfCnpj         = "";

            historico       = "";

            valorJuros      = 0;
            valorDesconto   = 0;
            valorMulta      = 0;
            valorPagamento  = 0;


            if (line.substring(2,3).equals("/") && line.substring(5,6).equals("/")) {

                if (line.length() < 81) continue;

                // Data Movimento.
                if (line.substring(2,3).equals("/") && line.substring(5,6).equals("/")) {
                    try {
                        dataMovimento = line.substring( 0, 10 );
                        Date dt 	  = DateUtil.stringToDate( dataMovimento, "dd/MM/yyyy" );
                        dataMovimento = DateUtil.dateToString( dt, "dd/MM/yyyy" );
                        dataLote      = DateUtil.dateToString( dt,"yyyy-MM" );
                    } catch (Exception dte) { continue; }
                }
                if (dataMovimento.equals("")) continue;
                debitoCredito = StringUtil.removeSpecialCharsToUC(line.substring( 80, 81 )).trim();

                nomeOrigem    = StringUtil.removeSpecialChars(line.substring( 25, 70 )).trim().toUpperCase();

                complemento02 = StringUtil.removeSpecialChars(line.substring( 11, 25 )).trim().toUpperCase();

                strValorDocumento = "0";
                try{
                    strValorDocumento    = StringUtil.removeSpecialChars(line.substring( 70, 79 )).trim().toUpperCase();
                    strValorDocumento    = strValorDocumento.replaceAll("\\.","").replaceAll("-","");

                    valorDocumento = DecimalUtil.toDecimal(strValorDocumento);
                } catch (Exception vlrx) {
                    valorDocumento = 0;
                }

                if(valorDocumento == 0) dataMovimento = "";
                if(valorDocumento == 0) continue;

                if (debitoCredito.contains("C")) debitoCredito = "EXTRATO-CREDITO";
                else if (debitoCredito.contains("D")) debitoCredito = "EXTRATO-DEBITO";
                else continue;

                contLinhaExtrato = StringUtil.leftPad(String.valueOf(memFile.getCurrentIndex()), 05, "0");
            } else {

				//complemento02 = line.trim();
                //
                //complemento02 = String.format("%s Documento:%s", complemento02, documento);
				continue;
			}

            if (dataMovimento.trim().equals("")) continue;

            if(naoLeMais) continue;



            // Chave para Insert/Update no Banco de Dados.
            chaveExtrato = codEmpresa + "-" +  dataMovimento + "-" + debitoCredito + "-" + String.format("%.2f", valorDocumento) + "-" + nomePortador + "-" + contLinhaExtrato;

			// Buscar Extrato por Chave na Tabela IO_EXTRATO.
            extratoEmpresa = dbIOCont.sql("SELECT CHAVE FROM IO_EXTRATO WHERE CHAVE = ?")
            .fields("CHAVE")
            .param(chaveExtrato)
            .queryUnique();

            if (extratoEmpresa == null || !extratoEmpresa.has("CHAVE")) {
                try {

                    dbIOCont.insert("IO_EXTRATO")
                    .fields("CHAVE,CODEMPRESA, DATAMOVIMENTO, PORTADOR, HISTORICO, LOTE, COMPLEMENTO, VALORDOCUMENTO, DEBITOCREDITO, EXTRATOLIDO")
                    .param(chaveExtrato)
                    .param(codEmpresa)
                    .param(dataMovimento)
                    .param(nomePortador)
                    .param(nomeOrigem)
                    .param(nomeArquivo.toUpperCase())
                    .param(complemento02)
                    .param(valorDocumento)
                    .param(debitoCredito)
                    .param(0)
                    .execute();
                } catch(Exception e) {
                    logger.logError("Error inserting to IO_EXTRATO", e);
                    continue;
                }
            } else {
                try {

                    dbIOCont.update("IO_EXTRATO")
                    .fields("COMPLEMENTO, EXTRATOLIDO")
                    .where("CHAVE = ? ")
                    .param(complemento02)
                    .param(0)
                    .param(chaveExtrato)
                    .execute();
                } catch(Exception e1) {
                    logger.logError("Error updating IO_EXTRATO", e1);
                    continue;
                }
            }
        } catch(Exception e) {
            logger.logError("ERRO: ", e);
        }
    }

    return true;
}


/* ################################################################################################ @EXTRATO-UNIPRIME ##
                                        Leitura de Planilha Padrão EXTRATO - UNIPRIME
                                        ## ################################################################################################################## */
public boolean readExtratoUniprime(MemoryFile memFile, String nomePortador, JSONObject jDados, DataBase dbIOCont, InoutLogger logger) throws Exception {

    JSONObject extratoEmpresa = new JSONObject();

    // Inicializacao de Variaveis
    String codEmpresa        = "";
    String nomeArquivo       = "";
    String chaveExtrato      = "";

    String documento         = "";
    String nomeOrigem        = "";
    String dataMovimento     = "";
    String dataLote          = "";
    String complemento01     = "";
    String complemento02     = "";
    String complemento03     = "";
    String complemento04     = "";
    String complemento05     = "";
    String complemento06     = "";
    String complemento07     = "";
    String complemento08     = "";
    String complemento09     = "";
    String complemento10     = "";
    String debitoCredito     = "";
    String cpfCnpj           = "";
    String historico         = "";

    String strValorDocumento = "";
    String contLinhaExtrato  = "";

    double valorDocumento    = 0.0;
    double valorJuros        = 0.0;
    double valorDesconto     = 0.0;
    double valorMulta        = 0.0;
    double valorPagamento    = 0.0;

    boolean naoLeMais = false;

    if(jDados.has("CODEMPRESA"))   codEmpresa   = jDados.optString("CODEMPRESA");
    if(jDados.has("NOMEARQUIVO"))  nomeArquivo  = jDados.optString("NOMEARQUIVO");

    while (memFile.hasNextLine()) {

        try {
            String line = memFile.nextLine();
            line = StringUtil.removeSpecialCharsToUC(line);

            complemento01   = "";
            complemento02   = "";
            complemento03   = "";
            complemento04   = "";
            complemento05   = "";

            complemento06   = "";
            complemento07   = "";
            complemento08   = "";
            complemento09   = "";
            complemento10   = "";

            cpfCnpj         = "";

            nomeOrigem      = "";
            documento       = "";
            historico       = "";

            valorDocumento  = 0;
            valorJuros      = 0;
            valorDesconto   = 0;
            valorMulta      = 0;
            valorPagamento  = 0;

			if(memFile.getStringFieldRemoveEspCharsUpper(1).contains("CONTA=")) nomePortador = memFile.getStringFieldRemoveEspCharsUpper(1);
			if(nomePortador.contains("CONTA=")) nomePortador = cutString(nomePortador, "CONTA=",",");

			complemento01   = nomePortador;

            if (memFile.getStringField(1).equals("")) continue;
            try {
                Date dt = memFile.getDateField(1);
                dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                dataLote = DateUtil.dateToString(dt, "yyyy-MM");
            } catch (Exception dt1) {
                try {
                    Date dt = memFile.getDateField(1, "dd/MM/yyyy");    // --- VERIFICAR
                    dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                    dataLote = DateUtil.dateToString(dt, "yyyy-MM");
                } catch (Exception dt2) {
                    continue;
                }
            }


            try {
                valorDocumento = Math.abs(memFile.getDoubleField(5));
            } catch(Exception e) {
                valorDocumento = 0;
            }
            if (valorDocumento > 0) debitoCredito = "EXTRATO-CREDITO";
            else {
                try {
                    valorDocumento = Math.abs(memFile.getDoubleField(4));
                } catch(Exception e) {
                    valorDocumento = 0;
                }

                if(valorDocumento > 0) debitoCredito = "EXTRATO-DEBITO"; else continue;
            }



            complemento02 = memFile.getStringFieldRemoveEspCharsUpper(2);
			nomeOrigem    = memFile.getStringFieldRemoveEspCharsUpper(3);


            if(naoLeMais) continue;

            contLinhaExtrato = StringUtil.leftPad(String.valueOf(memFile.getCurrentIndex()), 05, "0");
            chaveExtrato = codEmpresa + "-" +  dataMovimento + "-" + debitoCredito + "-" + String.format("%.2f", valorDocumento) + "-" + nomePortador + "-" + contLinhaExtrato;

            // Buscar Extrato por Chave na Tabela IO_EXTRATO.
            extratoEmpresa = dbIOCont.sql("SELECT CHAVE FROM IO_EXTRATO WHERE CHAVE = ?")
            .fields("CHAVE")
            .param(chaveExtrato)
            .queryUnique();

            // Inserir caso Chave nao encontrada.
            if (extratoEmpresa == null || !extratoEmpresa.has("CHAVE")) {
                try {
                    dbIOCont.insert("IO_EXTRATO")
                    .fields("CHAVE,CODEMPRESA, DATAMOVIMENTO, PORTADOR, HISTORICO, LOTE, COMPLEMENTO, VALORDOCUMENTO, DEBITOCREDITO, EXTRATOLIDO")
                    .param(chaveExtrato)
                    .param(codEmpresa)
                    .param(dataMovimento)
                    .param(nomePortador)
                    .param(nomeOrigem)
                    .param(nomeArquivo.toUpperCase())
                    .param(complemento02)
                    .param(valorDocumento)
                    .param(debitoCredito)
                    .param(0)
                    .execute();
                } catch(Exception e) {
                    logger.logError("Error inserting to IO_EXTRATO", e);
                    continue;
                }
                // Atualizar Chave caso encontrada.
            } else {
                try {
                    dbIOCont.update("IO_EXTRATO")
                    .fields("EXTRATOLIDO")
                    .where("CHAVE = ? ")
                    .param(0)
                    .param(chaveExtrato)
                    .execute();
                } catch(Exception e1) {
                    logger.logError("Error updating IO_EXTRATO", e1);
                    continue;
                }
            }
        } catch(Exception e) {
            logger.logError("ERRO: ", e);
        }
    }

    return true;
}

// Extrato_Banpara_TXT
public boolean readExtratoBanparaTxt(MemoryFile memFile, String nomePortador, JSONObject jDados, DataBase dbIOCont, InoutLogger logger) throws Exception {

    JSONObject extratoEmpresa = new JSONObject();

    // Inicializacao de Variaveis
    String codEmpresa        = "";
    String nomeArquivo       = "";
    String chaveExtrato      = "";

    String documento         = "";
    String nomeOrigem        = "";
    String dataMovimento     = "";
    String dataLote          = "";
    String complemento01     = "";
    String complemento02     = "";
    String complemento03     = "";
    String complemento04     = "";
    String complemento05     = "";
    String complemento06     = "";
    String complemento07     = "";
    String complemento08     = "";
    String complemento09     = "";
    String complemento10     = "";
    String debitoCredito     = "";
    String cpfCnpj           = "";
    String historico         = "";
	String ano 				 = "";

    String strValorDocumento = "";
    String contLinhaExtrato  = "";

    double valorDocumento    = 0.0;
    double valorJuros        = 0.0;
    double valorDesconto     = 0.0;
    double valorMulta        = 0.0;
    double valorPagamento    = 0.0;

    boolean naoLeMais = false;

    if(jDados.has("CODEMPRESA"))   codEmpresa   = jDados.optString("CODEMPRESA");
    if(jDados.has("NOMEARQUIVO"))  nomeArquivo  = jDados.optString("NOMEARQUIVO");

    while (memFile.hasNextLine()) {

        try {
            String line = memFile.nextLine();
            line = StringUtil.removeSpecialCharsToUC(line);

            if (line.startsWith("CONTA:")) {
                nomePortador = line.substring(line.indexOf("CONTA:")).trim();
                continue;
            }

            complemento01   = "";
            complemento02   = "";
            complemento03   = "";
            complemento04   = "";
            complemento05   = "";

            complemento06   = "";
            complemento07   = "";
            complemento08   = "";
            complemento09   = "";
            complemento10   = "";

            cpfCnpj         = "";

            documento       = "";
            historico       = "";

            valorJuros      = 0;
            valorDesconto   = 0;
            valorMulta      = 0;
            valorPagamento  = 0;

            if (line.contains("SALDO")) continue;

            // Data Movimento.
			if (line.contains("PERIODO: ")) {
				ano = line.substring(14,19).trim();
				continue;
			}
            if (line.substring(2,3).equals("/")) {
                try {
                    dataMovimento = line.substring( 0, 5) + ano;
                    Date dt 	  = DateUtil.stringToDate( dataMovimento, "dd/MM/yyyy" );
                    dataMovimento = DateUtil.dateToString( dt, "dd/MM/yyyy" );
                    dataLote      = DateUtil.dateToString( dt,"yyyy-MM" );
                } catch (Exception dte) { continue; }
	            if (dataMovimento.equals("")) continue;

	            nomeOrigem    = StringUtil.removeSpecialChars(line.substring(  6, 40 )).trim().toUpperCase();
	            documento     = StringUtil.removeSpecialChars(line.substring( 41, 51 )).trim().toUpperCase();
				complemento01 = StringUtil.removeSpecialChars(line.substring( 12, 30 )).trim().toUpperCase();

	            strValorDocumento = "0";
	            try{
	                strValorDocumento   = line.substring(55, 68).trim().toUpperCase().replaceAll("\\.","");
	                debitoCredito		= strValorDocumento;

	                valorDocumento = Math.abs(DecimalUtil.toDecimal(strValorDocumento.replaceAll("-","")));
	            } catch (Exception vlrx) {
	                valorDocumento = 0;
	            }

	            if (!debitoCredito.contains("-")) debitoCredito = "EXTRATO-CREDITO";
				else if (debitoCredito.contains("-")) debitoCredito = "EXTRATO-DEBITO";


	            if(naoLeMais) continue;
			}
			if(valorDocumento == 0) continue;
			if (dataMovimento.trim().equals("")) continue;

            // Chave para Insert/Update no Banco de Dados.
            chaveExtrato = codEmpresa + "-" +  dataMovimento + "-" + debitoCredito + "-" + String.format("%.2f", valorDocumento) + "-" + nomePortador + "-" + contLinhaExtrato;

            // Buscar Extrato por Chave na Tabela IO_EXTRATO.
            extratoEmpresa = dbIOCont.sql("SELECT CHAVE FROM IO_EXTRATO WHERE CHAVE = ?")
            .fields("CHAVE")
            .param(chaveExtrato)
            .queryUnique();

            if (extratoEmpresa == null || !extratoEmpresa.has("CHAVE")) {
                try {

                    dbIOCont.insert("IO_EXTRATO")
                    .fields("CHAVE,CODEMPRESA, DATAMOVIMENTO, PORTADOR, HISTORICO, LOTE, COMPLEMENTO, VALORDOCUMENTO, DEBITOCREDITO, EXTRATOLIDO")
                    .param(chaveExtrato)
                    .param(codEmpresa)
                    .param(dataMovimento)
                    .param(nomePortador)
                    .param(nomeOrigem)
                    .param(nomeArquivo.toUpperCase())
                    .param(complemento01)
                    .param(valorDocumento)
                    .param(debitoCredito)
                    .param(0)
                    .execute();
                } catch(Exception e) {
                    logger.logError("Error inserting to IO_EXTRATO", e);
                    continue;
                }
            } else {
                try {

                    dbIOCont.update("IO_EXTRATO")
                    .fields("COMPLEMENTO, EXTRATOLIDO")
                    .where("CHAVE = ? ")
                    .param(complemento01)
                    .param(0)
                    .param(chaveExtrato)
                    .execute();
                } catch(Exception e1) {
                    logger.logError("Error updating IO_EXTRATO", e1);
                    continue;
                }
            }
        } catch(Exception e) {
            logger.logError("ERRO: ", e);
        }
    }

    return true;
}

// Extrato_Tribanco_Excel
public boolean readExtratoTribancoExcel(MemoryFile memFile, String nomePortador, JSONObject jDados, DataBase dbIOCont, InoutLogger logger) throws Exception {

    JSONObject extratoEmpresa = new JSONObject();

    // Inicializacao de Variaveis
    String codEmpresa        = "";
    String nomeArquivo       = "";
    String chaveExtrato      = "";

    String documento         = "";
    String nomeOrigem        = "";
    String dataMovimento     = "";
    String dataLote          = "";
    String complemento01     = "";
    String complemento02     = "";
    String complemento03     = "";
    String complemento04     = "";
    String complemento05     = "";
    String complemento06     = "";
    String complemento07     = "";
    String complemento08     = "";
    String complemento09     = "";
    String complemento10     = "";
    String debitoCredito     = "";
    String cpfCnpj           = "";
    String historico         = "";

    String strValorDocumento = "";
    String contLinhaExtrato  = "";

    double valorDocumento    = 0.0;
    double valorJuros        = 0.0;
    double valorDesconto     = 0.0;
    double valorMulta        = 0.0;
    double valorPagamento    = 0.0;

	int idataMovimento	= 0;
	int idocumento		= 2;
	int inomeOrigem		= 1;
	int ivalorDocumento	= 3;
	int icomplemento02	= 3;

    if(jDados.has("CODEMPRESA"))   codEmpresa   = jDados.optString("CODEMPRESA");
    if(jDados.has("NOMEARQUIVO"))  nomeArquivo  = jDados.optString("NOMEARQUIVO");

    while (memFile.hasNextLine()) {

        try {
            String line = memFile.nextLine();
            line = StringUtil.removeSpecialCharsToUC(line);
            if (memFile.getStringFieldRemoveEspCharsUpper(idataMovimento).replaceAll("\"","").equals("")) continue;

            try {
                Date dt = memFile.getDateField(idataMovimento, "dd/MM/yyyy");
                dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                dataLote = DateUtil.dateToString(dt, "yyyy-MM");
            } catch (Exception dt1) {
                try {
                    Date dt = memFile.getDateField(idataMovimento);
                    dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                    dataLote = DateUtil.dateToString(dt, "yyyy-MM");
                } catch (Exception dt2) {
                    try {
                        String dataString = memFile.getStringFieldRemoveEspCharsUpper(idataMovimento).replaceAll("\"","");
                        Date dt  = DateUtil.stringToDate(dataString, "dd/MM/yyyy");
                        dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                        dataLote = DateUtil.dateToString(dt, "yyyy-MM");
                    } catch (Exception dt2) { }
                }
            }

            valorDocumento  = 0;
			try{valorDocumento = Math.abs(memFile.getDoubleField(ivalorDocumento));}
			catch (Exception vlrd) { valorDocumento = 0; }
            if (valorDocumento == 0) continue;

			nomeOrigem      = "";
            nomeOrigem		= memFile.getStringFieldRemoveEspCharsUpper(inomeOrigem).replaceAll("\"","");
			complemento01   = nomePortador;
            complemento02	= "";
            complemento02	= memFile.getStringFieldRemoveEspCharsUpper(icomplemento02).replaceAll("\"","");
			documento		= "";
            documento		= memFile.getStringFieldRemoveEspCharsUpper(idocumento).replaceAll("\"","");

            if (!complemento02.contains("-")) debitoCredito = "EXTRATO-CREDITO";
            if (complemento02.contains("-")) debitoCredito = "EXTRATO-DEBITO";

            contLinhaExtrato = StringUtil.leftPad(String.valueOf(memFile.getCurrentIndex()), 05, "0");

            chaveExtrato = codEmpresa + "-" +  dataMovimento + "-" + debitoCredito + "-" + String.format("%.2f", valorDocumento) + "-" + nomePortador + "-" + contLinhaExtrato;

            // Buscar Extrato por Chave na Tabela IO_EXTRATO.
            extratoEmpresa = dbIOCont.sql("SELECT CHAVE FROM IO_EXTRATO WHERE CHAVE = ?")
            .fields("CHAVE")
            .param(chaveExtrato)
            .queryUnique();

            // Inserir caso Chave nao encontrada.
            if (extratoEmpresa == null || !extratoEmpresa.has("CHAVE")) {
                try {
                    dbIOCont.insert("IO_EXTRATO")
                    .fields("CHAVE,CODEMPRESA, DATAMOVIMENTO, PORTADOR, HISTORICO, LOTE, COMPLEMENTO, VALORDOCUMENTO, DEBITOCREDITO, EXTRATOLIDO")
                    .param(chaveExtrato)
                    .param(codEmpresa)
                    .param(dataMovimento)
                    .param(nomePortador)
                    .param(nomeOrigem)
                    .param(nomeArquivo.toUpperCase())
                    .param(complemento02)
                    .param(valorDocumento)
                    .param(debitoCredito)
                    .param(0)
                    .execute();
                } catch (Exception sqlInsertException) {
                    logger.logError("Error inserting to IO_EXTRATO", sqlInsertException);
                    continue;
                }
                // Atualizar Chave caso encontrada.
            } else {
                try {
                    dbIOCont.update("IO_EXTRATO")
                    .fields("EXTRATOLIDO")
                    .where("CHAVE = ? ")
                    .param(0)
                    .param(chaveExtrato)
                    .execute();
                } catch (Exception sqlUpdateException) {
                    logger.logError("Error updating IO_EXTRATO", sqlUpdateException);
                    continue;
                }
            }
        } catch (Exception readExtratoException) {
            logger.logError("Erro de leitura de Extrato Padrão Sicoob", readExtratoException);
        }
    }
    return true;
}


public boolean insertIOExtrato(JSONObject jDados, DataBase dbIOCont, InoutLogger logger) throws Exception {

    // Inicializacao de Variaveis
    String codEmpresa        = jDados.optString("EMPRESA");
    String nomeArquivo       = jDados.optString("NOMEARQUIVO");
    String nomePortador      = jDados.optString("PORTADOR");
    String nomeOrigem        = jDados.optString("NOMEORIGEM");
    String dataMovimento     = jDados.optString("DATAMOVIMENTO");
    double valorDocumento    = jDados.optDouble("VALORDOCUMENTO");
    String complemento01     = jDados.optString("COMPLEMENTO01");
    String debitoCredito     = jDados.optString("DEBITO-CREDITO");
	String contLinhaExtrato    = jDados.optString("CONT");

	complemento01 = cutString(complemento01, 0, 199);
	
            // Gerar Chave Extrato;
    String chaveExtrato = codEmpresa + "-" +  dataMovimento + "-" + debitoCredito + "-" + String.format("%.2f", valorDocumento) + "-" + nomePortador.toLowerCase() + "-" + contLinhaExtrato;
	
	// Buscar Extrato por Chave na Tabela IO_EXTRATO.
	JSONObject extratoEmpresa = dbIOCont.sql("SELECT CHAVE FROM IO_EXTRATO WHERE CHAVE = ?")
	.fields("CHAVE")
	.param(chaveExtrato)
	.queryUnique();

	// Inserir caso Chave nao encontrada.
	if (extratoEmpresa == null || !extratoEmpresa.has("CHAVE")) {
		try {
			dbIOCont.insert("IO_EXTRATO")
			.fields("CHAVE,CODEMPRESA, DATAMOVIMENTO, PORTADOR, HISTORICO, LOTE, COMPLEMENTO, VALORDOCUMENTO, DEBITOCREDITO, EXTRATOLIDO")
			.param(chaveExtrato)
			.param(codEmpresa)
			.param(dataMovimento)
			.param(nomePortador.toUpperCase())
			.param(nomeOrigem)
			.param(nomeArquivo)
			.param(complemento01)
			.param(valorDocumento)
			.param(debitoCredito)
			.param(0)
			.execute();
		} catch(Exception e) {
			logger.logError("Error inserting to IO_EXTRATO", e);
		}
		// Atualizar Chave caso encontrada.
	} else {
		try {
			dbIOCont.update("IO_EXTRATO")
			.fields("EXTRATOLIDO")
			.where("CHAVE = ? ")
			.param(0)
			.param(chaveExtrato)
			.execute();
		} catch(Exception e1) {
			logger.logError("Error updating IO_EXTRATO", e1);
		}
	}

	return true;

}


class ttMovimentoPadrao {
    public String lote = "";
	public String classificacao = "";
	public String dataMovimento = "";
	public String documento = "";
	public int    parcelaDoc;
	public String codEmpresa = "";
	public String nomeEmpresa = "";
	public String nomeOrigem = "";
	public String contaJuros = "";
	public String contaMulta = "";
	public String contaDesconto = "";
	public String contaDebito = "";
	public String contaCredito = "";
	public String historico = "";
	public String historicoJuros = "";
	public String historicoDesconto = "";
	public String historicoMulta = "";
	public double valorDocumento;
	public double valorDesconto;
	public double valorJuros;
	public double valorMulta;
	public String nomePortador = "";
	public String centroCusto = "";
	public String naturezaContabil = "";
	public String tipoMovimento = "";
	public String tipoLancamento = "";
	public String cpfCnpj = "";
	public String serie = "";
	public String statusMovimento = "";
	public String chave = "";
	public int    contador;
	public String complemento01 = "";
	public String complemento02 = "";
	public String complemento03 = "";
	public String complemento04 = "";
	public String complemento05 = "";
	public String complemento06 = "";
	public String complemento07 = "";
	public String complemento08 = "";
	public String complemento09 = "";
	public String complemento10 = "";
	public String nomeArquivo   = "";
	public String mesAnoAtual   = "";
	public String mesAnoAnterior = "";
	public String mesAnoAnterior2 = "";
	public String tipoPlanilha  = "";
	public String codFilial     = "";
	public String chaveExtrato  = "";
	public String debitoCredito = "";
	public String abaPlanilha   = "";
	public String contLinha		= "2";


	public ttMovimentoPadrao(){}
	public ttMovimentoPadrao(ttMovimentoPadrao tt){

		lote=tt.lote;
		classificacao=tt.classificacao;
		dataMovimento=tt.dataMovimento;
		documento=tt.documento;
		parcelaDoc=tt.parcelaDoc;
		codEmpresa=tt.codEmpresa;
		nomeEmpresa=tt.nomeEmpresa;
		nomeOrigem=tt.nomeOrigem;
		contaJuros=tt.contaJuros;
		contaMulta=tt.contaMulta;
		contaDesconto=tt.contaDesconto;
		contaDebito=tt.contaDebito;
		contaCredito=tt.contaCredito;
		historico=tt.historico;
		historicoJuros=tt.historicoJuros;
		historicoDesconto=tt.historicoDesconto;
		historicoMulta=tt.historicoMulta;
		valorDocumento=tt.valorDocumento;
		valorDesconto=tt.valorDesconto;
		valorJuros=tt.valorJuros;
		valorMulta=tt.valorMulta;
		nomePortador=tt.nomePortador;
		centroCusto=tt.centroCusto;
		naturezaContabil=tt.naturezaContabil;
		tipoMovimento=tt.tipoMovimento;
		tipoLancamento=tt.tipoLancamento;
		cpfCnpj=tt.cpfCnpj;
		documento=tt.documento;
		serie=tt.serie;
		statusMovimento=tt.statusMovimento;
		chave=tt.chave;
		contador=tt.contador;
		complemento01=tt.complemento01;
		complemento02=tt.complemento02;
		complemento03=tt.complemento03;
		complemento04=tt.complemento04;
		complemento05=tt.complemento05;
		complemento06=tt.complemento06;
		complemento07=tt.complemento07;
		complemento08=tt.complemento08;
		complemento09=tt.complemento09;
		complemento10=tt.complemento10;
		nomeArquivo=tt.nomeArquivo;
		mesAnoAtual=tt.mesAnoAtual;
		mesAnoAnterior=tt.mesAnoAnterior;
		mesAnoAnterior2=tt.mesAnoAnterior2;
		tipoPlanilha=tt.tipoPlanilha;
		codFilial=tt.codFilial;
		chaveExtrato=tt.chaveExtrato;
		debitoCredito=tt.debitoCredito;
		abaPlanilha=tt.abaPlanilha;
		contLinha=tt.contLinha;

	}
}

class ttParcelaDominio {
    public String documento;
	public int ultimaParcela;
    public ttParcelaDominio(){}

    public ttParcelaDominio(ttParcelaDominio ttP){
        documento = ttP.documento;
		ultimaParcela = ttP.ultimaParcela;
    }
}


/* ################################################################################################ @EXTRATO-ITAU ##
    Leitura de Planilha Padr�o EXTRATO - ITAU
    ## ################################################################################################################## */
public boolean readExtratoItauTXT(MemoryFile memFile, String nomePortador, JSONObject jDados, DataBase dbIOCont, InoutLogger logger) throws Exception {
    JSONObject extratoEmpresa = new JSONObject();

    // Inicializacao de Variaveis
        String codEmpresa        = "";
        String nomeArquivo       = "";
        String chaveExtrato      = "";

        String documento         = "";
        String nomeOrigem        = "";
        String dataMovimento     = "";
        String dataLote          = "";
        String complemento01     = "";
        String complemento02     = "";
        String complemento03     = "";
        String complemento04     = "";
        String complemento05     = "";
        String complemento06     = "";
        String complemento07     = "";
        String complemento08     = "";
        String complemento09     = "";
        String complemento10     = "";
        String debitoCredito     = "";
        String cpfCnpj           = "";
        String historico         = "";

        String strValorDocumento = "";
        String contLinhaExtrato  = "";
		
		String line 			 = "";

        double valorDocumento    = 0.0;
        double valorJuros        = 0.0;
        double valorDesconto     = 0.0;
        double valorMulta        = 0.0;
        double valorPagamento    = 0.0;

        boolean naoLeMais = false;

        if(jDados.has("CODEMPRESA"))   codEmpresa   = jDados.optString("CODEMPRESA");
        if(jDados.has("NOMEARQUIVO"))  nomeArquivo  = jDados.optString("NOMEARQUIVO");
		if(jDados.has("LINE"))  {
			line		    = jDados.optString("LINE");
			memFile.addLine(line, memFile.getLines().size());
		}

        memFile.setFieldSeparator(";");
        while (memFile.hasNextLine()) {

            try {
                line = memFile.nextLine();
                line = StringUtil.removeSpecialCharsToUC(line);

                complemento01   = nomePortador;
                complemento02   = nomePortador;
                complemento03   = "";
                complemento04   = "";
                complemento05   = "";

                complemento06   = "";
                complemento07   = "";
                complemento08   = "";
                complemento09   = "";
                complemento10   = "";

                cpfCnpj         = "";
                nomeOrigem      = "";
                documento       = "";
                historico       = "";

                valorDocumento  = 0;
                valorJuros      = 0;
                valorDesconto   = 0;
                valorMulta      = 0;
                valorPagamento  = 0;

                if (memFile.getStringField(0).equals("")) continue;
                try {
                    Date dt = memFile.getDateField(0, "dd/MM/yyyy");
                    dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                    dataLote = DateUtil.dateToString(dt, "yyyy-MM");
                } catch (Exception dt1) {
                    try {
                       Date dt = memFile.getDateField(0);
                       dataMovimento = DateUtil.dateToString(dt, "dd/MM/yyyy");
                       dataLote = DateUtil.dateToString(dt, "yyyy-MM");
                   } catch (Exception dt2) {
                       continue;
                   }
                }

                try {valorDocumento = memFile.getDoubleField(2);}
                catch(Exception e) { valorDocumento = 0;}

                if (valorDocumento > 0) debitoCredito = "EXTRATO-CREDITO";
                if (valorDocumento < 0) debitoCredito = "EXTRATO-DEBITO";
                if (valorDocumento == 0) continue;

                valorDocumento = Math.abs(valorDocumento);

                nomeOrigem    = memFile.getStringFieldRemoveEspCharsUpper(1);

                if(naoLeMais) continue;

                contLinhaExtrato = StringUtil.leftPad(String.valueOf(memFile.getCurrentIndex()), 05, "0");
                chaveExtrato = codEmpresa + "-" +  dataMovimento + "-" + debitoCredito + "-" + String.format("%.2f", valorDocumento) + "-" + nomePortador + "-" + contLinhaExtrato;

                // Buscar Extrato por Chave na Tabela IO_EXTRATO.
                extratoEmpresa = dbIOCont.sql("SELECT CHAVE FROM IO_EXTRATO WHERE CHAVE = ?")
                .fields("CHAVE")
                .param(chaveExtrato)
                .queryUnique();

                // Inserir caso Chave nao encontrada.
                if (extratoEmpresa == null || !extratoEmpresa.has("CHAVE")) {
                try {
                    dbIOCont.insert("IO_EXTRATO")
                    .fields("CHAVE,CODEMPRESA, DATAMOVIMENTO, PORTADOR, HISTORICO, LOTE, COMPLEMENTO, VALORDOCUMENTO, DEBITOCREDITO, EXTRATOLIDO")
                    .param(chaveExtrato)
                    .param(codEmpresa)
                    .param(dataMovimento)
                    .param(nomePortador)
                    .param(nomeOrigem)
                    .param(nomeArquivo.toUpperCase())
                    .param(complemento02)
                    .param(valorDocumento)
                    .param(debitoCredito)
                    .param(0)
                    .execute();
                } catch(Exception e) {
                    logger.logError("Error inserting to IO_EXTRATO", e);
                    continue;
                }
            // Atualizar Chave caso encontrada.
            } else {
                try {
                    dbIOCont.update("IO_EXTRATO")
                    .fields("EXTRATOLIDO")
                    .where("CHAVE = ? ")
                    .param(0)
                    .param(chaveExtrato)
                    .execute();
                } catch(Exception e1) {
                    logger.logError("Error updating IO_EXTRATO", e1);
                    continue;
                }
            }
        } catch(Exception e) {
            logger.logError("ERRO: ", e);
        }
    }
    return true;
}

//JWR

public void preparaArquivo(String idRoteiro, String tipoIntegracao, String contabilidade, String empresa, String dirName, String dirNameW, ConnectorConfig config, InoutLogger logger) {

	try {
		StringBuilder txt1 = new StringBuilder();    
		String empresaProperties = dirName + "empresa.properties";
		FileWriter writer = new FileWriter(empresaProperties);
		txt1.append("NOME_EMPRESA = " + empresa);
		txt1.append("\r\n");
		txt1.append("NOME_CONTABILIDADE = " + contabilidade);
		txt1.append("\r\n");
		txt1.append("MANTEM_ARQUIVO = SIM");
		writer.writeNewFile(txt1.toString());

		empresaProperties = dirNameW + "empresa.properties";
		writer = new FileWriter(empresaProperties);
		writer.writeNewFile(txt1.toString());
		
 		logger.logInfo("PREPARAND ARQUIVO = " + contabilidade + "/" + empresa);
	
		StringBuilder codigoNovo    = new StringBuilder();
		StringBuilder codigoRoteiro = new StringBuilder();
		
		FileReader reader = new FileReader("c:/ottimizza/dropbox/deploy/routes/ottimizza/TemplateOficialAtualEndpointA.script");
		try {
			reader.openFile();
			String line = "";
			while(reader.hasNextLine()) {
				// Le a proxima linha do arquivo
				line = reader.nextLine();
				// Processa a linha
				// ....
				
				codigoNovo.append(line);
				if (line.contains("NAO ALTERAR DAQUI ATE O FINAL")) break;				
			}
		} catch (IOException ioe) {
			logger.logError(ioe);
		} finally {
			reader.closeFile();
		}
		
		String tipoRoteiro = "_ContasPagasRoteiroPadrao.script";
		if (tipoIntegracao.toUpperCase().contains("RECE")) tipoRoteiro = "_ContasRecebidasRoteiroPadrao.script";
 			
		try {
			File fileRoteiro = new File("c:/ottimizza/dropbox/deploy/routes/" + contabilidade + "/" + empresa + tipoRoteiro);
			
			
 
			//if (fileRoteiro.exists() /*&& tipoRoteiro.contains("TESTE XAVIER")*/) {
			if (fileRoteiro.exists()) {
 				
				FileReader readerRoteiro = new FileReader("c:/ottimizza/dropbox/deploy/routes/" + contabilidade + "/" + empresa + tipoRoteiro);
				try {
					readerRoteiro.openFile();
					String lineRoteiro = "";
					while(readerRoteiro.hasNextLine()) {
						// Le a proxima linha do arquivo
						lineRoteiro = readerRoteiro.nextLine();
						// Processa a linha
						// ....
						
						codigoRoteiro.append(lineRoteiro);
 					}
				} catch (IOException ioe) {
					logger.logError(ioe);
				} finally {
					readerRoteiro.closeFile();
				}
			}
			else {
				//PartnerConnection connection = Connector.newConnection(config);  
				//codigoRoteiro.append(prepareScript(idRoteiro, "OTTPADRAO" + empresa, "", contabilidade, tipoIntegracao, connection, logger));
			}
		} catch (Exception xx) {logger.logDebug("XX " + xx);}
		
 
		if (!codigoRoteiro.toString().equals("")) {
		
			empresaProperties = "";
 			
			if (tipoIntegracao.toUpperCase().contains("PAGA"))  empresaProperties = RouteEngine.INOUT_HOME + "/routes/" + getNomeContabilidade() + "/" + getNomeContabilidade() + "_ContasPagasEndpointA.script";
			if (tipoIntegracao.toUpperCase().contains("RECE"))  empresaProperties = RouteEngine.INOUT_HOME + "/routes/" + getNomeContabilidade() + "/" + getNomeContabilidade() + "_ContasRecebidasEndpointA.script";
			writer = new FileWriter(empresaProperties);
			writer.writeNewFile(codigoNovo.toString() + codigoRoteiro.toString());			
			
			writer = new FileWriter("c:/inout/tmp/"+contabilidade+"_copia.txt");
			writer.writeNewFile(codigoNovo.toString() + codigoRoteiro.toString());
			
			writer = new FileWriter("c:/ottimizza/dropbox/deploy/routes/" + contabilidade + "/" + empresa + tipoRoteiro);
			writer.writeNewFile(codigoRoteiro.toString());	
		}		
 	}
	catch (Exception xx) {}
	return;
}


public void preparaArquivoEspecifico(String idRoteiro, String tipoIntegracao, String contabilidade, String empresa, String dirName, String dirNameW, InoutLogger logger) {

	try {
		StringBuilder txt1 = new StringBuilder();    
		String empresaProperties = dirName + "empresa.properties";
		FileWriter writer = new FileWriter(empresaProperties);
		txt1.append("NOME_EMPRESA = " + empresa);
		txt1.append("\r\n");
		txt1.append("NOME_CONTABILIDADE = " + contabilidade);
		txt1.append("\r\n");
		txt1.append("MANTEM_ARQUIVO = SIM");
		writer.writeNewFile(txt1.toString());

		empresaProperties = dirNameW + "empresa.properties";
		writer = new FileWriter(empresaProperties);
		writer.writeNewFile(txt1.toString());
		
		logger.logInfo("preparaArquivoEspecifico = " + contabilidade + "/" + empresa);

	
		StringBuilder codigoNovo    = new StringBuilder();
		StringBuilder codigoRoteiro = new StringBuilder();
		
		String tipoRoteiro = "_ContasPagasRoteiro.script";
		String tipoRota = "_ContasPagasEndpointA.script";
		if (tipoIntegracao.toUpperCase().contains("RECE")) {
			tipoRoteiro = "_ContasRecebidasRoteiro.script";
			tipoRota = "_ContasRecebidasEndpointA.script";
		}
			
		try {
			
			
			FileReader reader = new FileReader("c:/ottimizza/dropbox/deploy/routes/" + contabilidade + "/" + empresa + tipoRota);
			try {
				reader.openFile();
				String line = "";
				while(reader.hasNextLine()) {
					// Le a proxima linha do arquivo
					line = reader.nextLine();
					// Processa a linha
					// ....
					
					codigoNovo.append(line);
					if (line.contains("NAO ALTERAR DAQUI ATE O FINAL")) break;				
				}
			} catch (IOException ioe) {
				logger.logError(ioe);
			} finally {
				reader.closeFile();
			}
					
			 
 
 			File fileRoteiro = new File("c:/ottimizza/dropbox/deploy/routes/" + contabilidade + "/" + empresa + tipoRoteiro);

			if (fileRoteiro.exists()) {
 				
				FileReader readerRoteiro = new FileReader("c:/ottimizza/dropbox/deploy/routes/" + contabilidade + "/" + empresa + tipoRoteiro);
				try {
					readerRoteiro.openFile();
					String lineRoteiro = "";
					while(readerRoteiro.hasNextLine()) {
						// Le a proxima linha do arquivo
						lineRoteiro = readerRoteiro.nextLine();
						// Processa a linha
						// ....
						
						codigoRoteiro.append(lineRoteiro);
 					}
				} catch (IOException ioe) {
					logger.logError(ioe);
				} finally {
					readerRoteiro.closeFile();
				}
			}
			else {
				ConnectorConfig config = new ConnectorConfig();
				config.setUsername("fabrica@ottimizza.com.br");
				config.setPassword("ottimizza@123HU4ssqt1HCiLyCzj6QStgteM2");
				config.setTraceMessage(false);
				logger.logInfo("API SALES SHR: preparaArquivoEspecifico RegrasWorkflowT 2");
				// colocado por Xavier PartnerConnection connection = Connector.newConnection(config);  
							//codigoRoteiro.append(prepareScript(idRoteiro, "OTTPADRAO" + empresa, "", contabilidade, tipoIntegracao, connection, logger));
			}
		} catch (Exception xx) {logger.logDebug("XX " + xx);}
		
 
		if (!codigoRoteiro.toString().equals("")) {
		
			empresaProperties = "";
 			
			if (tipoIntegracao.toUpperCase().contains("PAGA"))  empresaProperties = "c:/ottimizza/dropbox/deploy/routes/" + contabilidade + "/" + empresa + "_ContasPagasEndpointA.script";
			if (tipoIntegracao.toUpperCase().contains("RECE"))  empresaProperties = "c:/ottimizza/dropbox/deploy/routes/" + contabilidade + "/" + empresa + "_ContasRecebidasEndpointA.script";
			writer = new FileWriter(empresaProperties);
			writer.writeNewFile(codigoNovo.toString() + codigoRoteiro.toString());			
			
			writer = new FileWriter("c:/inout/tmp/"+contabilidade+"_copia_especifica.txt");
			writer.writeNewFile(codigoNovo.toString() + codigoRoteiro.toString());
			
			writer = new FileWriter("c:/ottimizza/dropbox/deploy/routes/" + contabilidade + "/" + empresa + tipoRoteiro);
			writer.writeNewFile(codigoRoteiro.toString());	
		}		
 	}
	catch (Exception xx) {}
	return;
}



public void criaAvisoErroLayout (String arquivo,InoutLogger logger) {

    try {


        FileUtil.deleteFile(arquivo);
        arquivo = arquivo.replaceAll("\\.status",".err");


        FileWriter writerRazao = new FileWriter(arquivo);

        StringBuilder sb1 = new StringBuilder();       
        
        sb1.append("<div class=\"er-content\">").append("\r\n");
        sb1.append("<div class=\"er-message\">").append("\r\n");


        sb1.append("<p>Esta planilha nao pode ser processada pela Ottimizza. Alguns motivos:</p>").append("\r\n");
        sb1.append("</div>").append("\r\n");
        sb1.append("<ul class=\"ul-tips\">").append("\r\n");
		
		StringBuilder mens = new StringBuilder();
		String dirName = cutString(arquivo, 0, "DePara") + "/DePara/Processado";
		logger.logDebug("LENDO regrasotw = " + dirName);
		
		FilesLoader fileLoader2 = new FilesLoader(dirName, "TIPOPLANILHA.txt", dirName+"/lido", true, logger);
		fileLoader2.loadFiles();
		for (MemoryFile memFile: fileLoader2.getMemFiles()) {
			while (memFile.hasNextLine()) {
				try {
					mens.append(memFile.nextLine()).append("    ");
				} catch (Exception xx) {}
			}
		}
							
		if (!mens.toString().equals("")) {
	        sb1.append("<li class=\"it-tip\">").append("\r\n");
			sb1.append("<span><cont color=\red\">").append(mens.toString()).append("</font></span>").append("\r\n");
			sb1.append("</li>").append("\r\n");
		}
        sb1.append("<li class=\"it-tip\">").append("\r\n");
        sb1.append("<span><cont color=\red\">Em 95% dos casos isto ocorre porque o layout do arquivo postado difere do arquivo esperado pela integracao.</font></span>").append("\r\n");
        sb1.append("</li>").append("\r\n");

        sb1.append("<li class=\"it-tip\">").append("\r\n");
        sb1.append("<span><cont color=\red\">Verifique tambem se a planilha esta protegida ou com links a outras planilhas</font></span>").append("\r\n");
        sb1.append("</li>").append("\r\n");
 


        sb1.append("<li class=\"it-tip\">").append("\r\n");
        sb1.append("<span>Verifique se a planilha enviada possui formulas para valores, datas, etc.</span>").append("\r\n");
        sb1.append("</li>").append("\r\n");
        sb1.append("</ul>").append("\r\n");
        sb1.append("<div class=\"er-obs\">").append("\r\n");
        sb1.append("<h6>Caso nao encontre problema na planilha processada, entre em contato com o <a href=\"https://suporte.ottimizza.com.br/\">Suporte Ottimizza</a> </h6>").append("\r\n");
        sb1.append("</div>").append("\r\n");
        sb1.append("</div>").append("\r\n");
        sb1.append("</body>").append("\r\n");

       


        writerRazao.writeNewFile(sb1.toString());
    }
    catch (Exception xx) {} 

}



//-------------------------------------------------------------------------------------
// Manda informacoes para o servidor status
// Vitor 16/05/2022
//-------------------------------------------------------------------------------------


public void postStatus(String servidor, String workflow, String contabilidade, String empresa, String tipo, String id) {
    String url = "https://api-status-server.herokuapp.com/status";


    try {


        JSONObject body = new JSONObject();

        body.put("servidor", servidor);
        body.put("workflow", workflow);
        body.put("contabilidade", contabilidade);
        body.put("empresa", empresa);
        body.put("tipo", tipo);
        body.put("id", servidor + id);

        java.net.URL serviceURL = new java.net.URL(url);

        // Opens java.net.URL as a POST Request
        java.net.HttpURLConnection connection = (java.net.HttpURLConnection) serviceURL.openConnection();
        connection.setDoOutput(true); // indicates a post
        connection.setRequestMethod("POST");
        connection.setRequestProperty("Accept", "application/json");
        connection.setRequestProperty("Content-Type", "application/json");

        try {
            java.io.OutputStream os = connection.getOutputStream();
            os.write(body.toString().getBytes());
            os.flush();
            os.close();
        } catch (Exception ex1) {
            logger.logError("Erro tentando enviar informa??es para o status server -> " + ex1);
        } 

        try {
            java.io.BufferedReader reader = new java.io.BufferedReader(new java.io.InputStreamReader(connection.getInputStream(), "UTF-8"));
            String line;
            StringBuilder responseRaw = new StringBuilder();
            while ((line = reader.readLine()) != null) {
                responseRaw.append(line);
            }
            reader.close();
        } catch (Exception ex2) {
            logger.logError("Segundo Catch " + ex2);
        } 

    } catch (Exception ex2) {
        logger.logError("Segundo Catch " + ex2);
    }

}


